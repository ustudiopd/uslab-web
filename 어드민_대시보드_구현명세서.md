아래 문서는 기존 “어드민/대시보드/트래킹/SEO 명세서”의 현재 상태·제약(Next.js 14 App Router, Supabase 공유 프로젝트 + `uslab_` prefix, Vercel Pro 등)  과, **추가 의견 3가지(봇 필터링 / Retention / sendBeacon 기반 fire-and-forget)**를 반영해서 **Cursor에 그대로 던질 수 있는 단일 통합 명세서**로 재구성한 것입니다. 또한 “고급 트래킹”의 기본 테이블 방향(세션/페이지뷰/이벤트)  은 유지하되, Step 1은 **Lite(MVP)로 안전/운영성 중심**으로 확정합니다.

> ✅ 아래 코드블록(마크다운) 전체를 **Cursor에 그대로 붙여넣어** 작업 지시서로 사용하면 됩니다.

````markdown
# USLab.ai Admin + Dashboard + Tracking + SEO 통합 명세서 (Cursor 전달용)
작성일: 2025-12-14
버전: v1.0 (MVP → 확장형)
대상 프로젝트: uslab.ai (Next.js App Router, TypeScript, Tailwind, Supabase, Vercel)

---

## 0) 문서 목적
USLab.ai에서 “어드민에서 콘텐츠 운영 + 통합 대시보드 + 유입률/트래킹 + SEO/메타태그 관리”를
1인 개발/빠른 운영 전환/공유 Supabase 환경이라는 제약 하에 **과도한 엔지니어링 없이** 구현 가능한 수준으로 정의한다.

이 명세서는 구현 순서를 “Step 1: 트래킹 시스템 구축 → Step 2: 대시보드 지표 연결 → Step 3: SEO 기술요소 보강 → Step 4: SEO 운영도구(Audit) 강화”로 잡는다.

---

## 1) 프로젝트 전제/제약 (매우 중요)

### 1.1 기술 스택
- Next.js 14 (App Router)
- TypeScript
- Tailwind CSS
- Supabase (PostgreSQL)
- Vercel (Pro)

### 1.2 Supabase 구조 (공유 프로젝트)
- uslab.ai는 독립 Supabase 프로젝트가 아니다.
- “ustudio” Supabase 프로젝트 1개를 3개 사이트가 공유하고,
  uslab.ai는 `uslab_` prefix로 스키마/테이블을 분리한다.
  - ustudio.co.kr → `ustudio_`
  - modoolucture → `modu_`
  - uslab.ai → `uslab_`

➡️ 결론: 트래킹 테이블은 row가 급증하므로 **Retention(데이터 청소) 전략을 반드시 포함**한다.

### 1.3 운영/보안 전제
- Admin은 Supabase Auth 기반으로 동작.
- 트래킹 데이터는 공개 클라이언트에서 직접 insert 하지 않는다.
  - 반드시 `/api/track` → server-side (service role) insert 패턴으로 진행한다.
- Bot 유입이 많을 수 있으므로 서버에서 UA 기반 필터링을 “최소한” 적용한다.

---

## 2) 현행 구현 요약 (이미 있는 것)
> (구현 코드/DB는 이미 존재한다고 가정하고, 신규 개발은 “추가”만 한다)

### 2.1 Admin
- /admin/login
- /admin/posts (목록: 발행/초안/언어/조회수)
- /admin/posts/write, /admin/posts/[id]
- /admin/about
- 가비지 이미지 정리 (/api/garbage 등)

### 2.2 조회수(기존)
- posts.view_count (누적)
- about.view_count (누적)
- “단순 누적 카운터”이므로 일/주/월 방문자·추이·유입경로는 만들 수 없음

### 2.3 SEO(기존)
- generateMetadata 기반 메타/OG/hreflang 적용
- AI 기반 SEO 메타 생성 엔드포인트 (/api/ai/seo) 존재

---

## 3) 목표 범위 정의 (이번 작업에서 달성할 것)

### 3.1 Admin 운영 범위
- Posts 관리(기존)
- About 관리(기존)
- Comments 관리 UI 추가(승인 토글/삭제 등)
- Inquiries 관리 UI 추가(status 변경/메모 등)
- Media/Garbage (기존)

### 3.2 통합 Dashboard (/admin/dashboard) 신규
- “콘텐츠 KPI + 트래픽 KPI + 최근 활동 + SEO 상태”를 한 화면에서 요약 제공
- 트래킹 MVP가 붙는 즉시 “오늘/7일/30일” 지표가 정상적으로 뜨도록 설계

### 3.3 Tracking (Step 1: Lite MVP)
- 목표: “오늘 방문자/오늘 페이지뷰/최근 7일 추이/상위 페이지/상위 referrer”를 만들 수 있는 최소 데이터 수집
- 반드시 포함:
  1) Bot 필터링(UA 기반)
  2) Retention(삭제 정책 + 인덱스)
  3) Vercel 비용/성능 방어(클라에서 sendBeacon 기반 fire-and-forget)

### 3.4 SEO (기술적 SEO 우선)
- sitemap.xml / robots.txt / canonical / JSON-LD 추가
- Admin에서 메타 관리 UX(타이틀/디스크립션/키워드) 강화 + SEO Audit 페이지 제공

---

## 4) Admin IA (정보 구조) / 라우트 구성안

### 4.1 라우트
- /admin/login (기존)
- /admin/dashboard (신규)  ← 통합 대시보드
- /admin/posts (기존)
- /admin/posts/write (기존)
- /admin/posts/[id] (기존)
- /admin/about (기존)
- /admin/comments (신규)
- /admin/inquiries (신규)
- /admin/analytics (신규: 트래픽 상세)
- /admin/seo (신규: SEO 설정/감사)
  - /admin/seo/audit (신규: 포스트 SEO 품질 검사)

### 4.2 네비게이션
- Sidebar(또는 Top nav) 기준 섹션:
  - Dashboard
  - Content (Posts, About)
  - Engagement (Comments, Inquiries)
  - Analytics
  - SEO
  - Media/Garbage

---

## 5) 통합 Dashboard 상세 구성안 (/admin/dashboard)

### 5.1 화면 구성(섹션)
A. 상단 KPI 카드(4~6개)
B. 트래픽 추이 차트(최근 7/30일)
C. Top 콘텐츠 / Top 페이지 / Top Referrer (테이블 3열 또는 2행 구성)
D. 최근 활동(최근 발행 포스트/최근 댓글/최근 문의)
E. SEO 상태(필수 항목 완료 여부 + SEO 누락 포스트 카운트)

### 5.2 KPI 정의(정확히)
- 총 포스트 수: uslab_posts count(*)
- 발행 포스트 수: uslab_posts where is_published = true
- 초안 포스트 수: uslab_posts where is_published = false
- 총 조회수(누적): sum(uslab_posts.view_count) + sum(uslab_about.view_count)
- 오늘 방문자(Unique Sessions Today):
  - uslab_page_views에서 created_at이 “오늘(Asia/Seoul 기준)”에 해당하는 row들의 DISTINCT session_pk 수
- 오늘 페이지뷰(Pageviews Today):
  - uslab_page_views 오늘 count(*)
- 최근 7일 방문자/페이지뷰:
  - 동일 방식으로 date range 집계

> 시간대 기준: Analytics는 기본 “Asia/Seoul” day boundary를 사용한다.
> (DB는 timestamptz 유지, 집계 쿼리에서 AT TIME ZONE 적용)

### 5.3 차트 요구사항
- Line chart 1: 최근 30일 일별 Pageviews
- (선택) Line chart 2: 최근 30일 일별 Unique Sessions
- 필터: 7일 / 30일 토글

### 5.4 테이블 요구사항
- Top Posts (최근 30일)
  - post title, locale, pageviews(30d), uniques(30d)
- Top Pages (최근 30일)
  - page_path, pageviews, uniques
- Top Referrers (최근 30일)
  - referrer_host, sessions, share(%)

### 5.5 최근 활동
- 최근 발행 포스트 5개(발행일 desc)
- 최근 댓글 5개(created_at desc)
- 최근 문의 5개(created_at desc, status 포함)

### 5.6 SEO 상태 박스
- 기술적 SEO 체크:
  - sitemap.ts 존재/정상
  - robots.ts 존재/정상
  - canonical 적용 여부
  - JSON-LD 적용 여부
- 포스트 SEO 품질:
  - seo_title 누락 개수
  - seo_description 누락 개수
  - thumbnail_url(OG 이미지) 누락 개수
  - (선택) title/description 길이 초과 개수

---

## 6) Tracking Step 1 (Lite MVP) — 핵심 스펙

### 6.1 수집 목표(최소)
- Session(유니크 방문자 근사)
- Page View(페이지별 조회)
- Referrer(유입경로)
- UTM(캠페인 추적)
- Device type(모바일/데스크톱 정도)

> 체류시간/스크롤/이벤트는 Step 2+에서 확장하되,
> Step 1에서 컬럼만 미리 만들어두는 것은 허용(마이그레이션 최소화 목적).

### 6.2 반드시 반영할 3가지(추가 의견 반영)
1) Bot filtering:
   - `/api/track`에서 User-Agent 검사.
   - Googlebot/Bingbot/Slurp/DuckDuckBot/YandexBot/Baiduspider/facebookexternalhit/Twitterbot 등 유명 봇 패턴은 DB insert 하지 않고 204 응답.
   - 완벽할 필요는 없지만 “대시보드 데이터가 봇으로 오염되는 것”은 반드시 막는다.

2) Retention:
   - 트래킹 raw 테이블은 90일(기본) 보관 후 삭제 가능해야 한다.
   - created_at index를 반드시 생성한다.
   - 삭제 SQL/정책을 문서화한다(스케줄링은 나중에).

3) Vercel 비용/성능 방어:
   - Next.js 14이므로 after() 기반 서버 후처리 대신,
   - 클라이언트에서 `navigator.sendBeacon` 또는 `fetch(..., { keepalive: true })`로 fire-and-forget 전송.
   - UI 렌더링/라우팅을 절대 블로킹하지 않는다.

### 6.3 수집 제외(개인정보/리스크 최소화)
- IP 주소 raw 저장: 하지 않음(v1)
- 사용자 식별 정보(email 등): 하지 않음(v1)
- 정확한 지리 정보: 하지 않음(v1)

---

## 7) DB 스키마 (Step 1)

### 7.1 uslab_sessions
- 목적: 방문자(세션) 단위 집계, referrer/utm/device 단위 집계를 가능하게 한다.

```sql
-- supabase/migrations/XXXXXXXXXX_create_uslab_tracking_tables.sql

create table if not exists uslab_sessions (
  id uuid primary key default gen_random_uuid(),

  -- 클라이언트 쿠키 기반 세션 키(유니크)
  session_key text not null unique,

  -- entry(첫 유입) 정보
  landing_path text,
  referrer text,
  referrer_host text,

  -- 캠페인(UTM)
  utm_source text,
  utm_medium text,
  utm_campaign text,
  utm_term text,
  utm_content text,

  -- 디바이스/환경
  user_agent text,
  device_type text, -- 'mobile' | 'desktop' | 'tablet' | 'bot' | 'unknown'

  -- 운영 편의
  created_at timestamptz not null default now(),
  last_seen_at timestamptz not null default now()
);

create index if not exists uslab_idx_sessions_created_at on uslab_sessions (created_at desc);
create index if not exists uslab_idx_sessions_last_seen_at on uslab_sessions (last_seen_at desc);
create index if not exists uslab_idx_sessions_referrer_host on uslab_sessions (referrer_host);
create index if not exists uslab_idx_sessions_utm_campaign on uslab_sessions (utm_campaign);

alter table uslab_sessions enable row level security;

-- RLS: Admin(authenticated)만 조회 가능 (원하면 anon은 아예 불가)
create policy if not exists uslab_policy_sessions_select_authenticated
  on uslab_sessions
  for select
  using (auth.role() = 'authenticated');
````

### 7.2 uslab_page_views

* 목적: 페이지뷰 집계, top page/post, 기간별 추이, unique 세션 집계를 가능하게 한다.

```sql
create table if not exists uslab_page_views (
  id uuid primary key default gen_random_uuid(),
  session_id uuid not null references uslab_sessions(id) on delete cascade,

  -- 콘텐츠 매핑(가능하면 저장; 없으면 null)
  post_id uuid references uslab_posts(id) on delete set null,

  -- 페이지 경로(필수)
  page_path text not null,

  -- 언어(선택: /ko, /en 파싱 또는 클라 전달)
  locale text check (locale in ('ko', 'en')),

  -- 확장 컬럼(지금은 null 허용)
  view_duration integer,  -- seconds
  scroll_depth integer,   -- 0-100

  created_at timestamptz not null default now()
);

create index if not exists uslab_idx_page_views_created_at on uslab_page_views (created_at desc);
create index if not exists uslab_idx_page_views_page_path_created_at on uslab_page_views (page_path, created_at desc);
create index if not exists uslab_idx_page_views_post_id_created_at on uslab_page_views (post_id, created_at desc);
create index if not exists uslab_idx_page_views_session_id_created_at on uslab_page_views (session_id, created_at desc);

alter table uslab_page_views enable row level security;

create policy if not exists uslab_policy_page_views_select_authenticated
  on uslab_page_views
  for select
  using (auth.role() = 'authenticated');
```

> NOTE: insert 정책은 만들지 않는다.
> `/api/track`는 service role로 insert하므로 RLS를 우회한다.
> 클라이언트(anon/authenticated)가 직접 insert 하게 열어두지 않는다.

---

## 8) Retention(데이터 청소) 정책

### 8.1 기본 정책

* raw 트래킹 데이터(uslab_page_views)는 “기본 90일 보관” 후 삭제 가능
* uslab_sessions는 page_views의 FK cascade로 함께 일부 정리되지만,
  “세션이 남아있고 page_views가 삭제되면 orphan이 될 수 있음” → 정리 쿼리 제공

### 8.2 삭제 SQL(운영용)

```sql
-- 90일 지난 page_views 삭제
delete from uslab_page_views
where created_at < now() - interval '90 days';

-- orphan sessions 삭제(선택)
delete from uslab_sessions s
where s.created_at < now() - interval '90 days'
  and not exists (select 1 from uslab_page_views pv where pv.session_id = s.id);
```

> 스케줄링은 Step 2에서:
>
> * Supabase cron/pg_cron 사용 가능 여부 확인 후 주 1회 실행 또는
> * Vercel Cron → /api/admin/retention 호출 방식으로 구현(인증 필요)

---

## 9) Bot Filtering (서버 필터)

### 9.1 필터 규칙

* `/api/track` 진입 시 `User-Agent`를 검사한다.
* 아래 패턴 포함 시 insert 하지 않고 204 반환:

  * Googlebot, Bingbot, Slurp, DuckDuckBot, YandexBot, Baiduspider,
    facebookexternalhit, Twitterbot, Slackbot, LinkedInBot, TelegramBot,
    WhatsApp, Discordbot, Applebot

### 9.2 한계

* UA 위조는 100% 막을 수 없다.
* 하지만 “대부분의 봇 유입”을 걸러서 대시보드 오염을 크게 줄이는 것이 목표.

---

## 10) API: /api/track (Step 1 핵심)

### 10.1 Endpoint

* POST /api/track
* Auth: 불필요(공개) BUT

  * bot filtering 적용
  * payload validation + 길이 제한 적용
  * service role insert

### 10.2 Request payload (JSON)

```json
{
  "session_key": "string (cookie/localStorage 기반)",
  "page_path": "/ko/blog/ai-agent",
  "post_id": "uuid | null",
  "locale": "ko | en | null",
  "referrer": "https://www.google.com/...",
  "utm": {
    "source": "google",
    "medium": "cpc",
    "campaign": "brand",
    "term": "",
    "content": ""
  }
}
```

### 10.3 Response

* 204 No Content (기본)
* 에러여도 204로 처리(클라 UX 방해 방지) + 서버 로그만 남긴다.

### 10.4 서버 처리 로직(의사코드)

1. UA 읽기 → 봇이면 return 204
2. body parse + zod validation

   * session_key/page_path 필수
   * 길이 제한: session_key 128, page_path 2048, referrer 2048, ua 1024 등
3. referrer_host 파싱(URL 파싱 실패하면 null)
4. device_type 파싱(간단 UA 기반: mobile/tablet/desktop)
5. sessions upsert:

   * unique(session_key) 기준
   * 새 세션이면 created_at=now, last_seen_at=now, landing_path/referrer/utm/user_agent/device_type 저장
   * 기존이면 last_seen_at=now만 업데이트 (landing/referrer/utm은 최초값 유지)
6. page_views insert:

   * session_id FK, page_path, post_id, locale, created_at

---

## 11) Client Tracking 컴포넌트 (sendBeacon)

### 11.1 동작 지점

* Public 영역에서만 동작:

  * /admin, /api, /_next 등은 제외
* 라우팅 변화(Next.js App Router)마다 pageview 전송

  * usePathname + useSearchParams 기반 감지

### 11.2 세션키 생성 규칙(MVP)

* session_key 생성: `crypto.randomUUID()` (브라우저 지원)
* 저장 위치:

  * localStorage: uslab_sid, uslab_sid_last(활동시각)
  * cookie: uslab_sid (optional)
* 만료 규칙:

  * last_seen 기준 30분 이상이면 새 session_key 발급
  * 매 track 호출 시 last_seen 갱신

### 11.3 전송 방식

* 우선: `navigator.sendBeacon('/api/track', blob)`
* fallback: `fetch('/api/track', { method:'POST', body: JSON.stringify(...), keepalive: true })`
* 절대 await 하지 않는다(UX/성능 방어)

### 11.4 referrer/utm

* referrer: document.referrer
* utm: window.location.search에서 파싱(utm_source 등)
* page_path: pathname + search(optional: search는 캠페인 분석에 유용하나, 쿼리 폭증이 싫으면 pathname만 저장)

  * 권장: page_path는 pathname만, utm은 별도 컬럼으로 저장

---

## 12) Analytics 쿼리 (Dashboard/Analytics 페이지에서 사용)

### 12.1 “오늘” 기준 계산(Asia/Seoul)

* DB에선 created_at timestamptz.
* SQL 예시:

```sql
-- 오늘 00:00 (KST) 기준
with bounds as (
  select
    (date_trunc('day', now() at time zone 'Asia/Seoul') at time zone 'Asia/Seoul') as start_ts,
    ((date_trunc('day', now() at time zone 'Asia/Seoul') + interval '1 day') at time zone 'Asia/Seoul') as end_ts
)
select
  (select count(*) from uslab_page_views pv, bounds b where pv.created_at >= b.start_ts and pv.created_at < b.end_ts) as pageviews_today,
  (select count(distinct pv.session_id) from uslab_page_views pv, bounds b where pv.created_at >= b.start_ts and pv.created_at < b.end_ts) as uniques_today;
```

### 12.2 최근 30일 일별 pageviews

```sql
select
  date_trunc('day', created_at at time zone 'Asia/Seoul') as day,
  count(*) as pageviews,
  count(distinct session_id) as uniques
from uslab_page_views
where created_at >= now() - interval '30 days'
group by 1
order by 1 asc;
```

### 12.3 Top pages / referrers

```sql
-- Top pages (30d)
select page_path, count(*) as pageviews, count(distinct session_id) as uniques
from uslab_page_views
where created_at >= now() - interval '30 days'
group by 1
order by pageviews desc
limit 20;

-- Top referrers (30d) : entry 기준
select coalesce(referrer_host, '(direct)') as referrer_host, count(*) as sessions
from uslab_sessions
where created_at >= now() - interval '30 days'
group by 1
order by sessions desc
limit 20;
```

---

## 13) SEO: 기술적 SEO (우선 구현)

### 13.1 반드시 구현(최우선)

* app/sitemap.ts

  * 발행된 포스트 전체 + 언어별 URL 포함
  * lastmod 포함
* app/robots.ts

  * Sitemap 위치 명시
  * /admin/*, /api/* 크롤링 차단
* Canonical URL 명시

  * 다국어 페이지는 “자기 자신 canonical” 기본
  * hreflang으로 서로 alternates 연결
* JSON-LD

  * Organization (site-wide)
  * Article (blog post)
  * BreadcrumbList (blog detail)

### 13.2 Admin SEO 운영도구

* Post 편집 화면에 SEO 패널:

  * seo_title/seo_description/seo_keywords 편집
  * 글자수 카운터(60/160 권장)
  * “AI로 재생성” 버튼(/api/ai/seo)
  * OG 미리보기(썸네일 기반)
* /admin/seo/audit:

  * SEO 누락/과다 길이/OG 이미지 없음/번역 짝 없음 등 점검 리스트 제공

---

## 14) Admin: Comments / Inquiries 관리 UI

### 14.1 /admin/comments

* 리스트: post, author_name, created_at, is_approved
* 액션: 승인 토글(is_approved), 삭제
* 필터: post_id, 날짜

### 14.2 /admin/inquiries

* 리스트: name, email, status, created_at
* 디테일: message 전문
* 액션: status 변경(pending/contacted/completed), 내부 메모(추가 컬럼 필요 시 추후)

---

## 15) 파일/코드 구조(추가될 것)

### 15.1 API

* app/api/track/route.ts (신규)

### 15.2 Lib

* lib/queries/analytics.ts (신규: dashboard 집계 쿼리)
* lib/utils/tracking.ts (신규: session_key, utm 파서, bot regex)
* lib/supabase/server.ts (이미 있으면 재사용: service role client 생성 유틸)

### 15.3 Admin Pages

* app/admin/dashboard/page.tsx
* app/admin/analytics/page.tsx
* app/admin/seo/page.tsx (+ audit)
* app/admin/comments/page.tsx
* app/admin/inquiries/page.tsx

### 15.4 Components

* components/admin/dashboard/*

  * StatCard.tsx
  * TrafficChart.tsx
  * TopTable.tsx
  * RecentActivity.tsx
* components/analytics/Tracker.tsx (Public layout에 삽입)

---

## 16) 수용 기준(Acceptance Criteria)

### 16.1 Tracking

* (봇 필터) UA에 “Googlebot” 포함한 요청은 DB row가 증가하지 않는다.
* (세션) 같은 브라우저에서 30분 내 이동은 동일 session_key로 page_views가 쌓인다.
* (성능) 페이지 전환/렌더가 track 호출로 느려지지 않는다(await 금지).
* (보관) 90일 삭제 SQL이 index(created_at)를 타고 빠르게 실행된다.

### 16.2 Dashboard

* Dashboard에서 “오늘 방문자/오늘 페이지뷰/최근 30일 추이”가 정상 표시된다.
* Top pages/referrers가 30일 기준으로 정상 표시된다.
* 최근 활동(문의/댓글/포스트)이 최신순으로 보여진다.

### 16.3 SEO

* sitemap/robots가 빌드 후 접근 가능하다.
* 포스트 상세에 JSON-LD(Article)가 포함된다.
* canonical이 중복 없이 설정된다.
* SEO Audit에서 누락 항목이 정확히 집계된다.

---

## 17) 단계별 구현 순서(권장)

Step 1) DB: tracking 테이블 마이그레이션 + 인덱스 + RLS
Step 2) API: /api/track (봇 필터 + upsert session + insert pageview)
Step 3) Client: Tracker 컴포넌트(sendBeacon, session_key, utm/referrer)
Step 4) Admin Dashboard: 최소 KPI + 차트 + Top tables (tracking 기반)
Step 5) SEO: sitemap/robots/canonical/JSON-LD
Step 6) SEO Audit + Comments/Inquiries Admin 확장

---

끝.

```

원하시면 위 명세서를 기준으로, **바로 Step 1 구현용 “Supabase 마이그레이션 SQL(실제 파일 형태) + `/api/track` 코드 + Tracker 컴포넌트 코드”까지** Cursor가 그대로 적용할 수 있게 “붙여넣기 단위”로 이어서 출력해드릴게요.
```
