# USLab ì›¹ ì‹œìŠ¤í…œ ì „ì²´ ì´ì‹ ëª…ì„¸ì„œ v1.0

> **ëª©ì **: ë…¸ë¸”sh ê¸°ë°˜ USLab ì›¹ ì‹œìŠ¤í…œì„ ustudio ì›¹í˜ì´ì§€ì— ì´ì‹ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ ì „ì²´ ëª…ì„¸ì„œ  
> **ëŒ€ìƒ**: ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…, í¬íŠ¸í´ë¦¬ì˜¤ ê²Œì‹œíŒ, ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ, SEO ê´€ë¦¬ ì‹œìŠ¤í…œ  
> **ì‘ì„±ì¼**: 2025-01-XX

---

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#1-ì‹œìŠ¤í…œ-ê°œìš”)
2. [ê¸°ìˆ  ìŠ¤íƒ ë° ì•„í‚¤í…ì²˜](#2-ê¸°ìˆ -ìŠ¤íƒ-ë°-ì•„í‚¤í…ì²˜)
3. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#3-ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
4. [ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì‹œìŠ¤í…œ](#4-ë¸”ë¡œê·¸-í¬ìŠ¤íŒ…-ì‹œìŠ¤í…œ)
5. [í¬íŠ¸í´ë¦¬ì˜¤ ê²Œì‹œíŒ ì‹œìŠ¤í…œ](#5-í¬íŠ¸í´ë¦¬ì˜¤-ê²Œì‹œíŒ-ì‹œìŠ¤í…œ)
6. [ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ ì‹œìŠ¤í…œ](#6-ì–´ë“œë¯¼-ëŒ€ì‹œë³´ë“œ-ì‹œìŠ¤í…œ)
7. [SEO ê´€ë¦¬ ì‹œìŠ¤í…œ](#7-seo-ê´€ë¦¬-ì‹œìŠ¤í…œ)
8. [ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬](#8-ì¸ì¦-ë°-ê¶Œí•œ-ê´€ë¦¬)
9. [íŠ¸ë˜í‚¹ ë° ë¶„ì„ ì‹œìŠ¤í…œ](#9-íŠ¸ë˜í‚¹-ë°-ë¶„ì„-ì‹œìŠ¤í…œ)
10. [API ëª…ì„¸](#10-api-ëª…ì„¸)
11. [í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°](#11-í”„ë¡ íŠ¸ì—”ë“œ-ì»´í¬ë„ŒíŠ¸-êµ¬ì¡°)
12. [ì´ì‹ ê°€ì´ë“œ](#12-ì´ì‹-ê°€ì´ë“œ)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 í”„ë¡œì íŠ¸ êµ¬ì¡°

- **í”„ë¡œì íŠ¸ëª…**: USLab ì›¹ ì‹œìŠ¤í…œ
- **ê¸°ë°˜ í”„ë ˆì„ì›Œí¬**: Next.js 16 (App Router)
- **ì—ë””í„°**: Novel.sh (Tiptap ê¸°ë°˜)
- **ë°ì´í„°ë² ì´ìŠ¤**: Supabase (PostgreSQL)
- **ì¸ì¦**: Supabase Auth
- **ë°°í¬**: Vercel (Frontend), Supabase (Backend)

### 1.2 í•µì‹¬ ê¸°ëŠ¥

1. **ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì‹œìŠ¤í…œ**
   - Novel.sh ê¸°ë°˜ ë¦¬ì¹˜ í…ìŠ¤íŠ¸ ì—ë””í„°
   - ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ (ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì ˆ)
   - ë‹¤êµ­ì–´ ì§€ì› (í•œêµ­ì–´/ì˜ì–´)
   - AI ê¸°ë°˜ SEO ë©”íƒ€ë°ì´í„° ìë™ ìƒì„±
   - ë²„ì „ ê´€ë¦¬ ë° íˆìŠ¤í† ë¦¬
   - ëŒ“ê¸€ ì‹œìŠ¤í…œ

2. **í¬íŠ¸í´ë¦¬ì˜¤ ê²Œì‹œíŒ** (í™•ì¥ ê°€ëŠ¥)
   - ë¸”ë¡œê·¸ ì‹œìŠ¤í…œ ê¸°ë°˜ ê²Œì‹œíŒ
   - í”„ë¡œì íŠ¸ ì¼€ì´ìŠ¤ ìŠ¤í„°ë”” ê´€ë¦¬
   - ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬

3. **ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ**
   - í†µí•© ëŒ€ì‹œë³´ë“œ (KPI, í†µê³„, ì°¨íŠ¸)
   - ì½˜í…ì¸  ê´€ë¦¬ (í¬ìŠ¤íŠ¸, ëŒ“ê¸€, ë¬¸ì˜)
   - íŠ¸ë˜í”½ ë¶„ì„
   - SEO ê°ì‚¬ ë„êµ¬

4. **SEO ê´€ë¦¬ ì‹œìŠ¤í…œ**
   - ìë™ sitemap.xml ìƒì„±
   - robots.txt ê´€ë¦¬
   - JSON-LD êµ¬ì¡°í™” ë°ì´í„°
   - Canonical URL ë° hreflang íƒœê·¸

---

## 2. ê¸°ìˆ  ìŠ¤íƒ ë° ì•„í‚¤í…ì²˜

### 2.1 ê¸°ìˆ  ìŠ¤íƒ

#### í”„ë¡ íŠ¸ì—”ë“œ
- **í”„ë ˆì„ì›Œí¬**: Next.js 16 (App Router)
- **ì–¸ì–´**: TypeScript
- **UI ë¼ì´ë¸ŒëŸ¬ë¦¬**: 
  - Tailwind CSS
  - Lucide React (ì•„ì´ì½˜)
  - Recharts (ì°¨íŠ¸)
- **ì—ë””í„°**: 
  - Novel.sh (`novel` íŒ¨í‚¤ì§€)
  - Tiptap Core (`@tiptap/core`, `@tiptap/react`)
  - Tiptap Extensions (starter-kit, markdown, html, image, link, youtube ë“±)

#### ë°±ì—”ë“œ
- **ë°ì´í„°ë² ì´ìŠ¤**: Supabase (PostgreSQL)
- **ì¸ì¦**: Supabase Auth
- **ìŠ¤í† ë¦¬ì§€**: Supabase Storage
- **API**: Next.js API Routes

#### AI ê¸°ëŠ¥
- **AI SDK**: Vercel AI SDK (`ai` íŒ¨í‚¤ì§€)
- **ëª¨ë¸**: Google Gemini 2.0 Flash (`@ai-sdk/google`)
- **ê¸°ëŠ¥**: 
  - AI ì´ì–´ì“°ê¸°
  - AI êµì •
  - SEO ë©”íƒ€ë°ì´í„° ìë™ ìƒì„±
  - AI Slug ìƒì„±

### 2.2 ì•„í‚¤í…ì²˜ íŒ¨í„´

#### 3-Tier Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Layer   â”‚  Next.js Frontend (React Components)
â”‚  (UI/UX)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application     â”‚  Next.js API Routes
â”‚ Layer           â”‚  (Business Logic)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Layer     â”‚  Supabase (PostgreSQL + Storage)
â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ë‹¤ì¤‘ í”„ë¡œì íŠ¸ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ì „ëµ
- **Prefix ê¸°ë°˜ ë¶„ë¦¬**: `uslab_`, `ustudio_`, `modu_` ë“±
- **ê°™ì€ Supabase í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ì™„ì „ ë¶„ë¦¬**
- **í…Œì´ë¸”, í•¨ìˆ˜, íŠ¸ë¦¬ê±°, RLS ì •ì±… ëª¨ë‘ prefix ì‚¬ìš©**

### 2.3 íŒŒì¼ êµ¬ì¡°

```
uslab-web/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ [lang]/                   # ë‹¤êµ­ì–´ ë¼ìš°íŒ… (ko, en)
â”‚   â”‚   â”œâ”€â”€ blog/                 # ë¸”ë¡œê·¸ í˜ì´ì§€
â”‚   â”‚   â”‚   â”œâ”€â”€ [slug]/           # í¬ìŠ¤íŠ¸ ìƒì„¸
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # ë¸”ë¡œê·¸ ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ about/                # ì†Œê°œ í˜ì´ì§€
â”‚   â”‚   â””â”€â”€ page.tsx              # í™ˆí˜ì´ì§€
â”‚   â”œâ”€â”€ admin/                    # ê´€ë¦¬ì í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ dashboard/            # ëŒ€ì‹œë³´ë“œ
â”‚   â”‚   â”œâ”€â”€ posts/                # í¬ìŠ¤íŠ¸ ê´€ë¦¬
â”‚   â”‚   â”‚   â”œâ”€â”€ write/            # í¬ìŠ¤íŠ¸ ì‘ì„±
â”‚   â”‚   â”‚   â””â”€â”€ [id]/             # í¬ìŠ¤íŠ¸ ìˆ˜ì •
â”‚   â”‚   â”œâ”€â”€ about/                # ì†Œê°œ í˜ì´ì§€ ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ login/                # ë¡œê·¸ì¸
â”‚   â”œâ”€â”€ api/                      # API Routes
â”‚   â”‚   â”œâ”€â”€ posts/                # í¬ìŠ¤íŠ¸ API
â”‚   â”‚   â”œâ”€â”€ admin/                # ê´€ë¦¬ì API
â”‚   â”‚   â”œâ”€â”€ ai/                   # AI ê¸°ëŠ¥ API
â”‚   â”‚   â”œâ”€â”€ comments/             # ëŒ“ê¸€ API
â”‚   â”‚   â”œâ”€â”€ track/                # íŠ¸ë˜í‚¹ API
â”‚   â”‚   â””â”€â”€ upload/               # íŒŒì¼ ì—…ë¡œë“œ API
â”‚   â”œâ”€â”€ sitemap.ts                # Sitemap ìƒì„±
â”‚   â””â”€â”€ robots.ts                 # Robots.txt ìƒì„±
â”œâ”€â”€ components/                   # React ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ blog/                     # ë¸”ë¡œê·¸ ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ admin/                    # ê´€ë¦¬ì ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ editor/                   # ì—ë””í„° ì»´í¬ë„ŒíŠ¸
â”‚   â””â”€â”€ sections/                 # ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸
â”œâ”€â”€ lib/                          # ìœ í‹¸ë¦¬í‹° ë° í—¬í¼
â”‚   â”œâ”€â”€ hooks/                    # React Hooks
â”‚   â”œâ”€â”€ queries/                  # ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬
â”‚   â”œâ”€â”€ supabase/                 # Supabase í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ types/                    # TypeScript íƒ€ì…
â”‚   â”œâ”€â”€ utils/                    # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚   â””â”€â”€ i18n/                     # ë‹¤êµ­ì–´ ì§€ì›
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/               # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
â””â”€â”€ public/                       # ì •ì  íŒŒì¼
```

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 3.1 ë¸”ë¡œê·¸ ì‹œìŠ¤í…œ í…Œì´ë¸”

#### `uslab_posts` (ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸)

```sql
CREATE TABLE uslab_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT NOT NULL,                    -- URL ê²½ë¡œ
  title TEXT NOT NULL,                   -- ì œëª©
  content JSONB NOT NULL,                -- Tiptap JSON ì½˜í…ì¸ 
  thumbnail_url TEXT,                    -- ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL
  
  -- ë‹¤êµ­ì–´ ì§€ì›
  locale TEXT DEFAULT 'ko' CHECK (locale IN ('ko', 'en')),
  canonical_id UUID REFERENCES uslab_posts(id),  -- ì–¸ì–´ë³„ ì—°ê²°
  
  -- SEO ë©”íƒ€ë°ì´í„°
  seo_title TEXT,                        -- SEO ì œëª©
  seo_description TEXT,                   -- SEO ì„¤ëª…
  seo_keywords TEXT[],                    -- SEO í‚¤ì›Œë“œ ë°°ì—´
  
  -- ìƒíƒœ ê´€ë¦¬
  is_published BOOLEAN DEFAULT false,
  published_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,          -- ì¡°íšŒìˆ˜
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  author_id UUID REFERENCES auth.users(id)
);

-- ì¸ë±ìŠ¤
CREATE UNIQUE INDEX uslab_idx_posts_locale_slug 
  ON uslab_posts(locale, slug);
CREATE INDEX uslab_idx_posts_published 
  ON uslab_posts(is_published, published_at DESC);
CREATE INDEX uslab_idx_posts_canonical 
  ON uslab_posts(canonical_id);
```

#### `uslab_post_versions` (ë²„ì „ ê´€ë¦¬)

```sql
CREATE TABLE uslab_post_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID REFERENCES uslab_posts(id) ON DELETE CASCADE,
  content JSONB NOT NULL,                -- ì½˜í…ì¸  ìŠ¤ëƒ…ìƒ·
  change_log TEXT,                       -- ë³€ê²½ ì‚¬ìœ 
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX uslab_idx_post_versions_post_id 
  ON uslab_post_versions(post_id, created_at DESC);
```

#### `uslab_comments` (ëŒ“ê¸€)

```sql
CREATE TABLE uslab_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID REFERENCES uslab_posts(id) ON DELETE CASCADE,
  author_name TEXT NOT NULL,
  password_hash TEXT NOT NULL,           -- bcrypt í•´ì‹œ
  content TEXT NOT NULL,
  is_approved BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX uslab_idx_comments_post_id 
  ON uslab_comments(post_id, created_at DESC);
```

### 3.2 íŠ¸ë˜í‚¹ ì‹œìŠ¤í…œ í…Œì´ë¸”

#### `uslab_sessions` (ì„¸ì…˜)

```sql
CREATE TABLE uslab_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_key TEXT NOT NULL UNIQUE,      -- í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ í‚¤
  landing_path TEXT,                      -- ì²« ìœ ì… ê²½ë¡œ
  referrer TEXT,                         -- ë¦¬í¼ëŸ¬ URL
  referrer_host TEXT,                    -- ë¦¬í¼ëŸ¬ í˜¸ìŠ¤íŠ¸
  utm_source TEXT,                       -- UTM ì†ŒìŠ¤
  utm_medium TEXT,                       -- UTM ë¯¸ë””ì—„
  utm_campaign TEXT,                     -- UTM ìº í˜ì¸
  utm_term TEXT,                         -- UTM í„°ë¯¸ë„
  utm_content TEXT,                      -- UTM ì½˜í…ì¸ 
  user_agent TEXT,                       -- User Agent
  device_type TEXT CHECK (device_type IN ('mobile', 'tablet', 'desktop', 'bot', 'unknown')),
  created_at TIMESTAMPTZ DEFAULT now(),
  last_seen_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX uslab_idx_sessions_created_at 
  ON uslab_sessions(created_at DESC);
CREATE INDEX uslab_idx_sessions_referrer_host 
  ON uslab_sessions(referrer_host);
```

#### `uslab_page_views` (í˜ì´ì§€ë·°)

```sql
CREATE TABLE uslab_page_views (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES uslab_sessions(id) ON DELETE CASCADE,
  post_id UUID REFERENCES uslab_posts(id) ON DELETE SET NULL,
  about_id UUID REFERENCES uslab_about(id) ON DELETE SET NULL,
  page_path TEXT NOT NULL,               -- í˜ì´ì§€ ê²½ë¡œ
  locale TEXT CHECK (locale IN ('ko', 'en')),
  view_duration INTEGER,                 -- ì²´ë¥˜ ì‹œê°„ (ì´ˆ)
  scroll_depth INTEGER,                  -- ìŠ¤í¬ë¡¤ ê¹Šì´ (0-100)
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX uslab_idx_page_views_created_at 
  ON uslab_page_views(created_at DESC);
CREATE INDEX uslab_idx_page_views_post_id 
  ON uslab_page_views(post_id, created_at DESC);
```

### 3.3 RLS (Row Level Security) ì •ì±…

#### ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ RLS

```sql
-- ê³µê°œ ì½ê¸° (ë°œí–‰ëœ í¬ìŠ¤íŠ¸ë§Œ)
CREATE POLICY uslab_policy_posts_select_public
  ON uslab_posts FOR SELECT
  USING (is_published = true);

-- ì¸ì¦ëœ ì‚¬ìš©ì ì½ê¸° (ëª¨ë“  í¬ìŠ¤íŠ¸, ì´ˆì•ˆ í¬í•¨)
CREATE POLICY uslab_policy_posts_select_authenticated
  ON uslab_posts FOR SELECT
  TO authenticated
  USING (true);

-- ì¸ì¦ëœ ì‚¬ìš©ì ì“°ê¸°
CREATE POLICY uslab_policy_posts_insert_authenticated
  ON uslab_posts FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY uslab_policy_posts_update_authenticated
  ON uslab_posts FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY uslab_policy_posts_delete_authenticated
  ON uslab_posts FOR DELETE
  TO authenticated
  USING (true);
```

#### íŠ¸ë˜í‚¹ RLS

```sql
-- ê´€ë¦¬ìë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY uslab_policy_sessions_select_authenticated
  ON uslab_sessions FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY uslab_policy_page_views_select_authenticated
  ON uslab_page_views FOR SELECT
  TO authenticated
  USING (true);
```

### 3.4 íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜

#### `updated_at` ìë™ ì—…ë°ì´íŠ¸

```sql
CREATE OR REPLACE FUNCTION uslab_update_post_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER uslab_trigger_post_updated_at
  BEFORE UPDATE ON uslab_posts
  FOR EACH ROW
  EXECUTE FUNCTION uslab_update_post_updated_at();
```

#### `canonical_id` ìë™ ì„¤ì •

```sql
CREATE OR REPLACE FUNCTION uslab_set_canonical_id()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.canonical_id IS NULL THEN
    NEW.canonical_id = NEW.id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER uslab_trigger_set_canonical_id
  BEFORE INSERT ON uslab_posts
  FOR EACH ROW
  EXECUTE FUNCTION uslab_set_canonical_id();
```

#### ì¡°íšŒìˆ˜ ì¦ê°€ í•¨ìˆ˜

```sql
CREATE OR REPLACE FUNCTION uslab_increment_view_count(post_uuid UUID)
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  new_count INTEGER;
BEGIN
  UPDATE uslab_posts
  SET view_count = view_count + 1
  WHERE id = post_uuid
    AND is_published = true
  RETURNING view_count INTO new_count;
  
  RETURN COALESCE(new_count, 0);
END;
$$;
```

#### íŠ¸ë˜í‚¹ ë°ì´í„° ì •ë¦¬ í•¨ìˆ˜ (90ì¼ Retention)

```sql
CREATE OR REPLACE FUNCTION uslab_cleanup_old_tracking()
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  deleted_pageviews INTEGER;
  deleted_sessions INTEGER;
BEGIN
  -- 90ì¼ ì§€ë‚œ page_views ì‚­ì œ
  DELETE FROM uslab_page_views
  WHERE created_at < now() - INTERVAL '90 days';
  
  GET DIAGNOSTICS deleted_pageviews = ROW_COUNT;
  
  -- orphan sessions ì‚­ì œ
  DELETE FROM uslab_sessions s
  WHERE s.created_at < now() - INTERVAL '90 days'
    AND NOT EXISTS (
      SELECT 1 FROM uslab_page_views pv 
      WHERE pv.session_id = s.id
    );
  
  GET DIAGNOSTICS deleted_sessions = ROW_COUNT;
  
  RETURN deleted_pageviews + deleted_sessions;
END;
$$;
```

---

## 4. ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì‹œìŠ¤í…œ

### 4.1 ì—ë””í„° í†µí•© (Novel.sh)

#### ì—ë””í„° ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```typescript
// components/editor/BlogEditor.tsx
import { EditorRoot, EditorContent } from 'novel';
import { extensions } from './extensions';

export default function BlogEditor({
  content,
  onChange,
}: {
  content: JSONContent | null;
  onChange: (content: JSONContent) => void;
}) {
  return (
    <EditorRoot>
      <EditorContent
        extensions={extensions}
        content={content}
        onUpdate={({ editor }) => {
          onChange(editor.getJSON());
        }}
      />
    </EditorRoot>
  );
}
```

#### Tiptap Extensions ì„¤ì •

```typescript
// components/editor/extensions.tsx
import StarterKit from '@tiptap/starter-kit';
import Image from '@tiptap/extension-image';
import Link from '@tiptap/extension-link';
import YouTube from '@tiptap/extension-youtube';
import TaskList from '@tiptap/extension-task-list';
import TaskItem from '@tiptap/extension-task-item';
import { ImageResizeExtension } from './extensions/ImageResizeExtension';

export const extensions = [
  StarterKit.configure({
    heading: {
      levels: [1, 2, 3],
    },
  }),
  Image.configure({
    inline: true,
    allowBase64: true,
  }),
  Link.configure({
    openOnClick: false,
    HTMLAttributes: {
      class: 'text-cyan-400 hover:text-cyan-300 underline',
    },
  }),
  YouTube,
  TaskList,
  TaskItem,
  ImageResizeExtension, // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
];
```

#### ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥

**ê°œìš”:**
- ì—ë””í„°ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë©´ ìš°ì¸¡ í•˜ë‹¨ì— ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤.
- í•¸ë“¤ì„ ë“œë˜ê·¸í•˜ì—¬ ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- Shift í‚¤ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ë©´ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©° í¬ê¸° ì¡°ì ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- í¬ê¸° ì¡°ì ˆ í›„ ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ ë…¸ë“œì˜ `width`, `height` ì†ì„±ì— ì €ì¥ë©ë‹ˆë‹¤.

**êµ¬í˜„ êµ¬ì¡°:**

1. **ImageResizeExtension** (Tiptap Extension ë˜í¼)
```typescript
// components/editor/extensions/ImageResizeExtension.ts
'use client';

import { Extension } from '@tiptap/core';
import { createImageResizePlugin } from '../ImageResizePlugin';

export const ImageResizeExtension = Extension.create({
  name: 'imageResizeExtension',
  addProseMirrorPlugins() {
    return [createImageResizePlugin()];
  },
});
```

2. **ImageResizePlugin** (ProseMirror Plugin)
```typescript
// components/editor/ImageResizePlugin.tsx
'use client';

import { Plugin, PluginKey, NodeSelection } from '@tiptap/pm/state';
import type { EditorView } from '@tiptap/pm/view';
import type { Node as ProseMirrorNode } from '@tiptap/pm/model';

const key = new PluginKey('uslab-image-resize');
const MIN = 50;
const MAX = 1200;
const HANDLE_SIZE = 16;

export function createImageResizePlugin() {
  return new Plugin({
    key,
    view(view) {
      const container = view.dom.parentElement;
      if (!container) return {};

      // ì˜¤ë²„ë ˆì´ìš© positioning context í™•ë³´
      if (getComputedStyle(container).position === 'static') {
        container.style.position = 'relative';
      }

      // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìƒì„± (ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë¶™ì„)
      const handle = document.createElement('button');
      handle.type = 'button';
      handle.className = 'resize-handle';
      Object.assign(handle.style, {
        position: 'absolute',
        width: `${HANDLE_SIZE}px`,
        height: `${HANDLE_SIZE}px`,
        backgroundColor: '#3b82f6',
        border: '2px solid white',
        borderRadius: '50%',
        cursor: 'se-resize',
        display: 'none',
        zIndex: '1000',
        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
        transition: 'transform 0.1s',
        pointerEvents: 'auto',
      });
      container.appendChild(handle);

      let active: { pos: number; node: ProseMirrorNode; img: HTMLImageElement } | null = null;
      let dragging = false;
      let startX = 0;
      let startY = 0;
      let startW = 0;
      let startH = 0;
      let aspect = 1;

      // í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      const positionHandle = () => {
        if (!active) return;
        const imgRect = active.img.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        const left = imgRect.right - containerRect.left + container.scrollLeft - HANDLE_SIZE / 2;
        const top = imgRect.bottom - containerRect.top + container.scrollTop - HANDLE_SIZE / 2;

        handle.style.left = `${left}px`;
        handle.style.top = `${top}px`;
      };

      // ë“œë˜ê·¸ ì¤‘ í¬ê¸° ì¡°ì ˆ
      const onMouseMove = (e: MouseEvent) => {
        if (!dragging || !active) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let nextW = Math.max(MIN, Math.min(MAX, startW + dx));
        let nextH = Math.max(MIN, Math.min(MAX, startH + dy));

        // Shift í‚¤: ë¹„ìœ¨ ìœ ì§€
        if (e.shiftKey) {
          nextH = Math.max(MIN, Math.min(MAX, nextW / aspect));
        }

        active.img.style.width = `${Math.round(nextW)}px`;
        active.img.style.height = `${Math.round(nextH)}px`;
        positionHandle();
      };

      // ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ í¬ê¸° ì €ì¥
      const onMouseUp = () => {
        if (!dragging || !active) return;
        dragging = false;

        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);

        const width = parseInt(active.img.style.width, 10) || Math.round(startW);
        const height = parseInt(active.img.style.height, 10) || Math.round(startH);

        const { state } = view;
        const nodeNow = state.doc.nodeAt(active.pos);
        if (!nodeNow) return;

        // ë…¸ë“œ ì†ì„±ì— í¬ê¸° ì €ì¥
        const tr = state.tr.setNodeMarkup(active.pos, undefined, {
          ...nodeNow.attrs,
          width,
          height,
        });
        view.dispatch(tr);
      };

      // ë“œë˜ê·¸ ì‹œì‘
      const onMouseDown = (e: MouseEvent) => {
        if (!active) return;
        e.preventDefault();
        e.stopPropagation();

        dragging = true;
        startX = e.clientX;
        startY = e.clientY;

        const rect = active.img.getBoundingClientRect();
        startW = rect.width;
        startH = rect.height;
        aspect = startW / (startH || 1);

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
      };

      handle.addEventListener('mousedown', onMouseDown);

      // ì„ íƒëœ ì´ë¯¸ì§€ ê°ì§€
      const getSelectedImage = (view: EditorView) => {
        const sel = view.state.selection;
        if (!(sel instanceof NodeSelection)) return null;
        
        const node = sel.node;
        if (!node || node.type.name !== 'image') return null;

        const pos = sel.from;
        const dom = view.nodeDOM(pos) as HTMLElement;
        const img = dom instanceof HTMLImageElement ? dom : dom.querySelector('img');
        
        if (!img) return null;
        return { pos, node, img };
      };

      return {
        update(view) {
          const next = getSelectedImage(view);
          if (!next) {
            if (active) {
              active = null;
              handle.style.display = 'none';
            }
            return;
          }

          if (!active || active.pos !== next.pos) {
            active = next;
            handle.style.display = 'block';
            positionHandle();
          } else {
            positionHandle();
          }
        },
        destroy() {
          handle.removeEventListener('mousedown', onMouseDown);
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
          handle.remove();
        },
      };
    },
  });
}
```

3. **CSS ìŠ¤íƒ€ì¼**

```css
/* app/globals.css */

/* ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
.resize-handle {
  position: absolute;
  width: 16px;
  height: 16px;
  background-color: #3b82f6;
  border: 2px solid white;
  border-radius: 50%;
  cursor: se-resize;
  z-index: 1000;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: transform 0.1s;
  pointer-events: auto;
}

.resize-handle:hover {
  transform: scale(1.2);
  background-color: #2563eb;
}

/* ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
.resizable-image {
  position: relative;
  display: inline-block;
  max-width: 100%;
  cursor: pointer;
}
```

**ì£¼ìš” íŠ¹ì§•:**
- **NodeSelection ê¸°ë°˜**: ì´ë¯¸ì§€ê°€ ì„ íƒë˜ë©´ ìë™ìœ¼ë¡œ í•¸ë“¤ í‘œì‹œ
- **ì˜¤ë²„ë ˆì´ ë°©ì‹**: ProseMirror ë‚´ë¶€ê°€ ì•„ë‹Œ ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— í•¸ë“¤ ë°°ì¹˜ (ì•ˆì •ì„± í–¥ìƒ)
- **ë¹„ìœ¨ ìœ ì§€**: Shift í‚¤ë¡œ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©° í¬ê¸° ì¡°ì ˆ
- **í¬ê¸° ì œí•œ**: ìµœì†Œ 50px, ìµœëŒ€ 1200px
- **ìë™ ì €ì¥**: ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ì´ë¯¸ì§€ ë…¸ë“œ ì†ì„±ì— ìë™ ì €ì¥

**ì‚¬ìš© ë°©ë²•:**
1. ì—ë””í„°ì—ì„œ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒ
2. ìš°ì¸¡ í•˜ë‹¨ì— íŒŒë€ìƒ‰ ì›í˜• í•¸ë“¤ì´ í‘œì‹œë¨
3. í•¸ë“¤ì„ ë“œë˜ê·¸í•˜ì—¬ í¬ê¸° ì¡°ì ˆ
4. Shift í‚¤ë¥¼ ëˆ„ë¥¸ ì±„ ë“œë˜ê·¸í•˜ë©´ ë¹„ìœ¨ ìœ ì§€
5. ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ìë™ìœ¼ë¡œ í¬ê¸°ê°€ ì €ì¥ë¨

**ì´ë¯¸ì§€ í™•ì¥ ì„¤ì • (width/height ì†ì„± ì§€ì›):**

```typescript
// components/editor/BlogEditor.tsx
import { UpdatedImage } from 'novel/extensions';

const imageExtension = useMemo(() => {
  return UpdatedImage.extend({
    addAttributes() {
      return {
        ...this.parent?.(),
        width: {
          default: null,
          parseHTML: (element) => {
            const width = element.getAttribute('width');
            return width ? parseInt(width, 10) : null;
          },
          renderHTML: (attributes) => {
            if (!attributes.width) {
              return {};
            }
            return {
              width: attributes.width,
            };
          },
        },
        height: {
          default: null,
          parseHTML: (element) => {
            const height = element.getAttribute('height');
            return height ? parseInt(height, 10) : null;
          },
          renderHTML: (attributes) => {
            if (!attributes.height) {
              return {};
            }
            return {
              height: attributes.height,
            };
          },
        },
      };
    },
  }).configure({
    allowBase64: false,
    HTMLAttributes: {
      class: 'rounded-lg border border-slate-700 resizable-image',
      style: 'max-width: 100%; height: auto; max-height: 600px; object-fit: contain; cursor: pointer;',
    },
    inline: false,
  });
}, []);
```

**ë¦¬ì‚¬ì´ì¦ˆëœ ì´ë¯¸ì§€ ë Œë”ë§:**

í¬ìŠ¤íŠ¸ ë·°ì–´ì—ì„œë„ ë¦¬ì‚¬ì´ì¦ˆëœ í¬ê¸°ê°€ ìœ ì§€ë˜ë„ë¡ ì´ë¯¸ì§€ ë Œë”ë§ ì‹œ width/height ì†ì„±ì„ ì ìš©í•©ë‹ˆë‹¤:

```typescript
// components/blog/PostViewer.tsx
const html = generateHTML(post.content, extensions);

// ì´ë¯¸ì§€ì— width/height ì†ì„±ì´ ìˆìœ¼ë©´ ìŠ¤íƒ€ì¼ë¡œ ì ìš©
useEffect(() => {
  const images = document.querySelectorAll('.prose img');
  images.forEach((img) => {
    const width = img.getAttribute('width');
    const height = img.getAttribute('height');
    if (width) {
      (img as HTMLImageElement).style.width = `${width}px`;
    }
    if (height) {
      (img as HTMLImageElement).style.height = `${height}px`;
    }
  });
}, [html]);
```

### 4.2 í¬ìŠ¤íŠ¸ ì‘ì„± í”Œë¡œìš°

#### 1. ì‘ì„± í˜ì´ì§€ (`/admin/posts/write`)

**ì£¼ìš” ê¸°ëŠ¥:**
- ì œëª© ì…ë ¥
- Slug ì…ë ¥ (AI ìë™ ìƒì„± ì˜µì…˜)
- ì–¸ì–´ ì„ íƒ (ko/en)
- Novel.sh ì—ë””í„°ë¡œ ì½˜í…ì¸  ì‘ì„±
- ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ
- ì´ˆì•ˆ ì €ì¥ / ë°œí–‰

**ë°œí–‰ ì‹œ ìë™ ì²˜ë¦¬:**
1. SEO ë©”íƒ€ë°ì´í„° ìë™ ìƒì„± (`/api/ai/seo`)
2. ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ (`uslab_post_versions`)
3. `is_published = true`, `published_at` ì„¤ì •

#### 2. AI Slug ìƒì„±

```typescript
// AI Slug ìƒì„± API
POST /api/ai/slug
{
  "title": "AI ì—ì´ì „íŠ¸ ê°œë°œ ê°€ì´ë“œ",
  "locale": "ko"
}

// Response
{
  "slug": "ai-agent-development-guide"
}
```

**í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ:**
```
ì œëª©ì„ ê¸°ë°˜ìœ¼ë¡œ SEO ì¹œí™”ì ì¸ ì˜ë¬¸ slugë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
- ì†Œë¬¸ìë§Œ ì‚¬ìš©
- í•˜ì´í”ˆ(-)ìœ¼ë¡œ ë‹¨ì–´ êµ¬ë¶„
- íŠ¹ìˆ˜ë¬¸ì ì œê±°
- 50ì ì´ë‚´
```

#### 3. SEO ë©”íƒ€ë°ì´í„° ìë™ ìƒì„±

```typescript
// SEO ìƒì„± API
POST /api/ai/seo
{
  "full_content": "<html>...</html>",
  "title": "í¬ìŠ¤íŠ¸ ì œëª©",
  "locale": "ko"
}

// Response
{
  "seo_title": "SEO ìµœì í™”ëœ ì œëª© (60ì ì´ë‚´)",
  "seo_description": "SEO ìµœì í™”ëœ ì„¤ëª… (160ì ì´ë‚´)",
  "seo_keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"]
}
```

**í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ (í•œêµ­ì–´):**
```
ë‹¤ìŒ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì˜ SEO ë©”íƒ€ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”:
- seo_title: 60ì ì´ë‚´, ê²€ìƒ‰ ìµœì í™”ëœ ì œëª©
- seo_description: 160ì ì´ë‚´, ê²€ìƒ‰ ê²°ê³¼ì— í‘œì‹œë  ì„¤ëª…
- seo_keywords: 5-10ê°œì˜ ê´€ë ¨ í‚¤ì›Œë“œ ë°°ì—´

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ:
{
  "seo_title": "...",
  "seo_description": "...",
  "seo_keywords": ["...", "..."]
}
```

### 4.3 í¬ìŠ¤íŠ¸ ìˆ˜ì • ë° ë²„ì „ ê´€ë¦¬

#### ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ ì‹œì 

1. **ë°œí–‰ ì‹œ**: ìë™ ì €ì¥
2. **AI êµì • ì „**: êµì • ì „ ë²„ì „ ì €ì¥
3. **ìˆ˜ë™ ìŠ¤ëƒ…ìƒ·**: ê´€ë¦¬ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥

#### ë²„ì „ íˆìŠ¤í† ë¦¬ ì¡°íšŒ

```typescript
// ë²„ì „ ëª©ë¡ ì¡°íšŒ
GET /api/posts/[id]/versions

// Response
{
  "versions": [
    {
      "id": "uuid",
      "created_at": "2025-01-01T00:00:00Z",
      "change_log": "AI í†¤ì•¤ë§¤ë„ˆ êµì •"
    }
  ]
}

// íŠ¹ì • ë²„ì „ ì¡°íšŒ
GET /api/posts/[id]/versions/[versionId]

// Response
{
  "version": {
    "id": "uuid",
    "content": { /* Tiptap JSON */ },
    "change_log": "...",
    "created_at": "..."
  }
}
```

### 4.4 ë‹¤êµ­ì–´ í¬ìŠ¤íŠ¸ ê´€ë¦¬

#### Canonical ID ê·œì¹™

- **ì›ë¬¸ ìƒì„± ì‹œ**: `canonical_id = id` (self ì°¸ì¡°, íŠ¸ë¦¬ê±°ë¡œ ìë™ ì„¤ì •)
- **ë²ˆì—­ ìƒì„± ì‹œ**: `canonical_id = ì›ë¬¸ id` (ìˆ˜ë™ ì„¤ì •)
- **ê°™ì€ `canonical_id`ë¥¼ ê°€ì§„ í¬ìŠ¤íŠ¸ë“¤ì´ í•˜ë‚˜ì˜ "ê¸€ ê·¸ë£¹"**

#### ë²ˆì—­ ìƒì„± í”Œë¡œìš°

```typescript
// 1. ì›ë¬¸ í¬ìŠ¤íŠ¸ ì¡°íšŒ
const originalPost = await getPostById(originalId);

// 2. ë²ˆì—­ API í˜¸ì¶œ
POST /api/ai/translate-post
{
  "post_id": "original-id",
  "target_locale": "en"
}

// 3. ë²ˆì—­ëœ í¬ìŠ¤íŠ¸ ìƒì„±
const translatedPost = {
  ...originalPost,
  locale: "en",
  canonical_id: originalPost.id,
  title: translatedTitle,
  content: translatedContent,
  seo_title: translatedSeoTitle,
  seo_description: translatedSeoDescription,
};
```

#### hreflang íƒœê·¸ ìƒì„±

```typescript
// ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ì—ì„œ
export async function generateMetadata({ params }: { params: { slug: string } }) {
  const post = await getPostBySlug(locale, slug);
  const alternates = await getPostAlternates(post.canonical_id);
  
  return {
    title: post.seo_title || post.title,
    description: post.seo_description,
    alternates: {
      languages: alternates.reduce((acc, alt) => {
        acc[alt.locale] = `/${alt.locale}/blog/${alt.slug}`;
        return acc;
      }, {}),
    },
  };
}
```

### 4.5 ëŒ“ê¸€ ì‹œìŠ¤í…œ

#### ëŒ“ê¸€ ì‘ì„±

```typescript
// ëŒ“ê¸€ ì‘ì„± API
POST /api/comments
{
  "post_id": "uuid",
  "author_name": "ì‘ì„±ìëª…",
  "password": "ë¹„ë°€ë²ˆí˜¸",
  "content": "ëŒ“ê¸€ ë‚´ìš©"
}

// ë¹„ë°€ë²ˆí˜¸ëŠ” bcryptë¡œ í•´ì‹œí•˜ì—¬ ì €ì¥
const passwordHash = await bcrypt.hash(password, 10);
```

#### ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ

```typescript
// ëŒ“ê¸€ ìˆ˜ì •
PUT /api/comments/[id]
{
  "password": "ë¹„ë°€ë²ˆí˜¸",
  "content": "ìˆ˜ì •ëœ ë‚´ìš©"
}

// ëŒ“ê¸€ ì‚­ì œ
DELETE /api/comments/[id]
{
  "password": "ë¹„ë°€ë²ˆí˜¸"
}

// ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ë¡œì§
const comment = await getCommentById(id);
const isValid = await bcrypt.compare(password, comment.password_hash);
if (!isValid) {
  throw new Error('Invalid password');
}
```

### 4.6 ì¡°íšŒìˆ˜ ì¶”ì 

#### ì¡°íšŒìˆ˜ ì¦ê°€ ë¡œì§

```typescript
// í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸
useEffect(() => {
  if (!hasTracked.current && post.is_published) {
    fetch(`/api/posts/${post.id}/view`, { method: 'POST' });
    hasTracked.current = true;
  }
}, [post.id, post.is_published]);
```

```typescript
// API Route: /api/posts/[id]/view
export async function POST(request: Request, { params }: { params: { id: string } }) {
  const supabase = createServerClient();
  
  const { data, error } = await supabase.rpc('uslab_increment_view_count', {
    post_uuid: params.id,
  });
  
  return NextResponse.json({ view_count: data });
}
```

---

## 5. í¬íŠ¸í´ë¦¬ì˜¤ ê²Œì‹œíŒ ì‹œìŠ¤í…œ

### 5.1 í™•ì¥ ë°©ì•ˆ

í¬íŠ¸í´ë¦¬ì˜¤ ê²Œì‹œíŒì€ ë¸”ë¡œê·¸ ì‹œìŠ¤í…œì„ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.

#### ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¥

```sql
-- ì˜µì…˜ 1: ë¸”ë¡œê·¸ í…Œì´ë¸” ì¬ì‚¬ìš© (ì¹´í…Œê³ ë¦¬ í•„ë“œ ì¶”ê°€)
ALTER TABLE uslab_posts ADD COLUMN category TEXT;
-- 'blog' | 'portfolio' êµ¬ë¶„

-- ì˜µì…˜ 2: ë³„ë„ í¬íŠ¸í´ë¦¬ì˜¤ í…Œì´ë¸” ìƒì„±
CREATE TABLE uslab_portfolio (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT NOT NULL,
  title TEXT NOT NULL,
  content JSONB NOT NULL,              -- Novel.sh ì—ë””í„° ì½˜í…ì¸ 
  thumbnail_url TEXT,
  client_name TEXT,                    -- í´ë¼ì´ì–¸íŠ¸ëª…
  project_type TEXT,                   -- í”„ë¡œì íŠ¸ ìœ í˜•
  technologies TEXT[],                 -- ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ
  project_url TEXT,                    -- í”„ë¡œì íŠ¸ URL
  github_url TEXT,                     -- GitHub URL
  images TEXT[],                       -- ì´ë¯¸ì§€ URL ë°°ì—´
  locale TEXT DEFAULT 'ko' CHECK (locale IN ('ko', 'en')),
  canonical_id UUID REFERENCES uslab_portfolio(id),
  seo_title TEXT,
  seo_description TEXT,
  seo_keywords TEXT[],
  is_published BOOLEAN DEFAULT false,
  published_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  author_id UUID REFERENCES auth.users(id)
);

CREATE UNIQUE INDEX uslab_idx_portfolio_locale_slug 
  ON uslab_portfolio(locale, slug);
```

#### í¬íŠ¸í´ë¦¬ì˜¤ ì „ìš© ì»´í¬ë„ŒíŠ¸

```typescript
// components/portfolio/PortfolioCard.tsx
export default function PortfolioCard({ portfolio }: { portfolio: Portfolio }) {
  return (
    <div className="bg-slate-900 rounded border border-slate-800 overflow-hidden">
      <Image src={portfolio.thumbnail_url} alt={portfolio.title} />
      <div className="p-6">
        <div className="flex justify-between items-center mb-2">
          <span className="text-cyan-400 text-xs font-bold">
            {portfolio.client_name}
          </span>
          <span className="text-slate-600 text-xs">
            {portfolio.project_type}
          </span>
        </div>
        <h3 className="text-lg font-bold text-white mb-2">
          {portfolio.title}
        </h3>
        <div className="flex flex-wrap gap-2 mb-4">
          {portfolio.technologies.map((tech) => (
            <span key={tech} className="text-xs text-slate-400">
              {tech}
            </span>
          ))}
        </div>
        <div className="flex gap-2">
          {portfolio.project_url && (
            <a href={portfolio.project_url} target="_blank">
              í”„ë¡œì íŠ¸ ë³´ê¸°
            </a>
          )}
          {portfolio.github_url && (
            <a href={portfolio.github_url} target="_blank">
              GitHub
            </a>
          )}
        </div>
      </div>
    </div>
  );
}
```

### 5.2 í¬íŠ¸í´ë¦¬ì˜¤ ì‘ì„± í˜ì´ì§€

ë¸”ë¡œê·¸ ì‘ì„± í˜ì´ì§€ì™€ ë™ì¼í•œ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë˜, ì¶”ê°€ í•„ë“œë§Œ ì¶”ê°€:

```typescript
// app/admin/portfolio/write/page.tsx
export default function WritePortfolioPage() {
  const [clientName, setClientName] = useState('');
  const [projectType, setProjectType] = useState('');
  const [technologies, setTechnologies] = useState<string[]>([]);
  const [projectUrl, setProjectUrl] = useState('');
  const [githubUrl, setGithubUrl] = useState('');
  
  // ... ë¸”ë¡œê·¸ì™€ ë™ì¼í•œ ì—ë””í„° ë¡œì§
  
  return (
    <div>
      {/* ë¸”ë¡œê·¸ì™€ ë™ì¼í•œ ì—ë””í„° */}
      <BlogEditor content={content} onChange={setContent} />
      
      {/* í¬íŠ¸í´ë¦¬ì˜¤ ì „ìš© í•„ë“œ */}
      <input
        placeholder="í´ë¼ì´ì–¸íŠ¸ëª…"
        value={clientName}
        onChange={(e) => setClientName(e.target.value)}
      />
      {/* ... ê¸°íƒ€ í•„ë“œ */}
    </div>
  );
}
```

---

## 6. ì–´ë“œë¯¼ ëŒ€ì‹œë³´ë“œ ì‹œìŠ¤í…œ

### 6.1 ëŒ€ì‹œë³´ë“œ êµ¬ì¡°

#### í™”ë©´ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KPI ì¹´ë“œ (4-6ê°œ)                        â”‚
â”‚  [ì´ í¬ìŠ¤íŠ¸] [ë°œí–‰] [ì´ˆì•ˆ] [ì¡°íšŒìˆ˜]      â”‚
â”‚  [ì˜¤ëŠ˜ ë°©ë¬¸ì] [7ì¼/30ì¼ í†µê³„]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  íŠ¸ë˜í”½ ì¶”ì´ ì°¨íŠ¸ (7ì¼/30ì¼ í† ê¸€)        â”‚
â”‚  [Line Chart: ì¼ë³„ í˜ì´ì§€ë·°/ë°©ë¬¸ì]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Top ì½˜í…ì¸  / Top í˜ì´ì§€ / Top Referrer â”‚
â”‚  [í…Œì´ë¸” 3ì—´ ë˜ëŠ” 2í–‰ êµ¬ì„±]              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ìµœê·¼ í™œë™                               â”‚
â”‚  [ìµœê·¼ ë°œí–‰ í¬ìŠ¤íŠ¸] [ìµœê·¼ ëŒ“ê¸€] [ìµœê·¼ ë¬¸ì˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SEO ìƒíƒœ                                â”‚
â”‚  [ê¸°ìˆ ì  SEO ì²´í¬] [ì½˜í…ì¸  SEO í’ˆì§ˆ]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 KPI ì¹´ë“œ ë°ì´í„°

#### API: `/api/admin/dashboard`

```typescript
// Response
{
  "stats": {
    "totalPosts": 100,
    "publishedPosts": 85,
    "draftPosts": 15,
    "totalViews": 50000,
    "todayStats": {
      "pageviews": 500,
      "uniques": 200
    },
    "periodStats": {
      "last7Days": {
        "pageviews": 3000,
        "uniques": 1200
      },
      "last30Days": {
        "pageviews": 15000,
        "uniques": 5000
      }
    }
  },
  "topPages": [...],
  "topPosts": [...],
  "topReferrers": [...],
  "recentActivity": {
    "recentPosts": [...],
    "recentComments": [...],
    "recentInquiries": [...]
  },
  "dailyStats": {
    "last7Days": [...],
    "last30Days": [...]
  },
  "seoStatus": {
    "technicalSeo": {
      "sitemap": true,
      "robots": true,
      "canonical": true,
      "jsonLd": true
    },
    "contentSeo": {
      "missingSeoTitle": 5,
      "missingSeoDescription": 3,
      "longSeoTitle": 2,
      "longSeoDescription": 1
    }
  }
}
```

### 6.3 íŠ¸ë˜í”½ ì¶”ì´ ì°¨íŠ¸

#### ë°ì´í„° êµ¬ì¡°

```typescript
// getDailyStats() ë°˜í™˜ í˜•ì‹
[
  { day: "2025-01-01", pageviews: 100, uniques: 50 },
  { day: "2025-01-02", pageviews: 120, uniques: 60 },
  // ...
]

// Recharts ì»´í¬ë„ŒíŠ¸
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

export default function TrafficChart({ data, days }: { data: DailyStats[], days: 7 | 30 }) {
  return (
    <LineChart width={800} height={400} data={data}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="day" />
      <YAxis />
      <Tooltip />
      <Legend />
      <Line type="monotone" dataKey="pageviews" stroke="#06b6d4" name="í˜ì´ì§€ë·°" />
      <Line type="monotone" dataKey="uniques" stroke="#8b5cf6" name="ë°©ë¬¸ì" />
    </LineChart>
  );
}
```

### 6.4 SEO ìƒíƒœ ë°•ìŠ¤

#### ê¸°ìˆ ì  SEO ì²´í¬

```typescript
// SEO ìƒíƒœ í™•ì¸ ë¡œì§
const seoStatus = {
  technicalSeo: {
    sitemap: await checkSitemapExists(),      // /sitemap.xml ì¡´ì¬ ì—¬ë¶€
    robots: await checkRobotsExists(),         // /robots.txt ì¡´ì¬ ì—¬ë¶€
    canonical: await checkCanonicalTags(),    // canonical íƒœê·¸ ì‚¬ìš© ì—¬ë¶€
    jsonLd: await checkJsonLd(),              // JSON-LD êµ¬ì¡°í™” ë°ì´í„° ì¡´ì¬ ì—¬ë¶€
  },
  contentSeo: {
    missingSeoTitle: await countMissingSeoTitle(),
    missingSeoDescription: await countMissingSeoDescription(),
    longSeoTitle: await countLongSeoTitle(),  // 60ì ì´ˆê³¼
    longSeoDescription: await countLongSeoDescription(), // 160ì ì´ˆê³¼
  },
};
```

---

## 7. SEO ê´€ë¦¬ ì‹œìŠ¤í…œ

### 7.1 Sitemap.xml ìƒì„±

#### êµ¬í˜„: `app/sitemap.ts`

```typescript
import { MetadataRoute } from 'next';
import { createServerClient } from '@/lib/supabase/client';

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://uslab.ai';
  const supabase = createServerClient();

  // ë°œí–‰ëœ í¬ìŠ¤íŠ¸ ì¡°íšŒ
  const { data: posts } = await supabase
    .from('uslab_posts')
    .select('slug, locale, updated_at, published_at')
    .eq('is_published', true)
    .order('published_at', { ascending: false });

  // í¬ìŠ¤íŠ¸ URL ìƒì„±
  const postUrls = (posts || []).map((post) => ({
    url: `${baseUrl}/${post.locale}/blog/${post.slug}`,
    lastModified: post.updated_at || post.published_at || new Date(),
    changeFrequency: 'weekly' as const,
    priority: 0.8,
  }));

  // ì •ì  í˜ì´ì§€ URL
  const staticUrls = [
    {
      url: baseUrl,
      lastModified: new Date(),
      changeFrequency: 'daily',
      priority: 1.0,
    },
    // ... ê¸°íƒ€ ì •ì  í˜ì´ì§€
  ];

  return [...staticUrls, ...postUrls];
}
```

### 7.2 Robots.txt ìƒì„±

#### êµ¬í˜„: `app/robots.ts`

```typescript
import { MetadataRoute } from 'next';

export default function robots(): MetadataRoute.Robots {
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://uslab.ai';

  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: ['/admin/', '/api/'],
      },
    ],
    sitemap: `${baseUrl}/sitemap.xml`,
  };
}
```

### 7.3 Canonical URL ë° hreflang

#### ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€

```typescript
// app/[lang]/blog/[slug]/page.tsx
export async function generateMetadata({ params }: { params: { slug: string, lang: string } }) {
  const post = await getPostBySlug(params.lang as Locale, params.slug);
  const alternates = await getPostAlternates(post.canonical_id);
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://uslab.ai';

  return {
    title: post.seo_title || post.title,
    description: post.seo_description,
    alternates: {
      canonical: `${baseUrl}/${params.lang}/blog/${params.slug}`,
      languages: alternates.reduce((acc, alt) => {
        acc[alt.locale] = `${baseUrl}/${alt.locale}/blog/${alt.slug}`;
        return acc;
      }, {}),
    },
  };
}
```

### 7.4 JSON-LD êµ¬ì¡°í™” ë°ì´í„°

#### Organization (ì‚¬ì´íŠ¸ ì „ì²´)

```typescript
// app/layout.tsx
const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'USLab',
  url: 'https://uslab.ai',
  logo: 'https://uslab.ai/logo.png',
  sameAs: [
    'https://github.com/uslab',
    // ... ê¸°íƒ€ ì†Œì…œ ë¯¸ë””ì–´
  ],
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <head>
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{ __html: JSON.stringify(organizationSchema) }}
        />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

#### Article (ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸)

```typescript
// app/[lang]/blog/[slug]/page.tsx
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.seo_title || post.title,
  description: post.seo_description,
  image: post.thumbnail_url || defaultImage,
  datePublished: post.published_at,
  dateModified: post.updated_at,
  author: {
    '@type': 'Organization',
    name: 'USLab',
  },
  publisher: {
    '@type': 'Organization',
    name: 'USLab',
    logo: {
      '@type': 'ImageObject',
      url: 'https://uslab.ai/logo.png',
    },
  },
};

<script
  type="application/ld+json"
  dangerouslySetInnerHTML={{ __html: JSON.stringify(articleSchema) }}
/>
```

#### BreadcrumbList

```typescript
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: `${baseUrl}/${locale}`,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Blog',
      item: `${baseUrl}/${locale}/blog`,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: post.title,
      item: `${baseUrl}/${locale}/blog/${post.slug}`,
    },
  ],
};
```

---

## 8. ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬

### 8.1 Supabase Auth í†µí•©

#### ì¸ì¦ í›…

```typescript
// lib/hooks/useAuth.ts
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase/client';
import type { User, Session } from '@supabase/supabase-js';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // ì´ˆê¸° ì„¸ì…˜ í™•ì¸
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
      setUser(session?.user ?? null);
      setLoading(false);
    });

    return () => subscription.unsubscribe();
  }, []);

  return {
    user,
    session,
    loading,
    signIn: async (email: string, password: string) => {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });
      if (error) throw error;
      return data;
    },
    signOut: async () => {
      await supabase.auth.signOut();
    },
  };
}
```

### 8.2 ê´€ë¦¬ì í˜ì´ì§€ ë³´í˜¸

#### ë¯¸ë“¤ì›¨ì–´

```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // /admin ê²½ë¡œ ë³´í˜¸
  if (req.nextUrl.pathname.startsWith('/admin')) {
    if (!session) {
      return NextResponse.redirect(new URL('/admin/login', req.url));
    }
  }

  return res;
}

export const config = {
  matcher: ['/admin/:path*'],
};
```

### 8.3 API ì¸ì¦ ê²€ì¦

```typescript
// API Route ì˜ˆì‹œ
export async function POST(request: Request) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const token = authHeader.replace('Bearer ', '');
  const supabase = createServerClient();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  
  if (error || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
  // ...
}
```

---

## 9. íŠ¸ë˜í‚¹ ë° ë¶„ì„ ì‹œìŠ¤í…œ

### 9.1 í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ íŠ¸ë˜í‚¹

#### Tracker ì»´í¬ë„ŒíŠ¸

```typescript
// components/analytics/Tracker.tsx
'use client';

import { useEffect, useRef } from 'react';
import { usePathname } from 'next/navigation';

export default function Tracker() {
  const pathname = usePathname();
  const hasTracked = useRef(false);

  useEffect(() => {
    if (hasTracked.current) return;
    hasTracked.current = true;

    // ì„¸ì…˜ í‚¤ ìƒì„±/ì¡°íšŒ
    let sessionKey = localStorage.getItem('session_key');
    if (!sessionKey) {
      sessionKey = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      localStorage.setItem('session_key', sessionKey);
    }

    // UTM íŒŒë¼ë¯¸í„° íŒŒì‹±
    const urlParams = new URLSearchParams(window.location.search);
    const utm = {
      source: urlParams.get('utm_source'),
      medium: urlParams.get('utm_medium'),
      campaign: urlParams.get('utm_campaign'),
      term: urlParams.get('utm_term'),
      content: urlParams.get('utm_content'),
    };

    // íŠ¸ë˜í‚¹ ë°ì´í„° ì „ì†¡
    const trackingData = {
      session_key: sessionKey,
      page_path: pathname,
      referrer: document.referrer || null,
      utm: Object.values(utm).some(v => v) ? utm : null,
      locale: pathname.startsWith('/en') ? 'en' : 'ko',
    };

    // sendBeacon ì‚¬ìš© (í˜ì´ì§€ ì´íƒˆ ì‹œì—ë„ ì „ì†¡ ë³´ì¥)
    if (navigator.sendBeacon) {
      navigator.sendBeacon(
        '/api/track',
        JSON.stringify(trackingData)
      );
    } else {
      // Fallback: fetch
      fetch('/api/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(trackingData),
        keepalive: true,
      }).catch(() => {}); // ì—ëŸ¬ ë¬´ì‹œ
    }
  }, [pathname]);

  return null;
}
```

### 9.2 ì„œë²„ ì‚¬ì´ë“œ íŠ¸ë˜í‚¹ API

#### Bot í•„í„°ë§

```typescript
// lib/utils/tracking.ts
export function isBot(userAgent: string | null): boolean {
  if (!userAgent) return false;
  
  const botPattern = /bot|crawl|spider|slurp|facebookexternalhit|preview|googlebot|bingbot/i;
  return botPattern.test(userAgent);
}

export function parseDeviceType(userAgent: string | null): 'mobile' | 'tablet' | 'desktop' | 'bot' | 'unknown' {
  if (!userAgent) return 'unknown';
  if (isBot(userAgent)) return 'bot';
  
  const mobilePattern = /Mobile|Android|iPhone|iPad/i;
  const tabletPattern = /iPad|Tablet/i;
  
  if (tabletPattern.test(userAgent)) return 'tablet';
  if (mobilePattern.test(userAgent)) return 'mobile';
  return 'desktop';
}
```

### 9.3 ë¶„ì„ ì¿¼ë¦¬ í•¨ìˆ˜

#### ì¼ë³„ í†µê³„

```typescript
// lib/queries/analytics.ts
export async function getDailyStats(days: number = 30) {
  const supabase = getServerSupabase();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);

  const { data: pageViews } = await supabase
    .from('uslab_page_views')
    .select('created_at, session_id')
    .gte('created_at', startDate.toISOString())
    .order('created_at', { ascending: true });

  // ì¼ë³„ë¡œ ê·¸ë£¹í™”
  const dailyMap = new Map<string, { pageviews: number; sessions: Set<string> }>();

  pageViews?.forEach((pv) => {
    const date = new Date(pv.created_at);
    const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD

    if (!dailyMap.has(dayKey)) {
      dailyMap.set(dayKey, { pageviews: 0, sessions: new Set() });
    }

    const day = dailyMap.get(dayKey)!;
    day.pageviews++;
    day.sessions.add(pv.session_id);
  });

  return Array.from(dailyMap.entries())
    .map(([day, stats]) => ({
      day,
      pageviews: stats.pageviews,
      uniques: stats.sessions.size,
    }))
    .sort((a, b) => a.day.localeCompare(b.day));
}
```

---

## 10. API ëª…ì„¸

### 10.1 ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ API

#### í¬ìŠ¤íŠ¸ ëª©ë¡ ì¡°íšŒ

```
GET /api/posts?page=1&limit=10&locale=ko&all=false

Query Parameters:
- page: number (ê¸°ë³¸ê°’: 1)
- limit: number (ê¸°ë³¸ê°’: 10)
- locale: 'ko' | 'en' (ì„ íƒ)
- all: boolean (ê¸°ë³¸ê°’: false, ê´€ë¦¬ìë§Œ true ê°€ëŠ¥)

Response:
{
  "posts": UslabPost[],
  "total": number,
  "page": number,
  "limit": number,
  "totalPages": number
}
```

#### í¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ

```
GET /api/posts/[id]

Response:
{
  "post": UslabPost
}
```

#### í¬ìŠ¤íŠ¸ ìƒì„±

```
POST /api/posts
Headers:
  Authorization: Bearer <token>

Body:
{
  "slug": string,
  "title": string,
  "content": JSONContent,
  "locale": "ko" | "en",
  "thumbnail_url"?: string,
  "is_published"?: boolean
}

Response:
{
  "post": UslabPost
}
```

#### í¬ìŠ¤íŠ¸ ìˆ˜ì •

```
PUT /api/posts/[id]
Headers:
  Authorization: Bearer <token>

Body:
{
  "slug"?: string,
  "title"?: string,
  "content"?: JSONContent,
  "locale"?: "ko" | "en",
  "is_published"?: boolean
}

Response:
{
  "post": UslabPost
}
```

#### í¬ìŠ¤íŠ¸ ì‚­ì œ

```
DELETE /api/posts/[id]
Headers:
  Authorization: Bearer <token>

Response:
{
  "success": boolean
}
```

#### ì¡°íšŒìˆ˜ ì¦ê°€

```
POST /api/posts/[id]/view

Response:
{
  "view_count": number
}
```

### 10.2 AI ê¸°ëŠ¥ API

#### AI Slug ìƒì„±

```
POST /api/ai/slug
Headers:
  Authorization: Bearer <token>

Body:
{
  "title": string,
  "locale": "ko" | "en"
}

Response:
{
  "slug": string
}
```

#### AI ì´ì–´ì“°ê¸°

```
POST /api/ai/generate
Headers:
  Authorization: Bearer <token>

Body:
{
  "content": string,  // í˜„ì¬ ì½˜í…ì¸ 
  "locale": "ko" | "en"
}

Response: Streaming (text/event-stream)
```

#### AI êµì •

```
POST /api/ai/refine
Headers:
  Authorization: Bearer <token>

Body:
{
  "content": string,
  "locale": "ko" | "en"
}

Response:
{
  "original": string,
  "suggested": string,
  "reason": string
}
```

#### SEO ë©”íƒ€ë°ì´í„° ìƒì„±

```
POST /api/ai/seo
Headers:
  Authorization: Bearer <token>

Body:
{
  "full_content": string,  // HTML í˜•ì‹
  "title": string,
  "locale": "ko" | "en"
}

Response:
{
  "seo_title": string,
  "seo_description": string,
  "seo_keywords": string[]
}
```

### 10.3 ëŒ“ê¸€ API

#### ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ

```
GET /api/comments?post_id=uuid

Response:
{
  "comments": UslabComment[]
}
```

#### ëŒ“ê¸€ ì‘ì„±

```
POST /api/comments

Body:
{
  "post_id": string,
  "author_name": string,
  "password": string,
  "content": string
}

Response:
{
  "comment": UslabComment
}
```

#### ëŒ“ê¸€ ìˆ˜ì •

```
PUT /api/comments/[id]

Body:
{
  "password": string,
  "content": string
}

Response:
{
  "comment": UslabComment
}
```

#### ëŒ“ê¸€ ì‚­ì œ

```
DELETE /api/comments/[id]

Body:
{
  "password": string
}

Response:
{
  "success": boolean
}
```

### 10.4 íŠ¸ë˜í‚¹ API

#### í˜ì´ì§€ë·° íŠ¸ë˜í‚¹

```
POST /api/track

Body:
{
  "session_key": string,
  "page_path": string,
  "post_id"?: string,
  "about_id"?: string,
  "locale"?: "ko" | "en",
  "referrer"?: string,
  "utm"?: {
    "source"?: string,
    "medium"?: string,
    "campaign"?: string,
    "term"?: string,
    "content"?: string
  }
}

Response: 204 No Content
```

### 10.5 ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ API

#### ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ

```
GET /api/admin/dashboard
Headers:
  Authorization: Bearer <token>

Response:
{
  "stats": {
    "totalPosts": number,
    "publishedPosts": number,
    "draftPosts": number,
    "totalViews": number,
    "todayStats": {
      "pageviews": number,
      "uniques": number
    },
    "periodStats": {
      "last7Days": { "pageviews": number, "uniques": number },
      "last30Days": { "pageviews": number, "uniques": number }
    }
  },
  "topPages": Array<{ page_path: string, pageviews: number, uniques: number }>,
  "topPosts": Array<{ post_id: string, title: string, pageviews: number, uniques: number }>,
  "topReferrers": Array<{ referrer_host: string, sessions: number }>,
  "recentActivity": {
    "recentPosts": UslabPost[],
    "recentComments": UslabComment[],
    "recentInquiries": Inquiry[]
  },
  "dailyStats": {
    "last7Days": DailyStats[],
    "last30Days": DailyStats[]
  },
  "seoStatus": {
    "technicalSeo": {
      "sitemap": boolean,
      "robots": boolean,
      "canonical": boolean,
      "jsonLd": boolean
    },
    "contentSeo": {
      "missingSeoTitle": number,
      "missingSeoDescription": number,
      "longSeoTitle": number,
      "longSeoDescription": number
    }
  }
}
```

---

## 11. í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

### 11.1 ë¸”ë¡œê·¸ ì»´í¬ë„ŒíŠ¸

#### PostViewer (í¬ìŠ¤íŠ¸ ë·°ì–´)

```typescript
// components/blog/PostViewer.tsx
import { generateHTML } from '@tiptap/html';
import { extensions } from '@/components/editor/extensions';
import StarterKit from '@tiptap/starter-kit';

export default function PostViewer({ post }: { post: UslabPost }) {
  const html = generateHTML(post.content, extensions);
  
  return (
    <article className="prose prose-invert max-w-none">
      <h1>{post.title}</h1>
      <div dangerouslySetInnerHTML={{ __html: html }} />
    </article>
  );
}
```

#### PostCard (í¬ìŠ¤íŠ¸ ì¹´ë“œ)

```typescript
// components/blog/PostCard.tsx
export default function PostCard({ post }: { post: UslabPost }) {
  return (
    <Link href={`/${post.locale}/blog/${post.slug}`}>
      <div className="bg-slate-900 rounded border border-slate-800 p-6 hover:border-cyan-500 transition">
        <h3 className="text-xl font-bold text-white mb-2">{post.title}</h3>
        <p className="text-slate-400 text-sm mb-4">
          {post.seo_description || '...'}
        </p>
        <div className="flex items-center gap-4 text-xs text-slate-500">
          <span>{formatDate(post.published_at)}</span>
          <span>ì¡°íšŒ {post.view_count.toLocaleString()}</span>
        </div>
      </div>
    </Link>
  );
}
```

#### CommentSection (ëŒ“ê¸€ ì„¹ì…˜)

```typescript
// components/blog/CommentSection.tsx
export default function CommentSection({ postId }: { postId: string }) {
  const [comments, setComments] = useState<UslabComment[]>([]);
  const [authorName, setAuthorName] = useState('');
  const [password, setPassword] = useState('');
  const [content, setContent] = useState('');

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    const response = await fetch('/api/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        post_id: postId,
        author_name: authorName,
        password,
        content,
      }),
    });
    // ...
  };

  return (
    <div>
      <form onSubmit={handleSubmit}>
        {/* ëŒ“ê¸€ ì‘ì„± í¼ */}
      </form>
      <div>
        {comments.map((comment) => (
          <CommentItem key={comment.id} comment={comment} />
        ))}
      </div>
    </div>
  );
}
```

### 11.2 ê´€ë¦¬ì ì»´í¬ë„ŒíŠ¸

#### AdminLayout (ê´€ë¦¬ì ë ˆì´ì•„ì›ƒ)

```typescript
// components/admin/AdminLayout.tsx
export default function AdminLayout({ children }: { children: React.ReactNode }) {
  const { user, signOut } = useAuth();

  return (
    <div className="min-h-screen bg-slate-950">
      <nav className="bg-slate-900 border-b border-slate-800">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <Link href="/admin/dashboard">ëŒ€ì‹œë³´ë“œ</Link>
          <div className="flex items-center gap-4">
            <span className="text-slate-400">{user?.email}</span>
            <button onClick={signOut}>ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </nav>
      <main>{children}</main>
    </div>
  );
}
```

---

## 12. ì´ì‹ ê°€ì´ë“œ

### 12.1 í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

#### í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Site
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# AI (Google Gemini)
GOOGLE_API_KEY=your-google-api-key
```

### 12.2 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

#### 1. Supabase í”„ë¡œì íŠ¸ ìƒì„±/ì—°ê²°

```bash
# Supabase CLI ì„¤ì¹˜ (ì„ íƒ)
npm install -g supabase

# Supabase í”„ë¡œì íŠ¸ ì—°ê²°
supabase link --project-ref your-project-ref
```

#### 2. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‹¤í–‰

```sql
-- 1. ë¸”ë¡œê·¸ í…Œì´ë¸” ìƒì„±
-- supabase/migrations/20250101_create_uslab_blog_tables.sql

-- 2. ëŒ“ê¸€ í…Œì´ë¸” ìƒì„±
-- supabase/migrations/20250102_create_uslab_comments.sql

-- 3. íŠ¸ë˜í‚¹ í…Œì´ë¸” ìƒì„±
-- supabase/migrations/20250115_create_uslab_tracking_tables.sql

-- 4. ê¸°íƒ€ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤...
```

#### 3. Storage ë²„í‚· ìƒì„±

```sql
-- ì´ë¯¸ì§€ ì €ì¥ìš© ë²„í‚·
INSERT INTO storage.buckets (id, name, public) 
VALUES ('uslab-images', 'uslab-images', true);

-- RLS ì •ì±…
CREATE POLICY "Public read images"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'uslab-images');
```

### 12.3 ì½”ë“œ ì´ì‹ ë‹¨ê³„

#### Step 1: ê¸°ë³¸ êµ¬ì¡° ì´ì‹

1. **Next.js í”„ë¡œì íŠ¸ ìƒì„±**
   ```bash
   npx create-next-app@latest your-project --typescript --tailwind --app
   ```

2. **ì˜ì¡´ì„± ì„¤ì¹˜**
   ```bash
   npm install novel @tiptap/core @tiptap/react @tiptap/starter-kit \
     @tiptap/html @tiptap/markdown @tiptap/extension-image \
     @tiptap/extension-link @tiptap/extension-youtube \
     @supabase/supabase-js ai @ai-sdk/google recharts \
     lucide-react clsx tailwind-merge zod
   ```

3. **íŒŒì¼ êµ¬ì¡° ë³µì‚¬**
   - `app/` ë””ë ‰í† ë¦¬ êµ¬ì¡°
   - `components/` ë””ë ‰í† ë¦¬
     - `components/editor/ImageResizePlugin.tsx` (ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í”ŒëŸ¬ê·¸ì¸)
     - `components/editor/extensions/ImageResizeExtension.ts` (Extension ë˜í¼)
   - `lib/` ë””ë ‰í† ë¦¬
   - `supabase/migrations/` ë””ë ‰í† ë¦¬
   - `app/globals.css` (ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ CSS í¬í•¨)

#### Step 2: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

1. `.env.local` íŒŒì¼ ìƒì„±
2. ìœ„ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

#### Step 3: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

1. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ SQL Editor ì—´ê¸°
2. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰

#### Step 4: í…ŒìŠ¤íŠ¸

1. **ë¸”ë¡œê·¸ ì‘ì„± í…ŒìŠ¤íŠ¸**
   - `/admin/login` ì ‘ì†
   - ë¡œê·¸ì¸
   - `/admin/posts/write` ì ‘ì†
   - í¬ìŠ¤íŠ¸ ì‘ì„± ë° ë°œí–‰

2. **ë¸”ë¡œê·¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸**
   - `/ko/blog` ì ‘ì†
   - í¬ìŠ¤íŠ¸ ëª©ë¡ í™•ì¸
   - í¬ìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ í™•ì¸

3. **ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸**
   - `/admin/dashboard` ì ‘ì†
   - KPI ì¹´ë“œ í™•ì¸
   - ì°¨íŠ¸ í™•ì¸

4. **ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸**
   - `/admin/posts/write` ì ‘ì†
   - ì´ë¯¸ì§€ ì—…ë¡œë“œ
   - ì´ë¯¸ì§€ í´ë¦­í•˜ì—¬ ì„ íƒ
   - ìš°ì¸¡ í•˜ë‹¨ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ í™•ì¸
   - í•¸ë“¤ ë“œë˜ê·¸í•˜ì—¬ í¬ê¸° ì¡°ì ˆ
   - Shift í‚¤ + ë“œë˜ê·¸ë¡œ ë¹„ìœ¨ ìœ ì§€ í™•ì¸
   - ì €ì¥ í›„ í¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹œ í¬ê¸° ìœ ì§€ í™•ì¸

### 12.4 ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ì´ë“œ

#### Prefix ë³€ê²½

ëª¨ë“  `uslab_` prefixë¥¼ ì›í•˜ëŠ” prefixë¡œ ë³€ê²½:

1. **ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìˆ˜ì •**
   - `uslab_` â†’ `yourprefix_` (ì˜ˆ: `ustudio_`)

2. **ì½”ë“œ ë‚´ prefix ë³€ê²½**
   ```typescript
   // lib/queries/posts.ts
   .from('uslab_posts')  // â†’ .from('yourprefix_posts')
   ```

3. **íƒ€ì… ì •ì˜ ë³€ê²½**
   ```typescript
   // lib/types/blog.ts
   // UslabPost â†’ YourPrefixPost
   ```

#### ë‹¤êµ­ì–´ ì§€ì› í™•ì¥

í˜„ì¬ `ko`, `en`ë§Œ ì§€ì›í•˜ì§€ë§Œ, ì¶”ê°€ ì–¸ì–´ ì§€ì› ê°€ëŠ¥:

```sql
-- locale ì²´í¬ ì œì•½ì¡°ê±´ ìˆ˜ì •
ALTER TABLE uslab_posts 
  DROP CONSTRAINT IF EXISTS uslab_posts_locale_check;
ALTER TABLE uslab_posts 
  ADD CONSTRAINT uslab_posts_locale_check 
  CHECK (locale IN ('ko', 'en', 'ja', 'zh'));  -- ì¼ë³¸ì–´, ì¤‘êµ­ì–´ ì¶”ê°€
```

```typescript
// lib/i18n/config.ts
export type Locale = 'ko' | 'en' | 'ja' | 'zh';
export const locales: Locale[] = ['ko', 'en', 'ja', 'zh'];
```

### 12.5 ì£¼ì˜ì‚¬í•­

1. **Supabase í”„ë¡œì íŠ¸ êµ¬ì¡°**
   - ê°™ì€ Supabase í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ì—¬ëŸ¬ ì›¹ì‚¬ì´íŠ¸ë¥¼ ìš´ì˜í•˜ëŠ” ê²½ìš°, prefixë¡œ ì™„ì „ ë¶„ë¦¬ í•„ìˆ˜
   - RLS ì •ì±…ë„ prefixë¡œ êµ¬ë¶„

2. **í™˜ê²½ ë³€ìˆ˜ ë³´ì•ˆ**
   - `SUPABASE_SERVICE_ROLE_KEY`ëŠ” ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œ ê¸ˆì§€
   - `.env.local`ì€ `.gitignore`ì— í¬í•¨

3. **AI API ë¹„ìš©**
   - Google Gemini API ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
   - Rate limiting ê³ ë ¤

4. **íŠ¸ë˜í‚¹ ë°ì´í„° Retention**
   - 90ì¼ ìë™ ì‚­ì œ í•¨ìˆ˜ (`uslab_cleanup_old_tracking`) ì •ê¸° ì‹¤í–‰ í•„ìš”
   - Vercel Cron ë˜ëŠ” Supabase Scheduled Triggers ì‚¬ìš©

---

## ë¶€ë¡ A: ì£¼ìš” íŒŒì¼ ëª©ë¡

### ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
- `supabase/migrations/20250101_create_uslab_blog_tables.sql`
- `supabase/migrations/20250102_create_uslab_comments.sql`
- `supabase/migrations/20250115_create_uslab_tracking_tables.sql`
- `supabase/migrations/20250104_add_view_count_to_posts.sql`

### API Routes
- `app/api/posts/route.ts`
- `app/api/posts/[id]/route.ts`
- `app/api/posts/[id]/view/route.ts`
- `app/api/ai/slug/route.ts`
- `app/api/ai/generate/route.ts`
- `app/api/ai/refine/route.ts`
- `app/api/ai/seo/route.ts`
- `app/api/comments/route.ts`
- `app/api/track/route.ts`
- `app/api/admin/dashboard/route.ts`

### ì»´í¬ë„ŒíŠ¸
- `components/editor/BlogEditor.tsx`
- `components/editor/ImageResizePlugin.tsx` (ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í”ŒëŸ¬ê·¸ì¸)
- `components/editor/extensions/ImageResizeExtension.ts` (Extension ë˜í¼)
- `components/blog/PostViewer.tsx`
- `components/blog/PostCard.tsx`
- `components/blog/CommentSection.tsx`
- `components/admin/AdminLayout.tsx`
- `components/analytics/Tracker.tsx`

### ìœ í‹¸ë¦¬í‹°
- `lib/queries/posts.ts`
- `lib/queries/analytics.ts`
- `lib/utils/tracking.ts`
- `lib/utils/blog.ts`
- `lib/supabase/client.ts`

---

## ë¶€ë¡ B: ì°¸ê³  ìë£Œ

- [Next.js ê³µì‹ ë¬¸ì„œ](https://nextjs.org/docs)
- [Novel.sh ë¬¸ì„œ](https://novel.sh)
- [Tiptap ë¬¸ì„œ](https://tiptap.dev)
- [Supabase ë¬¸ì„œ](https://supabase.com/docs)
- [Vercel AI SDK ë¬¸ì„œ](https://sdk.vercel.ai/docs)

---

**ë¬¸ì„œ ë²„ì „**: v1.1  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-01-XX  
**ì‘ì„±ì**: AI Assistant  
**ë³€ê²½ ì´ë ¥**:
- v1.1: ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì¶”ê°€
- v1.0: ì´ˆê¸° ë²„ì „

