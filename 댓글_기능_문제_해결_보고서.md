# 댓글 기능 문제 해결 보고서

## 📋 현재 상황

### 발생 중인 에러
1. **404 에러**: `GET http://localhost:3000/api/comments?post_id=... 404 (Not Found)`
2. **PostgREST 스키마 캐시 에러**: 
   ```
   {
     "code": "PGRST205",
     "message": "Could not find the table 'public.uslab_comments' in the schema cache",
     "hint": "Perhaps you meant the table 'public.uslab_posts'"
   }
   ```

### 확인된 사실
- ✅ `uslab_comments` 테이블은 데이터베이스에 존재함 (MCP로 확인)
- ✅ 테이블 구조는 정상 (컬럼: id, post_id, author_name, password_hash, content, is_approved, created_at, updated_at)
- ✅ 직접 SQL 쿼리는 작동함 (`SELECT COUNT(*) FROM uslab_comments` 성공)
- ✅ API 라우트 파일은 존재함 (`app/api/comments/route.ts`, `app/api/comments/[id]/route.ts`)

## 🔍 시도한 해결 방법들

### 1단계: Supabase 클라이언트 타입 캐스팅
**시도 내용**:
- `const supabase: any = createClient(...)` 로 타입 체크 우회
- `@ts-ignore` 주석 추가

**결과**: ❌ 실패 - 여전히 스키마 캐시 문제 발생

### 2단계: PostgREST API 직접 호출
**시도 내용**:
- Supabase 클라이언트 대신 `fetch()` API로 PostgREST REST API 직접 호출
- URL: `${supabaseUrl}/rest/v1/uslab_comments`
- 헤더에 `apikey`, `Authorization`, `Content-Type` 포함

**결과**: ❌ 실패 - PostgREST 자체의 스키마 캐시 문제로 인해 동일한 에러 발생

### 3단계: 스키마 명시
**시도 내용**:
- `createClient` 옵션에 `db: { schema: 'public' }` 추가

**결과**: ❌ 실패 - 여전히 스키마 캐시 문제 발생

## 🎯 근본 원인

**PostgREST 스키마 캐시 문제**:
- PostgREST는 성능 최적화를 위해 데이터베이스 스키마를 메모리에 캐시합니다
- 새로 생성된 테이블(`uslab_comments`)이 아직 PostgREST의 스키마 캐시에 반영되지 않았습니다
- 이는 Supabase 클라이언트를 사용하든, PostgREST API를 직접 호출하든 동일하게 발생합니다

## 💡 해결 방안

### 추천 해결책: 직접 SQL 쿼리 사용

PostgREST를 우회하고 Supabase의 SQL 실행 기능을 직접 사용합니다.

**장점**:
- 스키마 캐시 문제 완전 우회
- 테이블이 존재하면 즉시 작동
- 더 유연한 쿼리 가능

**구현 방법**:
1. `supabase.rpc()` 함수 사용 (PostgreSQL 함수 호출)
2. 또는 `supabase.from()` 대신 직접 SQL 실행

### 대안: PostgREST 스키마 캐시 새로고침

Supabase 대시보드에서:
1. Settings → API → Schema Cache
2. "Reload Schema Cache" 버튼 클릭

또는 Supabase CLI로:
```bash
supabase db reset
```

## 📝 다음 단계

1. **즉시 해결**: 직접 SQL 쿼리 방식으로 API 라우트 수정
2. **장기 해결**: PostgREST 스키마 캐시 새로고침 또는 Supabase 지원팀에 문의

---

**작성일**: 2025-01-02
**상태**: 해결 중


