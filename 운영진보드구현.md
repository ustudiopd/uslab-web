아래는 **Cursor에서 그대로 복붙해서 개발 시작**할 수 있는 수준으로 정리한 **운영진 보드 전체 명세 v1.0(노션형/내부전용/동시편집 A 옵션)** 입니다.
(기존 `운영진보드_명세서.md`가 “발행/공개/핀” 중심이었던 부분—예: 공개 읽기/핀/우선순위↑ 버튼  —을 **이번 요구사항에 맞게 완전히 재정의**했습니다.)

---

# 운영진 보드(Executive Board) 전체 명세 v1.0

## 0. 문서 정보

* 문서명: 운영진 보드(Executive Board) 전체 명세
* 버전: v1.0
* 목적: **운영진 내부 문서/공지/메모를 노션처럼 작성·정렬·공유**하고, **자동저장/히스토리/동시편집을 운영진 보드에서 실험**하여 블로그/다른 영역에 확장
* 기술 컨텍스트(참고):

  * Next.js 14(App Router) + Supabase 
  * 에디터: Novel(Tiptap 기반) 
  * 자동저장(계획): 로컬스토리지 백업 + debounce 저장 
  * 아키텍처: 3-tier + API Routes 패턴 
  * DB 네이밍: `uslab_` prefix, 동일 Supabase 프로젝트 공유 구조 

---

## 1. 확정 요구사항(당신이 결정한 것들)

### 1.1 보안/노출

1. **내부 전용**: 외부(anon) 접근 경로/페이지/데이터 조회 **불가**
2. **관리 위치**: `/admin/dashboard` 안에서 “탭” 형태로 관리

### 1.2 권한

3. 운영진(관리자) **모두가 작성/수정/삭제 가능**

   * 작성자 전용 권한 없음(공동 문서)

### 1.3 편집/저장 UX

4. **저장 버튼 없음**(노션처럼)
5. 변경사항은 **자동저장**(실시간 느낌) + 저장상태 표시
6. 동시 편집자 2~3명 수준 → **동시편집 허용(A 옵션)**

### 1.4 정렬/노출 규칙

7. **핀 고정 없음**(핀 개념 삭제)
8. 정렬은 **우선순위(=순서) 단일 축**
9. 순서 변경은 **드래그로만**(우선순위↑ 버튼 같은 보조 버튼 없음)
10. 상단 하이라이트는 **최상단 1개만 노출**

---

## 2. 핵심 개념 정의

* **Board(보드)**: 문서를 모아두는 “공간”(예: “공지”, “주간 회의”, “의사결정 로그”)
* **Doc(문서)**: 보드 안의 개별 문서(노션 페이지 같은 단위)
* **Priority(우선순위)**: 문서의 정렬 순서 값(값이 높을수록 상단)
* **Top Highlight(최상단 1개 노출)**: 현재 정렬 1등 문서를 상단 카드로 보여주는 UI

> “보드마다 실시간 저장” 요구를 자연스럽게 수용하기 위해 **Board 단위 구조를 기본으로 설계**합니다.

---

## 3. 정보 구조(IA) & 라우팅

### 3.1 관리자 진입점

* `/admin/dashboard`

  * 탭:

    * `대시보드`(기존 KPI/통계)
    * `운영진 보드`(이번 기능)

> 기존 명세에서도 대시보드 내 탭 구조를 전제로 했었음 

### 3.2 운영진 보드 탭 내부 화면 구성

* 상단: **최상단 1개 하이라이트 카드**
* 좌측(또는 상단 드롭다운): **보드 선택/관리**
* 본문: 선택된 보드의 문서 리스트(드래그 정렬)
* 우측(또는 모달/슬라이드오버): 문서 상세(편집기)

### 3.3 딥링크(권장)

* `/admin/dashboard?tab=exec-board`
* `/admin/dashboard?tab=exec-board&board=<boardId>`
* `/admin/dashboard?tab=exec-board&doc=<docId>`

(내부 탭이지만 문서 링크 공유를 위해 docId 기반 딥링크는 있으면 운영이 편합니다.)

---

## 4. 권한/보안 정책(기능 명세)

### 4.1 기본 원칙

* **운영진 보드는 “공개/발행” 개념이 없음**

  * 기존 명세에 있던 “발행된 게시물 공개” 모델(읽기 정책)  을 **완전히 제거**

### 4.2 권한 규칙

* 로그인(authenticated) + 운영진(관리자)만 접근
* 운영진은 모두:

  * 보드 생성/수정/삭제(선택: 삭제는 제한 가능)
  * 문서 생성/수정/삭제/복원
  * 정렬(드래그) 수행

### 4.3 삭제 정책(필수)

* “삭제”는 **휴지통(soft delete)** 로 이동
* 휴지통에서 복원 가능
* 완전 삭제(purge)는:

  * (A) 30일 후 자동 정리 또는
  * (B) 관리자만 “완전 삭제” 가능(권장)

> 운영진 모두 삭제 가능이면 사고가 잦기 때문에, **soft delete는 MVP 필수**입니다.

---

## 5. 데이터 모델(DB) – Supabase(Postgres)

### 5.1 테이블: `uslab_exec_boards`

보드(카테고리) 테이블

```sql
create table uslab_exec_boards (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  description text,
  sort_order int not null default 0,

  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  created_by uuid references auth.users(id),
  updated_by uuid references auth.users(id)
);

create index uslab_idx_exec_boards_sort on uslab_exec_boards(sort_order asc, created_at asc);
```

### 5.2 테이블: `uslab_exec_docs`

문서(노션 페이지) 테이블

> **핀 없음**, **발행 없음**, **priority만** 사용

```sql
create table uslab_exec_docs (
  id uuid primary key default gen_random_uuid(),
  board_id uuid not null references uslab_exec_boards(id) on delete cascade,

  title text not null,
  content jsonb not null default '{}'::jsonb,

  -- ordering
  priority numeric not null default 0,

  -- soft delete
  is_trashed boolean not null default false,
  trashed_at timestamptz,

  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  created_by uuid references auth.users(id),
  updated_by uuid references auth.users(id)
);

create index uslab_idx_exec_docs_board_priority
  on uslab_exec_docs(board_id, is_trashed asc, priority desc, updated_at desc);

create index uslab_idx_exec_docs_trashed
  on uslab_exec_docs(is_trashed, trashed_at desc);
```

### 5.3 테이블: `uslab_exec_doc_versions`

히스토리(스냅샷) 테이블: “자동저장”과 분리된 **복원 가능한 버전** 저장

```sql
create table uslab_exec_doc_versions (
  id uuid primary key default gen_random_uuid(),
  doc_id uuid not null references uslab_exec_docs(id) on delete cascade,

  title text not null,
  content jsonb not null,

  -- why/how
  change_type text not null check (change_type in ('auto_snapshot','manual_snapshot','restore_point')),
  note text,

  created_at timestamptz not null default now(),
  created_by uuid references auth.users(id)
);

create index uslab_idx_exec_doc_versions_doc
  on uslab_exec_doc_versions(doc_id, created_at desc);
```

### 5.4 (선택) 테이블: `uslab_admins`

운영진 화이트리스트를 DB 레벨에서 보장하고 싶으면 추가
(프로젝트는 prefix 전략을 따름 )

```sql
create table if not exists uslab_admins (
  user_id uuid primary key references auth.users(id) on delete cascade,
  created_at timestamptz not null default now()
);
```

### 5.5 트리거: updated_at 자동 갱신

(블로그와 동일한 패턴으로 운영 권장)

```sql
create or replace function uslab_exec_set_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

create trigger uslab_exec_boards_updated_at
before update on uslab_exec_boards
for each row execute function uslab_exec_set_updated_at();

create trigger uslab_exec_docs_updated_at
before update on uslab_exec_docs
for each row execute function uslab_exec_set_updated_at();
```

---

## 6. RLS 정책(내부전용 강제)

기본 원칙: **anon은 어떤 select도 불가**, authenticated 중에서도 운영진만 가능

### 6.1 공통: RLS 활성화

```sql
alter table uslab_exec_boards enable row level security;
alter table uslab_exec_docs enable row level security;
alter table uslab_exec_doc_versions enable row level security;
```

### 6.2 운영진 판별 함수(권장)

```sql
create or replace function uslab_is_admin()
returns boolean as $$
  select exists (
    select 1 from uslab_admins a where a.user_id = auth.uid()
  );
$$ language sql stable;
```

### 6.3 boards/docs/versions 정책

```sql
-- boards
create policy uslab_exec_boards_select_admin
on uslab_exec_boards for select
to authenticated
using (uslab_is_admin());

create policy uslab_exec_boards_write_admin
on uslab_exec_boards for all
to authenticated
using (uslab_is_admin())
with check (uslab_is_admin());

-- docs
create policy uslab_exec_docs_select_admin
on uslab_exec_docs for select
to authenticated
using (uslab_is_admin());

create policy uslab_exec_docs_write_admin
on uslab_exec_docs for all
to authenticated
using (uslab_is_admin())
with check (uslab_is_admin());

-- versions
create policy uslab_exec_versions_select_admin
on uslab_exec_doc_versions for select
to authenticated
using (uslab_is_admin());

create policy uslab_exec_versions_insert_admin
on uslab_exec_doc_versions for insert
to authenticated
with check (uslab_is_admin());
```

> (중요) 기존 운영진보드 명세는 공개 읽기 정책이 있었는데 , 이번 버전에서는 **0% 공개**가 목표이므로 반드시 제거/미생성해야 합니다.

---

## 7. API 명세(Next.js Route Handlers 기준)

아키텍처는 Next.js API Routes 패턴을 따른다 
모든 `/api/admin/**`는 **운영진 인증/권한 체크 필수**.

### 7.1 Boards

* `GET /api/admin/exec-boards`

  * Response: `{ boards: ExecBoard[] }`
* `POST /api/admin/exec-boards`

  * Body: `{ name, description?, sort_order? }`
  * Response: `{ board: ExecBoard }`
* `PATCH /api/admin/exec-boards/[id]`

  * Body: `{ name?, description?, sort_order? }`
* `DELETE /api/admin/exec-boards/[id]`

  * 정책: 보드 삭제 시 문서 cascade 삭제(주의)
  * 권장: **보드 삭제는 일단 막고(또는 관리자만)**, 보드명/정렬만 지원해도 충분

### 7.2 Docs

* `GET /api/admin/exec-boards/[boardId]/docs?trashed=false`

  * Response: `{ docs: ExecDoc[] }`

* `POST /api/admin/exec-boards/[boardId]/docs`

  * Body: `{ title, content? }`
  * Response: `{ doc: ExecDoc }`

* `GET /api/admin/exec-docs/[id]`

  * Response: `{ doc: ExecDoc }`

* `PATCH /api/admin/exec-docs/[id]`

  * Body(부분 업데이트): `{ title?, content?, priority?, is_trashed? }`
  * Response: `{ doc: ExecDoc }`
  * **자동저장 시 사용되는 엔드포인트**

* `DELETE /api/admin/exec-docs/[id]`

  * 동작: hard delete ❌
  * 실제 동작: `{ is_trashed: true, trashed_at: now() }` 로 업데이트(soft delete)
  * Response: `{ success: true }`

* `POST /api/admin/exec-docs/[id]/restore`

  * 동작: `{ is_trashed: false, trashed_at: null }`
  * Response: `{ doc }`

### 7.3 정렬(드래그-only)

* `PATCH /api/admin/exec-boards/[boardId]/order`

  * Body:

    ```ts
    {
      orderedDocIds: string[] // 위에서 아래 순서
    }
    ```
  * 서버는 받은 배열 기준으로 priority를 재계산해서 일괄 업데이트
  * Response: `{ success: true, updated: number }`

> 기존 명세에 있던 “우선순위↑ 버튼”  과 “핀 고정”  은 이번 버전에서 **삭제**합니다.

### 7.4 Top Highlight(최상단 1개)

* `GET /api/admin/exec-boards/[boardId]/top`

  * Response: `{ doc: ExecDoc | null }`
  * 규칙: `is_trashed=false` 중 `priority desc, updated_at desc` 1개

* (선택) `GET /api/admin/exec-board/top?board=default`

  * `/admin/dashboard` 기본 탭 상단에 “중요 공지 1개”를 띄우려면 사용

### 7.5 Versions(히스토리)

* `GET /api/admin/exec-docs/[id]/versions`

  * Response: `{ versions: ExecDocVersion[] }`
* `POST /api/admin/exec-docs/[id]/versions`

  * Body: `{ change_type: 'manual_snapshot', note? }`
  * 동작: 현재 doc의 `{title, content}`를 versions에 저장
* `POST /api/admin/exec-docs/[id]/versions/[versionId]/restore`

  * 동작:

    1. 현재 상태를 `restore_point`로 versions에 저장
    2. doc을 해당 version의 title/content로 덮어쓰기
  * Response: `{ doc }`

---

## 8. UI/UX 상세 명세

## 8.1 운영진 보드 탭(리스트 화면)

### 헤더

* 타이틀: “운영진 보드”
* 보드 선택: 드롭다운/탭 (보드명)
* 버튼:

  * “새 문서”
  * “보드 관리”(선택)

### 최상단 1개 하이라이트 카드

* 조건: 현재 보드의 1등 문서 1개
* 표시:

  * 제목
  * 본문 요약(첫 100~150자 텍스트 추출)
  * 메타: “마지막 수정: yyyy-mm-dd hh:mm / 수정자”
  * 클릭: 해당 문서 열기(편집 화면)

### 문서 리스트(드래그 정렬)

* 리스트 아이템 구성:

  * 드래그 핸들(좌측)
  * 제목
  * 마지막 수정 시간/수정자
  * … 메뉴(휴지통 이동)
* 정렬:

  * 항상 `priority desc`
* 조작:

  * **드래그로만** 순서 변경
  * 드래그 완료 후 즉시 저장(자동)

### 휴지통(Trash)

* 탭 내 서브탭 또는 필터:

  * “전체”
  * “휴지통”
* 휴지통 목록에서는:

  * 복원 버튼
  * (선택) 완전삭제 버튼(관리자만)

---

## 8.2 문서 편집 화면(노션형)

에디터는 Novel(Tiptap) 기반 사용 

### 상단 바(필수)

* 좌측: ← 목록으로(닫기)
* 중앙: 제목(인라인 편집)
* 우측:

  * **저장 상태**: `Saving… / Saved / Offline / Error`
  * **접속자 표시(Presence)**: 아바타 1~3개
  * 버튼:

    * “히스토리”
    * “스냅샷 저장”(수동 스냅샷)
    * “휴지통으로”

> 저장 버튼 없음(노션 방식). “닫기”는 변경을 버리는 개념이 아니라 **그냥 화면을 나가는 것**.

### 자동저장 규칙(필수)

* 제목/본문 변경 시:

  * debounce 1~2초 후 서버 저장
* 저장 실패 시:

  * 상단 상태를 `Error`로 표시
  * 로컬 백업 유지
* 오프라인 시:

  * `Offline – changes will sync` 표시
  * 온라인 복귀 시 자동 재시도

> 자동 저장 구현 가이드는 “로컬 스토리지 백업 + debounce” 방향이 이미 존재 

### 동시편집(A 옵션) UX

* 문서에 2~3명이 동시에 들어오면:

  * 상단 Presence에 표시(누가 들어와 있는지)
  * 모두 편집 가능(실시간 반영)
* 최소 요구:

  * A가 입력하면 B 화면에도 1~2초 내 반영
  * “누가 편집중인지” 정도의 인지는 제공(커서까지는 옵션)

> 구현 스택은 Yjs/Collab Provider 등 어떤 걸 쓰든 상관 없고, **기능 요구는 “실시간 병합/동시편집”**을 만족하면 됩니다.

### 정렬(드래그) 충돌 방지(권장)

* 본문 동시편집은 완전 허용하되,
* “정렬 변경”은 **정렬 모드 진입 시 1명만 수행**(소프트 락)

  * 다른 사람은 “정렬 중: OOO” 배지 표시 + 정렬 조작 비활성화
  * 락은 30초~60초 TTL(자동 해제)
  * (힌트) 이 TTL 락 패턴은 크론/락 문서에도 잘 정리되어 있음 

---

## 9. 우선순위(priority) 정책(핀 없음)

### 9.1 정렬 규칙(단일)

* `is_trashed = false`
* `priority desc`
* 동률이면 `updated_at desc`

> 기존 명세는 `is_pinned` 최우선이었지만 , 이번 버전에서는 **pin 제거**.

### 9.2 priority 재계산 방식(권장)

드래그 결과 `orderedDocIds`를 서버에 보내면 서버가 일괄 갱신:

* 예: 문서 개수 N일 때

  * 1등: `priority = 1000`
  * 2등: `priority = 990`
  * …
  * N등: `priority = 1000 - (N-1)*10`

장점:

* 단순/명확/일괄 업데이트라 버그 적음
* N이 작을 때(운영진 문서) 충분히 효율적

---

## 10. 히스토리(버전) 정책 – “실험 가능한 형태”로

### 10.1 자동 스냅샷(권장)

* 조건: 문서가 마지막 스냅샷 이후 변경되었고(dirty), 아래 중 하나면 생성

  * 10분마다 1회(`auto_snapshot`)
  * “휴지통 이동” 직전 1회
  * “복원” 직전 1회(`restore_point`)
* 자동 스냅샷은 너무 자주 찍지 않도록 최소 간격을 둠(예: 10분)

### 10.2 수동 스냅샷

* 운영진이 “스냅샷 저장” 버튼을 누르면 즉시 저장(`manual_snapshot`)
* note 입력 가능(예: “회의 전 버전”)

### 10.3 히스토리 UI

* 오른쪽 슬라이드오버:

  * 버전 리스트(시간/작성자/타입)
  * 클릭 시 미리보기(읽기 전용)
  * “이 버전으로 복원” 버튼

---

## 11. 타입 정의(TypeScript)

```ts
export interface ExecBoard {
  id: string
  name: string
  description: string | null
  sort_order: number
  created_at: string
  updated_at: string
  created_by: string | null
  updated_by: string | null
}

export interface ExecDoc {
  id: string
  board_id: string
  title: string
  content: any // Tiptap JSON
  priority: number
  is_trashed: boolean
  trashed_at: string | null
  created_at: string
  updated_at: string
  created_by: string | null
  updated_by: string | null
}

export interface ExecDocVersion {
  id: string
  doc_id: string
  title: string
  content: any
  change_type: 'auto_snapshot' | 'manual_snapshot' | 'restore_point'
  note: string | null
  created_at: string
  created_by: string | null
}
```

---

## 12. 권장 파일 구조(예시)

(블로그 구조와 유사하게 가면 유지보수 쉬움)

```
app/
  admin/
    dashboard/
      page.tsx                 # 탭 UI 포함 (대시보드/운영진보드)
  api/
    admin/
      exec-boards/
        route.ts               # GET/POST
        [id]/route.ts          # PATCH/DELETE
        [boardId]/
          docs/route.ts        # GET/POST
          order/route.ts       # PATCH
          top/route.ts         # GET
      exec-docs/
        [id]/route.ts          # GET/PATCH/DELETE(soft)
        [id]/restore/route.ts  # POST
        [id]/versions/route.ts # GET/POST
        [id]/versions/[versionId]/restore/route.ts # POST

components/
  admin/exec-board/
    ExecBoardTab.tsx
    ExecBoardSelector.tsx
    ExecDocList.tsx
    ExecDocEditor.tsx          # Novel 에디터 + autosave/presence
    ExecDocHistoryDrawer.tsx
    ExecTrashView.tsx

lib/
  queries/
    execBoards.ts
    execDocs.ts
  auth/
    requireAdmin.ts            # uslab_admins 기반 가드
  utils/
    extractText.ts             # content에서 요약 추출
```

---

## 13. 수용 기준(“GO” 체크리스트)

아래가 충족되면 **이대로 GO** 해도 됩니다.

### 보안/권한

* [ ] 비로그인/외부에서 운영진 보드 데이터 조회 불가(RLS로 차단)
* [ ] 운영진 계정은 모두 문서 생성/수정/휴지통 이동/복원 가능

### 노션형 UX

* [ ] 저장 버튼 없음
* [ ] 자동저장 동작 + 상태(Saving/Saved/Error/Offline) 표시
* [ ] 탭 닫기/이동해도 내용이 유실되지 않음(최소 로컬 백업)

### 정렬/노출

* [ ] 핀 기능 없음
* [ ] 드래그로만 순서 변경 가능(우선순위↑ 같은 버튼 없음)
* [ ] 최상단 카드 1개만 노출(현재 1등 문서)

### 동시편집(2~3명)

* [ ] 동시에 편집해도 서로 변경이 실시간으로 반영
* [ ] 누가 접속 중인지 표시(Presence)
* [ ] 정렬 드래그는 소프트 락 등으로 충돌이 최소화됨(권장)

### 히스토리 실험

* [ ] 수동 스냅샷 저장 가능
* [ ] 히스토리 목록 조회 가능
* [ ] 특정 버전으로 복원 가능(복원 직전 restore_point 남김)

---

원하면, 다음 메시지에서 **“이 명세 기준으로 Cursor에 붙일 구현 TODO(작업 순서/PR 단위/테이블 마이그레이션 파일명/컴포넌트 체크리스트)”**까지 바로 쪼개서 드릴게요.
