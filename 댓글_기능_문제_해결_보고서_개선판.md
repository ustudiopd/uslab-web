# 댓글 기능 문제 해결 보고서 (개선판)

## 📋 현재 상황

### 발생 중인 에러
1. **Next.js API Route 404**: `GET http://localhost:3000/api/comments?post_id=... 404 (Not Found)`
   - ⚠️ **참고**: `/api/comments` 라우트는 존재하며, 내부에서 Supabase 요청 실패(PGRST205)를 받아 에러를 반환하고 있습니다.

2. **PostgREST 스키마 캐시 에러**: 
   ```
   {
     "code": "PGRST205",
     "message": "Could not find the table 'public.uslab_comments' in the schema cache",
     "hint": "Perhaps you meant the table 'public.uslab_posts'"
   }
   ```

### 확인된 사실
- ✅ `uslab_comments` 테이블은 데이터베이스에 존재함 (MCP로 확인)
- ✅ 테이블 구조는 정상 (컬럼: id, post_id, author_name, password_hash, content, is_approved, created_at, updated_at)
- ✅ 직접 SQL 쿼리는 작동함 (`SELECT COUNT(*) FROM uslab_comments` 성공)
- ✅ API 라우트 파일은 존재함 (`app/api/comments/route.ts`, `app/api/comments/[id]/route.ts`)
- ✅ **RLS 정책이 설정되어 있음** (4개 정책 확인: SELECT, INSERT, UPDATE, DELETE)
- ✅ **GRANT 권한이 설정되어 있음** (anon, authenticated, service_role 모두 권한 보유)

### 사용 중인 API 키 확인 필요
- 현재 API 라우트에서 사용하는 키: `supabaseServiceRoleKey` 또는 `supabaseAnonKey`
- 어떤 키로 호출했는지에 따라 PostgREST가 노출하는 스키마가 달라질 수 있습니다.

## 🔍 시도한 해결 방법들

### 1단계: Supabase 클라이언트 타입 캐스팅
**시도 내용**:
- `const supabase: any = createClient(...)` 로 타입 체크 우회
- `@ts-ignore` 주석 추가

**결과**: ❌ 실패 - 여전히 스키마 캐시 문제 발생

### 2단계: PostgREST API 직접 호출
**시도 내용**:
- Supabase 클라이언트 대신 `fetch()` API로 PostgREST REST API 직접 호출
- URL: `${supabaseUrl}/rest/v1/uslab_comments`
- 헤더에 `apikey`, `Authorization`, `Content-Type` 포함

**결과**: ❌ 실패 - PostgREST 자체의 스키마 캐시 문제로 인해 동일한 에러 발생

### 3단계: 스키마 명시
**시도 내용**:
- `createClient` 옵션에 `db: { schema: 'public' }` 추가

**결과**: ❌ 실패 - 여전히 스키마 캐시 문제 발생

## 🎯 근본 원인 분석

### 원인 후보 A: PostgREST 스키마 캐시 미반영 (가능성 높음)
- PostgREST는 성능 최적화를 위해 데이터베이스 스키마를 메모리에 캐시합니다
- 새로 생성된 테이블(`uslab_comments`)이 아직 PostgREST의 스키마 캐시에 반영되지 않았을 수 있습니다
- 이는 Supabase 클라이언트를 사용하든, PostgREST API를 직접 호출하든 동일하게 발생합니다

### 원인 후보 B: 권한/RLS/GRANT 문제 (확인 완료 - 문제 없음)
- ✅ RLS 정책이 모두 설정되어 있음
- ✅ GRANT 권한이 anon, authenticated, service_role 모두에게 부여되어 있음
- ⚠️ **하지만** PostgREST는 권한이 없어도 "스키마 캐시에 없다"고 응답할 수 있습니다

### 원인 후보 C: API 키별 스키마 노출 차이
- `anon` 키와 `service_role` 키로 호출했을 때 PostgREST가 노출하는 스키마가 다를 수 있습니다
- 현재 코드는 `supabaseServiceRoleKey || supabaseAnonKey` 순서로 사용 중

## 💡 해결 방안

### 1순위: PostgREST 스키마 캐시 새로고침 (가장 확실한 해결책)

#### 방법 A: MCP 또는 SQL Editor에서 (✅ 추천 - 가장 빠름)
**MCP 사용**:
```typescript
// MCP의 execute_sql로 직접 실행
mcp_supabase_execute_sql({
  project_id: "your-project-id",
  query: "NOTIFY pgrst, 'reload schema';"
})
```

**또는 Supabase 대시보드 SQL Editor에서**:
1. Supabase 대시보드 접속
2. 프로젝트 선택
3. **SQL Editor**로 이동
4. 아래 SQL 실행:
```sql
NOTIFY pgrst, 'reload schema';
```
5. **Run** 클릭
6. "Success. No rows returned" 메시지 확인

#### 방법 B: Supabase 대시보드 UI에서
1. Supabase 대시보드 접속
2. 프로젝트 선택
3. **Settings → API**로 이동
4. **Schema Cache** 섹션에서 **"Reload Schema Cache"** 버튼 클릭

#### 방법 C: Supabase CLI 사용 (⚠️ 로컬 개발 환경만)
```bash
# ⚠️ 주의: 이 명령은 로컬 개발 환경에서만 사용하세요
# 운영/원격 환경에서 사용하면 데이터가 날아갈 수 있습니다
supabase db reset
```

### 2순위: 권한/정책 재확인 및 수정

현재 RLS 정책과 GRANT 권한은 정상이지만, 혹시 모를 문제를 방지하기 위해 아래 SQL을 실행하여 재확인:

```sql
-- 1) RLS 활성화 확인
ALTER TABLE public.uslab_comments ENABLE ROW LEVEL SECURITY;

-- 2) GRANT 권한 확인 및 재부여
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.uslab_comments TO anon;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.uslab_comments TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.uslab_comments TO service_role;
```

### 3순위: API 키 사용 방식 확인

현재 코드에서 사용하는 키를 명확히 하고, 필요시 service_role 키를 우선 사용:

```typescript
// 현재: supabaseServiceRoleKey || supabaseAnonKey
// 권장: service_role 키를 명시적으로 우선 사용
const key = supabaseServiceRoleKey || supabaseAnonKey;
```

### ⚠️ 주의: "PostgREST 우회"에 대한 오해

**`supabase.rpc()`는 PostgREST를 우회하지 않습니다**:
- `rpc()`는 내부적으로 PostgREST의 `/rest/v1/rpc/...` 엔드포인트를 사용합니다
- 따라서 스키마 캐시 문제가 있다면 `rpc()`도 동일한 문제를 겪을 수 있습니다

**진짜 PostgREST 우회 방법**:
- 서버에서 PostgreSQL에 직접 연결 (예: `pg` 라이브러리 사용)
- 하지만 이는 Supabase의 관리 기능을 포기하는 것이므로 권장하지 않습니다

## 📝 해결 체크리스트

### Step 1: API 키 확인
- [ ] 클라이언트(브라우저)에서 직접 Supabase를 호출하는지 vs Next.js 서버 라우트에서 호출하는지 확인
- [ ] `anon` key인지 `service_role` key인지 확인
- [ ] 환경 변수 `SUPABASE_SERVICE_ROLE_KEY`가 설정되어 있는지 확인

### Step 2: 권한/정책 확인 (✅ 이미 확인 완료)
- [x] `anon`, `authenticated`에 테이블 GRANT가 있는지 확인
- [x] RLS가 켜져 있고 select/insert policy가 있는지 확인

### Step 3: Schema Cache Reload
- [x] **MCP로 실행 완료**: `NOTIFY pgrst, 'reload schema';` 실행됨
- [ ] 또는 Supabase Dashboard → SQL Editor에서 `NOTIFY pgrst, 'reload schema';` 실행
- [ ] 또는 Supabase Dashboard → Settings → API → Schema Cache → Reload 클릭
- [ ] 또는 Supabase CLI로 `supabase db reset` 실행 (로컬만)

### Step 4: 에러 응답 코드 개선
- [ ] PGRST205 같은 인프라/권한/스키마 문제는 404보다는 **500으로 반환**하도록 수정
- [ ] 클라이언트가 "댓글 없음"으로 오해하지 않도록 에러 메시지 명확화

## 📊 현재 RLS 정책 상태

확인된 RLS 정책 (4개):
1. ✅ `uslab_policy_comments_select_public`: 승인된 댓글만 공개 조회
2. ✅ `uslab_policy_comments_insert_public`: 누구나 댓글 작성 가능
3. ✅ `uslab_policy_comments_update_public`: 모든 사용자 수정 가능 (API에서 비밀번호 확인)
4. ✅ `uslab_policy_comments_delete_public`: 모든 사용자 삭제 가능 (API에서 비밀번호 확인)

## 📊 현재 GRANT 권한 상태

확인된 권한:
- ✅ `anon`: SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER
- ✅ `authenticated`: SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER
- ✅ `service_role`: SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER

## 🎯 결론 및 권장 사항

1. **즉시 시도**: Supabase 대시보드에서 **Schema Cache Reload** 실행
2. **확인 필요**: API 라우트에서 사용하는 키가 `service_role`인지 확인
3. **에러 처리 개선**: PGRST205 에러는 500으로 반환하도록 수정
4. **장기 해결**: Supabase 지원팀에 문의하여 스키마 캐시 자동 갱신 설정 확인

---

**작성일**: 2025-01-02  
**상태**: 해결 중  
**검토 반영**: 2025-01-02 (권한/RLS 확인 완료, 원인 후보 분기, 체크리스트 추가)



