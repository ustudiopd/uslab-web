# ì „ì²´ ì‹œìŠ¤í…œ ì´ì‹ ëª…ì„¸ì„œ

**í†µê³„ ê¸°ëŠ¥, íˆíŠ¸ë§µ, AI ë¶„ì„ ë³´ê³ ì„œ í†µí•© ì´ì‹ ê°€ì´ë“œ**

---

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#1-ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì•„í‚¤í…ì²˜](#2-ì•„í‚¤í…ì²˜)
3. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#3-ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
4. [í™˜ê²½ ì„¤ì •](#4-í™˜ê²½-ì„¤ì •)
5. [í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ êµ¬í˜„](#5-í´ë¼ì´ì–¸íŠ¸-ì‚¬ì´ë“œ-êµ¬í˜„)
6. [ì„œë²„ ì‚¬ì´ë“œ êµ¬í˜„](#6-ì„œë²„-ì‚¬ì´ë“œ-êµ¬í˜„)
7. [ëŒ€ì‹œë³´ë“œ êµ¬í˜„](#7-ëŒ€ì‹œë³´ë“œ-êµ¬í˜„)
8. [íˆíŠ¸ë§µ ê¸°ëŠ¥](#8-íˆíŠ¸ë§µ-ê¸°ëŠ¥)
9. [AI ë¶„ì„ ë³´ê³ ì„œ ê¸°ëŠ¥](#9-ai-ë¶„ì„-ë³´ê³ ì„œ-ê¸°ëŠ¥)
10. [ë””ìì¸ ì‹œìŠ¤í…œ](#10-ë””ìì¸-ì‹œìŠ¤í…œ)
11. [ë‹¨ê³„ë³„ ì´ì‹ ê°€ì´ë“œ](#11-ë‹¨ê³„ë³„-ì´ì‹-ê°€ì´ë“œ)
12. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#12-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 ê¸°ëŠ¥ ëª©ë¡

#### í†µê³„ ê¸°ëŠ¥
- âœ… **ì„¸ì…˜ ì¶”ì **: 30ë¶„ ë¹„í™œì„± ê¸°ì¤€ ì„¸ì…˜ ê´€ë¦¬
- âœ… **í˜ì´ì§€ë·° ì¶”ì **: ë¼ìš°íŠ¸ ë³€ê²½ ì‹œ ìë™ í˜ì´ì§€ë·° ê¸°ë¡
- âœ… **ì´ë²¤íŠ¸ ì¶”ì **: í´ë¦­, ìŠ¤í¬ë¡¤, ì „í™˜, í˜ì´ì§€ ì°¸ì—¬ë„, Web Vitals
- âœ… **ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ**: í†µê³„ ë° íŠ¸ë Œë“œ ë¶„ì„
- âœ… **ë©€í‹°í…Œë„ŒíŠ¸**: Prefix ê¸°ë°˜ ë°ì´í„° ë¶„ë¦¬ (uslab, ustudio, modu ë“±)

#### íˆíŠ¸ë§µ ê¸°ëŠ¥
- âœ… **í´ë¦­ íˆíŠ¸ë§µ**: í˜ì´ì§€ë³„ í´ë¦­ ìœ„ì¹˜ ì‹œê°í™”
- âœ… **ê³ í•´ìƒë„ ì§‘ê³„**: ê·¸ë¦¬ë“œ ê¸°ë°˜ í´ë¦­ ì§‘ê³„ (ê¸°ë³¸ 200px)
- âœ… **ë””ë°”ì´ìŠ¤ í•„í„°**: ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ë¶„ë¦¬ ë¶„ì„
- âœ… **Blob ë Œë”ë§**: Beusableê¸‰ íˆíŠ¸ë§µ ì‹œê°í™”
- âœ… **ë·°í¬íŠ¸ ê³ ì •**: ìŠ¤í¬ë¡¤ ì‹œ ì¦‰ì‹œ ë”°ë¼ë¶™ëŠ” ì˜¤ë²„ë ˆì´

#### AI ë¶„ì„ ë³´ê³ ì„œ
- âœ… **ìë™ ì¸ì‚¬ì´íŠ¸**: AI ê¸°ë°˜ ë°ì´í„° ë¶„ì„ ë° ì¸ì‚¬ì´íŠ¸ ìƒì„±
- âœ… **ì‹œê°í™”**: Line Chart, Bar Chart, Radar Chart
- âœ… **ë¹„êµ ë¶„ì„**: ì´ì „ ê¸°ê°„ ëŒ€ë¹„ ë³€í™”ìœ¨ ë¶„ì„
- âœ… **ì„±ëŠ¥ ë¶„ì„**: Web Vitals ê¸°ë°˜ ì„±ëŠ¥ í‰ê°€
- âœ… **ê¶Œì¥ì‚¬í•­**: AI ê¸°ë°˜ ê°œì„  ì œì•ˆ

### 1.2 ê¸°ìˆ  ìŠ¤íƒ

- **í”„ë¡ íŠ¸ì—”ë“œ**: Next.js 14+ (App Router), React, TypeScript
- **ë°±ì—”ë“œ**: Next.js API Routes, Supabase (PostgreSQL)
- **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL (Supabase)
- **ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬**: Recharts
- **AI**: Google Gemini API (`@ai-sdk/google`)
- **íŠ¸ë˜í‚¹**: HTML5 Canvas API (íˆíŠ¸ë§µ)
- **ìŠ¤íƒ€ì¼ë§**: Tailwind CSS

---

## 2. ì•„í‚¤í…ì²˜

### 2.1 ë°ì´í„° íë¦„

```
[í´ë¼ì´ì–¸íŠ¸]
  â†“
Tracker.tsx (ì„¸ì…˜/í˜ì´ì§€ë·° ê´€ë¦¬)
  â†“
eventTracker.ts (ì´ë²¤íŠ¸ í ê´€ë¦¬)
  â†“
WebVitals.tsx (ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘)
  â†“
POST /api/track (ë°°ì¹˜ ì „ì†¡)
  â†“
[ì„œë²„]
  â†“
Bot í•„í„°ë§
  â†“
ì„¸ì…˜ Upsert
  â†“
í˜ì´ì§€ë·° Insert
  â†“
ì´ë²¤íŠ¸ Bulk Insert
  â†“
[ë°ì´í„°ë² ì´ìŠ¤]
  â†“
{{prefix}}_sessions
{{prefix}}_page_views
{{prefix}}_events
```

### 2.2 í•µì‹¬ ì„¤ê³„ ì›ì¹™

1. **Prefix ê¸°ë°˜ ë©€í‹°í…Œë„ŒíŠ¸**: ëª¨ë“  í…Œì´ë¸”ê³¼ ì„¤ì •ì´ prefixë¡œ ë¶„ë¦¬
2. **Fire-and-Forget**: ì‚¬ìš©ì ê²½í—˜ì— ì˜í–¥ ì—†ë„ë¡ ì—ëŸ¬ ì‹œì—ë„ 204 ë°˜í™˜
3. **ë°°ì¹˜ ì „ì†¡**: ì´ë²¤íŠ¸ë¥¼ íì— ëª¨ì•„ 5ì´ˆë§ˆë‹¤ ë˜ëŠ” 20ê°œ ì´ìƒì¼ ë•Œ ì „ì†¡
4. **Bot í•„í„°ë§**: User-Agent ê¸°ë°˜ ë´‡ íŠ¸ë˜í”½ ì œì™¸
5. **ìƒ˜í”Œë§ ì§€ì›**: ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ ëŒ€ë¹„ ì´ë²¤íŠ¸ ìƒ˜í”Œë§ ê°€ëŠ¥

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 3.1 í…Œì´ë¸” êµ¬ì¡°

#### 3.1.1 `{{prefix}}_sessions`

```sql
create table if not exists {{prefix}}_sessions (
  id uuid primary key default gen_random_uuid(),
  session_key text not null unique,
  
  -- Entry ì •ë³´
  landing_path text,
  referrer text,
  referrer_host text,
  
  -- UTM íŒŒë¼ë¯¸í„°
  utm_source text,
  utm_medium text,
  utm_campaign text,
  utm_term text,
  utm_content text,
  
  -- ë””ë°”ì´ìŠ¤/í™˜ê²½
  user_agent text,
  device_type text check (device_type in ('mobile', 'tablet', 'desktop', 'bot', 'unknown')),
  
  -- ìš´ì˜ í¸ì˜
  created_at timestamptz not null default now(),
  last_seen_at timestamptz not null default now()
);

-- ì¸ë±ìŠ¤
create unique index if not exists {{prefix}}_idx_sessions_session_key 
  on {{prefix}}_sessions (session_key);
create index if not exists {{prefix}}_idx_sessions_created_at 
  on {{prefix}}_sessions (created_at desc);
create index if not exists {{prefix}}_idx_sessions_last_seen_at 
  on {{prefix}}_sessions (last_seen_at desc);
create index if not exists {{prefix}}_idx_sessions_referrer_host 
  on {{prefix}}_sessions (referrer_host);
```

#### 3.1.2 `{{prefix}}_page_views`

```sql
create table if not exists {{prefix}}_page_views (
  id uuid primary key,  -- í´ë¼ì´ì–¸íŠ¸ ìƒì„± UUID
  session_id uuid not null references {{prefix}}_sessions(id) on delete cascade,
  
  -- ì½˜í…ì¸  ë§¤í•‘ (ì˜µì…˜)
  post_id uuid references {{prefix}}_posts(id) on delete set null,
  about_id uuid references {{prefix}}_about(id) on delete set null,
  
  -- í˜ì´ì§€ ì •ë³´
  page_path text not null,
  locale text check (locale in ('ko', 'en')),
  
  -- í™•ì¥ ì»¬ëŸ¼
  view_duration integer,  -- seconds
  scroll_depth integer,   -- 0-100
  
  created_at timestamptz not null default now()
);

-- ì¸ë±ìŠ¤
create index if not exists {{prefix}}_idx_page_views_created_at 
  on {{prefix}}_page_views (created_at desc);
create index if not exists {{prefix}}_idx_page_views_page_path_created_at 
  on {{prefix}}_page_views (page_path, created_at desc);
create index if not exists {{prefix}}_idx_page_views_session_id_created_at 
  on {{prefix}}_page_views (session_id, created_at desc);
```

#### 3.1.3 `{{prefix}}_events`

```sql
create table if not exists {{prefix}}_events (
  id uuid primary key,  -- í´ë¼ì´ì–¸íŠ¸ ìƒì„± UUID
  session_id uuid not null references {{prefix}}_sessions(id) on delete cascade,
  page_view_id uuid references {{prefix}}_page_views(id) on delete set null,
  
  -- ì´ë²¤íŠ¸ ì •ë³´
  name varchar(100) not null,  -- click, scroll_depth, conversion, page_engagement, web_vital
  page_path text not null,
  
  -- ì´ë²¤íŠ¸ ì†ì„± (JSONB)
  props jsonb default '{}'::jsonb,
  
  -- íƒ€ì„ìŠ¤íƒ¬í”„
  client_ts bigint,  -- í´ë¼ì´ì–¸íŠ¸ íƒ€ì„ìŠ¤íƒ¬í”„ (ë°€ë¦¬ì´ˆ)
  created_at timestamptz not null default now()
);

-- ì¸ë±ìŠ¤
create index if not exists {{prefix}}_idx_events_created_at 
  on {{prefix}}_events (created_at desc);
create index if not exists {{prefix}}_idx_events_session_id 
  on {{prefix}}_events (session_id, created_at desc);
create index if not exists {{prefix}}_idx_events_page_view_id 
  on {{prefix}}_events (page_view_id, created_at desc);
create index if not exists {{prefix}}_idx_events_name 
  on {{prefix}}_events (name, created_at desc);
create index if not exists {{prefix}}_idx_events_page_path 
  on {{prefix}}_events (page_path, created_at desc);

-- props JSONB ì¸ë±ìŠ¤ (íˆíŠ¸ë§µ ì¿¼ë¦¬ ìµœì í™”)
create index if not exists {{prefix}}_idx_events_props_click 
  on {{prefix}}_events using gin (props jsonb_path_ops) 
  where name = 'click';
```

#### 3.1.4 `{{prefix}}_analytics_reports`

```sql
create table if not exists {{prefix}}_analytics_reports (
  id uuid primary key default gen_random_uuid(),
  
  -- ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì›
  site_prefix varchar(50) not null,
  
  -- ë³´ê³ ì„œ ë©”íƒ€ ì •ë³´
  report_type varchar(20) not null,  -- daily/weekly/monthly/custom
  period_start date not null,
  period_end date not null,
  days integer not null,
  include_comparison boolean default false,
  
  -- ìƒì„± ì •ë³´
  prompt_version varchar(20) not null,
  model_name varchar(50) not null,
  report_json jsonb not null,
  
  -- ìºì‹±ì„ ìœ„í•œ ì…ë ¥ í•´ì‹œ
  input_hash varchar(64) not null,
  
  -- ìƒì„± ë°©ì‹
  created_via varchar(20) not null,  -- manual/cron
  
  -- íƒ€ì„ìŠ¤íƒ¬í”„
  generated_at timestamptz not null default now(),
  created_at timestamptz not null default now()
);

-- ì¸ë±ìŠ¤
create index if not exists {{prefix}}_idx_reports_site_prefix 
  on {{prefix}}_analytics_reports (site_prefix, generated_at desc);
create index if not exists {{prefix}}_idx_reports_input_hash 
  on {{prefix}}_analytics_reports (input_hash);
```

#### 3.1.5 `{{prefix}}_analytics_report_comments`

```sql
create table if not exists {{prefix}}_analytics_report_comments (
  id uuid primary key default gen_random_uuid(),
  report_id uuid not null references {{prefix}}_analytics_reports(id) on delete cascade,
  user_id uuid references auth.users(id) on delete set null,
  user_email text,
  author_name text not null,
  content text not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- ì¸ë±ìŠ¤
create index if not exists {{prefix}}_idx_report_comments_report_id 
  on {{prefix}}_analytics_report_comments (report_id, created_at desc);
```

### 3.2 RLS ì •ì±…

ëª¨ë“  í…Œì´ë¸”ì— ëŒ€í•´ authenticated ì‚¬ìš©ìë§Œ ì¡°íšŒ ê°€ëŠ¥:

```sql
-- ì˜ˆì‹œ: sessions í…Œì´ë¸”
alter table {{prefix}}_sessions enable row level security;

create policy {{prefix}}_policy_sessions_select_authenticated
  on {{prefix}}_sessions
  for select
  using (auth.role() = 'authenticated');
```

### 3.3 ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ êµ¬ì¡°

```
supabase/migrations/
â”œâ”€â”€ YYYYMMDD_create_{{prefix}}_tracking_tables.sql
â”œâ”€â”€ YYYYMMDD_create_{{prefix}}_events_table.sql
â”œâ”€â”€ YYYYMMDD_create_{{prefix}}_analytics_reports.sql
â””â”€â”€ YYYYMMDD_create_{{prefix}}_analytics_report_comments.sql
```

---

## 4. í™˜ê²½ ì„¤ì •

### 4.1 í™˜ê²½ ë³€ìˆ˜

#### í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Analytics ì„¤ì •
ANALYTICS_PREFIX=uslab  # ê¸°ë³¸ê°’: uslab
ANALYTICS_ENABLED=true  # ê¸°ë³¸ê°’: true
ANALYTICS_SAMPLE_RATE_EVENTS=1.0  # ê¸°ë³¸ê°’: 1.0 (100%)
ANALYTICS_SAMPLE_RATE_HEATMAP=1.0  # ê¸°ë³¸ê°’: 1.0 (100%)
ANALYTICS_EXCLUDE_PATH_PREFIXES=/admin,/api,/_next
ANALYTICS_RESPECT_DNT=true  # ê¸°ë³¸ê°’: true

# AI ë³´ê³ ì„œ (ì„ íƒ)
GOOGLE_API_KEY=your-google-api-key
# ë˜ëŠ”
GOOGLE_GENERATIVE_AI_API_KEY=your-google-api-key
```

#### ì„ íƒ í™˜ê²½ ë³€ìˆ˜

```bash
# AI ëª¨ë¸ ì„¤ì •
AI_MODEL_NAME=gemini-2.0-flash-exp  # ê¸°ë³¸ê°’
AI_PROMPT_VERSION=1.1  # ê¸°ë³¸ê°’
```

### 4.2 ì„¤ì • íŒŒì¼

#### `lib/config/analytics.ts`

```typescript
export const ANALYTICS_PREFIX =
  (process.env.ANALYTICS_PREFIX || 'uslab').toLowerCase();

export const ANALYTICS_ENABLED =
  process.env.ANALYTICS_ENABLED !== 'false';

export const ANALYTICS_SAMPLE_RATE_EVENTS = parseFloat(
  process.env.ANALYTICS_SAMPLE_RATE_EVENTS || '1.0'
);

export const ANALYTICS_SAMPLE_RATE_HEATMAP = parseFloat(
  process.env.ANALYTICS_SAMPLE_RATE_HEATMAP || '1.0'
);

export const ANALYTICS_EXCLUDE_PATH_PREFIXES = (
  process.env.ANALYTICS_EXCLUDE_PATH_PREFIXES ||
  '/admin,/api,/_next'
).split(',').map((p) => p.trim());

export const ANALYTICS_RESPECT_DNT =
  process.env.ANALYTICS_RESPECT_DNT !== 'false';

export function getAnalyticsTableName(tableName: string): string {
  return `${ANALYTICS_PREFIX}_${tableName}`;
}

export function getSessionStorageKey(): string {
  return `${ANALYTICS_PREFIX}_sid`;
}

export function getLastSeenStorageKey(): string {
  return `${ANALYTICS_PREFIX}_sid_last`;
}
```

---

## 5. í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ êµ¬í˜„

### 5.1 íŒŒì¼ êµ¬ì¡°

```
components/
â”œâ”€â”€ analytics/
â”‚   â””â”€â”€ Tracker.tsx          # ì„¸ì…˜/í˜ì´ì§€ë·° ì¶”ì 
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ HeatmapViewer.tsx    # íˆíŠ¸ë§µ ë·°ì–´
â”‚   â””â”€â”€ HeatmapOverlay.tsx   # íˆíŠ¸ë§µ ì˜¤ë²„ë ˆì´ ë Œë”ë§
lib/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ analytics.ts         # ì„¤ì •
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ eventTracker.ts     # ì´ë²¤íŠ¸ í ê´€ë¦¬
â”‚   â””â”€â”€ tracking.ts         # íŠ¸ë˜í‚¹ ìœ í‹¸ë¦¬í‹°
```

### 5.2 Tracker ì»´í¬ë„ŒíŠ¸

**ìœ„ì¹˜**: `components/analytics/Tracker.tsx`

**ê¸°ëŠ¥**:
- ì„¸ì…˜ í‚¤ ê´€ë¦¬ (localStorage, 30ë¶„ ë§Œë£Œ)
- í˜ì´ì§€ë·° ìë™ ì¶”ì  (ë¼ìš°íŠ¸ ë³€ê²½ ì‹œ)
- UTM íŒŒë¼ë¯¸í„° ë° Referrer ì¶”ì 
- Do Not Track ì¡´ì¤‘

**ì£¼ìš” ë¡œì§**:

```typescript
// ì„¸ì…˜ í‚¤ ìƒì„±/ê°±ì‹ 
const getOrCreateSessionKey = () => {
  const storageKey = getSessionStorageKey();
  const lastSeenKey = getLastSeenStorageKey();
  
  const storedKey = localStorage.getItem(storageKey);
  const lastSeen = localStorage.getItem(lastSeenKey);
  
  // 30ë¶„ ë§Œë£Œ ì²´í¬
  if (storedKey && lastSeen) {
    const lastSeenTime = parseInt(lastSeen, 10);
    const now = Date.now();
    if (now - lastSeenTime < SESSION_EXPIRY_MS) {
      localStorage.setItem(lastSeenKey, now.toString());
      return storedKey;
    }
  }
  
  // ìƒˆ ì„¸ì…˜ ìƒì„±
  const newKey = crypto.randomUUID();
  localStorage.setItem(storageKey, newKey);
  localStorage.setItem(lastSeenKey, Date.now().toString());
  return newKey;
};

// í˜ì´ì§€ë·° ì „ì†¡
const trackPageView = () => {
  const sessionKey = getOrCreateSessionKey();
  const pageViewId = crypto.randomUUID();
  
  const payload = {
    session_key: sessionKey,
    page_view: {
      id: pageViewId,
      page_path: pathname,
      locale: parseLocaleFromPath(pathname),
      referrer: document.referrer,
      utm: parseUTM(window.location.href),
    },
    events: [],
  };
  
  // sendBeacon ìš°ì„  ì‚¬ìš©
  if (navigator.sendBeacon) {
    const blob = new Blob([JSON.stringify(payload)], {
      type: 'application/json',
    });
    navigator.sendBeacon('/api/track', blob);
  } else {
    fetch('/api/track', {
      method: 'POST',
      body: JSON.stringify(payload),
      keepalive: true,
    });
  }
};
```

### 5.3 ì´ë²¤íŠ¸ íŠ¸ë˜ì»¤

**ìœ„ì¹˜**: `lib/utils/eventTracker.ts`

**ê¸°ëŠ¥**:
- ì´ë²¤íŠ¸ í ê´€ë¦¬ (ë°°ì¹˜ ì „ì†¡)
- í´ë¦­ ì´ë²¤íŠ¸ ì¶”ì 
- ìŠ¤í¬ë¡¤ ê¹Šì´ ì¶”ì 
- ìƒ˜í”Œë§ ì§€ì›

**ì£¼ìš” í•¨ìˆ˜**:

```typescript
// í´ë¦­ ì´ë²¤íŠ¸ ì¶”ì 
export function trackClick(
  event: MouseEvent,
  elementId?: string
) {
  const element = event.target as HTMLElement;
  const rect = element.getBoundingClientRect();
  
  // ì¢Œí‘œ ê³„ì‚° (ë¬¸ì„œ ê¸°ì¤€)
  const pageX = event.pageX;
  const pageY = event.pageY;
  
  // ë·°í¬íŠ¸ í¬ê¸°
  const viewportW = window.innerWidth;
  const viewportH = window.innerHeight;
  
  // ë¬¸ì„œ í¬ê¸°
  const docW = document.documentElement.scrollWidth;
  const docH = document.documentElement.scrollHeight;
  
  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜
  const scrollX = window.scrollX;
  const scrollY = window.scrollY;
  
  eventQueue.add({
    name: 'click',
    page_view_id: eventQueue.getCurrentPageViewId(),
    page_path: eventQueue.getCurrentPagePath(),
    props: {
      page_x: pageX,
      page_y: pageY,
      x: pageX / docW,  // ì •ê·œí™” (0~1)
      y: pageY / docH,  // ì •ê·œí™” (0~1)
      viewport_w: viewportW,
      viewport_h: viewportH,
      doc_w: docW,
      doc_h: docH,
      scroll_x: scrollX,
      scroll_y: scrollY,
      element_id: elementId || element.getAttribute('data-analytics-id'),
      element_tag: element.tagName.toLowerCase(),
      href_host: element.getAttribute('href') 
        ? new URL(element.getAttribute('href')!, window.location.origin).host 
        : null,
      device_bucket: viewportW < 768 ? 'mobile' : 'desktop',
    },
  });
}

// ì´ë²¤íŠ¸ í flush
class EventQueue {
  private queue: Event[] = [];
  private flushTimer: NodeJS.Timeout | null = null;
  private readonly FLUSH_INTERVAL = 5000; // 5ì´ˆ
  private readonly FLUSH_SIZE = 20; // 20ê°œ ì´ìƒ
  
  flush() {
    if (this.queue.length === 0) return;
    
    const events = [...this.queue];
    this.queue = [];
    
    // ë°°ì¹˜ ì „ì†¡
    fetch('/api/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_key: getSessionKey(),
        events: events,
      }),
      keepalive: true,
    });
  }
}
```

### 5.4 íˆíŠ¸ë§µ ë·°ì–´

**ìœ„ì¹˜**: `components/admin/HeatmapViewer.tsx`

**ê¸°ëŠ¥**:
- íˆíŠ¸ë§µ ë°ì´í„° ì¡°íšŒ
- í•„í„° ì˜µì…˜ (days, device, gridSize)
- HeatmapOverlay ë Œë”ë§

**ì£¼ìš” ë¡œì§**:

```typescript
export default function HeatmapViewer({ pagePath }: HeatmapViewerProps) {
  const [days, setDays] = useState(30);
  const [deviceFilter, setDeviceFilter] = useState<'all' | 'mobile' | 'desktop'>('all');
  const [gridSize, setGridSize] = useState(200);
  
  useEffect(() => {
    const fetchHeatmapData = async () => {
      const encodedPath = encodeURIComponent(pagePath);
      const queryParams = new URLSearchParams({
        days: days.toString(),
        grid: gridSize.toString(),
        device: deviceFilter,
      });
      
      const response = await fetch(
        `/api/admin/heatmap/${encodedPath}?${queryParams.toString()}`,
        {
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
          },
        }
      );
      
      const data = await response.json();
      setHeatmapData(data);
    };
    
    fetchHeatmapData();
  }, [pagePath, days, deviceFilter, gridSize]);
  
  return (
    <HeatmapOverlay
      heatmapData={heatmapData}
      radiusPx={20}
      blurPx={15}
      opacity={0.6}
    />
  );
}
```

### 5.5 íˆíŠ¸ë§µ ì˜¤ë²„ë ˆì´

**ìœ„ì¹˜**: `components/admin/HeatmapOverlay.tsx`

**ê¸°ëŠ¥**:
- Canvas ê¸°ë°˜ íˆíŠ¸ë§µ ë Œë”ë§
- Blob ì•Œê³ ë¦¬ì¦˜ (Blur + Colorize)
- ë·°í¬íŠ¸ ê³ ì • (ìŠ¤í¬ë¡¤ ì‹œ ì¦‰ì‹œ ë”°ë¼ë¶™ìŒ)

**ì£¼ìš” ë¡œì§**:

```typescript
export default function HeatmapOverlay({
  heatmapData,
  radiusPx = 20,
  blurPx = 15,
  opacity = 0.6,
}: HeatmapOverlayProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas || !heatmapData) return;
    
    const ctx = canvas.getContext('2d')!;
    const { grid, gridSize } = heatmapData;
    
    // ë·°í¬íŠ¸ í¬ê¸°ë¡œ ì„¤ì •
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤ (ë¸”ëŸ¬ ëˆ„ì )
    const shadowCanvas = document.createElement('canvas');
    shadowCanvas.width = canvas.width;
    shadowCanvas.height = canvas.height;
    const shadowCtx = shadowCanvas.getContext('2d')!;
    
    // ìŠ¤íƒ¬í”„ ìº”ë²„ìŠ¤ (ì›í˜• ê·¸ë¼ë””ì–¸íŠ¸)
    const stampCanvas = document.createElement('canvas');
    const stampSize = radiusPx * 2;
    stampCanvas.width = stampSize;
    stampCanvas.height = stampSize;
    const stampCtx = stampCanvas.getContext('2d')!;
    
    const gradient = stampCtx.createRadialGradient(
      radiusPx, radiusPx, 0,
      radiusPx, radiusPx, radiusPx
    );
    gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
    stampCtx.fillStyle = gradient;
    stampCtx.fillRect(0, 0, stampSize, stampSize);
    
    // ê·¸ë¦¬ë“œ ë°ì´í„°ë¥¼ ìŠ¤íƒ¬í”„ë¡œ ë Œë”ë§
    shadowCtx.globalCompositeOperation = 'screen';
    shadowCtx.filter = `blur(${blurPx}px)`;
    
    Object.entries(grid).forEach(([key, count]) => {
      const [x, y] = key.split(',').map(Number);
      
      // ë¬¸ì„œ ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
      const screenX = x - window.scrollX;
      const screenY = y - window.scrollY;
      
      // ë·°í¬íŠ¸ ë°–ì´ë©´ ìŠ¤í‚µ
      if (screenX < -radiusPx || screenX > canvas.width + radiusPx ||
          screenY < -radiusPx || screenY > canvas.height + radiusPx) {
        return;
      }
      
      const intensity = Math.min(count / maxCount, 1);
      shadowCtx.globalAlpha = intensity;
      shadowCtx.drawImage(
        stampCanvas,
        screenX - radiusPx,
        screenY - radiusPx
      );
    });
    
    // ì•ŒíŒŒ ê°’ì„ ìƒ‰ìƒìœ¼ë¡œ ë§¤í•‘
    const imageData = shadowCtx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    
    for (let i = 0; i < data.length; i += 4) {
      const alpha = data[i + 3] / 255;
      if (alpha === 0) continue;
      
      // ìƒ‰ìƒ ë§¤í•‘ (íŒŒë€ìƒ‰ â†’ ì²­ë¡ìƒ‰ â†’ ì´ˆë¡ìƒ‰ â†’ ë…¸ë€ìƒ‰ â†’ ë¹¨ê°„ìƒ‰)
      const [r, g, b] = colorize(alpha);
      data[i] = r;
      data[i + 1] = g;
      data[i + 2] = b;
      data[i + 3] = Math.floor(alpha * opacity * 255);
    }
    
    ctx.putImageData(imageData, 0, 0);
  }, [heatmapData, radiusPx, blurPx, opacity]);
  
  return (
    <canvas
      ref={canvasRef}
      className="fixed top-0 left-0 w-screen h-screen pointer-events-none z-50"
    />
  );
}
```

---

## 6. ì„œë²„ ì‚¬ì´ë“œ êµ¬í˜„

### 6.1 íŒŒì¼ êµ¬ì¡°

```
app/api/
â”œâ”€â”€ track/
â”‚   â””â”€â”€ route.ts                    # íŠ¸ë˜í‚¹ API
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â””â”€â”€ route.ts               # ëŒ€ì‹œë³´ë“œ ë°ì´í„° API
â”‚   â””â”€â”€ heatmap/
â”‚       â””â”€â”€ [pagePath]/
â”‚           â””â”€â”€ route.ts           # íˆíŠ¸ë§µ ë°ì´í„° API
â””â”€â”€ ai/
    â””â”€â”€ analytics-report/
        â””â”€â”€ route.ts               # AI ë³´ê³ ì„œ ìƒì„± API
lib/
â”œâ”€â”€ queries/
â”‚   â””â”€â”€ analytics.ts               # ì§‘ê³„ ì¿¼ë¦¬ í•¨ìˆ˜
â””â”€â”€ utils/
    â”œâ”€â”€ tracking.ts                # ì„œë²„ ì‚¬ì´ë“œ íŒŒì‹± ìœ í‹¸ë¦¬í‹°
    â””â”€â”€ reportFormatter.ts         # AI ë³´ê³ ì„œ í¬ë§·íŒ…
```

### 6.2 POST /api/track

**ì—­í• **: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡ëœ íŠ¸ë˜í‚¹ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥

**ìš”ì²­ ìŠ¤í‚¤ë§ˆ**:

```typescript
{
  session_key: string;
  page_view?: {
    id: string;  // UUID
    page_path: string;
    locale?: 'ko' | 'en' | null;
    referrer?: string | null;
    utm?: {
      source?: string | null;
      medium?: string | null;
      campaign?: string | null;
      term?: string | null;
      content?: string | null;
    } | null;
  };
  post_id?: string | null;
  about_id?: string | null;
  events?: Array<{
    id: string;  // UUID
    name: string;
    page_view_id?: string | null;
    page_path: string;
    props?: Record<string, any>;
    client_ts?: number | null;
  }>;
}
```

**ì²˜ë¦¬ íë¦„**:

1. Bot í•„í„°ë§ (User-Agent ê¸°ë°˜)
2. ì„¸ì…˜ Upsert (ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ `last_seen_at` ì—…ë°ì´íŠ¸, throttle: 3ë¶„)
3. í˜ì´ì§€ë·° Insert (í´ë¼ì´ì–¸íŠ¸ ìƒì„± ID ì‚¬ìš©)
4. ì´ë²¤íŠ¸ Bulk Insert
5. ì‘ë‹µ: 204 No Content (ì—ëŸ¬ ì‹œì—ë„ 204)

### 6.3 GET /api/admin/dashboard

**ì—­í• **: ëŒ€ì‹œë³´ë“œìš© ì§‘ê³„ ë°ì´í„° ì œê³µ

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**:

```typescript
{
  startDate?: string;  // YYYY-MM-DD
  endDate?: string;    // YYYY-MM-DD
  days?: number;        // ê¸°ë³¸ê°’: 7
}
```

**ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**:

```typescript
{
  stats: {
    totalPosts: number;
    publishedPosts: number;
    draftPosts: number;
    totalViews: number;
    todayPageviews: number;
    todayUniques: number;
    last7Days: { pageviews: number; uniques: number };
    last30Days: { pageviews: number; uniques: number };
  };
  topPages: Array<{
    page_path: string;
    pageviews: number;
    uniques: number;
  }>;
  topPosts: Array<{
    post_id: string;
    title: string;
    locale: string;
    pageviews: number;
    uniques: number;
  }>;
  topReferrers: Array<{
    referrer_host: string | null;
    sessions: number;
  }>;
  dailyStats: Array<{
    day: string;  // YYYY-MM-DD
    pageviews: number;
    uniques: number;
  }>;
  heatmapData: {
    topClickedElements: Array<{
      element_id: string | null;
      page_path: string;
      clicks: number;
    }>;
    pageClickStats: Array<{
      page_path: string;
      clicks: number;
      unique_elements: number;
    }>;
  };
  webVitalsData: {
    metrics: Array<{
      name: string;
      p50: number;
      p75: number;
      p95: number;
      count: number;
      good: number;
      needsImprovement: number;
      poor: number;
    }>;
  };
}
```

### 6.4 GET /api/admin/heatmap/[pagePath]

**ì—­í• **: íˆíŠ¸ë§µ ê·¸ë¦¬ë“œ ë°ì´í„° ì œê³µ

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**:

```typescript
{
  days?: number;      // ê¸°ë³¸ê°’: 30
  grid?: number;      // ê¸°ë³¸ê°’: 200 (50-400 ë²”ìœ„)
  device?: 'all' | 'mobile' | 'desktop';  // ê¸°ë³¸ê°’: 'all'
}
```

**ì‘ë‹µ ìŠ¤í‚¤ë§ˆ**:

```typescript
{
  grid: Record<string, number>;  // "x,y": count
  stats: {
    gridSize: number;
    totalClicks: number;
    coordMode: string;  // "page_x/page_y" or "x/y"
    filteredBy?: {
      device: string;
    };
    samplingWarning?: string | null;
  };
}
```

**ì§‘ê³„ ë¡œì§**:

```typescript
// ì¢Œí‘œ ìš°ì„ ìˆœìœ„: page_x/page_y > x/y
const x = props.page_x ?? props.x;
const y = props.page_y ?? props.y;

// ê·¸ë¦¬ë“œ ì¢Œí‘œ ê³„ì‚°
const gridX = Math.floor(x / gridSize) * gridSize;
const gridY = Math.floor(y / gridSize) * gridSize;
const key = `${gridX},${gridY}`;

// ì§‘ê³„
grid[key] = (grid[key] || 0) + 1;
```

### 6.5 POST /api/ai/analytics-report

**ì—­í• **: AI ê¸°ë°˜ ë¶„ì„ ë³´ê³ ì„œ ìƒì„±

**ìš”ì²­ ìŠ¤í‚¤ë§ˆ**:

```typescript
{
  startDate: string;  // YYYY-MM-DD
  endDate: string;    // YYYY-MM-DD
  days: number;
  reportType: 'daily' | 'weekly' | 'monthly' | 'custom';
  includeComparison?: boolean;
}
```

**ì²˜ë¦¬ íë¦„**:

1. ì…ë ¥ ë°ì´í„° í•´ì‹œ ê³„ì‚° (ìºì‹±ìš©)
2. ê¸°ì¡´ ë³´ê³ ì„œ ì¡°íšŒ (ê°™ì€ í•´ì‹œê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
3. ë°ì´í„° ìˆ˜ì§‘ (ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬ í•¨ìˆ˜ ì‚¬ìš©)
4. AI í”„ë¡¬í”„íŠ¸ ìƒì„± (`reportFormatter.ts`)
5. Google Gemini API í˜¸ì¶œ
6. ë³´ê³ ì„œ ì €ì¥ ë° ë°˜í™˜

**AI í”„ë¡¬í”„íŠ¸ êµ¬ì¡°**:

```typescript
const prompt = `
ë‹¹ì‹ ì€ ì›¹ì‚¬ì´íŠ¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ë°ì´í„°
${JSON.stringify(formattedData, null, 2)}

## ìš”êµ¬ì‚¬í•­
1. ìš”ì•½: ì „ì²´ì ì¸ íŠ¸ë˜í”½ ìƒí™© ìš”ì•½
2. ì£¼ìš” ë°œê²¬ì‚¬í•­: ê¸ì •ì /ë¶€ì •ì /ì£¼ì˜ ì¸ì‚¬ì´íŠ¸
3. ì„±ëŠ¥ ë¶„ì„: Web Vitals ê¸°ë°˜ ì„±ëŠ¥ í‰ê°€
4. íŠ¸ë Œë“œ ë¶„ì„: íŠ¸ë˜í”½, ì½˜í…ì¸ , ìœ ì… íŠ¸ë Œë“œ
5. ê¶Œì¥ì‚¬í•­: êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ

JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”.
`;
```

---

## 7. ëŒ€ì‹œë³´ë“œ êµ¬í˜„

### 7.1 íŒŒì¼ êµ¬ì¡°

```
app/admin/dashboard/
â””â”€â”€ page.tsx  # ëŒ€ì‹œë³´ë“œ UI
```

### 7.2 ì£¼ìš” ê¸°ëŠ¥

- ì‹¤ì‹œê°„ í†µê³„ ì¹´ë“œ
- ì¼ë³„ íŠ¸ë˜í”½ ì¶”ì´ ê·¸ë˜í”„ (Line Chart)
- Top í˜ì´ì§€/í¬ìŠ¤íŠ¸ í…Œì´ë¸”
- íˆíŠ¸ë§µ ë§í¬
- AI ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼

### 7.3 UI ì»´í¬ë„ŒíŠ¸

```typescript
export default function AdminDashboard() {
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [dailyStats, setDailyStats] = useState<DailyStat[]>([]);
  
  useEffect(() => {
    const fetchData = async () => {
      const response = await fetch('/api/admin/dashboard');
      const data = await response.json();
      setStats(data.stats);
      setDailyStats(data.dailyStats);
    };
    fetchData();
  }, []);
  
  return (
    <div>
      {/* í†µê³„ ì¹´ë“œ */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard label="ì˜¤ëŠ˜ í˜ì´ì§€ë·°" value={stats?.todayPageviews} />
        <StatCard label="ì˜¤ëŠ˜ ë°©ë¬¸ì" value={stats?.todayUniques} />
        {/* ... */}
      </div>
      
      {/* ì¼ë³„ íŠ¸ë˜í”½ ì¶”ì´ */}
      <ResponsiveContainer width="100%" height={300}>
        <LineChart data={dailyStats}>
          {/* ... */}
        </LineChart>
      </ResponsiveContainer>
      
      {/* AI ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼ */}
      <button onClick={generateReport}>
        AI ë¶„ì„ ë³´ê³ ì„œ ìƒì„±
      </button>
    </div>
  );
}
```

---

## 8. íˆíŠ¸ë§µ ê¸°ëŠ¥

### 8.1 íˆíŠ¸ë§µ v2 ëª…ì„¸

#### ì£¼ìš” ê°œì„ ì‚¬í•­

1. **ê³ í•´ìƒë„ ì§‘ê³„**: ê·¸ë¦¬ë“œ í¬ê¸° 20px â†’ 200px (ê¸°ë³¸ê°’)
2. **ì •í™•í•œ ì¢Œí‘œ ì¶”ì **: `page_x/page_y` ìš°ì„  ì‚¬ìš©
3. **ë””ë°”ì´ìŠ¤ í•„í„°**: ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ë¶„ë¦¬ ë¶„ì„
4. **Blob ë Œë”ë§**: Beusableê¸‰ ì‹œê°í™”
5. **ë·°í¬íŠ¸ ê³ ì •**: ìŠ¤í¬ë¡¤ ì‹œ ì¦‰ì‹œ ë”°ë¼ë¶™ìŒ

#### ì¢Œí‘œ ì‹œìŠ¤í…œ

```typescript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ˜ì§‘
props: {
  page_x: number,      // ë¬¸ì„œ ê¸°ì¤€ X ì¢Œí‘œ (ìš°ì„ )
  page_y: number,     // ë¬¸ì„œ ê¸°ì¤€ Y ì¢Œí‘œ (ìš°ì„ )
  x: number,          // ì •ê·œí™” ì¢Œí‘œ (0~1, í•˜ìœ„ í˜¸í™˜)
  y: number,          // ì •ê·œí™” ì¢Œí‘œ (0~1, í•˜ìœ„ í˜¸í™˜)
  viewport_w: number,
  viewport_h: number,
  doc_w: number,
  doc_h: number,
  scroll_x: number,
  scroll_y: number,
  device_bucket: 'mobile' | 'desktop',
}

// ì„œë²„ì—ì„œ ì§‘ê³„
const x = props.page_x ?? (props.x * doc_w);
const y = props.page_y ?? (props.y * doc_h);
const gridX = Math.floor(x / gridSize) * gridSize;
const gridY = Math.floor(y / gridSize) * gridSize;
```

#### Blob ë Œë”ë§ ì•Œê³ ë¦¬ì¦˜

1. **ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤**: ë¸”ëŸ¬ ëˆ„ì ìš©
2. **ìŠ¤íƒ¬í”„ ìº”ë²„ìŠ¤**: ì›í˜• ê·¸ë¼ë””ì–¸íŠ¸ ìƒì„±
3. **Screen í•©ì„±**: `globalCompositeOperation = 'screen'`
4. **ë¸”ëŸ¬ ì ìš©**: `ctx.filter = 'blur(Xpx)'`
5. **ìƒ‰ìƒ ë§¤í•‘**: ì•ŒíŒŒ ê°’ â†’ ìƒ‰ìƒ íŒ”ë ˆíŠ¸

### 8.2 ì‚¬ìš©ë²•

```typescript
// í˜ì´ì§€ì— íˆíŠ¸ë§µ ë·°ì–´ ì¶”ê°€
import HeatmapViewer from '@/components/admin/HeatmapViewer';

export default function Page() {
  return (
    <>
      {/* í˜ì´ì§€ ì½˜í…ì¸  */}
      
      {/* íˆíŠ¸ë§µ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ í™œì„±í™”) */}
      <HeatmapViewer pagePath="/ko/blog/post-1" />
    </>
  );
}

// URL: /ko/blog/post-1?heatmap=true
```

---

## 9. AI ë¶„ì„ ë³´ê³ ì„œ ê¸°ëŠ¥

### 9.1 ë³´ê³ ì„œ êµ¬ì¡°

```typescript
interface AIReport {
  reportId: string;
  reportType: 'daily' | 'weekly' | 'monthly' | 'custom';
  period: {
    startDate: string;
    endDate: string;
    days: number;
  };
  summary: {
    overview: string;
    keyMetrics: {
      totalPageviews: number;
      totalUniques: number;
      avgDailyPageviews: number;
    };
  };
  insights: Array<{
    type: 'positive' | 'warning' | 'negative' | 'info';
    title: string;
    description: string;
    priority: 'high' | 'medium' | 'low';
    evidence: {
      metric: string;
      current?: number;
      changePct?: number;
    };
    confidence: 'high' | 'medium' | 'low';
  }>;
  trends: {
    trafficTrendDescription: string;
    topContentTrend: string;
    referrerTrend: string;
  };
  performance: {
    webVitals: {
      overall: 'good' | 'needs-improvement' | 'poor';
      summary: string;
      metrics: Array<{
        name: string;
        status: 'good' | 'needs-improvement' | 'poor';
        value: number;
        recommendation: string;
      }>;
    };
    engagement?: {
      avgScrollDepthPct: number;
      avgViewDurationSec: number;
    };
  };
  recommendations: Array<{
    title: string;
    description: string;
    category: string;
    actionItems?: string[];
  }>;
  comparison?: {
    previousPeriod: {
      startDate: string;
      endDate: string;
    };
    changes: {
      pageviews: {
        current: number;
        previous: number;
        change: number;
        trend: 'up' | 'down' | 'stable';
      };
      uniques: {
        current: number;
        previous: number;
        change: number;
        trend: 'up' | 'down' | 'stable';
      };
    };
  };
}
```

### 9.2 ì‹œê°í™”

#### Line Chart (ì¼ë³„ íŠ¸ë˜í”½ ì¶”ì´)

```typescript
<ResponsiveContainer width="100%" height={300}>
  <LineChart data={dailyStats}>
    <Line dataKey="pageviews" stroke="#06b6d4" name="í˜ì´ì§€ë·°" />
    <Line dataKey="uniques" stroke="#8b5cf6" name="ë°©ë¬¸ì" />
  </LineChart>
</ResponsiveContainer>
```

#### Bar Chart (ì´ì „ ê¸°ê°„ ë¹„êµ)

```typescript
<ResponsiveContainer width="100%" height={250}>
  <BarChart data={comparisonData}>
    <Bar dataKey="í˜„ì¬" fill="#06b6d4" />
    <Bar dataKey="ì´ì „" fill="#94a3b8" />
  </BarChart>
</ResponsiveContainer>
```

#### Radar Chart (Web Vitals)

```typescript
<ResponsiveContainer width="100%" height={300}>
  <RadarChart data={webVitalsMetrics}>
    <Radar dataKey="value" stroke="#06b6d4" fill="#06b6d4" fillOpacity={0.6} />
  </RadarChart>
</ResponsiveContainer>
```

### 9.3 ë””ìì¸ ì‹œìŠ¤í…œ

ìì„¸í•œ ë‚´ìš©ì€ `docs/AI_ë¶„ì„_ë³´ê³ ì„œ_ë””ìì¸_ëª…ì„¸ì„œ.md` ì°¸ì¡°.

**ì£¼ìš” ìƒ‰ìƒ**:
- Primary: `#06b6d4` (cyan-500)
- Secondary: `#8b5cf6` (violet-500)
- Success: `#10b981` (green-500)
- Warning: `#f59e0b` (amber-500)
- Error: `#ef4444` (red-500)

---

## 10. ë””ìì¸ ì‹œìŠ¤í…œ

### 10.1 ìƒ‰ìƒ íŒ”ë ˆíŠ¸

```typescript
const colors = {
  primary: '#06b6d4',      // cyan-500
  secondary: '#8b5cf6',    // violet-500
  success: '#10b981',      // green-500
  warning: '#f59e0b',      // amber-500
  error: '#ef4444',        // red-500
  slate: {
    50: '#f8fafc',
    100: '#f1f5f9',
    200: '#e2e8f0',
    300: '#cbd5e1',
    400: '#94a3b8',
    500: '#64748b',
    600: '#475569',
    700: '#334155',
    800: '#1e293b',
    900: '#0f172a',
  },
};
```

### 10.2 íƒ€ì´í¬ê·¸ë˜í”¼

```typescript
// ì œëª© ê³„ì¸µ
text-xl font-bold text-slate-900    // ëª¨ë‹¬ ì œëª©
text-lg font-bold text-slate-900    // ì„¹ì…˜ ì œëª©
text-md font-semibold text-slate-900 // í•˜ìœ„ ì„¹ì…˜ ì œëª©

// ë³¸ë¬¸
text-slate-700                       // ë³¸ë¬¸ í…ìŠ¤íŠ¸
text-sm text-slate-700              // ì‘ì€ ë³¸ë¬¸
text-xs text-slate-600              // ë³´ì¡° í…ìŠ¤íŠ¸
```

### 10.3 ì¹´ë“œ ì»´í¬ë„ŒíŠ¸

```typescript
// ë©”íŠ¸ë¦­ ì¹´ë“œ
<div className="p-4 bg-slate-50 rounded-lg">
  <div className="text-sm text-slate-600 mb-1">ë¼ë²¨</div>
  <div className="text-2xl font-bold text-slate-900">
    {value.toLocaleString()}
  </div>
</div>

// ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ
<div className={`p-4 rounded-lg border ${
  type === 'positive' ? 'bg-green-50 border-green-200' :
  type === 'warning' ? 'bg-yellow-50 border-yellow-200' :
  type === 'negative' ? 'bg-red-50 border-red-200' :
  'bg-blue-50 border-blue-200'
}`}>
  {/* ... */}
</div>
```

---

## 11. ë‹¨ê³„ë³„ ì´ì‹ ê°€ì´ë“œ

### 11.1 Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

1. **ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±**

```sql
-- supabase/migrations/YYYYMMDD_create_{{prefix}}_tracking_tables.sql
-- ìœ„ì˜ ìŠ¤í‚¤ë§ˆ ì°¸ì¡°
```

2. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**

```bash
npx supabase migration up
```

3. **RLS ì •ì±… í™•ì¸**

```sql
-- ëª¨ë“  í…Œì´ë¸”ì— authenticated ì‚¬ìš©ìë§Œ ì¡°íšŒ ê°€ëŠ¥í•œì§€ í™•ì¸
```

### 11.2 Phase 2: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

1. **`.env.local` íŒŒì¼ ìƒì„±**

```bash
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
ANALYTICS_PREFIX=yourprefix
```

2. **ì„¤ì • íŒŒì¼ ë³µì‚¬**

```bash
cp lib/config/analytics.ts your-project/lib/config/
```

### 11.3 Phase 3: í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ êµ¬í˜„

1. **Tracker ì»´í¬ë„ŒíŠ¸ ì¶”ê°€**

```typescript
// app/layout.tsx ë˜ëŠ” ì–¸ì–´ë³„ layout.tsx
import Tracker from '@/components/analytics/Tracker';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Tracker />
      </body>
    </html>
  );
}
```

2. **ì´ë²¤íŠ¸ íŠ¸ë˜ì»¤ ì„¤ì •**

```typescript
// í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
useEffect(() => {
  const handleClick = (e: MouseEvent) => {
    trackClick(e, (e.target as HTMLElement).getAttribute('data-analytics-id') || undefined);
  };
  
  document.addEventListener('click', handleClick);
  return () => document.removeEventListener('click', handleClick);
}, []);
```

### 11.4 Phase 4: ì„œë²„ ì‚¬ì´ë“œ êµ¬í˜„

1. **API ë¼ìš°íŠ¸ ìƒì„±**

```bash
mkdir -p app/api/track
mkdir -p app/api/admin/dashboard
mkdir -p app/api/admin/heatmap/[pagePath]
mkdir -p app/api/ai/analytics-report
```

2. **ì¿¼ë¦¬ í•¨ìˆ˜ ë³µì‚¬**

```bash
cp lib/queries/analytics.ts your-project/lib/queries/
cp lib/utils/tracking.ts your-project/lib/utils/
cp lib/utils/reportFormatter.ts your-project/lib/utils/
```

### 11.5 Phase 5: ëŒ€ì‹œë³´ë“œ êµ¬í˜„

1. **ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ìƒì„±**

```bash
mkdir -p app/admin/dashboard
cp app/admin/dashboard/page.tsx your-project/app/admin/dashboard/
```

2. **ì˜ì¡´ì„± ì„¤ì¹˜**

```bash
npm install recharts
```

### 11.6 Phase 6: íˆíŠ¸ë§µ êµ¬í˜„

1. **íˆíŠ¸ë§µ ì»´í¬ë„ŒíŠ¸ ë³µì‚¬**

```bash
cp components/admin/HeatmapViewer.tsx your-project/components/admin/
cp components/admin/HeatmapOverlay.tsx your-project/components/admin/
```

2. **í˜ì´ì§€ì— ì¶”ê°€**

```typescript
import HeatmapViewer from '@/components/admin/HeatmapViewer';

export default function Page() {
  return (
    <>
      {/* í˜ì´ì§€ ì½˜í…ì¸  */}
      <HeatmapViewer pagePath={pathname} />
    </>
  );
}
```

### 11.7 Phase 7: AI ë³´ê³ ì„œ êµ¬í˜„

1. **AI API ì„¤ì •**

```bash
npm install @ai-sdk/google ai zod
```

2. **í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€**

```bash
GOOGLE_API_KEY=your-api-key
```

3. **ë³´ê³ ì„œ ìƒì„± API ë³µì‚¬**

```bash
cp app/api/ai/analytics-report/route.ts your-project/app/api/ai/analytics-report/
```

### 11.8 Phase 8: í…ŒìŠ¤íŠ¸

1. **íŠ¸ë˜í‚¹ í…ŒìŠ¤íŠ¸**

```bash
# ê°œë°œ ì„œë²„ ì‹¤í–‰
npm run dev

# í˜ì´ì§€ ë°©ë¬¸ í›„ ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
```

2. **ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸**

```bash
# /admin/dashboard ì ‘ì†
# ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
```

3. **íˆíŠ¸ë§µ í…ŒìŠ¤íŠ¸**

```bash
# í˜ì´ì§€ URLì— ?heatmap=true ì¶”ê°€
# íˆíŠ¸ë§µì´ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
```

4. **AI ë³´ê³ ì„œ í…ŒìŠ¤íŠ¸**

```bash
# ëŒ€ì‹œë³´ë“œì—ì„œ "AI ë¶„ì„ ë³´ê³ ì„œ ìƒì„±" í´ë¦­
# ë³´ê³ ì„œê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸
```

---

## 12. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 12.1 ì¼ë°˜ì ì¸ ë¬¸ì œ

#### ë¬¸ì œ: íŠ¸ë˜í‚¹ ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- `SUPABASE_SERVICE_ROLE_KEY` ë¯¸ì„¤ì •
- Bot í•„í„°ë§ìœ¼ë¡œ ì°¨ë‹¨ë¨
- RLS ì •ì±… ë¬¸ì œ

**í•´ê²°**:
1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸
2. User-Agent í™•ì¸
3. RLS ì •ì±… í™•ì¸ (InsertëŠ” service roleë¡œ ìš°íšŒ)

#### ë¬¸ì œ: íˆíŠ¸ë§µì´ í‘œì‹œë˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- ì¸ì¦ í† í° ì—†ìŒ
- ì¢Œí‘œ ë°ì´í„° ì—†ìŒ
- Canvas ë Œë”ë§ ì˜¤ë¥˜

**í•´ê²°**:
1. ê´€ë¦¬ì ë¡œê·¸ì¸ í™•ì¸
2. í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì§‘ í™•ì¸
3. ë¸Œë¼ìš°ì € ì½˜ì†” ì˜¤ë¥˜ í™•ì¸

#### ë¬¸ì œ: AI ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨

**ì›ì¸**:
- Google API í‚¤ ë¯¸ì„¤ì •
- ë°ì´í„° ë¶€ì¡±
- í”„ë¡¬í”„íŠ¸ ì˜¤ë¥˜

**í•´ê²°**:
1. `GOOGLE_API_KEY` í™•ì¸
2. ë°ì´í„° ìˆ˜ì§‘ ê¸°ê°„ í™•ì¸
3. API ì‘ë‹µ ë¡œê·¸ í™•ì¸

### 12.2 ì„±ëŠ¥ ìµœì í™”

#### ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬

```typescript
// ìƒ˜í”Œë§ ì ìš©
ANALYTICS_SAMPLE_RATE_EVENTS=0.1  // 10%ë§Œ ìˆ˜ì§‘
ANALYTICS_SAMPLE_RATE_HEATMAP=0.5  // íˆíŠ¸ë§µ 50%ë§Œ ìˆ˜ì§‘
```

#### ì¿¼ë¦¬ ìµœì í™”

```sql
-- ì¸ë±ìŠ¤ í™•ì¸
EXPLAIN ANALYZE SELECT * FROM {{prefix}}_events 
WHERE name = 'click' AND created_at > NOW() - INTERVAL '30 days';

-- í•„ìš”ì‹œ ì¶”ê°€ ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX IF NOT EXISTS {{prefix}}_idx_events_name_created_at 
ON {{prefix}}_events (name, created_at DESC);
```

### 12.3 ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **RLS ì •ì±…**: ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”
2. **ì„œë¹„ìŠ¤ ë¡¤ í‚¤**: í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œ ê¸ˆì§€
3. **Bot í•„í„°ë§**: User-Agent ê¸°ë°˜ ë´‡ ì°¨ë‹¨
4. **Rate Limiting**: API ì—”ë“œí¬ì¸íŠ¸ì— rate limit ì ìš© (ì„ íƒ)

---

## 13. ì°¸ê³  ìë£Œ

- [í†µê³„ ì‹œìŠ¤í…œ ì´ì‹ ëª…ì„¸ì„œ](./í†µê³„ì‹œìŠ¤í…œ_ì´ì‹_ëª…ì„¸ì„œ.md)
- [AI ë¶„ì„ ë³´ê³ ì„œ ë””ìì¸ ëª…ì„¸ì„œ](./AI_ë¶„ì„_ë³´ê³ ì„œ_ë””ìì¸_ëª…ì„¸ì„œ.md)
- [íˆíŠ¸ë§µ v2 ëª…ì„¸ì„œ](./íˆíŠ¸ë§µê²€í† .md)
- [Recharts ê³µì‹ ë¬¸ì„œ](https://recharts.org/)
- [Supabase ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs)

---

**ë¬¸ì„œ ë²„ì „**: 1.0  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-01-25  
**ì‘ì„±ì**: AI Assistant

---

**ì´ ëª…ì„¸ì„œëŠ” í†µê³„ ê¸°ëŠ¥, íˆíŠ¸ë§µ, AI ë¶„ì„ ë³´ê³ ì„œë¥¼ í¬í•¨í•œ ì „ì²´ ì‹œìŠ¤í…œì˜ ì´ì‹ì„ ìœ„í•œ ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ ë”°ë¼í•˜ë©´ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œë„ ë™ì¼í•œ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
