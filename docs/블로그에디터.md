# ë¸”ë¡œê·¸ ì—ë””í„° í”Œëœ ê²€í†  ë° ê°œì„ ì•ˆ

## ğŸ“Š í˜„ì¬ ì§„í–‰ ìƒí™© (2025-01-02 ì—…ë°ì´íŠ¸)

### âœ… ì™„ë£Œëœ ì‘ì—…
- **Phase 1-2**: Novel.sh ì—ë””í„° í†µí•©, ê¸°ë³¸ CRUD ê¸°ëŠ¥ ì™„ë£Œ
  - í¬ìŠ¤íŠ¸ ìƒì„±/ì¡°íšŒ/ìˆ˜ì •/ì‚­ì œ
  - ê´€ë¦¬ì í˜ì´ì§€ (ëª©ë¡, ì‘ì„±, ìˆ˜ì •)
  - ì¸ì¦ ì‹œìŠ¤í…œ (Supabase Auth)
  - ë‹¤êµ­ì–´ ì§€ì› (ko/en)
  - ì´ˆì•ˆ/ë°œí–‰ ìƒíƒœ ê´€ë¦¬
- **Phase 3 ì¼ë¶€**: AI Slug ìƒì„± (`/api/ai/slug`) ì™„ë£Œ
  - Gemini 2.0 Flash ëª¨ë¸ ì‚¬ìš©
  - ì˜ë¯¸ ê¸°ë°˜ ì˜ë¬¸ slug ìë™ ìƒì„±
- **ëŒ“ê¸€ ì‹œìŠ¤í…œ**: ì™„ë£Œ
  - `uslab_comments` í…Œì´ë¸” ìƒì„±
  - ëŒ“ê¸€ API ë° UI ì»´í¬ë„ŒíŠ¸

### â³ ì§„í–‰ ì¤‘ì¸ ì‘ì—…
- **Phase 3**: AI ê¸°ëŠ¥ êµ¬í˜„ ì¤‘
  - `/api/ai/generate` (AI ì´ì–´ì“°ê¸°) - ë¯¸êµ¬í˜„
  - `/api/ai/refine` (AI êµì •) - ë¯¸êµ¬í˜„
  - `/api/ai/seo` (SEO ìë™ ìƒì„±) - ë¯¸êµ¬í˜„
  - AI Copilot UI - ë¯¸êµ¬í˜„

### âš ï¸ ë³´ì™„ í•„ìš” ì‚¬í•­ (ìš´ì˜ ì•ˆì •ì„±)
1. **RLS ì •ì±… ë³´ì™„**: authenticated ì‚¬ìš©ìê°€ draft ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡
2. **ê´€ë¦¬ì ê¶Œí•œ ëª¨ë¸ ê°•í™”**: authenticated != admin ê°€ì • ì œê±°
3. **DB ì œì•½ì¡°ê±´**: published_at/is_published ì¼ê´€ì„± ë³´ì¥
4. **ìš´ì˜ ê·œì¹™ ë¬¸ì„œí™”**: productContext.mdì— ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì¶”ê°€

---

## í˜„ì¬ ìƒí™©
- **Gemini API í‚¤**: `.env.local`ì— `GOOGLE_API_KEY`ë¡œ ì €ì¥ë¨
- **ëª¨ë¸**: `gemini-2.0-flash` ì‚¬ìš©
- **í”„ë¡œì íŠ¸**: Next.js 14 (App Router), Supabase, Novel.sh ì—ë””í„°
- **Supabase í”„ë¡œì íŠ¸**: ustudio í”„ë¡œì íŠ¸(`gzguucdzsrfypbkqlyku`) ë‚´ì—ì„œ `uslab_` prefix ì‚¬ìš©

---

## 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê²€í† 

### âœ… ê¶Œì¥ íŒ¨í‚¤ì§€ ëª©ë¡

```json
{
  "dependencies": {
    "ai": "^3.x.x",                    // Vercel AI SDK (ìµœì‹ , Streaming ì§€ì›)
    "@ai-sdk/google": "^0.x.x",       // Google Gemini SDK í†µí•©
    "novel": "^0.0.xxx",              // Novel.sh ì—ë””í„°
    "@tiptap/react": "^2.x.x",
    "@tiptap/starter-kit": "^2.x.x",
    "@tiptap/extension-markdown": "^2.x.x",
    "@tailwindcss/typography": "^0.5.x"
  }
}
```

### âš ï¸ ì£¼ì˜ì‚¬í•­
- **`ai`** íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš© (ê³¼ê±° `@vercel/ai`ì—ì„œ ë³€ê²½ë¨, 2025ë…„ ê¸°ì¤€)
- **`@ai-sdk/google`** íŒ¨í‚¤ì§€ë¡œ Geminië¥¼ Vercel AI SDKì™€ í¸í•˜ê²Œ ì—°ë™
- Vercel AI SDKëŠ” Streaming ì‘ë‹µì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬

---

## 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

### `.env.local` êµ¬ì¡°

```env
# Supabase (ê¸°ì¡´)
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Google Gemini API (ì¶”ê°€)
GOOGLE_API_KEY=your_gemini_api_key
```

**âš ï¸ ì¤‘ìš”**: `@ai-sdk/google`ëŠ” ìë™ìœ¼ë¡œ `GOOGLE_API_KEY` í™˜ê²½ ë³€ìˆ˜ë¥¼ ì½ì–´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

### âœ… í™•ì¸ ì‚¬í•­
- `GOOGLE_API_KEY`ê°€ ì´ë¯¸ `.env.local`ì— ì„¤ì •ë˜ì–´ ìˆìŒ
- ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‚¬ìš© (í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë˜ì§€ ì•ŠìŒ)

---

## 3. ë³´ì•ˆ ë° ê¶Œí•œ ëª¨ë¸ (âš ï¸ ì¤‘ìš”: ìš´ì˜ ì•ˆì •ì„±)

### 3-1. RLS ì •ì±… ë³´ì™„ (í•„ìˆ˜)

**í˜„ì¬ ë¬¸ì œ**: 
- `uslab_policy_posts_select_public` ì •ì±…ì´ `is_published = true`ë§Œ í—ˆìš©
- ì´ë¡œ ì¸í•´ authenticated ì‚¬ìš©ìë„ draftë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŒ
- Admin ëª©ë¡/í¸ì§‘ í˜ì´ì§€ì—ì„œ draft ë¡œë“œ ì‹¤íŒ¨ ê°€ëŠ¥ì„±

**í•´ê²° ë°©ë²•**: authenticated ì „ìš© SELECT ì •ì±… ì¶”ê°€

```sql
-- ê¸°ì¡´ ì •ì±…: ê³µê°œ ì½ê¸° (ë°œí–‰ëœ í¬ìŠ¤íŠ¸ë§Œ)
create policy uslab_policy_posts_select_public
  on uslab_posts
  for select
  using (is_published = true);

-- ì¶”ê°€ í•„ìš”: ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ëª¨ë“  í¬ìŠ¤íŠ¸ ì¡°íšŒ ê°€ëŠ¥ (draft í¬í•¨)
create policy uslab_policy_posts_select_authenticated
  on uslab_posts
  for select
  using (auth.role() = 'authenticated');
```

**ë˜ëŠ” í•œ ì •ì±…ìœ¼ë¡œ í†µí•©**:
```sql
-- ê¸°ì¡´ ì •ì±… ìˆ˜ì •
drop policy uslab_policy_posts_select_public on uslab_posts;

create policy uslab_policy_posts_select_public
  on uslab_posts
  for select
  using (is_published = true OR auth.role() = 'authenticated');
```

### 3-2. ê´€ë¦¬ì ê¶Œí•œ ëª¨ë¸ ê°•í™” (ê¶Œì¥)

**í˜„ì¬ ë¬¸ì œ**: 
- "authenticated = ê´€ë¦¬ì" ê°€ì •
- íšŒì›ê°€ì…ì´ ì—´ë ¤ìˆìœ¼ë©´ ëˆ„êµ¬ë‚˜ CRUD ê°€ëŠ¥

**í•´ê²° ë°©ë²• (ì„ íƒì§€)**:

**ì˜µì…˜ A: íšŒì›ê°€ì… ë¹„í™œì„±í™”/ì´ˆëŒ€ë§Œ í—ˆìš©** (ê°€ì¥ ê°„ë‹¨)
- Supabase Dashboard â†’ Authentication â†’ Settings
- "Enable email signup" ë¹„í™œì„±í™”
- ì´ˆëŒ€(invite)ë§Œ í—ˆìš©

**ì˜µì…˜ B: uslab_admins í…Œì´ë¸” ìƒì„±** (í™•ì¥ì„± ì¢‹ìŒ)
```sql
create table uslab_admins (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) on delete cascade unique not null,
  created_at timestamp with time zone default now()
);

-- RLS ì •ì±… ìˆ˜ì •
create policy uslab_policy_posts_insert_admin
  on uslab_posts
  for insert
  with check (
    exists (
      select 1 from uslab_admins 
      where user_id = auth.uid()
    )
  );
```

**ì˜µì…˜ C: ì„œë²„ì—ì„œ service_roleë¡œë§Œ Admin CRUD ìˆ˜í–‰** (í˜„ì¬ ë°©ì‹ ìœ ì§€)
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ DB ì ‘ê·¼ ê¸ˆì§€
- ëª¨ë“  Admin ì‘ì—…ì€ API Route Handlerì—ì„œ service_role í‚¤ë¡œ ìˆ˜í–‰
- í˜„ì¬ êµ¬í˜„ ë°©ì‹ê³¼ ì¼ì¹˜

### 3-3. AI API ì¸ì¦ (í•„ìˆ˜)

**ëª¨ë“  AI ì—”ë“œí¬ì¸íŠ¸ëŠ” ê´€ë¦¬ì ì¸ì¦ í•„ìš”**:
- ë¹„ìš©/ë‚¨ìš© ë¦¬ìŠ¤í¬ ë°©ì§€
- API Route Handlerì—ì„œ ì¸ì¦ í™•ì¸

```typescript
// app/api/ai/*/route.ts ê³µí†µ íŒ¨í„´
export async function POST(req: Request) {
  // ì¸ì¦ í™•ì¸
  const authHeader = req.headers.get('authorization');
  if (!authHeader) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // ... AI ë¡œì§
}
```

---

## 4. AI API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

### 4-1. `/api/ai/generate` - AI ì´ì–´ì“°ê¸°

**ëª©ì **: Novel.sh ì—ë””í„°ì˜ AI ì´ì–´ì“°ê¸° ê¸°ëŠ¥

**êµ¬í˜„ ì˜ˆì‹œ**:
```typescript
// app/api/ai/generate/route.ts
import { google } from '@ai-sdk/google';
import { streamText } from 'ai';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export async function POST(req: Request) {
  // ì¸ì¦ í™•ì¸ (ê´€ë¦¬ìë§Œ)
  const authHeader = req.headers.get('authorization');
  if (!authHeader) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const token = authHeader.replace('Bearer ', '');
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  const { data: { user }, error } = await supabase.auth.getUser(token);
  
  if (error || !user) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { prompt, context } = await req.json();
  
  // Vercel AI SDKë¡œ ê°„ê²°í•˜ê²Œ êµ¬í˜„
  const result = await streamText({
    model: google('models/gemini-2.0-flash'),
    prompt: `${context}\n\nê³„ì† ì‘ì„±í•´ì£¼ì„¸ìš”: ${prompt}`,
  });
  
  // Streaming ì‘ë‹µ ìë™ ì²˜ë¦¬
  return result.toDataStreamResponse();
}
```

### 4-2. `/api/ai/refine` - ë¬¸ë‹¨ë³„ AI êµì •

**âš ï¸ ì¤‘ìš”**: AI êµì • ì ìš© ì „ ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ í•„ìš”

**ëª©ì **: ì„ íƒí•œ ë¬¸ë‹¨ì„ AIë¡œ êµì • (í†¤ì•¤ë§¤ë„ˆ, ë¬¸ë²•, ê°€ë…ì„±)

**êµ¬í˜„ ì˜ˆì‹œ**:
```typescript
// app/api/ai/refine/route.ts
import { google } from '@ai-sdk/google';
import { generateText } from 'ai';
import { createClient } from '@supabase/supabase-js';
import { z } from 'zod';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ì •ì˜ (zodë¡œ ê²€ì¦)
const refineResponseSchema = z.object({
  original: z.string(),
  suggested: z.string(),
  reason: z.string(),
  diff: z.string(),
});

export async function POST(req: Request) {
  // ì¸ì¦ í™•ì¸
  const authHeader = req.headers.get('authorization');
  if (!authHeader) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { post_id, text, tone_prompt, locale } = await req.json();
  
  // âš ï¸ ì¤‘ìš”: AI êµì • ì ìš© ì „ ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥
  if (post_id) {
    const supabase = createClient(supabaseUrl, supabaseServiceRoleKey);
    const { data: post } = await supabase
      .from('uslab_posts')
      .select('content')
      .eq('id', post_id)
      .single();
    
    if (post) {
      await supabase.from('uslab_post_versions').insert({
        post_id,
        content: post.content,
        change_log: 'AI êµì • ì „ ìŠ¤ëƒ…ìƒ·',
      });
    }
  }
  
  const prompt = `
ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ${locale === 'ko' ? 'í•œêµ­ì–´' : 'ì˜ì–´'}ë¡œ êµì •í•´ì£¼ì„¸ìš”.
${tone_prompt ? `í†¤ì•¤ë§¤ë„ˆ: ${tone_prompt}` : ''}

ì›ë³¸:
${text}

êµì •ëœ í…ìŠ¤íŠ¸ì™€ ìˆ˜ì • ì´ìœ ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:
{
  "original": "ì›ë³¸ í…ìŠ¤íŠ¸",
  "suggested": "êµì •ëœ í…ìŠ¤íŠ¸",
  "reason": "ìˆ˜ì • ì´ìœ ",
  "diff": "ë³€ê²½ ì‚¬í•­ ìš”ì•½"
}
  `;
  
  try {
    const { text: responseText } = await generateText({
      model: google('models/gemini-2.0-flash'),
      prompt,
    });
    
    // JSON íŒŒì‹± ë° ê²€ì¦
    const parsed = JSON.parse(responseText);
    const validated = refineResponseSchema.parse(parsed);
    
    return Response.json(validated);
  } catch (error) {
    // íŒŒì‹± ì‹¤íŒ¨ ì‹œ fallback
    console.error('AI refine error:', error);
    return Response.json({
      original: text,
      suggested: text, // ì›ë³¸ ê·¸ëŒ€ë¡œ ë°˜í™˜
      reason: 'AI êµì • ì‹¤íŒ¨: ì›ë³¸ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.',
      diff: '',
    });
  }
}
```

### 4-3. `/api/ai/seo` - SEO ë©”íƒ€ë°ì´í„° ìë™ ìƒì„±

**âš ï¸ ì¤‘ìš”**: ì‘ë‹µ í¬ë§·ì„ zod ìŠ¤í‚¤ë§ˆë¡œ ê°•ì œí•˜ì—¬ íŒŒì‹± ì‹¤íŒ¨ ì‹œ fallback ì „ëµ í•„ìš”

**ëª©ì **: ë°œí–‰ ì‹œ SEO ì œëª©, ì„¤ëª…, í‚¤ì›Œë“œ ìë™ ìƒì„±

**êµ¬í˜„ ì˜ˆì‹œ**:
```typescript
// app/api/ai/seo/route.ts
import { google } from '@ai-sdk/google';
import { generateText } from 'ai';
import { z } from 'zod';

// ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ì •ì˜ (zodë¡œ ê²€ì¦)
const seoResponseSchema = z.object({
  seo_title: z.string().max(60),
  seo_description: z.string().max(160),
  seo_keywords: z.array(z.string()),
});

export async function POST(req: Request) {
  // ì¸ì¦ í™•ì¸
  const authHeader = req.headers.get('authorization');
  if (!authHeader) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { full_content, title, locale } = await req.json();
  
  const prompt = `
ë‹¤ìŒ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì˜ SEO ë©”íƒ€ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

ì œëª©: ${title}
ë‚´ìš©: ${full_content.substring(0, 2000)}...

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ë°˜ë“œì‹œ JSON í˜•ì‹):
{
  "seo_title": "ê²€ìƒ‰ ì—”ì§„ ìµœì í™”ëœ ì œëª© (60ì ì´ë‚´)",
  "seo_description": "ê²€ìƒ‰ ì—”ì§„ ìµœì í™”ëœ ì„¤ëª… (160ì ì´ë‚´)",
  "seo_keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"]
}

ì£¼ì˜: seo_keywordsëŠ” ë°˜ë“œì‹œ JSON ë°°ì—´(string[]) í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
  `;
  
  try {
    const { text: responseText } = await generateText({
      model: google('models/gemini-2.0-flash'),
      prompt,
    });
    
    // JSON íŒŒì‹± ë° ê²€ì¦
    const parsed = JSON.parse(responseText);
    const validated = seoResponseSchema.parse(parsed);
    
    return Response.json(validated);
  } catch (error) {
    // íŒŒì‹± ì‹¤íŒ¨ ì‹œ fallback
    console.error('AI SEO error:', error);
    return Response.json({
      seo_title: title.substring(0, 60),
      seo_description: full_content.substring(0, 160).replace(/\n/g, ' '),
      seo_keywords: [],
    });
  }
}
```

---

## 5. DB ì œì•½ì¡°ê±´ ë° ë°ì´í„° ì¼ê´€ì„±

### 5-1. published_at/is_published ì¼ê´€ì„± ë³´ì¥

**ë¬¸ì œ**: `is_published = true`ì¸ë° `published_at = NULL` ê°™ì€ ë¶ˆì¼ì¹˜ ìƒíƒœ ê°€ëŠ¥

**í•´ê²° ë°©ë²•**: ì²´í¬ ì œì•½ì¡°ê±´ ì¶”ê°€

```sql
-- ë§ˆì´ê·¸ë ˆì´ì…˜: published_at/is_published ì¼ê´€ì„± ë³´ì¥
alter table uslab_posts
  add constraint uslab_check_published_consistency
  check (
    (is_published = false AND published_at IS NULL) OR
    (is_published = true AND published_at IS NOT NULL)
  );
```

**ë˜ëŠ” íŠ¸ë¦¬ê±°ë¡œ ìë™ ì„¤ì •**:
```sql
create or replace function uslab_set_published_at()
returns trigger as $$
begin
  if new.is_published = true AND new.published_at IS NULL then
    new.published_at = now();
  elsif new.is_published = false then
    new.published_at = NULL;
  end if;
  return new;
end;
$$ language plpgsql;

create trigger uslab_trigger_set_published_at
  before insert or update on uslab_posts
  for each row
  execute function uslab_set_published_at();
```

### 5-2. canonical_id FK ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤

**í˜„ì¬ êµ¬ì¡°**: `canonical_id uuid references uslab_posts(id)`

**ë¬¸ì œ**: ì›ë¬¸(ko) ì‚­ì œ ì‹œ ë²ˆì—­(en)ì´ FKë¡œ ë¬¶ì—¬ ì‚­ì œê°€ ë§‰í ìˆ˜ ìˆìŒ

**í•´ê²° ë°©ë²•**: ON DELETE ì •ì±… ëª…ì‹œ

```sql
-- ì˜µì…˜ A: ì›ë¬¸ ì‚­ì œ ì‹œ ë²ˆì—­ë„ ê°™ì´ ì‚­ì œ (CASCADE)
alter table uslab_posts
  drop constraint if exists uslab_posts_canonical_id_fkey;

alter table uslab_posts
  add constraint uslab_posts_canonical_id_fkey
  foreign key (canonical_id)
  references uslab_posts(id)
  on delete cascade;

-- ì˜µì…˜ B: ì›ë¬¸ ì‚­ì œ ì‹œ ë²ˆì—­ì€ ë‚¨ê¸°ë˜ ê·¸ë£¹ë§Œ í•´ì œ (SET NULL)
alter table uslab_posts
  drop constraint if exists uslab_posts_canonical_id_fkey;

alter table uslab_posts
  add constraint uslab_posts_canonical_id_fkey
  foreign key (canonical_id)
  references uslab_posts(id)
  on delete set null;
```

**ê¶Œì¥**: ì˜µì…˜ B (SET NULL) - ë²ˆì—­ ê¸€ì€ ë³´ì¡´í•˜ë˜ ê·¸ë£¹ë§Œ í•´ì œ

### 5-3. ìš”ì•½(excerpt) ì „ëµ í™•ì •

**í˜„ì¬ ìƒí™©**: PostCardì—ì„œ ìš”ì•½ì„ í‘œì‹œí•˜ì§€ë§Œ DBì— excerpt ì»¬ëŸ¼ ì—†ìŒ

**ì„ íƒì§€**:

**ì˜µì…˜ A: seo_description ì¬ì‚¬ìš©** (ê°€ì¥ ê°„ë‹¨, ê¶Œì¥)
- `seo_description`ì„ PostCard ìš”ì•½ìœ¼ë¡œ ì‚¬ìš©
- ë³„ë„ ì»¬ëŸ¼ ë¶ˆí•„ìš”
- SEOì™€ ì¼ê´€ì„± ìœ ì§€

**ì˜µì…˜ B: excerpt ì»¬ëŸ¼ ì¶”ê°€**
```sql
alter table uslab_posts
  add column excerpt text;
```
- ê´€ë¦¬ìê°€ ì§ì ‘ ì‘ì„± ë˜ëŠ” AI ìë™ ìƒì„±
- seo_descriptionê³¼ ë³„ë„ ê´€ë¦¬ ê°€ëŠ¥

**ì˜µì…˜ C: ë Œë”ë§ ì‹œ ì²« ë¬¸ë‹¨ ì¶”ì¶œ**
- Tiptap JSONì—ì„œ ì²« ë¬¸ë‹¨ íŒŒì‹±
- ë³µì¡ë„ ì¦ê°€, ê·œì¹™ í•„ìš”

**ê¶Œì¥**: ì˜µì…˜ A (seo_description ì¬ì‚¬ìš©)

---

## 6. Novel.sh ì—ë””í„° í†µí•©

### 6-1. ê¸°ë³¸ ì—ë””í„° ì„¤ì •

```typescript
// app/admin/posts/write/page.tsx
import { Editor } from 'novel';
import { extensions } from '@/lib/editor/extensions';

export default function WritePage() {
  return (
    <Editor
      extensions={extensions}
      onUpdate={({ editor }) => {
        // ìë™ ì €ì¥ ë¡œì§
        const json = editor.getJSON();
        // localStorage ë˜ëŠ” debounceë¡œ ì„œë²„ ì €ì¥
      }}
    />
  );
}
```

### 6-2. AI ì´ì–´ì“°ê¸° í†µí•©

```typescript
// Novel.shì˜ AI ê¸°ëŠ¥ê³¼ Gemini ì—°ë™
import { useAI } from 'novel/react';
import { useCompletion } from 'ai/react'; // 'ai' íŒ¨í‚¤ì§€ì—ì„œ import

function AICompletion() {
  const { completion, complete } = useCompletion({
    api: '/api/ai/generate',
  });
  
  // Novel.sh ì—ë””í„°ì— completion ì‚½ì…
  return (
    <button onClick={() => complete(prompt)}>
      AIë¡œ ì´ì–´ì“°ê¸°
    </button>
  );
}
```

---

## 7. AI Copilot UI êµ¬í˜„

### 7-1. ë¬¸ë‹¨ ì„ íƒ ì‹œ AI ìˆ˜ì • ë²„íŠ¼

```typescript
// components/blog/AICopilot.tsx
'use client';

import { useState } from 'react';

export function AICopilot({ selectedText, onApply }: Props) {
  const [loading, setLoading] = useState(false);
  const [suggestion, setSuggestion] = useState(null);
  
  const handleRefine = async () => {
    setLoading(true);
    const response = await fetch('/api/ai/refine', {
      method: 'POST',
      body: JSON.stringify({ text: selectedText }),
    });
    const data = await response.json();
    setSuggestion(data);
    setLoading(false);
  };
  
  return (
    <div className="ai-copilot-panel">
      <button onClick={handleRefine}>AIë¡œ ìˆ˜ì •</button>
      {suggestion && (
        <DiffView
          original={suggestion.original}
          suggested={suggestion.suggested}
          reason={suggestion.reason}
          onAccept={() => onApply(suggestion.suggested)}
          onReject={() => setSuggestion(null)}
        />
      )}
    </div>
  );
}
```

### 7-2. Diff View ì»´í¬ë„ŒíŠ¸

```typescript
// components/blog/DiffView.tsx
export function DiffView({ original, suggested, reason, onAccept, onReject }) {
  return (
    <div className="diff-view">
      <div className="original">
        <h3>ì›ë³¸</h3>
        <p>{original}</p>
      </div>
      <div className="suggested">
        <h3>ì œì•ˆ</h3>
        <p>{suggested}</p>
      </div>
      <div className="reason">
        <p>{reason}</p>
      </div>
      <div className="actions">
        <button onClick={onAccept}>ìˆ˜ë½</button>
        <button onClick={onReject}>ê±°ì ˆ</button>
      </div>
    </div>
  );
}
```

---

## 8. ë°œí–‰ í”„ë¡œì„¸ìŠ¤ ê°œì„ 

**âš ï¸ ì¤‘ìš”**: ë°œí–‰ ì‹œ ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ ë° SEO ìë™ ìƒì„± í†µí•©

### 8-1. ë™ê¸° SEO ìƒì„± (ì´ˆê¸° ì „ëµ)

**ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ í¬í•¨**:

```typescript
// app/admin/posts/write/page.tsx
async function handlePublish() {
  // 1. ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ (ë°œí–‰ ì „)
  if (postId) {
    await fetch(`/api/posts/${postId}/versions`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({
        content: editor.getJSON(),
        change_log: 'ë°œí–‰ ì „ ìŠ¤ëƒ…ìƒ·',
      }),
    });
  }
  
  // 2. SEO ë©”íƒ€ë°ì´í„° ìƒì„± (AI)
  const seoResponse = await fetch('/api/ai/seo', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify({
      full_content: editor.getHTML(),
      title: title,
      locale: locale,
    }),
  });
  const seoData = await seoResponse.json();
  
  // 3. í¬ìŠ¤íŠ¸ ì €ì¥
  await fetch('/api/posts', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify({
      title,
      content: editor.getJSON(),
      locale,
      seo_title: seoData.seo_title,
      seo_description: seoData.seo_description,
      seo_keywords: seoData.seo_keywords,
      is_published: true,
      published_at: new Date().toISOString(),
    }),
  });
  
  // 4. ìºì‹œ ì¬ê²€ì¦
  revalidatePath(`/${locale}/blog`);
}
```

### 8-2. í–¥í›„ ë¹„ë™ê¸° ì „í™˜ (ì„ íƒì )

```typescript
// ë¹„ë™ê¸° SEO ìƒì„± (ë°±ê·¸ë¼ìš´ë“œ)
async function handlePublish() {
  // 1. í¬ìŠ¤íŠ¸ ì¦‰ì‹œ ë°œí–‰
  const post = await createPost({ ... });
  
  // 2. SEOëŠ” ë°±ê·¸ë¼ìš´ë“œë¡œ ìƒì„±
  fetch('/api/ai/seo', {
    method: 'POST',
    body: JSON.stringify({ post_id: post.id, ... }),
  }).then(async (seoData) => {
    await updatePost(post.id, { ...seoData });
  });
}
```

---

## 9. ì—ëŸ¬ ì²˜ë¦¬ ë° ìµœì í™”

### 9-1. API ì—ëŸ¬ ì²˜ë¦¬

```typescript
// lib/ai/error-handler.ts
export function handleAIError(error: Error) {
  if (error.message.includes('API_KEY')) {
    return 'Gemini API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  }
  if (error.message.includes('QUOTA')) {
    return 'API ì‚¬ìš©ëŸ‰ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.';
  }
  return 'AI ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
}
```

### 9-2. Rate Limiting

```typescript
// lib/ai/rate-limit.ts
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '1 m'), // 1ë¶„ì— 10íšŒ
});

export async function checkRateLimit(userId: string) {
  const { success } = await ratelimit.limit(userId);
  if (!success) {
    throw new Error('ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.');
  }
}
```

---

## 10. i18n ë¼ìš°íŒ… ì „ëµ

### 10-1. í˜„ì¬ êµ¬í˜„ ìƒíƒœ

**âœ… ì´ë¯¸ ì™„ë£Œ**: `/admin` ì˜ˆì™¸ ì²˜ë¦¬
- `middleware.ts`ì—ì„œ `/admin` ê²½ë¡œëŠ” ì–¸ì–´ prefix ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥
- Admin í˜ì´ì§€ëŠ” ì–¸ì–´ì™€ ë¬´ê´€í•˜ê²Œ ë™ì‘

**í˜„ì¬ êµ¬ì¡°**:
- Public ë¸”ë¡œê·¸: `/[lang]/blog`, `/[lang]/blog/[slug]`
- Admin: `/admin/*` (ì–¸ì–´ prefix ì—†ìŒ)

### 10-2. SEO ìµœì í™” (í–¥í›„ ê°œì„ )

**í˜„ì¬**: Context + localStorage ê¸°ë°˜ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ i18n
**í–¥í›„**: ì„œë²„ ì‚¬ì´ë“œ i18n ë¼ìš°íŒ… (`/ko`, `/en`) + 301 ë¦¬ë‹¤ì´ë ‰íŠ¸

**êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­**:
- `/admin` ê²½ë¡œëŠ” ë°˜ë“œì‹œ ì˜ˆì™¸ ì²˜ë¦¬ (ì´ë¯¸ ì™„ë£Œ)
- ê¸°ì¡´ URLê³¼ì˜ í˜¸í™˜ì„± ìœ ì§€
- hreflang íƒœê·¸ ì¶”ê°€ (canonical_id í™œìš©)

---

## 11. ê²€í†  í¬ì¸íŠ¸ ë° ê°œì„ ì‚¬í•­

### âœ… ì˜ ëœ ì 
1. **Gemini 2.0 Flash ì„ íƒ**: ë¹ ë¥¸ ì‘ë‹µ ì†ë„, ê¸´ ë¬¸ë§¥ ì´í•´
2. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**: `GOOGLE_API_KEY`ë¡œ ëª…í™•í•˜ê²Œ ì„¤ì •
3. **Phaseë³„ ë‹¨ê³„ì  êµ¬í˜„**: Phase 1 â†’ Phase 2 â†’ Phase 3 ìˆœì„œ
4. **ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ì „ëµ**: `uslab_` prefixë¡œ ustudio í”„ë¡œì íŠ¸ ë‚´ì—ì„œ ì™„ì „ ë¶„ë¦¬
5. **i18n middleware**: `/admin` ì˜ˆì™¸ ì²˜ë¦¬ ì™„ë£Œ

### âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­ (ìš´ì˜ ì•ˆì •ì„±)

1. **RLS ì •ì±… ë³´ì™„** (í•„ìˆ˜)
   - authenticated ì‚¬ìš©ìê°€ draft ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡ ì •ì±… ì¶”ê°€
   - í˜„ì¬: `is_published = true`ë§Œ í—ˆìš© â†’ Adminì—ì„œ draft ë¡œë“œ ì‹¤íŒ¨ ê°€ëŠ¥

2. **ê´€ë¦¬ì ê¶Œí•œ ëª¨ë¸ ê°•í™”** (ê¶Œì¥)
   - "authenticated = admin" ê°€ì • ì œê±°
   - íšŒì›ê°€ì… ë¹„í™œì„±í™” ë˜ëŠ” `uslab_admins` í…Œì´ë¸” ìƒì„±

3. **DB ì œì•½ì¡°ê±´ ì¶”ê°€** (ê¶Œì¥)
   - `published_at`/`is_published` ì¼ê´€ì„± ë³´ì¥ (ì²´í¬ ì œì•½ ë˜ëŠ” íŠ¸ë¦¬ê±°)
   - `canonical_id` FK ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤ ì •ì˜ (CASCADE vs SET NULL)

4. **AI API ë³´ì•ˆ** (í•„ìˆ˜)
   - ëª¨ë“  AI ì—”ë“œí¬ì¸íŠ¸ì— ì¸ì¦ í™•ì¸ ì¶”ê°€
   - zod ìŠ¤í‚¤ë§ˆë¡œ ì‘ë‹µ ê²€ì¦ ë° fallback ì „ëµ

5. **ë²„ì „ ìŠ¤ëƒ…ìƒ· ìë™ ì €ì¥** (ê¶Œì¥)
   - AI êµì •/SEO ì ìš© ì „ ìë™ìœ¼ë¡œ `uslab_post_versions`ì— ì €ì¥
   - ë˜ëŒë¦¬ê¸° ê¸°ëŠ¥ í™œì„±í™”

6. **ìš”ì•½(excerpt) ì „ëµ í™•ì •** (ì„ íƒ)
   - `seo_description` ì¬ì‚¬ìš© (ê¶Œì¥) vs `excerpt` ì»¬ëŸ¼ ì¶”ê°€

7. **íŒ¨í‚¤ì§€ ë²„ì „ ëª…ì‹œ**
   - `ai`: ìµœì‹  ë²„ì „ í™•ì¸ í•„ìš”
   - `@ai-sdk/google`: ìµœì‹  ë²„ì „ í™•ì¸ í•„ìš”
   - `novel`: ë²„ì „ í˜¸í™˜ì„± í™•ì¸ í•„ìš”

8. **í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§**
   - í•œêµ­ì–´/ì˜ì–´ í”„ë¡¬í”„íŠ¸ ìµœì í™”
   - JSON ì‘ë‹µ í˜•ì‹ ê°•ì œ (êµ¬ì¡°í™”ëœ ì¶œë ¥)

9. **ë¹„ìš© ìµœì í™”**
   - í† í° ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
   - ìºì‹± ì „ëµ (ê°™ì€ ì½˜í…ì¸ ì— ëŒ€í•œ ì¤‘ë³µ ìš”ì²­ ë°©ì§€)

---

## 12. êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1 (ê¸°ë³¸) - âœ… ì™„ë£Œ
1. âœ… Novel.sh ì—ë””í„° í†µí•© (ìµœì†Œ ë²„ì „)
2. âœ… ê¸°ë³¸ CRUD ê¸°ëŠ¥

### Phase 2 (ì—ë””í„° ê³ ê¸‰ ê¸°ëŠ¥) - âœ… ì™„ë£Œ
1. âœ… ìŠ¬ë˜ì‹œ ë©”ë‰´, ë“œë˜ê·¸ì•¤ë“œë¡­
2. âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ
3. âœ… ìë™ ì €ì¥

### Phase 3 (AI ê¸°ëŠ¥) - â³ ì§„í–‰ ì¤‘
1. âœ… AI Slug ìƒì„± (`/api/ai/slug`) - ì™„ë£Œ
2. â³ AI ì´ì–´ì“°ê¸° (`/api/ai/generate`) - ë¯¸êµ¬í˜„
3. â³ AI êµì • (`/api/ai/refine`) - ë¯¸êµ¬í˜„
4. â³ SEO ìë™ ìƒì„± (`/api/ai/seo`) - ë¯¸êµ¬í˜„
5. â³ AI Copilot UI - ë¯¸êµ¬í˜„

### Phase 3.5 (ë³´ì•ˆ ë° ì•ˆì •ì„± ê°•í™”) - âš ï¸ ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. âš ï¸ RLS ì •ì±… ë³´ì™„ (authenticated draft ì¡°íšŒ)
2. âš ï¸ AI API ì¸ì¦ ì¶”ê°€
3. âš ï¸ DB ì œì•½ì¡°ê±´ ì¶”ê°€ (published_at/is_published ì¼ê´€ì„±)
4. âš ï¸ ë²„ì „ ìŠ¤ëƒ…ìƒ· ìë™ ì €ì¥ (AI ì ìš© ì „)

---

## 13. ë‹¤ìŒ ë‹¨ê³„ (ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥)

### ìš°ì„ ìˆœìœ„ 1: ë³´ì•ˆ ë° ì•ˆì •ì„± (í•„ìˆ˜)
1. **RLS ì •ì±… ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±**
   - `supabase/migrations/20250102_fix_uslab_posts_rls.sql` ìƒì„±
   - authenticated ì‚¬ìš©ì draft ì¡°íšŒ ì •ì±… ì¶”ê°€

2. **AI API ì¸ì¦ ì¶”ê°€**
   - `/api/ai/generate`, `/api/ai/refine`, `/api/ai/seo`ì— ì¸ì¦ í™•ì¸ ì¶”ê°€

3. **DB ì œì•½ì¡°ê±´ ë§ˆì´ê·¸ë ˆì´ì…˜**
   - `published_at`/`is_published` ì¼ê´€ì„± ë³´ì¥
   - `canonical_id` FK ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤ ì •ì˜

### ìš°ì„ ìˆœìœ„ 2: AI ê¸°ëŠ¥ êµ¬í˜„
1. **AI ì´ì–´ì“°ê¸° êµ¬í˜„** (`/api/ai/generate`)
   - Streaming ì‘ë‹µ
   - ì¸ì¦ í™•ì¸ í¬í•¨

2. **AI êµì • êµ¬í˜„** (`/api/ai/refine`)
   - ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ í¬í•¨
   - zod ìŠ¤í‚¤ë§ˆ ê²€ì¦

3. **SEO ìë™ ìƒì„±** (`/api/ai/seo`)
   - zod ìŠ¤í‚¤ë§ˆ ê²€ì¦
   - fallback ì „ëµ

4. **AI Copilot UI**
   - AICopilot ì»´í¬ë„ŒíŠ¸
   - DiffView ì»´í¬ë„ŒíŠ¸

### ìš°ì„ ìˆœìœ„ 3: ìš´ì˜ ê·œì¹™ ë¬¸ì„œí™”
1. **productContext.md ì—…ë°ì´íŠ¸**
   - ë°œí–‰ ì¡°ê±´
   - slug ì •ì±…
   - ë²ˆì—­ ì •ì±…
   - ì‚­ì œ ì •ì±…

---

## 14. ìš´ì˜ ê·œì¹™ (productContext.mdì— ì¶”ê°€ í•„ìš”)

### ë°œí–‰ ì¡°ê±´
- ëˆ„ê°€ ë°œí–‰í•  ìˆ˜ ìˆëŠ”ì§€: ê´€ë¦¬ì(authenticated ë˜ëŠ” uslab_admins)
- ë°œí–‰ ì‹œ ìë™ ìƒì„±: SEO ë©”íƒ€ë°ì´í„°, ë²„ì „ ìŠ¤ëƒ…ìƒ·

### Slug ì •ì±…
- ì¤‘ë³µ: ê°™ì€ locale ë‚´ì—ì„œë§Œ unique
- ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€: ê°€ëŠ¥ (í•˜ì§€ë§Œ SEO ì˜í–¥ ê³ ë ¤)
- ìˆ˜ì • ì‹œ redirect: 301 ë¦¬ë‹¤ì´ë ‰íŠ¸ ê¶Œì¥ (í–¥í›„ êµ¬í˜„)

### ë²ˆì—­ ì •ì±…
- ko ì›ë¬¸ ìˆ˜ì • â†’ en ìë™ ì—…ë°ì´íŠ¸: ì•„ë‹ˆì˜¤ (ìˆ˜ë™)
- canonical_idë¡œ ê·¸ë£¹í•‘: ko ì›ë¬¸ì´ canonical_id = id (self ì°¸ì¡°)

### ì‚­ì œ ì •ì±…
- Soft delete vs Hard delete: í˜„ì¬ëŠ” Hard delete
- canonical_id FK ì‚­ì œ: SET NULL (ë²ˆì—­ì€ ë³´ì¡´, ê·¸ë£¹ë§Œ í•´ì œ)

---

**ê²€í†  ì™„ë£Œ**: ì´ í”Œëœì€ plan.mdì˜ Phase 2-3ì™€ ì¼ê´€ì„± ìˆìœ¼ë©°, Gemini 2.0 Flash í†µí•© ë°©í–¥ì´ ëª…í™•í•©ë‹ˆë‹¤. ìœ„ì˜ ë³´ì•ˆ ë° ì•ˆì •ì„± ê°œì„ ì‚¬í•­ì„ ë°˜ì˜í•˜ë©´ ìš´ì˜ê¸‰ ì‹œìŠ¤í…œìœ¼ë¡œ ì™„ì„±ë©ë‹ˆë‹¤.
