# 운영진 보드 명세서

## 1. 개요

### 1.1 목적
- 운영진이 자유롭게 공지사항, 업데이트, 내부 소통 등을 할 수 있는 게시판 시스템
- 블로그 에디터 기능을 재사용하여 풍부한 콘텐츠 작성 지원
- 우선순위 기능을 통한 중요 공지사항 상단 고정
- 대시보드 통합을 통한 최신 공지사항 노출

### 1.2 주요 기능
- 운영진 전용 게시판 (인증된 사용자만 작성/수정/삭제 가능)
- 블로그 에디터 기반 콘텐츠 작성 (Novel.sh 에디터)
- 목록형/카드형 보기 전환 (목록형 기본)
- 우선순위 기반 정렬 (드래그 앤 드롭 지원)
- 대시보드 최상단 공지사항 노출

---

## 2. 데이터베이스 설계

### 2.1 테이블 구조: `uslab_staff_board`

```sql
CREATE TABLE uslab_staff_board (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  content JSONB NOT NULL, -- Tiptap JSON 형식 (블로그와 동일)
  author_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  priority INTEGER DEFAULT 0, -- 우선순위 (높을수록 상단)
  is_pinned BOOLEAN DEFAULT false, -- 상단 고정 여부
  view_count INTEGER DEFAULT 0, -- 조회수
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  published_at TIMESTAMPTZ, -- 발행 시각 (초안/발행 구분)
  is_published BOOLEAN DEFAULT false -- 발행 여부
);

-- 인덱스
CREATE INDEX uslab_idx_staff_board_priority ON uslab_staff_board(priority DESC, created_at DESC);
CREATE INDEX uslab_idx_staff_board_published ON uslab_staff_board(is_published, priority DESC, created_at DESC);
CREATE INDEX uslab_idx_staff_board_author ON uslab_staff_board(author_id);

-- RLS 정책
ALTER TABLE uslab_staff_board ENABLE ROW LEVEL SECURITY;

-- 공개 읽기: 발행된 게시물만
CREATE POLICY "Public read published staff board posts"
  ON uslab_staff_board FOR SELECT
  USING (is_published = true);

-- 인증된 사용자 읽기: 모든 게시물 (초안 포함)
CREATE POLICY "Authenticated read all staff board posts"
  ON uslab_staff_board FOR SELECT
  TO authenticated
  USING (true);

-- 인증된 사용자 쓰기
CREATE POLICY "Authenticated insert staff board posts"
  ON uslab_staff_board FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY "Authenticated update staff board posts"
  ON uslab_staff_board FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Authenticated delete staff board posts"
  ON uslab_staff_board FOR DELETE
  TO authenticated
  USING (true);
```

### 2.2 우선순위 정렬 규칙
- `priority` 값이 높을수록 상단에 표시
- `is_pinned = true`인 게시물은 항상 최상단 (priority 무시)
- 같은 priority 내에서는 `created_at DESC` (최신순)
- 정렬 순서:
  1. `is_pinned = true` (최상단 고정)
  2. `priority DESC` (우선순위 높은 순)
  3. `created_at DESC` (최신순)

---

## 3. API 엔드포인트

### 3.1 게시물 목록 조회
```
GET /api/staff-board
Query Parameters:
  - all: boolean (기본값: false) - 초안 포함 여부 (관리자만)
  - limit: number (기본값: 20)
  - offset: number (기본값: 0)

Response:
{
  posts: StaffBoardPost[],
  total: number
}
```

### 3.2 게시물 상세 조회
```
GET /api/staff-board/[id]

Response:
{
  post: StaffBoardPost
}
```

### 3.3 게시물 작성
```
POST /api/staff-board
Headers:
  Authorization: Bearer <token>

Body:
{
  title: string,
  content: JSONB (Tiptap JSON),
  is_published: boolean,
  priority?: number,
  is_pinned?: boolean
}

Response:
{
  post: StaffBoardPost
}
```

### 3.4 게시물 수정
```
PUT /api/staff-board/[id]
Headers:
  Authorization: Bearer <token>

Body:
{
  title?: string,
  content?: JSONB,
  is_published?: boolean,
  priority?: number,
  is_pinned?: boolean
}

Response:
{
  post: StaffBoardPost
}
```

### 3.5 게시물 삭제
```
DELETE /api/staff-board/[id]
Headers:
  Authorization: Bearer <token>

Response:
{
  success: boolean
}
```

### 3.6 우선순위 업데이트 (드래그 앤 드롭)
```
PATCH /api/staff-board/priority
Headers:
  Authorization: Bearer <token>

Body:
{
  updates: Array<{
    id: string,
    priority: number,
    is_pinned?: boolean
  }>
}

Response:
{
  success: boolean,
  updated: number
}
```

### 3.7 조회수 증가
```
POST /api/staff-board/[id]/view

Response:
{
  view_count: number
}
```

### 3.8 최상단 게시물 조회 (대시보드용)
```
GET /api/staff-board/top

Response:
{
  post: StaffBoardPost | null
}
```

---

## 4. UI/UX 설계

### 4.1 관리자 페이지: `/admin/staff-board`

#### 4.1.1 헤더 영역
- 제목: "운영진 보드"
- 설명: "운영진 전용 게시판입니다."
- 액션 버튼:
  - "새 게시물 작성" (우측 상단)

#### 4.1.2 뷰 모드 전환
- 위치: 목록 상단 우측
- 버튼:
  - 목록형 아이콘 (기본 선택)
  - 카드형 아이콘
- 기본값: 목록형

#### 4.1.3 게시물 목록 (목록형 - 기본)
```
┌─────────────────────────────────────────────────────────┐
│ [핀 아이콘] 제목                                    [우선순위: 10] │
│ 작성자 • 2025-01-16 • 조회수: 42                      │
│ [수정] [삭제] [우선순위 ↑] [핀 고정]                    │
└─────────────────────────────────────────────────────────┘
```

- 드래그 핸들 아이콘 (좌측) - 드래그 가능 표시
- 핀 아이콘 (고정 게시물 표시)
- 우선순위 표시 (우측 상단)
- 작성자, 날짜, 조회수 정보
- 액션 버튼: 수정, 삭제, 우선순위 올리기, 핀 고정/해제

#### 4.1.4 게시물 목록 (카드형)
- 블로그 포스트 카드와 유사한 디자인
- 썸네일 이미지 (있는 경우)
- 제목, 요약, 날짜, 조회수 표시
- 드래그 핸들 포함

#### 4.1.5 드래그 앤 드롭 기능
- 드래그 핸들 아이콘 (좌측) 클릭/드래그
- 드래그 중 시각적 피드백 (그림자, 테두리 강조)
- 드롭 위치에 따라 우선순위 자동 계산
- 드롭 후 즉시 API 호출하여 우선순위 업데이트
- 로딩 상태 표시

#### 4.1.6 우선순위 올리기 버튼
- 각 게시물에 "우선순위 ↑" 버튼
- 클릭 시 현재 priority + 1
- 즉시 API 호출하여 업데이트

#### 4.1.7 핀 고정 기능
- 각 게시물에 "핀 고정" / "핀 해제" 버튼
- `is_pinned = true`인 게시물은 항상 최상단
- 핀 아이콘으로 시각적 표시

### 4.2 게시물 작성/수정 페이지: `/admin/staff-board/write`, `/admin/staff-board/[id]`

#### 4.2.1 에디터 영역
- 블로그 에디터와 동일한 Novel.sh 에디터 사용
- 제목 입력 필드
- 콘텐츠 에디터 (Tiptap JSON)

#### 4.2.2 메타데이터 설정
- 우선순위 입력 (숫자, 기본값: 0)
- 핀 고정 체크박스
- 발행 여부 선택 (초안 저장 / 발행)

#### 4.2.3 액션 버튼
- "초안 저장" (좌측)
- "발행하기" (우측)
- "취소" (좌측 하단)
- "목록으로 돌아가기" (좌측 하단)

### 4.3 대시보드 통합: `/admin/dashboard`

#### 4.3.1 탭 구조
- 기존 대시보드 내용을 탭으로 구성
- 탭 목록:
  1. "대시보드" (기본) - 기존 통계 및 분석
  2. "운영진 보드" - 운영진 보드 게시물 목록

#### 4.3.2 최상단 공지사항 카드
- 위치: 대시보드 탭 최상단 (KPI 카드 위)
- 조건: `is_pinned = true` 또는 `priority`가 가장 높은 게시물 1개
- 디자인:
  ```
  ┌─────────────────────────────────────────────────┐
  │ [핀 아이콘] 중요 공지                              │
  │ 제목: [게시물 제목]                                │
  │ 내용: [게시물 요약 또는 첫 100자]                    │
  │ [자세히 보기 →]                                   │
  └─────────────────────────────────────────────────┘
  ```
- 클릭 시: `/admin/staff-board/[id]` 또는 상세 페이지로 이동

---

## 5. 타입 정의

### 5.1 TypeScript 인터페이스

```typescript
// lib/types/staff-board.ts

export interface StaffBoardPost {
  id: string;
  title: string;
  content: any; // Tiptap JSON
  author_id: string;
  priority: number;
  is_pinned: boolean;
  view_count: number;
  created_at: string;
  updated_at: string;
  published_at: string | null;
  is_published: boolean;
}

export interface StaffBoardListResponse {
  posts: StaffBoardPost[];
  total: number;
}

export interface UpdatePriorityRequest {
  updates: Array<{
    id: string;
    priority: number;
    is_pinned?: boolean;
  }>;
}
```

---

## 6. 기능 상세

### 6.1 우선순위 관리

#### 6.1.1 드래그 앤 드롭
- 라이브러리: `@dnd-kit/core`, `@dnd-kit/sortable` (또는 `react-beautiful-dnd`)
- 드래그 가능 영역: 게시물 카드/목록 아이템 전체 또는 드래그 핸들
- 드롭 영역: 다른 게시물 사이
- 우선순위 계산:
  - 드롭 위치에 따라 자동으로 priority 값 계산
  - 예: 3번째 위치에 드롭 → priority = 1000 - (index * 10)
  - 핀 고정 게시물은 항상 최상단 (priority 무시)

#### 6.1.2 우선순위 올리기 버튼
- 클릭 시 현재 priority + 10 (또는 사용자 정의 증가값)
- 즉시 API 호출하여 업데이트
- 목록 자동 새로고침

### 6.2 뷰 모드 전환
- 목록형 (기본):
  - 컴팩트한 리스트 형태
  - 드래그 핸들, 핀 아이콘, 우선순위 표시
  - 작성자, 날짜, 조회수 정보
- 카드형:
  - 블로그 포스트 카드와 유사
  - 썸네일 이미지 (있는 경우)
  - 제목, 요약, 메타데이터

### 6.3 대시보드 통합
- 최상단 공지사항:
  - `GET /api/staff-board/top` API 호출
  - `is_pinned = true` 우선, 없으면 `priority` 최고값
  - 카드 형태로 표시
  - 클릭 시 상세 페이지 또는 운영진 보드 탭으로 이동

---

## 7. 보안 및 권한

### 7.1 접근 권한
- 읽기: 발행된 게시물은 공개, 초안은 인증된 사용자만
- 쓰기: 인증된 사용자만 (관리자)
- 수정/삭제: 작성자 또는 관리자

### 7.2 RLS 정책
- 공개 읽기: `is_published = true`인 게시물만
- 인증된 사용자: 모든 게시물 읽기 가능
- 인증된 사용자: 작성/수정/삭제 가능

---

## 8. 구현 단계

### Phase 1: 데이터베이스 및 API
1. `uslab_staff_board` 테이블 생성 (마이그레이션)
2. RLS 정책 설정
3. API 엔드포인트 구현
   - GET /api/staff-board
   - GET /api/staff-board/[id]
   - POST /api/staff-board
   - PUT /api/staff-board/[id]
   - DELETE /api/staff-board/[id]
   - PATCH /api/staff-board/priority
   - POST /api/staff-board/[id]/view
   - GET /api/staff-board/top

### Phase 2: 타입 정의 및 쿼리 함수
1. TypeScript 타입 정의 (`lib/types/staff-board.ts`)
2. 쿼리 함수 구현 (`lib/queries/staff-board.ts`)
3. Database 타입 업데이트 (`lib/types/uslab.ts`)

### Phase 3: 관리자 페이지 UI
1. 목록 페이지 (`/admin/staff-board/page.tsx`)
   - 목록형/카드형 뷰 전환
   - 드래그 앤 드롭 구현
   - 우선순위 관리 UI
2. 작성 페이지 (`/admin/staff-board/write/page.tsx`)
   - Novel.sh 에디터 통합
   - 메타데이터 설정
3. 수정 페이지 (`/admin/staff-board/[id]/page.tsx`)
   - 기존 게시물 로드
   - 에디터에 콘텐츠 표시
   - 수정 기능

### Phase 4: 대시보드 통합
1. 대시보드 탭 구조 구현
2. 운영진 보드 탭 추가
3. 최상단 공지사항 카드 구현
4. API 연동

### Phase 5: 조회수 추적
1. 조회수 증가 API 구현
2. 게시물 상세 페이지에서 자동 증가
3. 목록에 조회수 표시

---

## 9. 기술 스택

### 9.1 프론트엔드
- React (Next.js)
- Novel.sh 에디터 (블로그와 동일)
- 드래그 앤 드롭: `@dnd-kit/core`, `@dnd-kit/sortable`
- 상태 관리: React useState/useEffect

### 9.2 백엔드
- Next.js API Routes
- Supabase (PostgreSQL)
- RLS (Row Level Security)

---

## 10. 참고사항

### 10.1 블로그 시스템과의 차이점
- SEO 필드 없음 (운영진 전용이므로)
- 다국어 지원 없음 (한국어만)
- Slug 없음 (ID 기반 라우팅)
- 조회수 추적은 동일하게 구현

### 10.2 우선순위 계산 전략
- 초기 priority: 0
- 드래그 앤 드롭 시: 1000 - (index * 10) 형태로 계산
- 우선순위 올리기 버튼: +10씩 증가
- 핀 고정: priority 무시하고 항상 최상단

### 10.3 성능 고려사항
- 목록 조회 시 인덱스 활용 (priority, is_published)
- 드래그 앤 드롭 시 배치 업데이트 (여러 게시물 동시 업데이트)
- 대시보드 최상단 공지사항은 캐싱 고려

---

## 11. 향후 개선사항 (선택)

- 댓글 기능 (블로그와 동일)
- 파일 첨부 기능
- 알림 기능 (새 게시물 작성 시)
- 검색 기능
- 카테고리/태그 기능

