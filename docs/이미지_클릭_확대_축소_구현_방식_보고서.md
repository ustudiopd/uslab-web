# 이미지 클릭 확대/축소 기능 구현 방식 보고서

**작성 일자**: 2025-01-16  
**프로젝트**: uslab-web  
**에디터**: Novel.sh (Tiptap 기반)

---

## 📋 개요

현재 프로젝트는 **두 가지 시나리오**에서 이미지 확대/축소 기능을 제공합니다:

1. **에디터에서 이미지 리사이즈** (크기 조절)
   - 이미지 클릭 → 리사이즈 핸들 표시 → 드래그로 크기 조절
   - 최소 50px, 최대 1200px
   - Shift 키로 비율 유지

2. **뷰어에서 이미지 확대** (라이트박스 모달)
   - 이미지 클릭 → 전체 화면 라이트박스 모달 표시
   - ESC 키 또는 배경 클릭으로 닫기

---

## 🎨 기능 1: 에디터에서 이미지 리사이즈

### 아키텍처

```
이미지 클릭
    ↓
ProseMirror NodeSelection 생성
    ↓
ImageResizePlugin.update() 호출
    ↓
리사이즈 핸들 표시 (우측 하단)
    ↓
핸들 드래그
    ↓
이미지 크기 실시간 조절
    ↓
드래그 종료
    ↓
이미지 노드 속성에 width/height 저장
```

---

### 구현 상세

#### 1. ImageResizeExtension

**파일**: `components/editor/extensions/ImageResizeExtension.ts`

```typescript:1:17:components/editor/extensions/ImageResizeExtension.ts
/**
 * 이미지 리사이즈 Extension
 * ProseMirror Plugin을 Tiptap Extension으로 감싸서 확실히 등록
 */

'use client';

import { Extension } from '@tiptap/core';
import { createImageResizePlugin } from '../ImageResizePlugin';

export const ImageResizeExtension = Extension.create({
  name: 'imageResizeExtension',
  addProseMirrorPlugins() {
    console.log('[ImageResizeExtension] addProseMirrorPlugins() called');
    return [createImageResizePlugin()];
  },
});
```

**역할**: Tiptap Extension으로 플러그인을 등록하여 확실히 동작하도록 보장

---

#### 2. ImageResizePlugin

**파일**: `components/editor/ImageResizePlugin.tsx`

##### 핵심 상수

```typescript:14:16:components/editor/ImageResizePlugin.tsx
const MIN = 50;
const MAX = 1200;
const HANDLE_SIZE = 16;
```

- **MIN**: 최소 크기 50px
- **MAX**: 최대 크기 1200px
- **HANDLE_SIZE**: 리사이즈 핸들 크기 16px

##### 이미지 선택 감지

```typescript:28:49:components/editor/ImageResizePlugin.tsx
function getSelectedImage(view: EditorView): {
  pos: number;
  node: ProseMirrorNode;
  img: HTMLImageElement;
} | null {
  const sel = view.state.selection;
  if (!(sel instanceof NodeSelection)) return null;
  if (!isImageNode(sel.node)) return null;

  const pos = sel.from;
  const dom = view.nodeDOM(pos) as unknown;

  let img: HTMLImageElement | null = null;
  if (dom instanceof HTMLImageElement) {
    img = dom;
  } else if (dom instanceof HTMLElement) {
    img = dom.querySelector('img');
  }

  if (!img) return null;
  return { pos, node: sel.node, img };
}
```

**핵심 포인트**:
- `NodeSelection`: ProseMirror의 노드 선택 타입
- 이미지 노드가 선택되면 `pos`, `node`, `img` DOM 요소 반환

##### 리사이즈 핸들 생성

```typescript:68:86:components/editor/ImageResizePlugin.tsx
// 핸들(오버레이) 생성: ProseMirror 내부가 아니라 "부모"에 붙임
const handle = document.createElement('button');
handle.type = 'button';
handle.className = 'resize-handle'; // globals.css와 일치
Object.assign(handle.style, {
  position: 'absolute',
  width: `${HANDLE_SIZE}px`,
  height: `${HANDLE_SIZE}px`,
  backgroundColor: '#3b82f6',
  border: '2px solid white',
  borderRadius: '50%',
  cursor: 'se-resize',
  display: 'none',
  zIndex: '1000', // globals.css와 일치
  boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
  transition: 'transform 0.1s',
  pointerEvents: 'auto', // 클릭 가능하도록
});
container.appendChild(handle);
```

**특징**:
- **오버레이 방식**: ProseMirror 내부가 아닌 부모 컨테이너에 핸들 배치
- **절대 위치**: 이미지 우측 하단에 배치
- **초기 숨김**: `display: 'none'`으로 시작

##### 핸들 위치 계산

```typescript:99:111:components/editor/ImageResizePlugin.tsx
const positionHandle = () => {
  if (!active) return;
  const imgRect = active.img.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();

  const left =
    imgRect.right - containerRect.left + container.scrollLeft - HANDLE_SIZE / 2;
  const top =
    imgRect.bottom - containerRect.top + container.scrollTop - HANDLE_SIZE / 2;

  handle.style.left = `${left}px`;
  handle.style.top = `${top}px`;
};
```

**계산 방식**:
- 이미지의 우측 하단 좌표 계산
- 컨테이너 기준 상대 위치로 변환
- 스크롤 오프셋 고려

##### 드래그로 크기 조절

```typescript:126:143:components/editor/ImageResizePlugin.tsx
const onMouseMove = (e: MouseEvent) => {
  if (!dragging || !active) return;

  const dx = e.clientX - startX;
  const dy = e.clientY - startY;

  let nextW = clamp(startW + dx, MIN, MAX);
  let nextH = clamp(startH + dy, MIN, MAX);

  // Shift: 비율 유지
  if (e.shiftKey) {
    nextH = clamp(nextW / aspect, MIN, MAX);
  }

  active.img.style.width = `${Math.round(nextW)}px`;
  active.img.style.height = `${Math.round(nextH)}px`;
  positionHandle();
};
```

**동작 방식**:
1. 마우스 이동 거리 계산 (`dx`, `dy`)
2. 최소/최대 크기 제한 (`clamp`)
3. **Shift 키**: 원본 비율 유지
4. 실시간으로 이미지 크기 조절

##### 크기 저장

```typescript:145:167:components/editor/ImageResizePlugin.tsx
const onMouseUp = () => {
  if (!dragging || !active) return;
  dragging = false;

  window.removeEventListener('mousemove', onMouseMove);
  window.removeEventListener('mouseup', onMouseUp);

  // 최종 크기를 노드 attrs로 저장
  const width = parseInt(active.img.style.width, 10) || Math.round(startW);
  const height = parseInt(active.img.style.height, 10) || Math.round(startH);

  const { state } = view;
  const nodeNow = state.doc.nodeAt(active.pos);
  if (!nodeNow) return;

  const tr = state.tr.setNodeMarkup(active.pos, undefined, {
    ...nodeNow.attrs,
    width,
    height,
  });
  view.dispatch(tr);
  console.log('[ImageResize] 크기 저장 완료', { width, height });
};
```

**핵심 포인트**:
- 드래그 종료 시 최종 크기를 이미지 노드 속성에 저장
- `setNodeMarkup`: ProseMirror 트랜잭션으로 노드 속성 업데이트
- 저장된 크기는 Tiptap JSON에 포함됨

##### 선택 상태 업데이트

```typescript:207:224:components/editor/ImageResizePlugin.tsx
return {
  update(view) {
    const next = getSelectedImage(view);
    if (!next) {
      if (active) {
        console.log('[ImageResize] update() - 이미지 선택 해제');
        hide();
      }
      return;
    }

    if (!active || active.pos !== next.pos) {
      console.log('[ImageResize] update() - 새 이미지 선택됨', next.pos);
      show(next);
    } else {
      positionHandle(); // 같은 이미지면 위치만 업데이트
    }
  },
  // ...
};
```

**동작 방식**:
- ProseMirror 선택 상태 변경 시 `update()` 호출
- 이미지가 선택되면 핸들 표시
- 이미지 선택 해제 시 핸들 숨김

---

### 사용 방법

1. **이미지 선택**: 에디터에서 이미지를 클릭
2. **핸들 표시**: 우측 하단에 파란색 원형 핸들이 표시됨
3. **크기 조절**: 핸들을 드래그하여 크기 조절
4. **비율 유지**: Shift 키를 누른 채 드래그하면 원본 비율 유지
5. **자동 저장**: 드래그 종료 시 자동으로 크기가 저장됨

---

## 🖼️ 기능 2: 뷰어에서 이미지 확대 (라이트박스)

### 아키텍처

```
이미지 클릭
    ↓
이벤트 위임으로 클릭 감지
    ↓
lightboxImage state 업데이트
    ↓
라이트박스 모달 표시
    ↓
ESC 키 또는 배경 클릭
    ↓
모달 닫기
```

---

### 구현 상세

#### 1. 상태 관리

**파일**: `components/blog/PostViewer.tsx`

```typescript:23:23:components/blog/PostViewer.tsx
const [lightboxImage, setLightboxImage] = useState<string | null>(null);
```

- `lightboxImage`: 확대할 이미지의 URL (null이면 모달 숨김)

---

#### 2. 이미지 클릭 감지

**파일**: `components/blog/PostViewer.tsx`

```typescript:210:241:components/blog/PostViewer.tsx
// 이미지 클릭 시 라이트박스 모달 열기 (이벤트 위임 사용)
useEffect(() => {
  if (!contentRef.current) return;

  // 모든 이미지에 커서 스타일 추가
  const images = contentRef.current.querySelectorAll('img');
  images.forEach((img) => {
    (img as HTMLImageElement).style.cursor = 'pointer';
  });

  // 이벤트 위임: contentRef에 클릭 이벤트를 등록하고, 클릭된 요소가 이미지인지 확인
  const handleContentClick = (e: MouseEvent) => {
    const target = e.target as HTMLElement;
    
    // 클릭된 요소가 이미지이거나 이미지의 자식인 경우
    const image = target.closest('img');
    if (image && image.src) {
      e.preventDefault();
      e.stopPropagation();
      setLightboxImage(image.src);
    }
  };

  contentRef.current.addEventListener('click', handleContentClick);

  // 클린업: 이벤트 리스너 제거
  return () => {
    if (contentRef.current) {
      contentRef.current.removeEventListener('click', handleContentClick);
    }
  };
}, [htmlContent]);
```

**핵심 포인트**:
- **이벤트 위임**: 모든 이미지에 개별 이벤트를 등록하지 않고, 부모 요소에 하나만 등록
- **`closest('img')`**: 클릭된 요소가 이미지이거나 이미지의 자식인지 확인
- **커서 스타일**: 모든 이미지에 `cursor: pointer` 추가하여 클릭 가능함을 표시

---

#### 3. ESC 키로 닫기

**파일**: `components/blog/PostViewer.tsx`

```typescript:243:255:components/blog/PostViewer.tsx
// ESC 키로 라이트박스 닫기
useEffect(() => {
  if (!lightboxImage) return;

  const handleEscape = (e: KeyboardEvent) => {
    if (e.key === 'Escape') {
      setLightboxImage(null);
    }
  };

  window.addEventListener('keydown', handleEscape);
  return () => window.removeEventListener('keydown', handleEscape);
}, [lightboxImage]);
```

**동작**: ESC 키 입력 시 모달 닫기

---

#### 4. 라이트박스 모달 UI

**파일**: `components/blog/PostViewer.tsx`

```typescript:452:491:components/blog/PostViewer.tsx
{/* 이미지 라이트박스 모달 */}
{lightboxImage && (
  <div
    className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm"
    onClick={() => setLightboxImage(null)}
  >
    {/* 닫기 버튼 */}
    <button
      onClick={() => setLightboxImage(null)}
      className="absolute top-4 right-4 p-3 rounded-full bg-slate-800/80 hover:bg-slate-700/80 text-white transition-colors z-10"
      aria-label="닫기"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      >
        <path d="M18 6 6 18" />
        <path d="m6 6 12 12" />
      </svg>
    </button>

    {/* 이미지 */}
    <div
      className="max-w-[90vw] max-h-[90vh] flex items-center justify-center"
      onClick={(e) => e.stopPropagation()}
    >
      <img
        src={lightboxImage}
        alt="확대 이미지"
        className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"
      />
    </div>
  </div>
)}
```

**UI 특징**:
- **전체 화면**: `fixed inset-0`로 전체 화면 덮기
- **반투명 배경**: `bg-black/90 backdrop-blur-sm`
- **이미지 크기**: `max-w-[90vw] max-h-[90vh]`로 화면 크기에 맞춤
- **닫기 방법**:
  - 배경 클릭
  - 우측 상단 닫기 버튼
  - ESC 키

---

### 사용 방법

1. **이미지 클릭**: 뷰어에서 이미지를 클릭
2. **라이트박스 표시**: 전체 화면 모달로 이미지 확대 표시
3. **닫기**: 
   - 배경 클릭
   - 우측 상단 닫기 버튼 클릭
   - ESC 키 입력

---

## 📊 두 기능 비교

| 기능 | 위치 | 목적 | 동작 방식 |
|------|------|------|----------|
| **이미지 리사이즈** | 에디터 | 크기 조절 | 핸들 드래그 |
| **이미지 확대** | 뷰어 | 전체 화면 보기 | 라이트박스 모달 |

---

## 🔧 기술 스택

### 에디터 리사이즈
- **ProseMirror Plugin**: `Plugin`, `PluginKey`, `NodeSelection`
- **Tiptap Extension**: `Extension.create()`
- **DOM 조작**: 핸들 생성 및 위치 계산

### 뷰어 확대
- **React Hooks**: `useState`, `useEffect`
- **이벤트 위임**: 부모 요소에 이벤트 등록
- **Tailwind CSS**: 모달 스타일링

---

## 🎯 핵심 포인트

### 에디터 리사이즈
1. **NodeSelection 기반**: ProseMirror의 노드 선택 상태를 감지
2. **오버레이 방식**: ProseMirror 내부가 아닌 부모 컨테이너에 핸들 배치
3. **실시간 조절**: 드래그 중 실시간으로 크기 조절
4. **자동 저장**: 드래그 종료 시 노드 속성에 자동 저장

### 뷰어 확대
1. **이벤트 위임**: 성능 최적화를 위한 이벤트 위임 패턴
2. **전체 화면**: `fixed inset-0`로 전체 화면 덮기
3. **반응형**: 화면 크기에 맞춰 이미지 크기 조절
4. **접근성**: ESC 키, 닫기 버튼, 배경 클릭 등 다양한 닫기 방법

---

## 📝 데이터 저장

### 에디터 리사이즈

리사이즈된 이미지는 Tiptap JSON에 다음과 같이 저장됩니다:

```json
{
  "type": "image",
  "attrs": {
    "src": "https://...supabase.co/storage/v1/object/public/uslab-images/...",
    "width": 800,
    "height": 600
  }
}
```

- `width`, `height` 속성이 노드에 저장됨
- 저장된 크기는 뷰어에서도 동일하게 표시됨

---

## 🚀 향후 개선 사항

### 에디터 리사이즈
1. **다중 핸들**: 4개 모서리와 4개 변에 핸들 추가
2. **키보드 조절**: 화살표 키로 크기 조절
3. **비율 고정 토글**: 비율 유지 모드 토글 버튼

### 뷰어 확대
1. **이미지 네비게이션**: 이전/다음 이미지로 이동
2. **줌 인/아웃**: 마우스 휠로 확대/축소
3. **터치 제스처**: 모바일에서 핀치 줌 지원

---

## 📚 참고 자료

- [ProseMirror Plugin 문서](https://prosemirror.net/docs/guide/#plugins)
- [Tiptap Extension 문서](https://tiptap.dev/docs/editor/extensions/custom-extensions)
- [React 이벤트 위임 패턴](https://react.dev/learn/responding-to-events)

---

**작성 완료**: 2025-01-16

