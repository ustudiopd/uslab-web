# 대시보드 통계 기능 구현 검토 보고서

**작성일**: 2025-01-XX  
**검토 대상**: 현재 구현 상태 vs v2 명세서  
**현재 구현 상태**: Step1 완료 + Phase 0 완료 + Phase 1 부분 완료  
**검토자**: AI Assistant

---

## 📋 목차

1. [검토 개요](#검토-개요)
2. [현재 구현 상태 상세 분석](#현재-구현-상태-상세-분석)
3. [v2 명세서 대비 구현 현황](#v2-명세서-대비-구현-현황)
4. [우선순위별 구현 계획](#우선순위별-구현-계획)
5. [즉시 구현 필요 사항](#즉시-구현-필요-사항)
6. [결론 및 권장사항](#결론-및-권장사항)

---

## 1. 검토 개요

### 1.1 검토 목적

- 현재 구현된 대시보드 및 통계 기능의 완성도 평가
- v2 명세서 대비 누락된 기능 식별
- 다음 단계 구현 우선순위 결정

### 1.2 검토 범위

- ✅ **완료된 기능**: Step1 (기본 트래킹), Phase 0 (이식성 확보)
- ⚠️ **부분 완료**: Phase 1 (Events 시스템)
- ❌ **미구현**: Phase 2 (Rollup + 퍼널), Phase 3 (Web Vitals + AI 리포트)

---

## 2. 현재 구현 상태 상세 분석

### 2.1 ✅ 완전 구현된 기능

#### A) Phase 0: 이식성 확보 (완료)

**구현 파일**:
- `lib/config/analytics.ts`: 환경변수 기반 prefix 관리
- `components/analytics/Tracker.tsx`: page_view_id 클라이언트 생성
- `app/api/track/route.ts`: v2 스키마 지원

**구현 내용**:
1. ✅ **ANALYTICS_PREFIX 환경변수**: `lib/config/analytics.ts`에서 완전 구현
   - 기본값: `uslab`
   - `getAnalyticsTableName()` 함수로 동적 테이블명 생성
   - `getSessionStorageKey()`, `getLastSeenStorageKey()` 함수로 동적 키 생성

2. ✅ **page_path 정규화**: `Tracker.tsx`에서 pathname만 저장
   ```typescript
   const canonicalPath = pathname; // query 제외
   ```

3. ✅ **page_view_id 클라이언트 생성**: `Tracker.tsx`에서 UUID 생성
   ```typescript
   const pageViewId = crypto.randomUUID();
   ```

4. ✅ **v2 API 스키마**: `app/api/track/route.ts`에서 v1/v2 하위 호환성 지원
   - `trackSchemaV2`: page_view 객체, events 배열 지원
   - `trackSchemaV1`: 기존 형식 지원 (하위 호환성)

**평가**: ⭐⭐⭐⭐⭐ (완벽 구현)

#### B) Step1: 기본 트래킹 시스템 (완료)

**구현 파일**:
- `components/analytics/Tracker.tsx`: 클라이언트 트래킹
- `app/api/track/route.ts`: 서버 트래킹 API
- `supabase/migrations/20250115_create_uslab_tracking_tables.sql`: DB 스키마
- `lib/queries/analytics.ts`: 통계 쿼리 함수
- `app/admin/dashboard/page.tsx`: 대시보드 UI

**구현 내용**:
1. ✅ **세션 관리**: 30분 TTL, localStorage 기반
2. ✅ **Bot 필터링**: User-Agent 기반
3. ✅ **페이지뷰 추적**: 실시간 수집
4. ✅ **통계 쿼리**: 오늘/7일/30일 통계
5. ✅ **대시보드 UI**: KPI, 차트, Top 콘텐츠

**평가**: ⭐⭐⭐⭐⭐ (완벽 구현)

#### C) Phase 1: Events 시스템 (부분 완료)

**구현 파일**:
- `lib/utils/eventTracker.ts`: 이벤트 수집 로직
- `components/analytics/Tracker.tsx`: 이벤트 수집 통합
- `app/api/track/route.ts`: Events bulk insert 지원

**구현 내용**:
1. ✅ **이벤트 수집 로직**: 완전 구현
   - `click`: 클릭 좌표, element 정보
   - `scroll_depth`: 스크롤 깊이 추적
   - `conversion`: 전환 이벤트 (개발자 호출)
   - `page_engagement`: 페이지 참여도

2. ✅ **이벤트 배치 전송**: 완전 구현
   - 5초 간격 또는 20개 이상 쌓이면 전송
   - `sendBeacon` 우선 사용
   - 샘플링 지원 (세션 단위)

3. ✅ **API Events 처리**: 완전 구현
   - `/api/track`에서 events[] 배열 처리
   - page_view 없이 events만 전송 가능

4. ❌ **Events 테이블**: **마이그레이션 파일 없음**
   - `app/api/track/route.ts`에서 `getAnalyticsTableName('events')` 호출하지만
   - 실제 테이블이 존재하지 않음
   - **즉시 구현 필요**

5. ❌ **히트맵 UI**: 미구현
   - 대시보드에 히트맵 카드 없음
   - 이벤트 데이터는 수집 중이지만 시각화 없음

**평가**: ⭐⭐⭐ (부분 완료, Events 테이블 및 히트맵 UI 필요)

### 2.2 ⚠️ 개선 필요 사항

#### A) Retention 스케줄러 미설정

**현재 상태**:
- ✅ `uslab_cleanup_old_tracking()` 함수는 구현됨
- ❌ Vercel Cron 또는 Supabase Cron으로 스케줄러 미설정

**영향**: 90일 지난 데이터가 자동 삭제되지 않음

**우선순위**: 🟡 중간 (데이터 증가 시 문제)

#### B) page_view_id 마이그레이션

**현재 상태**:
- ✅ 클라이언트에서 page_view_id 생성
- ⚠️ 기존 데이터는 서버 생성 UUID 사용
- ⚠️ 마이그레이션 스크립트 없음

**영향**: 기존 데이터와의 호환성 문제 없음 (새 데이터만 클라이언트 생성)

**우선순위**: 🟢 낮음 (기존 데이터 영향 없음)

#### C) post_id/about_id 자동 매핑

**현재 상태**:
- ⚠️ 클라이언트에서 `post_id: null`로 전송
- ⚠️ 서버에서 `page_path` 분석하여 매핑하는 로직 없음

**영향**: Top Posts 집계 시 post_id가 null인 경우 제외됨

**우선순위**: 🟡 중간 (데이터 품질 향상)

---

## 3. v2 명세서 대비 구현 현황

### 3.1 Phase 0: 이식성 확보 ✅ 완료

| 항목 | 명세서 요구사항 | 현재 구현 상태 | 평가 |
|------|----------------|---------------|------|
| ANALYTICS_PREFIX 환경변수 | 필수 | ✅ 완료 | ⭐⭐⭐⭐⭐ |
| page_path 정규화 | 필수 | ✅ 완료 | ⭐⭐⭐⭐⭐ |
| page_view_id 클라이언트 생성 | 필수 | ✅ 완료 | ⭐⭐⭐⭐⭐ |
| v2 API 스키마 | 필수 | ✅ 완료 | ⭐⭐⭐⭐⭐ |

**결론**: Phase 0는 **100% 완료**

### 3.2 Phase 1: Events + 히트맵 ⚠️ 부분 완료

| 항목 | 명세서 요구사항 | 현재 구현 상태 | 평가 |
|------|----------------|---------------|------|
| Events 테이블 | 필수 | ❌ 미구현 | ⭐ |
| 이벤트 수집 (click, scroll) | 필수 | ✅ 완료 | ⭐⭐⭐⭐⭐ |
| 이벤트 배치 전송 | 필수 | ✅ 완료 | ⭐⭐⭐⭐⭐ |
| 히트맵 UI | 필수 | ❌ 미구현 | ⭐ |

**결론**: Phase 1는 **60% 완료** (Events 테이블 + 히트맵 UI 필요)

### 3.3 Phase 2: Rollup + 퍼널 ❌ 미구현

| 항목 | 명세서 요구사항 | 현재 구현 상태 | 평가 |
|------|----------------|---------------|------|
| Rollup 테이블 | 권장 | ❌ 미구현 | ⭐ |
| Rollup 생성 스케줄러 | 권장 | ❌ 미구현 | ⭐ |
| 퍼널 정의 테이블 | 권장 | ❌ 미구현 | ⭐ |
| 퍼널 UI | 권장 | ❌ 미구현 | ⭐ |

**결론**: Phase 2는 **0% 완료** (성능 최적화 필요 시 구현)

### 3.4 Phase 3: Web Vitals + AI 리포트 ❌ 미구현

| 항목 | 명세서 요구사항 | 현재 구현 상태 | 평가 |
|------|----------------|---------------|------|
| Web Vitals 수집 | 선택 | ❌ 미구현 | ⭐ |
| Web Vitals UI | 선택 | ❌ 미구현 | ⭐ |
| AI 요약 리포트 | 선택 | ❌ 미구현 | ⭐ |

**결론**: Phase 3는 **0% 완료** (옵션 기능)

---

## 4. 우선순위별 구현 계획

### 4.1 🔴 즉시 구현 필요 (Phase 1 완료)

**목표**: Events 시스템 완전 구축

**작업 목록**:
1. ✅ Events 테이블 마이그레이션 파일 생성
   - `supabase/migrations/YYYYMMDD_create_uslab_events_table.sql`
   - 스키마: `id`, `session_id`, `page_view_id`, `name`, `page_path`, `props`, `client_ts`, `created_at`
   - 인덱스: `created_at`, `session_id`, `page_view_id`, `name`
   - RLS 정책: authenticated만 조회

2. ✅ 히트맵 UI 카드 추가 (대시보드)
   - `app/admin/dashboard/page.tsx`에 히트맵 섹션 추가
   - Top Clicked Elements 표시
   - 페이지별 클릭 히트맵 (간단한 버전)

**예상 기간**: 1-2일  
**리스크**: 낮음  
**ROI**: 높음 (핵심 기능 완성)

### 4.2 🟡 단기 구현 권장 (성능 최적화)

**목표**: Retention 스케줄러 설정

**작업 목록**:
1. ✅ Vercel Cron 설정
   - `vercel.json`에 cron job 추가
   - 매일 새벽 2시 (KST) 실행
   - `/api/analytics/cleanup` 엔드포인트 생성

2. ✅ post_id/about_id 자동 매핑 (선택)
   - `app/api/track/route.ts`에서 `page_path` 분석
   - `/ko/blog/[slug]` → `uslab_posts` 조회하여 `post_id` 매핑
   - `/ko/about` → `uslab_about` 조회하여 `about_id` 매핑

**예상 기간**: 1일  
**리스크**: 낮음  
**ROI**: 중간 (데이터 관리 및 품질 향상)

### 4.3 🟢 중기 검토 (성능 필요 시)

**목표**: Rollup 테이블 도입

**작업 목록**:
1. ✅ Rollup 테이블 생성
   - `uslab_daily_stats`: 일별 집계
   - `uslab_daily_page_stats`: 페이지별 일별 집계

2. ✅ Rollup 생성 스케줄러
   - 매일 자정에 전날 데이터 집계

3. ✅ Query 함수를 rollup 우선으로 변경
   - Raw 데이터 대신 rollup 테이블 조회

**예상 기간**: 3-5일  
**리스크**: 중간  
**ROI**: 중간 (트래픽 증가 시 필수)

### 4.4 🔵 장기 검토 (옵션)

**목표**: Web Vitals + AI 리포트

**작업 목록**:
1. ⚠️ Web Vitals 수집 (Next.js `useReportWebVitals`)
2. ⚠️ AI 요약 리포트 (복잡도 높음)

**예상 기간**: 7-10일  
**리스크**: 높음  
**ROI**: 낮음 (고급 기능)

---

## 5. 즉시 구현 필요 사항

### 5.1 Events 테이블 마이그레이션

**파일**: `supabase/migrations/YYYYMMDD_create_uslab_events_table.sql`

**필요 사항**:
- `{{prefix}}_events` 테이블 생성
- 인덱스 생성 (성능 최적화)
- RLS 정책 설정
- 주석 추가

**우선순위**: 🔴 높음 (즉시 구현)

### 5.2 히트맵 UI 카드

**파일**: `app/admin/dashboard/page.tsx`

**필요 사항**:
- Top Clicked Elements 표시
- 페이지별 클릭 히트맵 (간단한 버전)
- API 엔드포인트: `/api/admin/dashboard`에 히트맵 데이터 추가

**우선순위**: 🔴 높음 (Phase 1 완성)

---

## 6. 결론 및 권장사항

### 6.1 현재 상태 평가

**전체 평가**: ⭐⭐⭐⭐ (4/5)

**강점**:
- ✅ Phase 0 (이식성 확보) 완벽 구현
- ✅ Step1 (기본 트래킹) 완벽 구현
- ✅ Events 수집 로직 완벽 구현
- ✅ v2 API 스키마 완벽 지원

**보완 필요**:
- ⚠️ Events 테이블 마이그레이션 필요 (즉시)
- ⚠️ 히트맵 UI 구현 필요 (즉시)
- ⚠️ Retention 스케줄러 설정 필요 (단기)

### 6.2 권장 구현 순서

1. **즉시 (1-2일)**: Events 테이블 + 히트맵 UI
   - Phase 1 완성
   - ROI 높음, 리스크 낮음

2. **단기 (1일)**: Retention 스케줄러 + post_id 매핑
   - 데이터 관리 및 품질 향상
   - 리스크 낮음

3. **중기 (트래픽 증가 시)**: Rollup 테이블
   - 성능 최적화
   - 트래픽 증가 시 필수

4. **장기 (필요 시)**: Web Vitals + AI 리포트
   - 고급 기능
   - 복잡도 높음

### 6.3 최종 권장사항

**현재 구현 상태는 매우 우수하며, Phase 0와 Step1이 완벽하게 구현되어 있습니다.**

**즉시 구현 권장**:
1. Events 테이블 마이그레이션 (필수)
2. 히트맵 UI 카드 추가 (Phase 1 완성)

**단기 구현 권장**:
1. Retention 스케줄러 설정 (데이터 관리)
2. post_id/about_id 자동 매핑 (데이터 품질)

**중기/장기**:
- 트래픽 증가 시 Rollup 테이블 검토
- 필요 시 Web Vitals 및 AI 리포트 검토

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-01-XX




