# ì—ë””í„° ì´ë¯¸ì§€ ì‚½ì… êµ¬í˜„ ë°©ì‹ ë³´ê³ ì„œ

**ì‘ì„± ì¼ì**: 2025-01-16  
**í”„ë¡œì íŠ¸**: uslab-web  
**ì—ë””í„°**: Novel.sh (Tiptap ê¸°ë°˜)

---

## ğŸ“‹ ê°œìš”

í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” **3ê°€ì§€ ë°©ì‹**ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì‚½ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ë“œë˜ê·¸ ì•¤ ë“œë¡­** (Drag & Drop)
2. **í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸°** (Ctrl+V / Cmd+V)
3. **ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°** (URL ìë™ ê°ì§€)

ëª¨ë“  ì´ë¯¸ì§€ëŠ” **Supabase Storage**ì— ì—…ë¡œë“œë˜ë©°, ì—…ë¡œë“œ ì¤‘ì—ëŠ” placeholderê°€ í‘œì‹œë©ë‹ˆë‹¤.

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ì „ì²´ íë¦„

```
ì‚¬ìš©ì ì•¡ì…˜ (ë“œë˜ê·¸/ë¶™ì—¬ë„£ê¸°/URL)
    â†“
Novel.sh í•¸ë“¤ëŸ¬ (handleImageDrop / handleImagePaste)
    â†“
createImageUpload í•¨ìˆ˜ í˜¸ì¶œ
    â†“
/api/upload API ì—”ë“œí¬ì¸íŠ¸
    â†“
Supabase Storage ì—…ë¡œë“œ
    â†“
Public URL ë°˜í™˜
    â†“
ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì…
```

---

## ğŸ”§ êµ¬í˜„ ìƒì„¸

### 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜ ì„¤ì •

**íŒŒì¼**: `components/editor/BlogEditor.tsx`

```typescript:30:115:components/editor/BlogEditor.tsx
// ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
const uploadFn = useMemo(() => {
  return createImageUpload({
    validateFn: (file: File) => {
      // íŒŒì¼ íƒ€ì… ê²€ì¦
      if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return false;
      }
      // íŒŒì¼ í¬ê¸° ê²€ì¦ (ìµœëŒ€ 50MB)
      if (file.size > 50 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
      }
      return true;
    },
    onUpload: async (file: File): Promise<string> => {
      // Supabase ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }

      // FormData ìƒì„±
      const formData = new FormData();
      formData.append('file', file);

      // ì—…ë¡œë“œ API í˜¸ì¶œ
      const response = await fetch('/api/upload', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
        },
        body: formData,
      });

      // ì—ëŸ¬ ì²˜ë¦¬
      if (!response.ok) {
        // ... ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ ...
        throw new Error(errorMessage);
      }

      // ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬
      const data = await response.json();
      if (!data.url) {
        throw new Error('ì´ë¯¸ì§€ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
      return data.url; // Public URL ë°˜í™˜
    },
  });
}, []);
```

**í•µì‹¬ í¬ì¸íŠ¸**:
- `createImageUpload`: Novel.shì—ì„œ ì œê³µí•˜ëŠ” ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜ ìƒì„± ìœ í‹¸
- `validateFn`: í´ë¼ì´ì–¸íŠ¸ ì¸¡ íŒŒì¼ ê²€ì¦ (íƒ€ì…, í¬ê¸°)
- `onUpload`: ì‹¤ì œ ì—…ë¡œë“œ ë¡œì§ (Supabase Storage)
- ë°˜í™˜ê°’: ì—…ë¡œë“œëœ ì´ë¯¸ì§€ì˜ Public URL

---

### 2. ì´ë¯¸ì§€ í™•ì¥ ì„¤ì •

**íŒŒì¼**: `components/editor/BlogEditor.tsx`

```typescript:117:171:components/editor/BlogEditor.tsx
// ì´ë¯¸ì§€ í™•ì¥ ì„¤ì • (ì—…ë¡œë“œ í”ŒëŸ¬ê·¸ì¸ í¬í•¨ + ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥)
const imageExtension = useMemo(() => {
  return UpdatedImage.extend({
    addAttributes() {
      return {
        ...this.parent?.(),
        width: {
          default: null,
          parseHTML: (element) => {
            const width = element.getAttribute('width');
            return width ? parseInt(width, 10) : null;
          },
          renderHTML: (attributes) => {
            if (!attributes.width) {
              return {};
            }
            return {
              width: attributes.width,
            };
          },
        },
        height: {
          default: null,
          parseHTML: (element) => {
            const height = element.getAttribute('height');
            return height ? parseInt(height, 10) : null;
          },
          renderHTML: (attributes) => {
            if (!attributes.height) {
              return {};
            }
            return {
              height: attributes.height,
            };
          },
        },
      };
    },
    addProseMirrorPlugins() {
      return [
        UploadImagesPlugin({
          imageClass: 'opacity-40 rounded-lg border border-slate-300',
        }),
        // ImageResizePluginì€ ImageResizeExtensionìœ¼ë¡œ ë³„ë„ ë“±ë¡
      ];
    },
  }).configure({
    allowBase64: false, // Base64 ì¸ì½”ë”© ë¹„í™œì„±í™” (URLë§Œ ì‚¬ìš©)
    HTMLAttributes: {
      class: 'rounded-lg border border-slate-300 resizable-image',
      style: 'max-width: 100%; height: auto; max-height: 600px; object-fit: contain; cursor: pointer;',
    },
    inline: false, // ë¸”ë¡ ë ˆë²¨ ì´ë¯¸ì§€
  });
}, []);
```

**í•µì‹¬ í¬ì¸íŠ¸**:
- `UpdatedImage`: Novel.shì—ì„œ ì œê³µí•˜ëŠ” ì´ë¯¸ì§€ í™•ì¥
- `addAttributes`: `width`, `height` ì†ì„± ì¶”ê°€ (ë¦¬ì‚¬ì´ì¦ˆ ì§€ì›)
- `UploadImagesPlugin`: ì—…ë¡œë“œ ì¤‘ placeholder í‘œì‹œ
- `allowBase64: false`: Base64 ì¸ì½”ë”© ë¹„í™œì„±í™” (URLë§Œ ì‚¬ìš©)

---

### 3. ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬

**íŒŒì¼**: `components/editor/BlogEditor.tsx`

```typescript:278:280:components/editor/BlogEditor.tsx
handleDrop: (view, event, slice, moved) => {
  return handleImageDrop(view, event, moved, uploadFn);
},
```

**ë™ì‘ ë°©ì‹**:
1. ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ íŒŒì¼ì„ ì—ë””í„° ì˜ì—­ìœ¼ë¡œ ë“œë˜ê·¸
2. `handleImageDrop` (Novel.sh ì œê³µ)ì´ ì´ë²¤íŠ¸ ê°ì§€
3. `uploadFn`ì„ í˜¸ì¶œí•˜ì—¬ ì—…ë¡œë“œ
4. ì—…ë¡œë“œ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ì‚½ì…

---

### 4. í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬

**íŒŒì¼**: `components/editor/BlogEditor.tsx`

```typescript:238:277:components/editor/BlogEditor.tsx
handlePaste: (view, event) => {
  // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬
  const handled = handleImagePaste(view, event, uploadFn);
  if (handled) return true;

  // URL ë¶™ì—¬ë„£ê¸° ê°ì§€
  const text = event.clipboardData?.getData('text/plain');
  if (!text) return false;

  // ì´ë¯¸ì§€ URLì¸ ê²½ìš°
  if (/\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i.test(text)) {
    event.preventDefault();
    const { state, dispatch } = view;
    const { selection } = state;
    const imageNode = state.schema.nodes.image.create({
      src: text,
    });
    const transaction = state.tr.replaceSelectionWith(imageNode);
    dispatch(transaction);
    return true;
  }

  // YouTube URLì¸ ê²½ìš°
  const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
  const youtubeMatch = text.match(youtubeRegex);
  if (youtubeMatch) {
    event.preventDefault();
    const { state, dispatch } = view;
    const { selection } = state;
    const videoId = youtubeMatch[1];
    const youtubeNode = state.schema.nodes.youtube.create({
      src: `https://www.youtube.com/embed/${videoId}`,
    });
    const transaction = state.tr.replaceSelectionWith(youtubeNode);
    dispatch(transaction);
    return true;
  }

  return false;
},
```

**ë™ì‘ ë°©ì‹**:
1. **ì´ë¯¸ì§€ íŒŒì¼ ë¶™ì—¬ë„£ê¸°**:
   - `handleImagePaste` (Novel.sh ì œê³µ)ê°€ í´ë¦½ë³´ë“œì˜ ì´ë¯¸ì§€ íŒŒì¼ ê°ì§€
   - `uploadFn`ì„ í˜¸ì¶œí•˜ì—¬ ì—…ë¡œë“œ
   - ì—…ë¡œë“œ ì™„ë£Œ í›„ ì´ë¯¸ì§€ ì‚½ì…

2. **ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°**:
   - í´ë¦½ë³´ë“œ í…ìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ì§€ URL íŒ¨í„´ ê°ì§€ (`jpg`, `png`, `gif`, `webp`, `svg`)
   - URLì„ ì§ì ‘ `src`ë¡œ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë…¸ë“œ ìƒì„±
   - ì—…ë¡œë“œ ì—†ì´ ë°”ë¡œ ì‚½ì… (ì™¸ë¶€ URL ì‚¬ìš©)

3. **YouTube URL ë¶™ì—¬ë„£ê¸°**:
   - YouTube URL íŒ¨í„´ ê°ì§€
   - YouTube ë…¸ë“œë¡œ ë³€í™˜í•˜ì—¬ ì‚½ì…

---

### 5. ì—…ë¡œë“œ API ì—”ë“œí¬ì¸íŠ¸

**íŒŒì¼**: `app/api/upload/route.ts`

```typescript:13:112:app/api/upload/route.ts
export async function POST(request: NextRequest) {
  try {
    // ì¸ì¦ í™•ì¸
    const authHeader = request.headers.get('authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { error: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 401 }
      );
    }

    // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (Service Role Key ì‚¬ìš©)
    const supabase = createClient(supabaseUrl, supabaseServiceRoleKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // FormDataì—ì„œ íŒŒì¼ ì¶”ì¶œ
    const formData = await request.formData();
    const file = formData.get('file') as File;

    // íŒŒì¼ íƒ€ì… ê²€ì¦ (ì´ë¯¸ì§€ë§Œ í—ˆìš©)
    if (!file.type.startsWith('image/')) {
      return NextResponse.json(
        { error: 'ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í¬ê¸° ê²€ì¦ (ìµœëŒ€ 50MB)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
      return NextResponse.json(
        { error: 'íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // ê³ ìœ í•œ íŒŒì¼ëª… ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ ë¬¸ìì—´)
    const timestamp = Date.now();
    const randomStr = Math.random().toString(36).substring(2, 15);
    const fileExt = file.name.split('.').pop() || 'png';
    const fileName = `uslab/${timestamp}-${randomStr}.${fileExt}`;

    // Supabase Storageì— ì—…ë¡œë“œ
    const { data, error } = await supabase.storage
      .from('uslab-images')
      .upload(fileName, file, {
        contentType: file.type,
        upsert: false, // ê¸°ì¡´ íŒŒì¼ ë®ì–´ì“°ê¸° ë°©ì§€
      });

    if (error) {
      return NextResponse.json(
        { error: `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}` },
        { status: 500 }
      );
    }

    // Public URL ê°€ì ¸ì˜¤ê¸°
    const { data: urlData } = supabase.storage
      .from('uslab-images')
      .getPublicUrl(fileName);

    return NextResponse.json({
      url: urlData.publicUrl,
      path: fileName,
    });
  } catch (error: any) {
    return NextResponse.json(
      { error: error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}
```

**í•µì‹¬ í¬ì¸íŠ¸**:
- **ì¸ì¦**: Bearer í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì¸ì¦ í™•ì¸
- **ê²€ì¦**: íŒŒì¼ íƒ€ì…, í¬ê¸° ê²€ì¦ (ì„œë²„ ì¸¡)
- **íŒŒì¼ëª…**: íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ ë¬¸ìì—´ë¡œ ê³ ìœ ì„± ë³´ì¥
- **ì €ì¥ì†Œ**: Supabase Storage `uslab-images` ë²„í‚·
- **ë°˜í™˜**: Public URLê³¼ íŒŒì¼ ê²½ë¡œ

---

### 6. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥

**íŒŒì¼**: `components/editor/ImageResizeExtension.tsx` (ë˜ëŠ” `ImageResizePlugin.tsx`)

ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì´ í‘œì‹œë˜ë©°, ë“œë˜ê·¸í•˜ì—¬ í¬ê¸°ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íŠ¹ì§•**:
- ìµœì†Œ í¬ê¸°: 50px
- ìµœëŒ€ í¬ê¸°: 1200px
- ë¹„ìœ¨ ìœ ì§€ (aspect ratio)
- í¬ê¸° ì •ë³´ë¥¼ ë…¸ë“œ ì†ì„±ì— ì €ì¥

---

## ğŸ“Š ì‚½ì… ë°©ì‹ ë¹„êµ

| ë°©ì‹ | ì—…ë¡œë“œ í•„ìš” | ì²˜ë¦¬ í•¨ìˆ˜ | ì‚¬ìš© ì‚¬ë¡€ |
|------|------------|----------|----------|
| **ë“œë˜ê·¸ ì•¤ ë“œë¡­** | âœ… í•„ìš” | `handleImageDrop` | ë¡œì»¬ íŒŒì¼ ì§ì ‘ ì‚½ì… |
| **í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸°** | âœ… í•„ìš” | `handleImagePaste` | ìŠ¤í¬ë¦°ìƒ·, ë³µì‚¬í•œ ì´ë¯¸ì§€ |
| **ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸°** | âŒ ë¶ˆí•„ìš” | `handlePaste` (ì»¤ìŠ¤í…€) | ì™¸ë¶€ ì´ë¯¸ì§€ URL ì‚¬ìš© |

---

## ğŸ”’ ë³´ì•ˆ ë° ê²€ì¦

### í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê²€ì¦
- íŒŒì¼ íƒ€ì…: `image/*`ë§Œ í—ˆìš©
- íŒŒì¼ í¬ê¸°: ìµœëŒ€ 50MB

### ì„œë²„ ì¸¡ ê²€ì¦
- ì¸ì¦: Bearer í† í° í™•ì¸
- íŒŒì¼ íƒ€ì…: `image/*`ë§Œ í—ˆìš©
- íŒŒì¼ í¬ê¸°: ìµœëŒ€ 50MB
- íŒŒì¼ëª…: ê³ ìœ ì„± ë³´ì¥ (íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤)

---

## ğŸ¨ ì‚¬ìš©ì ê²½í—˜ (UX)

### ì—…ë¡œë“œ ì¤‘ í‘œì‹œ
- `UploadImagesPlugin`ì´ ì—…ë¡œë“œ ì¤‘ ì´ë¯¸ì§€ì— `opacity-40` í´ë˜ìŠ¤ ì ìš©
- ì—…ë¡œë“œ ì™„ë£Œ ì‹œ ì •ìƒ í‘œì‹œë¡œ ì „í™˜

### ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼
- `max-width: 100%`: ë°˜ì‘í˜• í¬ê¸° ì¡°ì ˆ
- `max-height: 600px`: ìµœëŒ€ ë†’ì´ ì œí•œ
- `object-fit: contain`: ë¹„ìœ¨ ìœ ì§€
- `rounded-lg border`: ë‘¥ê·¼ ëª¨ì„œë¦¬ì™€ í…Œë‘ë¦¬

---

## ğŸ”„ ë°ì´í„° ì €ì¥

### Tiptap JSON í˜•ì‹
```json
{
  "type": "image",
  "attrs": {
    "src": "https://...supabase.co/storage/v1/object/public/uslab-images/uslab/1234567890-abc123.png",
    "width": 800,
    "height": 600
  }
}
```

### ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
- `uslab_posts.content` (jsonb ì»¬ëŸ¼)ì— Tiptap JSONìœ¼ë¡œ ì €ì¥
- ì´ë¯¸ì§€ URLì€ Supabase Storage Public URL

---

## ğŸ“ ì£¼ìš” í•¨ìˆ˜ ë° ì»´í¬ë„ŒíŠ¸

### Novel.sh ì œê³µ
- `createImageUpload`: ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜ ìƒì„±
- `handleImagePaste`: í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬
- `handleImageDrop`: ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
- `UploadImagesPlugin`: ì—…ë¡œë“œ ì¤‘ placeholder í‘œì‹œ
- `UpdatedImage`: ì´ë¯¸ì§€ í™•ì¥

### ì»¤ìŠ¤í…€ êµ¬í˜„
- `/api/upload`: Supabase Storage ì—…ë¡œë“œ API
- `ImageResizeExtension`: ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥

---

## ğŸš€ í–¥í›„ ê°œì„  ì‚¬í•­

1. **ì´ë¯¸ì§€ ìµœì í™”**
   - ì—…ë¡œë“œ ì „ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
   - WebP í˜•ì‹ ë³€í™˜
   - ì¸ë„¤ì¼ ìƒì„±

2. **ìº¡ì…˜ ì§€ì›**
   - ì´ë¯¸ì§€ í•˜ë‹¨ì— ìº¡ì…˜ ì¶”ê°€
   - `figure` / `figcaption` êµ¬ì¡°

3. **ëŒ€í‘œ ì´ë¯¸ì§€ ì„¤ì •**
   - ì´ë¯¸ì§€ ìš°í´ë¦­ ë©”ë‰´
   - "ëŒ€í‘œ ì´ë¯¸ì§€ë¡œ ì„¤ì •" ì˜µì…˜

4. **ìŠ¬ë˜ì‹œ ë©”ë‰´ í†µí•©**
   - `/image` ëª…ë ¹ì–´ë¡œ ì´ë¯¸ì§€ ì‚½ì…
   - íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Novel.sh ê³µì‹ ë¬¸ì„œ](https://novel.sh/docs)
- [Tiptap Image Extension](https://tiptap.dev/api/nodes/image)
- [Supabase Storage ë¬¸ì„œ](https://supabase.com/docs/guides/storage)

---

**ì‘ì„± ì™„ë£Œ**: 2025-01-16

