# AI ë³´ê³ ì„œ ê¸°ëŠ¥ êµ¬í˜„ ëª…ì„¸ì„œ (v1.1)

**ì‘ì„±ì¼**: 2025-01-XX  
**í”„ë¡œì íŠ¸**: USLab.ai  
**ëª©ì **: AI ê¸°ë°˜ ëŒ€ì‹œë³´ë“œ ë¶„ì„ ë³´ê³ ì„œ ìë™ ìƒì„± ê¸°ëŠ¥ êµ¬í˜„  
**ë²„ì „**: 1.1 (ê²€í† ì˜ê²¬ ë°˜ì˜)  
**ì´ì „ ë²„ì „**: [v1.0](./AI_ë³´ê³ ì„œ_ê¸°ëŠ¥_êµ¬í˜„_ëª…ì„¸ì„œ.md)

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ë³´ì•ˆ ë° ê°œì¸ì •ë³´ ë³´í˜¸](#ë³´ì•ˆ-ë°-ê°œì¸ì •ë³´-ë³´í˜¸)
3. [AI ë³´ê³ ì„œ ë°ì´í„° êµ¬ì¡°](#ai-ë³´ê³ ì„œ-ë°ì´í„°-êµ¬ì¡°)
4. [AI ë³´ê³ ì„œ ìƒì„± ë°©ì•ˆ](#ai-ë³´ê³ ì„œ-ìƒì„±-ë°©ì•ˆ)
5. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
6. [êµ¬í˜„ ê³„íš](#êµ¬í˜„-ê³„íš)
7. [í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿](#í”„ë¡¬í”„íŠ¸-í…œí”Œë¦¿)

---

## 1. ê°œìš”

### 1.1 ëª©ì 

ëŒ€ì‹œë³´ë“œì— í‘œì‹œë˜ëŠ” ëª¨ë“  í†µê³„ ë°ì´í„°ë¥¼ AIê°€ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ì™€ ê¶Œì¥ì‚¬í•­ì„ í¬í•¨í•œ ìë™ ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### 1.2 ì£¼ìš” ê¸°ëŠ¥

- **ìë™ ë¶„ì„**: ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ AIê°€ ë¶„ì„í•˜ì—¬ íŠ¸ë Œë“œ, íŒ¨í„´, ì´ìƒ ì§•í›„ ê°ì§€
- **ì¸ì‚¬ì´íŠ¸ ì œê³µ**: ì£¼ìš” ë°œê²¬ì‚¬í•­, ê°œì„  ê¸°íšŒ, ì„±ê³¼ ìš”ì•½ (ê·¼ê±° ê¸°ë°˜)
- **ê¶Œì¥ì‚¬í•­ ì œì‹œ**: êµ¬ì²´ì ì¸ ì•¡ì…˜ ì•„ì´í…œ ì œì•ˆ
- **ê¸°ê°„ë³„ ë¦¬í¬íŠ¸**: ì¼ì¼/ì£¼ê°„/ì›”ê°„ ë¦¬í¬íŠ¸ ìƒì„±
- **ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì›**: í”„ë¦¬í”½ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì§€ì› (uslab/ustudio/modu)

### 1.3 v1.1 ì£¼ìš” ê°œì„ ì‚¬í•­

- âœ… **PII ì œê±°**: ê°œì¸ì •ë³´/ë¯¼ê°ì •ë³´ê°€ AI ì…ë ¥ì— í¬í•¨ë˜ì§€ ì•Šë„ë¡ í•„í„°ë§
- âœ… **í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€**: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ë³´ì•ˆ ê·œì¹™ ì¶”ê°€
- âœ… **ì…ë ¥/ì¶œë ¥ ìŠ¤í‚¤ë§ˆ ì¼ì¹˜**: engagementSummary ë“± ì‚¬ì „ ê³„ì‚° ê°’ ì¶”ê°€
- âœ… **í† í° ê¸¸ì´ ìµœì í™”**: ë°ì´í„° ê°œìˆ˜ ì œí•œ ë° ìš”ì•½ ê·œì¹™ ì ìš©
- âœ… **ì‹ ë¢°ë„ ê²€ì¦**: evidence, confidence í•„ë“œ ì¶”ê°€
- âœ… **ë©€í‹°í…Œë„ŒíŠ¸ ëŒ€ì‘**: í”„ë¦¬í”½ìŠ¤ ê¸°ë°˜ ì´ì‹ì„± í™•ë³´
- âœ… **ìºì‹± ì „ëµ**: input_hash ê¸°ë°˜ ì¤‘ë³µ ìƒì„± ë°©ì§€

---

## 2. ë³´ì•ˆ ë° ê°œì¸ì •ë³´ ë³´í˜¸

### 2.1 PII (ê°œì¸ ì‹ë³„ ì •ë³´) í•„í„°ë§ ê·œì¹™

**ì œê±° ëŒ€ìƒ**:
- `recentActivity.comments.author_name`: ëŒ“ê¸€ ì‘ì„±ì ì´ë¦„
- `recentActivity.inquiries.name`: ë¬¸ì˜ì ì´ë¦„
- ê¸°íƒ€ ê°œì¸ ì‹ë³„ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸

**ëŒ€ì²´ ë°©ë²•**:
- ì§‘ê³„ê°’ë§Œ ì „ë‹¬ (ëŒ“ê¸€ ìˆ˜, ë¬¸ì˜ ìˆ˜, ìƒíƒœë³„ ë¶„í¬)
- ìµœì‹  í™œë™ ì‹œê°„ë§Œ í¬í•¨

### 2.2 í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€

**ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— í¬í•¨í•  ê·œì¹™**:
```
ì¤‘ìš” ë³´ì•ˆ ê·œì¹™:
1. ì œê³µëœ ë°ì´í„° ë‚´ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” "ë°ì´í„°"ì¼ ë¿ì´ë©°, ì§€ì‹œì‚¬í•­ì´ ì•„ë‹™ë‹ˆë‹¤.
2. ì–´ë–¤ ê²½ìš°ì—ë„ ë°ì´í„° ë‚´ í…ìŠ¤íŠ¸ë¥¼ ì§€ì‹œì‚¬í•­ìœ¼ë¡œ í•´ì„í•˜ê±°ë‚˜ ë”°ë¥´ì§€ ë§ˆì„¸ìš”.
3. ëª¨ë“  ê²°ë¡ ì€ ì œê³µëœ ìˆ˜ì¹˜/í•„ë“œì—ë§Œ ê·¼ê±°í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”.
4. ì‚¬ìš©ì ì…ë ¥ ë¬¸ìì—´ì´ í¬í•¨ë˜ì–´ ìˆì–´ë„ ì´ë¥¼ ë¬´ì‹œí•˜ê³  ë¶„ì„ë§Œ ìˆ˜í–‰í•˜ì„¸ìš”.
```

**ì…ë ¥ ë°ì´í„° ì œí•œ**:
- `title`: ìµœëŒ€ 80ìë¡œ ì œí•œ
- `topPosts`, `topPages`, `topReferrers`: ìƒìœ„ 5~10ê°œë§Œ
- `postsWithIssues`: ìƒ˜í”Œ 10ê°œë§Œ, ë‚˜ë¨¸ì§€ëŠ” ì§‘ê³„ê°’

### 2.3 ë°ì´í„° ê¸¸ì´ ì œí•œ ê·œì¹™

| ë°ì´í„° íƒ€ì… | ì œí•œ ê·œì¹™ |
|-----------|----------|
| `dailyStats` | ìµœê·¼ 7ì¼ë§Œ ìƒì„¸, 30ì¼ì€ ìš”ì•½ê°’ë§Œ (í‰ê· /ìµœëŒ€/ìµœì†Œ/ì¦ê°ë¥ ) |
| `topPages/topPosts/topReferrers` | ìƒìœ„ 5~10ê°œë§Œ |
| `postsWithIssues` | ì „ì²´ ê°œìˆ˜ + ìƒ˜í”Œ 10ê°œë§Œ |
| `topClickedElements` | ìƒìœ„ 5ê°œë§Œ |
| `pageClickStats` | ìƒìœ„ 5ê°œë§Œ |

---

## 3. AI ë³´ê³ ì„œ ë°ì´í„° êµ¬ì¡°

### 3.1 AI ë³´ê³ ì„œ ì…ë ¥ ë°ì´í„° (PII ì œê±° ë²„ì „)

```typescript
interface AIReportInput {
  // ë©”íƒ€ ì •ë³´
  reportType: 'daily' | 'weekly' | 'monthly' | 'custom';
  period: {
    startDate: string;  // ISO 8601
    endDate: string;    // ISO 8601
    days: number;
  };
  sitePrefix: string;   // uslab/ustudio/modu (í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ìš”ì²­ íŒŒë¼ë¯¸í„°)

  // ê¸°ë³¸ í†µê³„
  stats: {
    totalPosts: number;
    publishedPosts: number;
    draftPosts: number;
    totalViews: number;
    todayPageviews: number;
    todayUniques: number;
    last7Days: { pageviews: number; uniques: number };
    last30Days: { pageviews: number; uniques: number };
  };

  // íŠ¸ë˜í”½ ì¶”ì´ (ìµœê·¼ 7ì¼ ìƒì„¸ + 30ì¼ ìš”ì•½)
  dailyStats: {
    last7Days: Array<{
      day: string;                    // YYYY-MM-DD
      pageviews: number;
      uniques: number;
    }>;
    last30DaysSummary: {
      avgPageviews: number;
      maxPageviews: number;
      minPageviews: number;
      avgUniques: number;
      growthRate: number;             // ì „ ê¸°ê°„ ëŒ€ë¹„ ì¦ê°ë¥  (%)
      volatility: number;             // ë³€ë™ì„± (í‘œì¤€í¸ì°¨)
    };
  };

  // Top ë°ì´í„° (ìƒìœ„ 5~10ê°œë§Œ)
  topPages: Array<{
    page_path: string;
    pageviews: number;
    uniques: number;
  }>;  // ìµœëŒ€ 10ê°œ

  topPosts: Array<{
    post_id: string;
    title: string;                    // ìµœëŒ€ 80ìë¡œ ì œí•œ
    locale: string;
    pageviews: number;
    uniques: number;
  }>;  // ìµœëŒ€ 10ê°œ

  topReferrers: Array<{
    referrer_host: string | null;
    sessions: number;
  }>;  // ìµœëŒ€ 10ê°œ

  // SEO ìƒíƒœ
  seoStatus: {
    technical: {
      hasSitemap: boolean;
      hasRobots: boolean;
      hasCanonical: boolean;
      hasJsonLd: boolean;
    };
    quality: {
      totalPublished: number;
      missingSeoTitle: number;
      missingSeoDescription: number;
      seoTitleTooLong: number;
      seoDescriptionTooLong: number;
      postsWithIssuesSample: Array<{  // ìƒ˜í”Œ 10ê°œë§Œ
        id: string;
        title: string;                // ìµœëŒ€ 80ì
        slug: string;
        locale: string;
        issues: string[];
      }>;
    };
  };

  // íˆíŠ¸ë§µ ë°ì´í„° (ìƒìœ„ 5ê°œë§Œ)
  heatmapData: {
    topClickedElements: Array<{
      element_id: string | null;
      page_path: string;
      clicks: number;
    }>;  // ìµœëŒ€ 5ê°œ
    pageClickStats: Array<{
      page_path: string;
      clicks: number;
      unique_elements: number;
    }>;  // ìµœëŒ€ 5ê°œ
  } | null;

  // Web Vitals ë°ì´í„°
  webVitalsData: {
    metrics: Array<{
      name: string;
      p50: number;
      p75: number;
      p95: number;
      count: number;
      good: number;
      needsImprovement: number;
      poor: number;
    }>;
  } | null;

  // ì°¸ì—¬ë„ ì§‘ê³„ (ì‚¬ì „ ê³„ì‚°)
  engagementSummary: {
    avgScrollDepthPct: number;        // í‰ê·  ìŠ¤í¬ë¡¤ ê¹Šì´ (%)
    p50ScrollDepthPct: number;         // ì¤‘ì•™ê°’ ìŠ¤í¬ë¡¤ ê¹Šì´ (%)
    avgViewDurationSec: number;       // í‰ê·  ì²´ë¥˜ ì‹œê°„ (ì´ˆ)
    p50ViewDurationSec: number;       // ì¤‘ì•™ê°’ ì²´ë¥˜ ì‹œê°„ (ì´ˆ)
    topEngagedPages: Array<{          // ìƒìœ„ 5ê°œë§Œ
      page_path: string;
      avgScrollDepthPct: number;
      avgViewDurationSec: number;
      pageviews: number;
    }>;
  } | null;

  // ì‚¬ì „ ê³„ì‚° ì‹ í˜¸ê°’ (ì½”ë“œë¡œ ê³„ì‚°)
  computedSignals: {
    trafficChangeRate: number;         // ì „ ê¸°ê°„ ëŒ€ë¹„ íŠ¸ë˜í”½ ë³€í™”ìœ¨ (%)
    weekdayWeekendDiff: {              // ìš”ì¼ íŒ¨í„´
      weekdayAvg: number;
      weekendAvg: number;
      diffPct: number;
    };
    outliers: Array<{                  // ì´ìƒì¹˜ (ê¸‰ì¦/ê¸‰ê°)
      day: string;
      type: 'spike' | 'drop';
      value: number;
      deviation: number;               // í‰ê·  ëŒ€ë¹„ í¸ì°¨
    }>;
    referrerChanges: Array<{           // ìœ ì… ê²½ë¡œ ë³€í™”
      referrer_host: string | null;
      changePct: number;
      trend: 'up' | 'down' | 'stable';
    }>;
    webVitalsPoorRate: number;         // Web Vitals Poor ë¹„ìœ¨ (%)
    heatmapMismatch: Array<{           // í´ë¦­ ë§ì§€ë§Œ ì „í™˜ ë‚®ì€ ìš”ì†Œ
      element_id: string;
      page_path: string;
      clicks: number;
      conversions: number;
      conversionRate: number;
    }>;
  };

  // ìµœê·¼ í™œë™ (PII ì œê±°, ì§‘ê³„ë§Œ)
  recentActivity: {
    posts: {
      count: number;                   // ìµœê·¼ 7ì¼ ë°œí–‰ í¬ìŠ¤íŠ¸ ìˆ˜
      latestPublishedAt: string | null; // ìµœì‹  ë°œí–‰ ì‹œê°„
    };
    comments: {
      totalCount: number;              // ìµœê·¼ 7ì¼ ëŒ“ê¸€ ìˆ˜
      approvedCount: number;            // ìŠ¹ì¸ëœ ëŒ“ê¸€ ìˆ˜
      pendingCount: number;            // ë¯¸ìŠ¹ì¸ ëŒ“ê¸€ ìˆ˜
      latestCreatedAt: string | null;  // ìµœì‹  ëŒ“ê¸€ ì‹œê°„
    };
    inquiries: {
      totalCount: number;              // ìµœê·¼ 7ì¼ ë¬¸ì˜ ìˆ˜
      statusDistribution: {
        pending: number;
        contacted: number;
        completed: number;
      };
      latestCreatedAt: string | null;  // ìµœì‹  ë¬¸ì˜ ì‹œê°„
    };
  };
}
```

---

### 3.2 AI ë³´ê³ ì„œ ì¶œë ¥ êµ¬ì¡° (Evidence/Confidence ì¶”ê°€)

```typescript
interface AIReport {
  // ë©”íƒ€ ì •ë³´
  reportId: string;
  reportType: 'daily' | 'weekly' | 'monthly' | 'custom';
  period: {
    startDate: string;
    endDate: string;
    days: number;
  };
  sitePrefix: string;
  generatedAt: string;  // ISO 8601
  modelName: string;    // gemini-2.0-flash ë˜ëŠ” gemini-2.0-pro
  promptVersion: string; // í”„ë¡¬í”„íŠ¸ ë²„ì „ (ì˜ˆ: "1.1")

  // ìš”ì•½
  summary: {
    overview: string;              // ì „ì²´ ìš”ì•½ (2-3ë¬¸ì¥)
    keyMetrics: {
      totalPageviews: number;
      totalUniques: number;
      avgDailyPageviews: number;
      avgDailyUniques: number;
      topPostTitle: string;        // ìµœëŒ€ 80ì
      topPostPageviews: number;
    };
  };

  // ì£¼ìš” ë°œê²¬ì‚¬í•­ (Evidence/Confidence ì¶”ê°€)
  insights: Array<{
    type: 'positive' | 'warning' | 'negative' | 'info';
    title: string;
    description: string;
    priority: 'high' | 'medium' | 'low';
    // ì‹ ë¢°ë„ ê²€ì¦ í•„ë“œ ì¶”ê°€
    evidence: {
      metric: string;               // ê·¼ê±°ê°€ ëœ ì…ë ¥ í•„ë“œ (ì˜ˆ: "last7Days.pageviews")
      current?: number;             // í˜„ì¬ ê°’
      previous?: number;            // ì´ì „ ê°’ (ë¹„êµ ì‹œ)
      changePct?: number;           // ë³€í™”ìœ¨ (%)
      threshold?: number;           // ê¸°ì¤€ê°’ (ì„ íƒì )
    };
    confidence: 'high' | 'medium' | 'low';  // ì‹ ë¢°ë„
    assumptions?: string;           // ê°€ì • ì‚¬í•­ (ì„ íƒì )
  }>;

  // íŠ¸ë Œë“œ ë¶„ì„
  trends: {
    trafficTrend: 'increasing' | 'decreasing' | 'stable';
    trafficTrendDescription: string;
    topContentTrend: string;
    referrerTrend: string;
  };

  // ì„±ëŠ¥ ë¶„ì„
  performance: {
    webVitals: {
      overall: 'good' | 'needs-improvement' | 'poor';
      summary: string;
      metrics: Array<{
        name: string;
        status: 'good' | 'needs-improvement' | 'poor';
        value: number;
        recommendation: string;
      }>;
    };
    engagement: {
      avgScrollDepth: number;       // engagementSummaryì—ì„œ ê°€ì ¸ì˜´
      avgViewDuration: number;      // engagementSummaryì—ì„œ ê°€ì ¸ì˜´
      topEngagedPages: Array<{      // engagementSummaryì—ì„œ ê°€ì ¸ì˜´
        page_path: string;
        avgScrollDepth: number;
        avgViewDuration: number;
      }>;
    } | null;                       // ë°ì´í„° ì—†ìœ¼ë©´ null
  };

  // SEO ë¶„ì„
  seo: {
    technicalStatus: 'good' | 'needs-improvement';
    technicalIssues: string[];
    contentQuality: {
      score: number;                // 0-100
      issues: Array<{
        type: string;
        count: number;
        description: string;
      }>;
      recommendations: string[];
    };
  };

  // ê¶Œì¥ì‚¬í•­
  recommendations: Array<{
    category: 'content' | 'seo' | 'performance' | 'ux' | 'marketing';
    priority: 'high' | 'medium' | 'low';
    title: string;
    description: string;
    actionItems: string[];
  }>;

  // ë¹„êµ ë¶„ì„ (ì´ì „ ê¸°ê°„ ëŒ€ë¹„, ì„ íƒì )
  comparison?: {
    previousPeriod: {
      startDate: string;
      endDate: string;
    };
    changes: {
      pageviews: {
        current: number;
        previous: number;
        change: number;             // í¼ì„¼íŠ¸ ë³€í™”
        trend: 'up' | 'down' | 'stable';
      };
      uniques: {
        current: number;
        previous: number;
        change: number;
        trend: 'up' | 'down' | 'stable';
      };
    };
  };
}
```

---

## 4. AI ë³´ê³ ì„œ ìƒì„± ë°©ì•ˆ

### 4.1 API ì—”ë“œí¬ì¸íŠ¸

**ì—”ë“œí¬ì¸íŠ¸**: `POST /api/ai/analytics-report`

**ì¸ì¦**: ê´€ë¦¬ì ì¸ì¦ í•„ìˆ˜ (Bearer Token)

**ìš”ì²­ ë³¸ë¬¸**:
```typescript
{
  reportType: 'daily' | 'weekly' | 'monthly' | 'custom';
  startDate?: string;  // customì¼ ë•Œ í•„ìˆ˜ (YYYY-MM-DD)
  endDate?: string;    // customì¼ ë•Œ í•„ìˆ˜ (YYYY-MM-DD)
  days?: number;       // daily/weekly/monthlyì¼ ë•Œ ì‚¬ìš©
  includeComparison?: boolean;  // ì´ì „ ê¸°ê°„ ë¹„êµ í¬í•¨ ì—¬ë¶€
  sitePrefix?: string; // ì„ íƒì , ì—†ìœ¼ë©´ í™˜ê²½ë³€ìˆ˜ ANALYTICS_PREFIX ì‚¬ìš©
}
```

**ì‘ë‹µ**:
```typescript
{
  report: AIReport;
  generatedAt: string;
  cached: boolean;  // ìºì‹œëœ ë³´ê³ ì„œì¸ì§€ ì—¬ë¶€
}
```

**ì—ëŸ¬ ì²˜ë¦¬**:
- JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ 1íšŒ ì¬ì‹œë„
- ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ fallback ë§ˆí¬ë‹¤ìš´ ìš”ì•½ ë°˜í™˜ ë˜ëŠ” ì—ëŸ¬ ì €ì¥

---

### 4.2 ìš´ì˜ ì •ì±…

**ìë™ ìƒì„± ìš°ì„ **:
- ëŒ€ì‹œë³´ë“œ ì ‘ì† ì‹œ: ê°€ì¥ ìµœê·¼ ìë™ ìƒì„±ëœ ë³´ê³ ì„œ í‘œì‹œ
- "AI ë³´ê³ ì„œ ìƒì„±" ë²„íŠ¼:
  - ê¸°ë³¸: ì¬ìƒì„± (override)
  - ì»¤ìŠ¤í…€ ê¸°ê°„: ìƒˆë¡œ ìƒì„±

**ë¹„ìš© ìµœì í™”**:
- ê°™ì€ ê¸°ê°„/ê°™ì€ ì…ë ¥ì´ë©´ ìºì‹œ ì¬ì‚¬ìš© (`input_hash` ê¸°ë°˜)
- ì¼ì¼ ìƒì„± ë¹ˆë„ ì œí•œ (ê´€ë¦¬ì ì„¤ì • ê°€ëŠ¥)
- í”„ë¡¬í”„íŠ¸ ê¸¸ì´ ìµœì í™” (í•„ìˆ˜ ë°ì´í„°ë§Œ)

---

## 5. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 5.1 ë³´ê³ ì„œ ì €ì¥ í…Œì´ë¸”

**í…Œì´ë¸”ëª…**: `{{prefix}}_analytics_reports`

**DDL**:
```sql
-- Analytics Reports í…Œì´ë¸” ìƒì„±
-- ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚ ì§œ: 2025-01-XX
-- ëª©ì : AI ìƒì„± ë³´ê³ ì„œ ì €ì¥ ë° ìºì‹±

create table if not exists {{prefix}}_analytics_reports (
  id uuid primary key default gen_random_uuid(),
  
  -- ë©€í‹°í…Œë„ŒíŠ¸ ì§€ì›
  site_prefix varchar(50) not null,  -- uslab/ustudio/modu
  
  -- ë³´ê³ ì„œ ë©”íƒ€ ì •ë³´
  report_type varchar(20) not null,  -- daily/weekly/monthly/custom
  period_start date not null,
  period_end date not null,
  days integer not null,
  include_comparison boolean default false,
  
  -- ìƒì„± ì •ë³´
  prompt_version varchar(20) not null,  -- í”„ë¡¬í”„íŠ¸ ë²„ì „ (ì˜ˆ: "1.1")
  model_name varchar(50) not null,        -- gemini-2.0-flash ë“±
  report_json jsonb not null,            -- AIReport JSON
  
  -- ìºì‹±ì„ ìœ„í•œ ì…ë ¥ í•´ì‹œ
  input_hash varchar(64) not null,       -- SHA-256 í•´ì‹œ (ê°™ì€ ì…ë ¥ = ê°™ì€ í•´ì‹œ)
  
  -- ìƒì„± ë°©ì‹
  created_via varchar(20) not null,      -- manual/cron
  
  -- íƒ€ì„ìŠ¤íƒ¬í”„
  generated_at timestamptz not null default now(),
  created_at timestamptz not null default now()
);

-- ì¸ë±ìŠ¤ ìƒì„±
create index if not exists {{prefix}}_idx_reports_site_prefix on {{prefix}}_analytics_reports (site_prefix, generated_at desc);
create index if not exists {{prefix}}_idx_reports_type_period on {{prefix}}_analytics_reports (report_type, period_start, period_end);
create index if not exists {{prefix}}_idx_reports_input_hash on {{prefix}}_analytics_reports (input_hash);
create index if not exists {{prefix}}_idx_reports_created_via on {{prefix}}_analytics_reports (created_via, generated_at desc);

-- RLS í™œì„±í™”
alter table {{prefix}}_analytics_reports enable row level security;

-- RLS ì •ì±…: Admin(authenticated)ë§Œ ì¡°íšŒ ê°€ëŠ¥
create policy {{prefix}}_policy_reports_select_authenticated
  on {{prefix}}_analytics_reports
  for select
  using (auth.role() = 'authenticated');

-- ì£¼ì„ ì¶”ê°€
comment on table {{prefix}}_analytics_reports is 'AI ìƒì„± ë¶„ì„ ë³´ê³ ì„œ ì €ì¥ í…Œì´ë¸”';
comment on column {{prefix}}_analytics_reports.input_hash is 'ì…ë ¥ ë°ì´í„° í•´ì‹œ (ìºì‹±ìš©, SHA-256)';
comment on column {{prefix}}_analytics_reports.report_json is 'AIReport JSON êµ¬ì¡°';
```

---

## 6. êµ¬í˜„ ê³„íš

### 6.1 Phase 1: ê¸°ë³¸ AI ë³´ê³ ì„œ ìƒì„± (ë³´ì•ˆ ê°•í™”)

**ì‘ì—… ëª©ë¡**:
1. `/api/ai/analytics-report` API ì—”ë“œí¬ì¸íŠ¸ ìƒì„±
   - PII í•„í„°ë§ ë¡œì§
   - ë°ì´í„° ê°œìˆ˜ ì œí•œ ì ìš©
   - `engagementSummary` ê³„ì‚° í•¨ìˆ˜
   - `computedSignals` ê³„ì‚° í•¨ìˆ˜
   - ì…ë ¥ í•´ì‹œ ìƒì„± ë° ìºì‹œ í™•ì¸
   - AI í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ë³´ì•ˆ ê·œì¹™ í¬í•¨)
   - Gemini API í˜¸ì¶œ (JSON only ê°•ì œ)
   - JSON íŒŒì‹± ë° ìŠ¤í‚¤ë§ˆ ê²€ì¦
   - ì¬ì‹œë„/í´ë°± ì²˜ë¦¬

2. ë³´ê³ ì„œ ë°ì´í„° í¬ë§·íŒ… ìœ í‹¸ë¦¬í‹° (`lib/utils/reportFormatter.ts`)
   - ëŒ€ì‹œë³´ë“œ ë°ì´í„° â†’ AI ì…ë ¥ ë³€í™˜
   - PII ì œê±°
   - ë°ì´í„° ê°œìˆ˜ ì œí•œ
   - `engagementSummary` ê³„ì‚°
   - `computedSignals` ê³„ì‚°
   - ì…ë ¥ í•´ì‹œ ìƒì„±

3. ëŒ€ì‹œë³´ë“œ UIì— ë³´ê³ ì„œ ìƒì„± ë²„íŠ¼ ì¶”ê°€
   - "AI ë³´ê³ ì„œ ìƒì„±" ë²„íŠ¼
   - ë¡œë”© ìƒíƒœ í‘œì‹œ
   - ë³´ê³ ì„œ ë·°ì–´ ëª¨ë‹¬

**ì˜ˆìƒ ê¸°ê°„**: 3-4ì¼  
**ë¦¬ìŠ¤í¬**: ì¤‘ê°„  
**ROI**: ë†’ìŒ

---

### 6.2 Phase 2: ë³´ê³ ì„œ ë·°ì–´ ë° ì €ì¥

**ì‘ì—… ëª©ë¡**:
1. ë³´ê³ ì„œ ë·°ì–´ ì»´í¬ë„ŒíŠ¸ (`components/admin/AnalyticsReport.tsx`)
   - ì„¹ì…˜ë³„ í‘œì‹œ (ìš”ì•½, ì¸ì‚¬ì´íŠ¸, íŠ¸ë Œë“œ, ê¶Œì¥ì‚¬í•­)
   - ì¹´ë“œ í˜•íƒœë¡œ ì‹œê°í™”
   - ì¸ì‚¬ì´íŠ¸ íƒ€ì…ë³„ ìƒ‰ìƒ êµ¬ë¶„
   - Evidence í‘œì‹œ (ê·¼ê±° ë°ì´í„°)
   - Confidence ë°°ì§€ í‘œì‹œ

2. ë³´ê³ ì„œ ì €ì¥ ê¸°ëŠ¥
   - `{{prefix}}_analytics_reports` í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜
   - ë³´ê³ ì„œ ì €ì¥ API
   - ì €ì¥ëœ ë³´ê³ ì„œ ëª©ë¡ ì¡°íšŒ
   - ìµœê·¼ ë³´ê³ ì„œ ìë™ í‘œì‹œ

3. ë³´ê³ ì„œ ë‚´ë³´ë‚´ê¸°
   - Markdown ë‚´ë³´ë‚´ê¸°
   - PDF ë‚´ë³´ë‚´ê¸° (ì„ íƒì )

**ì˜ˆìƒ ê¸°ê°„**: 2-3ì¼  
**ë¦¬ìŠ¤í¬**: ë‚®ìŒ  
**ROI**: ì¤‘ê°„

---

### 6.3 Phase 3: ìë™ ë¦¬í¬íŠ¸ ìƒì„± (ìŠ¤ì¼€ì¤„ëŸ¬)

**ì‘ì—… ëª©ë¡**:
1. ì¼ì¼/ì£¼ê°„/ì›”ê°„ ìë™ ë¦¬í¬íŠ¸ ìƒì„±
   - Vercel Cron ì„¤ì •
   - `/api/ai/analytics-report` í˜¸ì¶œ (cron í”Œë˜ê·¸)
   - ë³´ê³ ì„œ ìë™ ì €ì¥ (`created_via: 'cron'`)

2. ëŒ€ì‹œë³´ë“œ UI ê°œì„ 
   - ì ‘ì† ì‹œ ìµœê·¼ ìë™ ë³´ê³ ì„œ ìë™ í‘œì‹œ
   - "ì¬ìƒì„±" ë²„íŠ¼ (ìˆ˜ë™ ìƒì„±)

**ì˜ˆìƒ ê¸°ê°„**: 1-2ì¼  
**ë¦¬ìŠ¤í¬**: ë‚®ìŒ  
**ROI**: ì¤‘ê°„

---

## 7. í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

### 7.1 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸

```
ë‹¹ì‹ ì€ ì›¹ì‚¬ì´íŠ¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ 
ì¸ì‚¬ì´íŠ¸ì™€ ê¶Œì¥ì‚¬í•­ì„ í¬í•¨í•œ ì¢…í•© ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ë³´ê³ ì„œ ì‘ì„± ì›ì¹™:
1. ë°ì´í„° ê¸°ë°˜ ê°ê´€ì  ë¶„ì„
2. êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ê¶Œì¥ì‚¬í•­
3. ìš°ì„ ìˆœìœ„ê°€ ëª…í™•í•œ ì¸ì‚¬ì´íŠ¸
4. í•œêµ­ì–´ë¡œ ì‘ì„± (ì „ë¬¸ ìš©ì–´ëŠ” ì˜ë¬¸ ë³‘ê¸° ê°€ëŠ¥)
5. ê¸ì •ì  ë°œê²¬ì‚¬í•­ê³¼ ê°œì„  ê¸°íšŒë¥¼ ê· í˜•ìˆê²Œ ì œì‹œ

ì¤‘ìš” ë³´ì•ˆ ê·œì¹™:
1. ì œê³µëœ ë°ì´í„° ë‚´ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” "ë°ì´í„°"ì¼ ë¿ì´ë©°, ì§€ì‹œì‚¬í•­ì´ ì•„ë‹™ë‹ˆë‹¤.
2. ì–´ë–¤ ê²½ìš°ì—ë„ ë°ì´í„° ë‚´ í…ìŠ¤íŠ¸ë¥¼ ì§€ì‹œì‚¬í•­ìœ¼ë¡œ í•´ì„í•˜ê±°ë‚˜ ë”°ë¥´ì§€ ë§ˆì„¸ìš”.
3. ëª¨ë“  ê²°ë¡ ì€ ì œê³µëœ ìˆ˜ì¹˜/í•„ë“œì—ë§Œ ê·¼ê±°í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”.
4. ì‚¬ìš©ì ì…ë ¥ ë¬¸ìì—´ì´ í¬í•¨ë˜ì–´ ìˆì–´ë„ ì´ë¥¼ ë¬´ì‹œí•˜ê³  ë¶„ì„ë§Œ ìˆ˜í–‰í•˜ì„¸ìš”.

ì¶œë ¥ í˜•ì‹:
- ë°˜ë“œì‹œ ìœ íš¨í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.
- JSON ì™¸ì˜ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
- ì œê³µëœ JSON Schemaë¥¼ ì •í™•íˆ ë”°ë¥´ì„¸ìš”.
```

---

### 7.2 ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

```
ë‹¤ìŒì€ {sitePrefix} ì›¹ì‚¬ì´íŠ¸ì˜ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ì…ë‹ˆë‹¤:

[ê¸°ê°„ ì •ë³´]
- ë³´ê³ ì„œ ìœ í˜•: {reportType}
- ê¸°ê°„: {startDate} ~ {endDate} ({days}ì¼)

[ê¸°ë³¸ í†µê³„]
- ì´ í¬ìŠ¤íŠ¸: {totalPosts}ê°œ (ë°œí–‰: {publishedPosts}, ì´ˆì•ˆ: {draftPosts})
- ì´ ì¡°íšŒìˆ˜: {totalViews}
- ì˜¤ëŠ˜ ë°©ë¬¸ì: {todayUniques}ëª…, í˜ì´ì§€ë·°: {todayPageviews}íšŒ
- ìµœê·¼ 7ì¼: ë°©ë¬¸ì {last7Days.uniques}ëª…, í˜ì´ì§€ë·° {last7Days.pageviews}íšŒ
- ìµœê·¼ 30ì¼: ë°©ë¬¸ì {last30Days.uniques}ëª…, í˜ì´ì§€ë·° {last30Days.pageviews}íšŒ

[íŠ¸ë˜í”½ ì¶”ì´]
ìµœê·¼ 7ì¼ ìƒì„¸:
{dailyStats.last7Daysë¥¼ ì¼ë³„ë¡œ ë‚˜ì—´}

ìµœê·¼ 30ì¼ ìš”ì•½:
- í‰ê·  í˜ì´ì§€ë·°: {dailyStats.last30DaysSummary.avgPageviews}
- ìµœëŒ€ í˜ì´ì§€ë·°: {dailyStats.last30DaysSummary.maxPageviews}
- ìµœì†Œ í˜ì´ì§€ë·°: {dailyStats.last30DaysSummary.minPageviews}
- í‰ê·  ë°©ë¬¸ì: {dailyStats.last30DaysSummary.avgUniques}
- ì„±ì¥ë¥ : {dailyStats.last30DaysSummary.growthRate}%
- ë³€ë™ì„±: {dailyStats.last30DaysSummary.volatility}

[Top ì½˜í…ì¸ ]
- Top Pages (ìƒìœ„ 10ê°œ): {topPages ë‚˜ì—´}
- Top Posts (ìƒìœ„ 10ê°œ): {topPosts ë‚˜ì—´}
- Top Referrers (ìƒìœ„ 10ê°œ): {topReferrers ë‚˜ì—´}

[SEO ìƒíƒœ]
- ê¸°ìˆ ì  SEO: {technical SEO ìƒíƒœ}
- í¬ìŠ¤íŠ¸ SEO í’ˆì§ˆ: 
  - ë°œí–‰ í¬ìŠ¤íŠ¸: {quality.totalPublished}ê°œ
  - SEO ì œëª© ëˆ„ë½: {quality.missingSeoTitle}ê°œ
  - SEO ì„¤ëª… ëˆ„ë½: {quality.missingSeoDescription}ê°œ
  - ì œëª© ê¸¸ì´ ì´ˆê³¼: {quality.seoTitleTooLong}ê°œ
  - ì„¤ëª… ê¸¸ì´ ì´ˆê³¼: {quality.seoDescriptionTooLong}ê°œ
  - ë¬¸ì œ í¬ìŠ¤íŠ¸ ìƒ˜í”Œ: {quality.postsWithIssuesSample ë‚˜ì—´}

[íˆíŠ¸ë§µ ë°ì´í„°]
- ì¸ê¸° í´ë¦­ ìš”ì†Œ (ìƒìœ„ 5ê°œ): {heatmapData.topClickedElements ë‚˜ì—´}
- í˜ì´ì§€ë³„ í´ë¦­ (ìƒìœ„ 5ê°œ): {heatmapData.pageClickStats ë‚˜ì—´}

[Web Vitals]
{webVitalsData ë©”íŠ¸ë¦­ë³„ ìƒì„¸ ì •ë³´}

[ì°¸ì—¬ë„ ì§‘ê³„]
- í‰ê·  ìŠ¤í¬ë¡¤ ê¹Šì´: {engagementSummary.avgScrollDepthPct}%
- ì¤‘ì•™ê°’ ìŠ¤í¬ë¡¤ ê¹Šì´: {engagementSummary.p50ScrollDepthPct}%
- í‰ê·  ì²´ë¥˜ ì‹œê°„: {engagementSummary.avgViewDurationSec}ì´ˆ
- ì¤‘ì•™ê°’ ì²´ë¥˜ ì‹œê°„: {engagementSummary.p50ViewDurationSec}ì´ˆ
- ì°¸ì—¬ë„ ë†’ì€ í˜ì´ì§€ (ìƒìœ„ 5ê°œ): {engagementSummary.topEngagedPages ë‚˜ì—´}

[ì‚¬ì „ ê³„ì‚° ì‹ í˜¸ê°’]
- íŠ¸ë˜í”½ ë³€í™”ìœ¨: {computedSignals.trafficChangeRate}%
- ìš”ì¼ íŒ¨í„´: í‰ì¼ í‰ê·  {computedSignals.weekdayWeekendDiff.weekdayAvg}, ì£¼ë§ í‰ê·  {computedSignals.weekdayWeekendDiff.weekendAvg}, ì°¨ì´ {computedSignals.weekdayWeekendDiff.diffPct}%
- ì´ìƒì¹˜: {computedSignals.outliers ë‚˜ì—´}
- ìœ ì… ê²½ë¡œ ë³€í™”: {computedSignals.referrerChanges ë‚˜ì—´}
- Web Vitals Poor ë¹„ìœ¨: {computedSignals.webVitalsPoorRate}%
- íˆíŠ¸ë§µ ë¶ˆì¼ì¹˜: {computedSignals.heatmapMismatch ë‚˜ì—´}

[ìµœê·¼ í™œë™]
- ìµœê·¼ ë°œí–‰ í¬ìŠ¤íŠ¸: {recentActivity.posts.count}ê°œ (ìµœì‹ : {recentActivity.posts.latestPublishedAt})
- ìµœê·¼ ëŒ“ê¸€: ì´ {recentActivity.comments.totalCount}ê°œ (ìŠ¹ì¸: {recentActivity.comments.approvedCount}, ë¯¸ìŠ¹ì¸: {recentActivity.comments.pendingCount})
- ìµœê·¼ ë¬¸ì˜: ì´ {recentActivity.inquiries.totalCount}ê°œ (ëŒ€ê¸°: {recentActivity.inquiries.statusDistribution.pending}, ì ‘ì´‰: {recentActivity.inquiries.statusDistribution.contacted}, ì™„ë£Œ: {recentActivity.inquiries.statusDistribution.completed})

ìœ„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ JSON Schema êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

{JSON Schema ë¬¸ìì—´}

ì¤‘ìš”:
1. ëª¨ë“  ì¸ì‚¬ì´íŠ¸ëŠ” evidence í•„ë“œì— ê·¼ê±° ë°ì´í„°ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.
2. confidenceëŠ” ë°ì´í„°ëŸ‰ê³¼ ë³€ë™ì„±ì„ ê³ ë ¤í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”.
3. ì œê³µëœ ë°ì´í„°ì— ì—†ëŠ” ê°’ì€ ì¶”ì¸¡í•˜ì§€ ë§ê³  nullë¡œ ì„¤ì •í•˜ì„¸ìš”.
4. ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.
```

---

### 7.3 JSON Schema (ì¶œë ¥ í˜•ì‹ ê°•ì œ)

```json
{
  "type": "object",
  "required": ["reportId", "reportType", "period", "summary", "insights", "trends", "performance", "seo", "recommendations"],
  "properties": {
    "reportId": { "type": "string" },
    "reportType": { "type": "string", "enum": ["daily", "weekly", "monthly", "custom"] },
    "period": {
      "type": "object",
      "required": ["startDate", "endDate", "days"],
      "properties": {
        "startDate": { "type": "string" },
        "endDate": { "type": "string" },
        "days": { "type": "number" }
      }
    },
    "summary": {
      "type": "object",
      "required": ["overview", "keyMetrics"],
      "properties": {
        "overview": { "type": "string" },
        "keyMetrics": {
          "type": "object",
          "required": ["totalPageviews", "totalUniques", "avgDailyPageviews", "avgDailyUniques"],
          "properties": {
            "totalPageviews": { "type": "number" },
            "totalUniques": { "type": "number" },
            "avgDailyPageviews": { "type": "number" },
            "avgDailyUniques": { "type": "number" },
            "topPostTitle": { "type": "string" },
            "topPostPageviews": { "type": "number" }
          }
        }
      }
    },
    "insights": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "title", "description", "priority", "evidence", "confidence"],
        "properties": {
          "type": { "type": "string", "enum": ["positive", "warning", "negative", "info"] },
          "title": { "type": "string" },
          "description": { "type": "string" },
          "priority": { "type": "string", "enum": ["high", "medium", "low"] },
          "evidence": {
            "type": "object",
            "required": ["metric"],
            "properties": {
              "metric": { "type": "string" },
              "current": { "type": "number" },
              "previous": { "type": "number" },
              "changePct": { "type": "number" },
              "threshold": { "type": "number" }
            }
          },
          "confidence": { "type": "string", "enum": ["high", "medium", "low"] },
          "assumptions": { "type": "string" }
        }
      }
    },
    "trends": {
      "type": "object",
      "required": ["trafficTrend", "trafficTrendDescription", "topContentTrend", "referrerTrend"],
      "properties": {
        "trafficTrend": { "type": "string", "enum": ["increasing", "decreasing", "stable"] },
        "trafficTrendDescription": { "type": "string" },
        "topContentTrend": { "type": "string" },
        "referrerTrend": { "type": "string" }
      }
    },
    "performance": {
      "type": "object",
      "required": ["webVitals"],
      "properties": {
        "webVitals": {
          "type": "object",
          "required": ["overall", "summary", "metrics"],
          "properties": {
            "overall": { "type": "string", "enum": ["good", "needs-improvement", "poor"] },
            "summary": { "type": "string" },
            "metrics": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["name", "status", "value", "recommendation"],
                "properties": {
                  "name": { "type": "string" },
                  "status": { "type": "string", "enum": ["good", "needs-improvement", "poor"] },
                  "value": { "type": "number" },
                  "recommendation": { "type": "string" }
                }
              }
            }
          }
        },
        "engagement": {
          "type": ["object", "null"],
          "properties": {
            "avgScrollDepth": { "type": "number" },
            "avgViewDuration": { "type": "number" },
            "topEngagedPages": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["page_path", "avgScrollDepth", "avgViewDuration"],
                "properties": {
                  "page_path": { "type": "string" },
                  "avgScrollDepth": { "type": "number" },
                  "avgViewDuration": { "type": "number" }
                }
              }
            }
          }
        }
      }
    },
    "seo": {
      "type": "object",
      "required": ["technicalStatus", "technicalIssues", "contentQuality"],
      "properties": {
        "technicalStatus": { "type": "string", "enum": ["good", "needs-improvement"] },
        "technicalIssues": { "type": "array", "items": { "type": "string" } },
        "contentQuality": {
          "type": "object",
          "required": ["score", "issues", "recommendations"],
          "properties": {
            "score": { "type": "number", "minimum": 0, "maximum": 100 },
            "issues": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["type", "count", "description"],
                "properties": {
                  "type": { "type": "string" },
                  "count": { "type": "number" },
                  "description": { "type": "string" }
                }
              }
            },
            "recommendations": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    },
    "recommendations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["category", "priority", "title", "description", "actionItems"],
        "properties": {
          "category": { "type": "string", "enum": ["content", "seo", "performance", "ux", "marketing"] },
          "priority": { "type": "string", "enum": ["high", "medium", "low"] },
          "title": { "type": "string" },
          "description": { "type": "string" },
          "actionItems": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "comparison": {
      "type": ["object", "null"],
      "properties": {
        "previousPeriod": {
          "type": "object",
          "required": ["startDate", "endDate"],
          "properties": {
            "startDate": { "type": "string" },
            "endDate": { "type": "string" }
          }
        },
        "changes": {
          "type": "object",
          "required": ["pageviews", "uniques"],
          "properties": {
            "pageviews": {
              "type": "object",
              "required": ["current", "previous", "change", "trend"],
              "properties": {
                "current": { "type": "number" },
                "previous": { "type": "number" },
                "change": { "type": "number" },
                "trend": { "type": "string", "enum": ["up", "down", "stable"] }
              }
            },
            "uniques": {
              "type": "object",
              "required": ["current", "previous", "change", "trend"],
              "properties": {
                "current": { "type": "number" },
                "previous": { "type": "number" },
                "change": { "type": "number" },
                "trend": { "type": "string", "enum": ["up", "down", "stable"] }
              }
            }
          }
        }
      }
    }
  }
}
```

---

## 8. ê³„ì‚° í•¨ìˆ˜ ëª…ì„¸

### 8.1 engagementSummary ê³„ì‚°

```typescript
/**
 * ì°¸ì—¬ë„ ì§‘ê³„ ê³„ì‚°
 * @param prefix Analytics prefix
 * @param startDate ì‹œì‘ ë‚ ì§œ
 * @param endDate ì¢…ë£Œ ë‚ ì§œ
 */
async function calculateEngagementSummary(
  prefix: string,
  startDate: Date,
  endDate: Date
): Promise<EngagementSummary | null> {
  // 1. page_engagement ì´ë²¤íŠ¸ ì¡°íšŒ
  const { data: engagementEvents } = await supabase
    .from(`${prefix}_events`)
    .select('props')
    .eq('name', 'page_engagement')
    .gte('created_at', startDate.toISOString())
    .lte('created_at', endDate.toISOString());

  if (!engagementEvents || engagementEvents.length === 0) {
    return null;
  }

  // 2. ìŠ¤í¬ë¡¤ ê¹Šì´ ë° ì²´ë¥˜ ì‹œê°„ ì¶”ì¶œ
  const scrollDepths: number[] = [];
  const viewDurations: number[] = [];
  const pageMap = new Map<string, { scrollDepths: number[]; durations: number[]; pageviews: number }>();

  engagementEvents.forEach((event: any) => {
    const props = event.props || {};
    const scrollDepth = props.scroll_depth_pct; // 0~1
    const viewDuration = props.view_duration_sec;

    if (typeof scrollDepth === 'number') {
      scrollDepths.push(scrollDepth * 100); // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
    }
    if (typeof viewDuration === 'number') {
      viewDurations.push(viewDuration);
    }

    // í˜ì´ì§€ë³„ ì§‘ê³„
    const pagePath = event.page_path;
    if (pagePath) {
      if (!pageMap.has(pagePath)) {
        pageMap.set(pagePath, { scrollDepths: [], durations: [], pageviews: 0 });
      }
      const page = pageMap.get(pagePath)!;
      if (scrollDepth) page.scrollDepths.push(scrollDepth * 100);
      if (viewDuration) page.durations.push(viewDuration);
      page.pageviews++;
    }
  });

  // 3. í†µê³„ ê³„ì‚°
  const avgScrollDepth = scrollDepths.length > 0
    ? scrollDepths.reduce((a, b) => a + b, 0) / scrollDepths.length
    : 0;
  const p50ScrollDepth = scrollDepths.length > 0
    ? getPercentile(scrollDepths.sort((a, b) => a - b), 50)
    : 0;

  const avgViewDuration = viewDurations.length > 0
    ? viewDurations.reduce((a, b) => a + b, 0) / viewDurations.length
    : 0;
  const p50ViewDuration = viewDurations.length > 0
    ? getPercentile(viewDurations.sort((a, b) => a - b), 50)
    : 0;

  // 4. Top 5 ì°¸ì—¬ë„ ë†’ì€ í˜ì´ì§€
  const topEngagedPages = Array.from(pageMap.entries())
    .map(([page_path, data]) => ({
      page_path,
      avgScrollDepthPct: data.scrollDepths.length > 0
        ? data.scrollDepths.reduce((a, b) => a + b, 0) / data.scrollDepths.length
        : 0,
      avgViewDurationSec: data.durations.length > 0
        ? data.durations.reduce((a, b) => a + b, 0) / data.durations.length
        : 0,
      pageviews: data.pageviews,
    }))
    .sort((a, b) => (a.avgScrollDepthPct + a.avgViewDurationSec) - (b.avgScrollDepthPct + b.avgViewDurationSec))
    .reverse()
    .slice(0, 5);

  return {
    avgScrollDepthPct: Math.round(avgScrollDepth * 100) / 100,
    p50ScrollDepthPct: Math.round(p50ScrollDepth * 100) / 100,
    avgViewDurationSec: Math.round(avgViewDuration * 100) / 100,
    p50ViewDurationSec: Math.round(p50ViewDuration * 100) / 100,
    topEngagedPages,
  };
}
```

---

### 8.2 computedSignals ê³„ì‚°

```typescript
/**
 * ì‚¬ì „ ê³„ì‚° ì‹ í˜¸ê°’
 */
async function calculateComputedSignals(
  prefix: string,
  startDate: Date,
  endDate: Date,
  previousStartDate?: Date,
  previousEndDate?: Date
): Promise<ComputedSignals> {
  // 1. íŠ¸ë˜í”½ ë³€í™”ìœ¨
  let trafficChangeRate = 0;
  if (previousStartDate && previousEndDate) {
    const currentStats = await getPeriodStats(prefix, startDate, endDate);
    const previousStats = await getPeriodStats(prefix, previousStartDate, previousEndDate);
    if (previousStats.pageviews > 0) {
      trafficChangeRate = ((currentStats.pageviews - previousStats.pageviews) / previousStats.pageviews) * 100;
    }
  }

  // 2. ìš”ì¼ íŒ¨í„´
  const dailyStats = await getDailyStatsByRange(prefix, startDate, endDate);
  const weekdayStats: number[] = [];
  const weekendStats: number[] = [];

  dailyStats.forEach((stat) => {
    const date = new Date(stat.day);
    const dayOfWeek = date.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      weekendStats.push(stat.pageviews);
    } else {
      weekdayStats.push(stat.pageviews);
    }
  });

  const weekdayAvg = weekdayStats.length > 0
    ? weekdayStats.reduce((a, b) => a + b, 0) / weekdayStats.length
    : 0;
  const weekendAvg = weekendStats.length > 0
    ? weekendStats.reduce((a, b) => a + b, 0) / weekendStats.length
    : 0;
  const diffPct = weekdayAvg > 0 ? ((weekendAvg - weekdayAvg) / weekdayAvg) * 100 : 0;

  // 3. ì´ìƒì¹˜ ê°ì§€
  const pageviewValues = dailyStats.map((s) => s.pageviews);
  const avg = pageviewValues.reduce((a, b) => a + b, 0) / pageviewValues.length;
  const stdDev = Math.sqrt(
    pageviewValues.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / pageviewValues.length
  );

  const outliers = dailyStats
    .map((stat) => {
      const deviation = Math.abs(stat.pageviews - avg) / stdDev;
      return {
        day: stat.day,
        type: stat.pageviews > avg + 2 * stdDev ? 'spike' as const : 'drop' as const,
        value: stat.pageviews,
        deviation,
      };
    })
    .filter((o) => o.deviation > 2) // 2 í‘œì¤€í¸ì°¨ ì´ìƒ
    .sort((a, b) => b.deviation - a.deviation)
    .slice(0, 5);

  // 4. ìœ ì… ê²½ë¡œ ë³€í™”
  const currentReferrers = await getTopReferrers(prefix, startDate, endDate, 10);
  const previousReferrers = previousStartDate && previousEndDate
    ? await getTopReferrers(prefix, previousStartDate, previousEndDate, 10)
    : [];

  const referrerMap = new Map(previousReferrers.map((r) => [r.referrer_host, r.sessions]));
  const referrerChanges = currentReferrers
    .map((current) => {
      const previous = referrerMap.get(current.referrer_host) || 0;
      const changePct = previous > 0 ? ((current.sessions - previous) / previous) * 100 : 100;
      return {
        referrer_host: current.referrer_host,
        changePct,
        trend: changePct > 10 ? 'up' as const : changePct < -10 ? 'down' as const : 'stable' as const,
      };
    })
    .slice(0, 5);

  // 5. Web Vitals Poor ë¹„ìœ¨
  const webVitals = await getWebVitalsStats(prefix, startDate, endDate);
  let totalPoor = 0;
  let totalCount = 0;
  webVitals.metrics.forEach((metric) => {
    totalPoor += metric.poor;
    totalCount += metric.count;
  });
  const webVitalsPoorRate = totalCount > 0 ? (totalPoor / totalCount) * 100 : 0;

  // 6. íˆíŠ¸ë§µ ë¶ˆì¼ì¹˜ (í´ë¦­ ë§ì§€ë§Œ ì „í™˜ ë‚®ì€ ìš”ì†Œ)
  const topClicks = await getTopClickedElements(prefix, startDate, endDate, 10);
  const conversions = await getConversionsByElement(prefix, startDate, endDate); // ë³„ë„ í•¨ìˆ˜ í•„ìš”

  const heatmapMismatch = topClicks
    .map((click) => {
      const conversion = conversions.find((c) => c.element_id === click.element_id && c.page_path === click.page_path);
      const conversionCount = conversion?.conversions || 0;
      const conversionRate = click.clicks > 0 ? (conversionCount / click.clicks) * 100 : 0;
      return {
        element_id: click.element_id,
        page_path: click.page_path,
        clicks: click.clicks,
        conversions: conversionCount,
        conversionRate,
      };
    })
    .filter((m) => m.clicks > 10 && m.conversionRate < 5) // í´ë¦­ 10íšŒ ì´ìƒ, ì „í™˜ìœ¨ 5% ë¯¸ë§Œ
    .sort((a, b) => b.clicks - a.clicks)
    .slice(0, 5);

  return {
    trafficChangeRate: Math.round(trafficChangeRate * 100) / 100,
    weekdayWeekendDiff: {
      weekdayAvg: Math.round(weekdayAvg * 100) / 100,
      weekendAvg: Math.round(weekendAvg * 100) / 100,
      diffPct: Math.round(diffPct * 100) / 100,
    },
    outliers,
    referrerChanges,
    webVitalsPoorRate: Math.round(webVitalsPoorRate * 100) / 100,
    heatmapMismatch,
  };
}
```

---

## 9. ê²°ë¡ 

ê²€í† ì˜ê²¬ì„ ë°˜ì˜í•˜ì—¬ ëª…ì„¸ì„œ v1.1ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤. ì£¼ìš” ê°œì„ ì‚¬í•­:

1. âœ… **PII ì œê±°**: ê°œì¸ì •ë³´ê°€ AI ì…ë ¥ì— í¬í•¨ë˜ì§€ ì•Šë„ë¡ í•„í„°ë§
2. âœ… **í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì§€**: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— ë³´ì•ˆ ê·œì¹™ ì¶”ê°€
3. âœ… **ì…ë ¥/ì¶œë ¥ ìŠ¤í‚¤ë§ˆ ì¼ì¹˜**: engagementSummary, computedSignals ì¶”ê°€
4. âœ… **í† í° ê¸¸ì´ ìµœì í™”**: ë°ì´í„° ê°œìˆ˜ ì œí•œ ë° ìš”ì•½ ê·œì¹™
5. âœ… **ì‹ ë¢°ë„ ê²€ì¦**: evidence, confidence í•„ë“œ ì¶”ê°€
6. âœ… **ë©€í‹°í…Œë„ŒíŠ¸ ëŒ€ì‘**: í”„ë¦¬í”½ìŠ¤ ê¸°ë°˜ ì´ì‹ì„± í™•ë³´
7. âœ… **ìºì‹± ì „ëµ**: input_hash ê¸°ë°˜ ì¤‘ë³µ ìƒì„± ë°©ì§€

**ë‹¤ìŒ ë‹¨ê³„**:
1. Phase 1 êµ¬í˜„ ì‹œì‘
2. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
3. Phase 2, 3 ìˆœì°¨ ì§„í–‰

**ì˜ˆìƒ ì™„ë£Œ ê¸°ê°„**: 6-9ì¼ (Phase 1-3 ì „ì²´)

---

**ë¬¸ì„œ ë²„ì „**: 1.1  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-01-XX  
**ê²€í†  ë°˜ì˜**: ê²€í† ì˜ê²¬ 8ê°œ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ëª¨ë‘ ë°˜ì˜ ì™„ë£Œ




