# 이미지 미아 상태 가비지 관리 기법 보고서

**작성 일자**: 2025-01-16  
**프로젝트**: uslab-web  
**기능**: 사용되지 않는 이미지 파일 자동 감지 및 삭제

---

## 📋 개요

이미지 미아 상태 가비지 관리 기능은 **Storage에 저장되어 있지만 실제로 포스트에서 사용되지 않는 이미지 파일**을 찾아서 정리하는 기능입니다.

### 주요 특징
- ✅ **자동 감지**: 모든 포스트를 스캔하여 사용 중인 이미지 수집
- ✅ **미아 이미지 식별**: Storage의 파일과 사용 중인 이미지 비교
- ✅ **선택적 삭제**: 관리자가 미리보기 후 선택적으로 삭제
- ✅ **안전한 삭제**: 확인 절차를 거쳐 삭제
- ✅ **통계 제공**: 전체 파일 수, 사용 중인 파일 수, 미아 파일 수 표시

---

## 🏗️ 아키텍처

### 전체 흐름

```
1. 모든 포스트 조회 (uslab_posts)
    ↓
2. 각 포스트의 content에서 이미지 URL 추출
    ↓
3. thumbnail_url도 포함하여 사용 중인 이미지 경로 수집
    ↓
4. Storage 버킷의 모든 파일 목록 가져오기
    ↓
5. 사용 중인 이미지와 Storage 파일 비교
    ↓
6. 미아 이미지 식별 및 반환
    ↓
7. 관리자가 선택하여 삭제
```

---

## 🔧 구현 상세

### 1. API 엔드포인트

**파일**: `app/api/garbage/route.ts`

#### GET: 미아 이미지 목록 조회

```typescript:55:157:app/api/garbage/route.ts
export async function GET(request: NextRequest) {
  try {
    // 인증 확인
    const authHeader = request.headers.get('authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { error: '인증이 필요합니다.' },
        { status: 401 }
      );
    }

    // 1. 모든 포스트 조회
    const { data: posts, error: postsError } = await supabase
      .from('uslab_posts')
      .select('id, content, thumbnail_url');

    // 2. 사용 중인 이미지 경로 수집
    const usedPaths = new Set<string>();

    (posts || []).forEach((post: { id: string; content: any; thumbnail_url: string | null }) => {
      // content에서 이미지 URL 추출
      const imageUrls = extractAllImageUrls(post.content as JSONContent);
      imageUrls.forEach(url => {
        const path = extractStoragePath(url);
        if (path) {
          usedPaths.add(path);
        }
      });

      // thumbnail_url 처리
      if (post.thumbnail_url) {
        const path = extractStoragePath(post.thumbnail_url);
        if (path) {
          usedPaths.add(path);
        }
      }
    });

    // 3. Storage 버킷의 모든 파일 목록 가져오기
    const { data: files, error: storageError } = await supabase.storage
      .from('uslab-images')
      .list('uslab', {
        limit: 1000,
        sortBy: { column: 'created_at', order: 'desc' },
      });

    // 4. 미아 이미지 찾기
    const orphanFiles = (files || [])
      .filter(file => {
        const fullPath = `uslab/${file.name}`;
        return !usedPaths.has(fullPath);
      })
      .map(file => ({
        name: file.name,
        path: `uslab/${file.name}`,
        size: file.metadata?.size || 0,
        created_at: file.created_at,
      }));

    return NextResponse.json({
      orphanFiles,
      totalOrphanFiles: orphanFiles.length,
      totalStorageFiles: files?.length || 0,
      totalUsedFiles: usedPaths.size,
    });
  } catch (error: any) {
    // 에러 처리
  }
}
```

**응답 형식**:
```json
{
  "orphanFiles": [
    {
      "name": "1234567890-abc123.png",
      "path": "uslab/1234567890-abc123.png",
      "size": 102400,
      "created_at": "2025-01-16T10:00:00Z"
    }
  ],
  "totalOrphanFiles": 5,
  "totalStorageFiles": 100,
  "totalUsedFiles": 95
}
```

---

#### DELETE: 미아 이미지 삭제

```typescript:162:222:app/api/garbage/route.ts
export async function DELETE(request: NextRequest) {
  try {
    // 인증 확인
    const authHeader = request.headers.get('authorization');
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return NextResponse.json(
        { error: '인증이 필요합니다.' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { paths } = body; // 삭제할 파일 경로 배열

    if (!paths || !Array.isArray(paths) || paths.length === 0) {
      return NextResponse.json(
        { error: '삭제할 파일 경로가 제공되지 않았습니다.' },
        { status: 400 }
      );
    }

    // 여러 파일 삭제
    const { data, error } = await supabase.storage
      .from('uslab-images')
      .remove(paths);

    if (error) {
      return NextResponse.json(
        { error: '파일 삭제 실패', details: error.message },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      deletedCount: paths.length,
      deletedFiles: data || [],
    });
  } catch (error: any) {
    // 에러 처리
  }
}
```

**요청 형식**:
```json
{
  "paths": [
    "uslab/1234567890-abc123.png",
    "uslab/1234567890-def456.jpg"
  ]
}
```

**응답 형식**:
```json
{
  "success": true,
  "deletedCount": 2,
  "deletedFiles": [...]
}
```

---

### 2. 이미지 URL 추출 함수

#### Tiptap JSON에서 이미지 URL 추출

```typescript:12:31:app/api/garbage/route.ts
function extractAllImageUrls(content: JSONContent | null | undefined): string[] {
  const urls: string[] = [];
  
  if (!content) return urls;

  function findImages(node: JSONContent) {
    if (node.type === 'image' && node.attrs?.src) {
      urls.push(node.attrs.src);
    }

    if (node.content && Array.isArray(node.content)) {
      for (const child of node.content) {
        findImages(child);
      }
    }
  }

  findImages(content);
  return urls;
}
```

**동작 방식**:
- 재귀적으로 Tiptap JSON 구조를 탐색
- `type === 'image'`인 노드의 `attrs.src` 추출
- 중첩된 구조에서도 모든 이미지 URL 수집

**예시**:
```json
{
  "type": "doc",
  "content": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "image",
          "attrs": {
            "src": "https://...supabase.co/storage/v1/object/public/uslab-images/uslab/123.png"
          }
        }
      ]
    }
  ]
}
```

→ `https://...supabase.co/storage/v1/object/public/uslab-images/uslab/123.png` 추출

---

#### URL에서 Storage 경로 추출

```typescript:33:50:app/api/garbage/route.ts
/**
 * URL에서 Storage 경로 추출
 * 예: https://xxx.supabase.co/storage/v1/object/public/uslab-images/uslab/123-abc.png
 *     → uslab/123-abc.png
 */
function extractStoragePath(url: string): string | null {
  try {
    const urlObj = new URL(url);
    // /storage/v1/object/public/uslab-images/ 경로에서 파일 경로 추출
    const match = urlObj.pathname.match(/\/storage\/v1\/object\/public\/uslab-images\/(.+)$/);
    if (match && match[1]) {
      return decodeURIComponent(match[1]);
    }
    return null;
  } catch {
    return null;
  }
}
```

**정규식 패턴**: `/\/storage\/v1\/object\/public\/uslab-images\/(.+)$/`

**예시**:
- 입력: `https://xxx.supabase.co/storage/v1/object/public/uslab-images/uslab/123-abc.png`
- 출력: `uslab/123-abc.png`

---

### 3. 관리자 UI

**파일**: `app/admin/posts/page.tsx`

#### 가비지 관리 모달 열기

```typescript:97:129:app/admin/posts/page.tsx
const handleOpenGarbageModal = async () => {
  setShowGarbageModal(true);
  setGarbageLoading(true);
  setOrphanFiles([]);
  setSelectedFiles(new Set());

  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      alert('로그인이 필요합니다.');
      return;
    }

    const response = await fetch('/api/garbage', {
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
      },
    });

    if (response.ok) {
      const data = await response.json();
      setOrphanFiles(data.orphanFiles || []);
    } else {
      const error = await response.json();
      alert(`미아 이미지 조회 실패: ${error.error}`);
    }
  } catch (error) {
    console.error('Error fetching orphan files:', error);
    alert('미아 이미지 조회 중 오류가 발생했습니다.');
  } finally {
    setGarbageLoading(false);
  }
};
```

**동작**:
1. 모달 열기 및 로딩 상태 설정
2. API 호출하여 미아 이미지 목록 조회
3. 결과를 상태에 저장

---

#### 파일 선택 관리

```typescript:131:147:app/admin/posts/page.tsx
const handleToggleFileSelection = (path: string) => {
  const newSelected = new Set(selectedFiles);
  if (newSelected.has(path)) {
    newSelected.delete(path);
  } else {
    newSelected.add(path);
  }
  setSelectedFiles(newSelected);
};

const handleSelectAll = () => {
  if (selectedFiles.size === orphanFiles.length) {
    setSelectedFiles(new Set());
  } else {
    setSelectedFiles(new Set(orphanFiles.map(f => f.path)));
  }
};
```

**기능**:
- 개별 파일 선택/해제
- 전체 선택/해제 토글

---

#### 선택한 파일 삭제

```typescript:149:193:app/admin/posts/page.tsx
const handleDeleteSelected = async () => {
  if (selectedFiles.size === 0) {
    alert('삭제할 파일을 선택해주세요.');
    return;
  }

  if (!confirm(`선택한 ${selectedFiles.size}개의 파일을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
    return;
  }

  setDeleting(true);
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      alert('로그인이 필요합니다.');
      return;
    }

    const response = await fetch('/api/garbage', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`,
      },
      body: JSON.stringify({
        paths: Array.from(selectedFiles),
      }),
    });

    if (response.ok) {
      const data = await response.json();
      alert(`${data.deletedCount}개의 파일이 삭제되었습니다.`);
      // 목록 새로고침
      await handleOpenGarbageModal();
    } else {
      const error = await response.json();
      alert(`파일 삭제 실패: ${error.error}`);
    }
  } catch (error) {
    console.error('Error deleting files:', error);
    alert('파일 삭제 중 오류가 발생했습니다.');
  } finally {
    setDeleting(false);
  }
};
```

**안전 장치**:
1. 선택한 파일이 없으면 경고
2. 확인 다이얼로그로 재확인
3. 삭제 후 목록 자동 새로고침

---

#### 모달 UI

```typescript:300:399:app/admin/posts/page.tsx
{/* 가비지 관리 모달 */}
{showGarbageModal && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div className="bg-white border border-slate-200 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-xl">
      {/* 헤더 */}
      <div className="flex items-center justify-between p-4 sm:p-6 border-b border-slate-200">
        <h2 className="text-lg sm:text-xl font-bold text-slate-900">가비지 관리 - 미아 이미지</h2>
        <button onClick={() => setShowGarbageModal(false)}>✕</button>
      </div>

      {/* 내용 */}
      <div className="flex-1 overflow-y-auto p-4 sm:p-6">
        {garbageLoading ? (
          <div className="text-center py-12">
            <p className="text-slate-600">미아 이미지를 검색 중...</p>
          </div>
        ) : orphanFiles.length === 0 ? (
          <div className="text-center py-12">
            <p className="text-slate-600 text-lg mb-2">미아 이미지가 없습니다!</p>
            <p className="text-slate-500 text-sm">모든 이미지가 포스트에서 사용 중입니다.</p>
          </div>
        ) : (
          <>
            <div className="mb-4 flex items-center justify-between">
              <div className="text-sm text-slate-600">
                총 {orphanFiles.length}개의 미아 이미지 발견
              </div>
              <div className="flex gap-2">
                <button onClick={handleSelectAll}>
                  {selectedFiles.size === orphanFiles.length ? '전체 해제' : '전체 선택'}
                </button>
                {selectedFiles.size > 0 && (
                  <button onClick={handleDeleteSelected} disabled={deleting}>
                    {deleting ? '삭제 중...' : `선택 삭제 (${selectedFiles.size})`}
                  </button>
                )}
              </div>
            </div>

            <div className="space-y-2 max-h-[400px] overflow-y-auto">
              {orphanFiles.map((file) => (
                <div key={file.path} className="flex items-center gap-3 p-3 rounded border">
                  <input
                    type="checkbox"
                    checked={selectedFiles.has(file.path)}
                    onChange={() => handleToggleFileSelection(file.path)}
                  />
                  <div className="flex-1 min-w-0">
                    <p className="text-sm text-slate-900 truncate font-mono">{file.name}</p>
                    <p className="text-xs text-slate-600">
                      {formatFileSize(file.size)} • {formatDate(file.created_at)}
                    </p>
                  </div>
                  <img
                    src={supabase.storage.from('uslab-images').getPublicUrl(file.path).data.publicUrl}
                    alt={file.name}
                    className="w-16 h-16 object-cover rounded border border-slate-200"
                  />
                </div>
              ))}
            </div>
          </>
        )}
      </div>
    </div>
  </div>
)}
```

**UI 특징**:
- **로딩 상태**: 검색 중 표시
- **빈 상태**: 미아 이미지가 없을 때 안내 메시지
- **파일 목록**: 체크박스, 파일명, 크기, 생성일, 미리보기 이미지
- **선택 기능**: 전체 선택/해제, 개별 선택
- **삭제 버튼**: 선택한 파일만 삭제

---

## 📊 알고리즘 상세

### 1. 사용 중인 이미지 수집

```typescript
// 1. 모든 포스트 조회
const posts = await supabase.from('uslab_posts').select('id, content, thumbnail_url');

// 2. 각 포스트에서 이미지 URL 추출
const usedPaths = new Set<string>();

posts.forEach(post => {
  // content에서 이미지 URL 추출
  const imageUrls = extractAllImageUrls(post.content);
  imageUrls.forEach(url => {
    const path = extractStoragePath(url);
    if (path) usedPaths.add(path);
  });

  // thumbnail_url도 포함
  if (post.thumbnail_url) {
    const path = extractStoragePath(post.thumbnail_url);
    if (path) usedPaths.add(path);
  }
});
```

**포함되는 이미지**:
- ✅ 포스트 본문(`content`)의 모든 이미지
- ✅ 포스트 썸네일(`thumbnail_url`)

---

### 2. 미아 이미지 식별

```typescript
// 3. Storage의 모든 파일 목록 가져오기
const files = await supabase.storage
  .from('uslab-images')
  .list('uslab', { limit: 1000 });

// 4. 사용 중인 이미지와 비교
const orphanFiles = files
  .filter(file => {
    const fullPath = `uslab/${file.name}`;
    return !usedPaths.has(fullPath); // 사용 중인 목록에 없으면 미아
  })
  .map(file => ({
    name: file.name,
    path: `uslab/${file.name}`,
    size: file.metadata?.size || 0,
    created_at: file.created_at,
  }));
```

**비교 로직**:
- Storage 파일 경로: `uslab/{filename}`
- 사용 중인 경로와 정확히 일치하는지 확인
- 일치하지 않으면 미아 이미지로 분류

---

## 🎯 핵심 포인트

### 1. 안전한 삭제
- **사전 확인**: 삭제 전 확인 다이얼로그
- **선택적 삭제**: 관리자가 직접 선택하여 삭제
- **미리보기**: 삭제 전 이미지 미리보기 가능

### 2. 정확한 감지
- **모든 포스트 스캔**: 모든 포스트의 content와 thumbnail_url 확인
- **재귀적 탐색**: 중첩된 Tiptap JSON 구조에서도 모든 이미지 추출
- **정확한 경로 매칭**: URL에서 Storage 경로를 정확히 추출

### 3. 성능 고려
- **Set 자료구조**: O(1) 조회 성능
- **한 번의 스캔**: 모든 포스트를 한 번만 스캔
- **제한된 파일 수**: Storage 목록 조회 시 limit 1000

---

## 🔒 보안

### 인증
- **Bearer 토큰**: 모든 API 요청에 인증 토큰 필요
- **관리자 권한**: 관리자만 접근 가능

### 안전 장치
- **확인 절차**: 삭제 전 확인 다이얼로그
- **선택적 삭제**: 전체 삭제가 아닌 선택적 삭제
- **에러 처리**: 삭제 실패 시 에러 메시지 표시

---

## 📝 사용 방법

### 1. 가비지 관리 모달 열기
- 관리자 페이지(`/admin/posts`)에서 "가비지 관리" 버튼 클릭

### 2. 미아 이미지 확인
- 자동으로 미아 이미지 목록 조회
- 각 이미지의 파일명, 크기, 생성일, 미리보기 확인

### 3. 파일 선택
- 체크박스로 개별 선택
- "전체 선택" 버튼으로 한 번에 선택

### 4. 삭제 실행
- "선택 삭제" 버튼 클릭
- 확인 다이얼로그에서 확인
- 삭제 완료 후 목록 자동 새로고침

---

## 🚀 향후 개선 사항

1. **자동 정리 스케줄러**
   - Cron job으로 주기적으로 미아 이미지 정리
   - 일정 기간 이상 미아 상태인 이미지 자동 삭제

2. **통계 대시보드**
   - 전체 Storage 사용량
   - 미아 이미지로 인한 낭비 용량
   - 시간대별 이미지 사용 추이

3. **복구 기능**
   - 삭제된 이미지 복구 (일정 기간 보관)
   - 삭제 로그 기록

4. **성능 최적화**
   - 대용량 Storage 처리 (페이지네이션)
   - 병렬 처리로 스캔 속도 향상

5. **다른 테이블 지원**
   - `uslab_about` 테이블의 이미지도 스캔
   - 운영진 게시판(`uslab_exec_docs`) 이미지도 스캔

---

## 📚 참고 자료

- [Supabase Storage API](https://supabase.com/docs/guides/storage)
- [Tiptap JSON 구조](https://tiptap.dev/api/schema)
- [가비지 컬렉션 패턴](https://en.wikipedia.org/wiki/Garbage_collection_(computer_science))

---

**작성 완료**: 2025-01-16

