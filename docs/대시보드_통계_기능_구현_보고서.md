# 대시보드 및 통계 기능 구현 보고서

**작성일**: 2025-01-XX  
**프로젝트**: USLab.ai  
**버전**: 1.0

---

## 📋 목차

1. [개요](#개요)
2. [아키텍처 구조](#아키텍처-구조)
3. [데이터 수집 시스템](#데이터-수집-시스템)
4. [대시보드 UI 구성](#대시보드-ui-구성)
5. [통계 쿼리 함수](#통계-쿼리-함수)
6. [데이터베이스 스키마](#데이터베이스-스키마)
7. [주요 기능 상세](#주요-기능-상세)
8. [성능 최적화](#성능-최적화)
9. [향후 개선 사항](#향후-개선-사항)

---

## 1. 개요

USLab.ai 관리자 대시보드는 콘텐츠 운영 현황과 트래픽 분석을 제공하는 통합 대시보드입니다. 실시간 통계, SEO 상태 모니터링, 인기 콘텐츠 분석 등의 기능을 포함합니다.

### 주요 특징

- ✅ **실시간 트래픽 추적**: 페이지뷰, 방문자 수, 세션 추적
- ✅ **KPI 대시보드**: 포스트 수, 조회수, 기간별 통계
- ✅ **트래픽 추이 차트**: 7일/30일 일별 트래픽 시각화
- ✅ **SEO 상태 모니터링**: 기술적 SEO 및 포스트 SEO 품질 체크
- ✅ **인기 콘텐츠 분석**: Top Posts, Top Referrers
- ✅ **최근 활동 피드**: 최근 발행 포스트, 댓글, 문의

---

## 2. 아키텍처 구조

### 2.1 전체 구조

```
┌─────────────────┐
│  Client (Browser)│
│   Tracker.tsx    │ ──┐
└─────────────────┘   │
                      │ sendBeacon/fetch
                      ▼
┌─────────────────────────────────┐
│      API Route                  │
│   /api/track (POST)             │
│   - Bot 필터링                  │
│   - 세션 관리                   │
│   - 페이지뷰 저장               │
└─────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────┐
│   Supabase Database             │
│   - uslab_sessions              │
│   - uslab_page_views            │
└─────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────┐
│   Analytics Query Functions     │
│   lib/queries/analytics.ts      │
│   - getTodayStats()             │
│   - getDailyStats()             │
│   - getTopPosts()               │
│   - getTopReferrers()           │
└─────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────┐
│   Dashboard API                 │
│   /api/admin/dashboard (GET)    │
│   - 통계 집계                   │
│   - SEO 상태 체크               │
│   - 최근 활동 조회               │
└─────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────┐
│   Dashboard UI                  │
│   /admin/dashboard              │
│   - KPI 카드                    │
│   - 트래픽 차트 (Recharts)      │
│   - SEO 상태 박스               │
│   - Top 콘텐츠 테이블           │
└─────────────────────────────────┘
```

### 2.2 주요 파일 구조

```
app/
├── admin/
│   └── dashboard/
│       └── page.tsx              # 대시보드 UI 컴포넌트
├── api/
│   ├── admin/
│   │   └── dashboard/
│   │       └── route.ts         # 대시보드 데이터 API
│   └── track/
│       └── route.ts              # 페이지뷰 트래킹 API
components/
└── analytics/
    └── Tracker.tsx               # 클라이언트 트래킹 컴포넌트
lib/
├── queries/
│   └── analytics.ts              # 통계 쿼리 함수
└── utils/
    └── tracking.ts               # 트래킹 유틸리티 함수
supabase/
└── migrations/
    └── 20250115_create_uslab_tracking_tables.sql  # 트래킹 테이블 스키마
```

---

## 3. 데이터 수집 시스템

### 3.1 클라이언트 사이드 트래킹 (`Tracker.tsx`)

**위치**: `components/analytics/Tracker.tsx`

**기능**:
- Next.js App Router의 `usePathname`, `useSearchParams` 훅을 사용하여 라우팅 변화 감지
- 페이지 로드 및 라우팅 변화 시 자동으로 페이지뷰 추적
- 세션 관리 (30분 만료, localStorage 기반)

**주요 로직**:

```typescript
// 세션 키 생성/갱신
- localStorage에 세션 키 저장
- 30분 미접속 시 새 세션 생성
- 세션 만료 시간 자동 갱신

// 페이지뷰 전송
- sendBeacon 우선 사용 (fire-and-forget)
- Fallback: fetch with keepalive
- Admin, API, _next 경로 제외
```

**수집 데이터**:
- `session_key`: 세션 식별자 (UUID)
- `page_path`: 페이지 경로 (pathname + search)
- `post_id`: 포스트 ID (서버에서 매핑)
- `about_id`: About 페이지 ID (서버에서 매핑)
- `locale`: 언어 (ko/en)
- `referrer`: 이전 페이지 URL
- `utm`: UTM 파라미터 (source, medium, campaign, term, content)

### 3.2 서버 사이드 트래킹 API (`/api/track`)

**위치**: `app/api/track/route.ts`

**기능**:
- Bot 필터링 (User-Agent 기반)
- 세션 Upsert (없으면 생성, 있으면 last_seen_at 업데이트)
- 페이지뷰 Insert
- 에러 처리 (모든 에러는 204 반환하여 UX 영향 없음)

**Bot 필터링 규칙**:
```typescript
// User-Agent에 다음 패턴이 포함되면 봇으로 판단
bot|spider|crawl|slurp|facebookexternalhit|preview
```

**세션 관리**:
- `session_key`로 기존 세션 조회
- 기존 세션: `last_seen_at`만 업데이트
- 새 세션: `landing_path`, `referrer`, `utm`, `device_type` 저장

**페이지뷰 저장**:
- `session_id` (FK)
- `post_id`, `about_id` (nullable)
- `page_path`, `locale`
- `created_at` (타임스탬프)

---

## 4. 대시보드 UI 구성

### 4.1 페이지 구조 (`/admin/dashboard`)

**위치**: `app/admin/dashboard/page.tsx`

**인증**: `useAuth` 훅으로 관리자 인증 확인

**주요 섹션**:

#### A) 운영진 보드 하이라이트 (최상단)
- 첫 번째 운영진 보드의 최상단 문서 표시
- 클릭 시 해당 문서 편집 페이지로 이동

#### B) KPI 카드 (4개)
1. **총 포스트**
   - 총 포스트 수
   - 발행/초안 구분 표시

2. **오늘 방문자**
   - 오늘 고유 방문자 수
   - 오늘 페이지뷰 수

3. **최근 7일**
   - 7일간 고유 방문자 수
   - 7일간 페이지뷰 수

4. **최근 30일**
   - 30일간 고유 방문자 수
   - 30일간 페이지뷰 수

#### C) 트래픽 추이 차트
- **라이브러리**: Recharts (`LineChart`)
- **기간 선택**: 7일 / 30일 토글
- **데이터**: 일별 페이지뷰 및 방문자 수
- **스타일**: 라이트 테마 적용 (연한 그리드, 밝은 색상)

#### D) SEO 상태 박스 (2개)
1. **기술적 SEO**
   - Sitemap 존재 여부
   - Robots.txt 존재 여부
   - Canonical URL 존재 여부
   - JSON-LD 존재 여부

2. **포스트 SEO 품질**
   - 발행 포스트 수
   - SEO 제목 누락 수
   - SEO 설명 누락 수
   - 제목 길이 초과 (60자) 수
   - 설명 길이 초과 (160자) 수

#### E) SEO 문제 포스트 목록
- SEO 문제가 있는 포스트 목록
- 문제 유형별 배지 표시
- 클릭 시 포스트 편집 페이지로 이동

#### F) Top 콘텐츠 및 Referrer
1. **인기 포스트 (30일)**
   - Top 10 포스트
   - 페이지뷰 및 방문자 수 표시
   - 언어 구분 표시

2. **유입 경로 (30일)**
   - Top 10 Referrer
   - 세션 수 표시
   - (direct) 표시

#### G) 최근 활동 (3개 카드)
1. **최근 발행 포스트**
   - 최근 5개 발행 포스트
   - 발행일 표시

2. **최근 댓글**
   - 최근 5개 승인된 댓글
   - 작성자 및 작성일 표시

3. **최근 문의**
   - 최근 5개 문의
   - 상태별 배지 표시 (완료/연락완료/대기)

---

## 5. 통계 쿼리 함수

### 5.1 함수 목록 (`lib/queries/analytics.ts`)

#### `getTodayStats()`
- **기능**: 오늘 방문자 수 및 페이지뷰 (Asia/Seoul 기준)
- **반환값**: `{ pageviews: number, uniques: number }`
- **로직**: 
  - 오늘 00:00 (KST) 기준으로 필터링
  - 페이지뷰: `uslab_page_views` 테이블 count
  - 고유 방문자: `session_id` 중복 제거

#### `getDailyStats(days: number)`
- **기능**: 최근 N일 일별 페이지뷰 및 방문자 추이
- **반환값**: `Array<{ day: string, pageviews: number, uniques: number }>`
- **로직**:
  - 클라이언트 사이드에서 일별 그룹화
  - 날짜별로 `pageviews` 및 고유 `session_id` 집계

#### `getTopPages(days: number, limit: number)`
- **기능**: Top Pages (최근 N일)
- **반환값**: `Array<{ page_path: string, pageviews: number, uniques: number }>`
- **정렬**: 페이지뷰 내림차순

#### `getTopPosts(days: number, limit: number)`
- **기능**: Top Posts (최근 N일)
- **반환값**: `Array<{ post_id: string, title: string, locale: string, pageviews: number, uniques: number }>`
- **로직**: `uslab_posts` 테이블과 JOIN하여 포스트 정보 포함

#### `getTopReferrers(days: number, limit: number)`
- **기능**: Top Referrers (최근 N일)
- **반환값**: `Array<{ referrer_host: string | null, sessions: number }>`
- **데이터 소스**: `uslab_sessions` 테이블

#### `getPeriodStats()`
- **기능**: 최근 7일 및 30일 통계
- **반환값**: `{ last7Days: { pageviews: number, uniques: number }, last30Days: { pageviews: number, uniques: number } }`

---

## 6. 데이터베이스 스키마

### 6.1 세션 테이블 (`uslab_sessions`)

```sql
CREATE TABLE uslab_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_key VARCHAR(128) UNIQUE NOT NULL,
  landing_path TEXT,
  referrer TEXT,
  referrer_host VARCHAR(255),
  utm_source VARCHAR(100),
  utm_medium VARCHAR(100),
  utm_campaign VARCHAR(100),
  utm_term VARCHAR(100),
  utm_content VARCHAR(100),
  user_agent TEXT,
  device_type VARCHAR(50),  -- mobile/tablet/desktop/bot/unknown
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**인덱스**:
- `uslab_idx_sessions_session_key` (UNIQUE)
- `uslab_idx_sessions_created_at` (DESC)
- `uslab_idx_sessions_last_seen_at` (DESC)
- `uslab_idx_sessions_referrer_host`
- `uslab_idx_sessions_utm_campaign`

### 6.2 페이지뷰 테이블 (`uslab_page_views`)

```sql
CREATE TABLE uslab_page_views (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES uslab_sessions(id) ON DELETE CASCADE,
  post_id UUID REFERENCES uslab_posts(id) ON DELETE SET NULL,
  about_id UUID REFERENCES uslab_about(id) ON DELETE SET NULL,
  page_path TEXT NOT NULL,
  locale VARCHAR(10),  -- ko/en
  view_duration INTEGER,  -- 초 (향후 활용)
  scroll_depth INTEGER,   -- 0-100% (향후 활용)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**인덱스**:
- `uslab_idx_page_views_created_at` (DESC)
- `uslab_idx_page_views_page_path_created_at`
- `uslab_idx_page_views_post_id_created_at`
- `uslab_idx_page_views_about_id_created_at`
- `uslab_idx_page_views_session_id_created_at`
- `uslab_idx_page_views_day` (일별 파티션 인덱스)

### 6.3 데이터 보존 정책

- **90일 보존**: 90일 지난 트래킹 로그 자동 삭제
- **함수**: `cleanup_old_tracking_data()` (Supabase Scheduled Trigger)

---

## 7. 주요 기능 상세

### 7.1 실시간 트래픽 추적

**구현 방식**:
- 클라이언트: `Tracker.tsx` 컴포넌트가 모든 페이지에 포함
- 서버: `/api/track` API가 페이지뷰 저장
- 데이터베이스: `uslab_page_views` 테이블에 실시간 저장

**세션 관리**:
- 세션 키: `crypto.randomUUID()`로 생성
- 저장 위치: `localStorage` (`uslab_sid`)
- 만료 시간: 30분 미접속 시 새 세션 생성
- 갱신: 페이지뷰마다 `last_seen_at` 업데이트

### 7.2 트래픽 추이 차트

**구현**:
- 라이브러리: Recharts (`LineChart`, `Line`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `Legend`)
- 데이터: `getDailyStats(7)` / `getDailyStats(30)`
- 기간 선택: 7일 / 30일 토글 버튼
- 시각화:
  - 페이지뷰: Cyan 색상 (`#06b6d4`)
  - 방문자: Indigo 색상 (`#8b5cf6`)
  - 그리드: 연한 회색 (`#e2e8f0`)

### 7.3 SEO 상태 모니터링

**기술적 SEO 체크**:
- Sitemap: `sitemap.xml` 존재 여부 (하드코딩: `true`)
- Robots.txt: `robots.ts` 존재 여부 (하드코딩: `true`)
- Canonical URL: 메타데이터에 canonical URL 포함 여부 (하드코딩: `true`)
- JSON-LD: 구조화된 데이터 포함 여부 (하드코딩: `true`)

**포스트 SEO 품질 체크**:
- 발행 포스트 전체 조회
- SEO 제목 누락: `seo_title`이 없는 포스트 수
- SEO 설명 누락: `seo_description`이 없는 포스트 수
- 제목 길이 초과: `seo_title`이 60자 초과인 포스트 수
- 설명 길이 초과: `seo_description`이 160자 초과인 포스트 수
- 문제 포스트 목록: 문제가 있는 포스트 상세 정보

### 7.4 인기 콘텐츠 분석

**Top Posts**:
- 데이터 소스: `uslab_page_views` + `uslab_posts` JOIN
- 집계 기간: 최근 30일
- 정렬 기준: 페이지뷰 내림차순
- 표시 정보: 제목, 언어, 페이지뷰, 방문자 수

**Top Referrers**:
- 데이터 소스: `uslab_sessions`
- 집계 기간: 최근 30일
- 정렬 기준: 세션 수 내림차순
- 표시 정보: Referrer 호스트, 세션 수

### 7.5 최근 활동 피드

**최근 발행 포스트**:
- 데이터 소스: `uslab_posts` (is_published = true)
- 정렬: `published_at` 내림차순
- 제한: 5개

**최근 댓글**:
- 데이터 소스: `uslab_comments` (is_approved = true)
- 정렬: `created_at` 내림차순
- 제한: 5개

**최근 문의**:
- 데이터 소스: `uslab_inquiries`
- 정렬: `created_at` 내림차순
- 제한: 5개
- 상태 표시: 완료/연락완료/대기

---

## 8. 성능 최적화

### 8.1 데이터베이스 최적화

**인덱스 전략**:
- 세션 조회: `session_key` UNIQUE 인덱스
- 시간 범위 쿼리: `created_at` DESC 인덱스
- 페이지 경로 조회: `page_path` + `created_at` 복합 인덱스
- 포스트별 집계: `post_id` + `created_at` 복합 인덱스
- 일별 집계: `date_trunc('day', created_at)` 인덱스

**쿼리 최적화**:
- 집계는 클라이언트 사이드에서 수행 (메모리 기반)
- 필요한 컬럼만 SELECT
- COUNT 쿼리는 `head: true` 옵션 사용

### 8.2 클라이언트 사이드 최적화

**트래킹 최적화**:
- `sendBeacon` 사용 (fire-and-forget)
- 에러 발생 시에도 UX 영향 없음 (204 반환)
- Bot 필터링으로 불필요한 데이터 저장 방지

**대시보드 최적화**:
- 단일 API 호출로 모든 데이터 조회
- React 상태 관리로 불필요한 리렌더링 방지
- Recharts의 `ResponsiveContainer`로 반응형 차트

---

## 9. 향후 개선 사항

### 9.1 현재 제한사항

1. **기술적 SEO 체크**: 하드코딩된 값 (`true`) 사용
   - 실제 파일 존재 여부 확인 필요
   - 메타데이터 실제 검증 필요

2. **post_id 매핑**: 클라이언트에서 `null`로 전송
   - 서버에서 `page_path` 분석하여 `post_id` 자동 매핑 가능

3. **데이터 보존 정책**: 90일 자동 삭제 함수는 구현되어 있으나 스케줄러 설정 필요

4. **고급 분석**: 현재는 기본 통계만 제공
   - 시간대별 분석
   - 디바이스별 분석
   - 지역별 분석 (IP 기반)

### 9.2 개선 제안

1. **실시간 업데이트**
   - WebSocket 또는 Server-Sent Events로 실시간 통계 업데이트

2. **고급 필터링**
   - 날짜 범위 선택
   - 언어별 필터
   - 포스트 카테고리별 필터

3. **내보내기 기능**
   - CSV/Excel 내보내기
   - PDF 리포트 생성

4. **알림 기능**
   - 트래픽 급증 알림
   - SEO 문제 알림
   - 댓글/문의 알림

5. **비교 분석**
   - 전일/전주/전월 대비 비교
   - 트렌드 분석

---

## 10. 기술 스택

- **프론트엔드**: Next.js 14 (App Router), React 19, TypeScript
- **차트 라이브러리**: Recharts
- **데이터베이스**: Supabase (PostgreSQL)
- **인증**: Supabase Auth
- **스타일링**: Tailwind CSS

---

## 11. 보안 고려사항

1. **인증**: 관리자만 대시보드 접근 가능 (`useAuth` 훅)
2. **RLS**: Supabase Row Level Security 활성화
3. **Bot 필터링**: User-Agent 기반 봇 필터링
4. **데이터 검증**: Zod 스키마로 요청 데이터 검증
5. **에러 처리**: 민감한 정보 노출 방지

---

## 12. 결론

현재 대시보드 및 통계 기능은 기본적인 트래픽 추적과 분석 기능을 완전히 구현하고 있습니다. 실시간 페이지뷰 추적, KPI 대시보드, 트래픽 추이 차트, SEO 상태 모니터링 등 핵심 기능이 모두 작동 중입니다.

향후 개선을 통해 더욱 정교한 분석 기능과 실시간 업데이트, 고급 필터링 등을 추가할 수 있습니다.

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-01-XX


