# 이미지 리사이즈 기능 문제 명세서 검토 보고서

**작성일**: 2025-01-15  
**검토자**: AI Assistant  
**원본 문서**: `docs/이미지_리사이즈_기능_문제_명세서.md`

---

## 1. 명세서 요약

명세서는 현재 이미지 리사이즈 기능이 작동하지 않는 문제에 대한 **해결 방안 중심의 가이드**로 작성되었습니다.

### 핵심 문제 진단
- **증상**: 이미지 선택은 되지만(`ProseMirror-selectednode` 클래스 추가) 리사이즈 핸들이 생성되지 않음
- **가설**: `ImageResizePlugin`의 `view()` 훅이 실행되지 않거나 플러그인이 제대로 등록되지 않음

### 제안된 해결책
1. **Extension 래퍼 생성**: ProseMirror Plugin을 Tiptap Extension으로 감싸서 확실히 등록
2. **선택 기반 구현**: MutationObserver/DOM 클릭 대신 NodeSelection 기반으로 핸들 표시
3. **오버레이 방식**: 핸들을 ProseMirror 내부가 아닌 부모 컨테이너에 붙여서 DOM 충돌 방지

---

## 2. 현재 구현 상태 확인

### 2.1 플러그인 등록 방식

**현재 코드** (`BlogEditor.tsx`):
```typescript
const imageExtension = useMemo(() => {
  return UpdatedImage.extend({
    addProseMirrorPlugins() {
      return [
        UploadImagesPlugin({...}),
        createImageResizePlugin(), // ← 여기에 등록
      ];
    },
  }).configure({...});
}, []);
```

**문제점**:
- `UpdatedImage.extend()` 내부의 `addProseMirrorPlugins()`에서 플러그인을 반환하고 있음
- 하지만 Novel.sh의 `UpdatedImage`가 이 플러그인을 제대로 처리하는지 불확실
- `view()` 훅이 실행되지 않을 가능성

### 2.2 현재 플러그인 구현

**현재 방식** (`ImageResizePlugin.tsx`):
- `view.dom.addEventListener('click', ...)` - DOM 클릭 이벤트
- `MutationObserver` - 클래스 변경 감지
- ProseMirror 내부에 wrapper와 핸들 생성

**문제점**:
- Novel.sh/Tiptap이 클릭 이벤트를 가로챌 수 있음
- MutationObserver가 타이밍 문제로 작동하지 않을 수 있음
- ProseMirror 내부 DOM 조작이 에디터에 의해 제거될 수 있음

---

## 3. 명세서 해결책 검토

### 3.1 해결책 A: Extension 래퍼 (✅ 적절함)

**제안**:
```typescript
export const ImageResizeExtension = Extension.create({
  name: 'imageResizeExtension',
  addProseMirrorPlugins() {
    return [createImageResizePlugin()]
  },
})
```

**검토 결과**:
- ✅ **올바른 접근**: Tiptap Extension으로 감싸면 확실히 등록됨
- ✅ **구현 간단**: 기존 플러그인 코드 재사용 가능
- ⚠️ **주의사항**: `BlogEditor`의 `extensions` 배열에 추가해야 함

**현재 구조 확인 필요**:
- `BlogEditor.tsx`에서 extensions 배열이 어떻게 구성되는지 확인
- Novel.sh의 `EditorContent`가 extensions를 어떻게 처리하는지 확인

### 3.2 해결책 B: 선택 기반 구현 (✅ 매우 적절함)

**제안**:
- `update()` 훅에서 `NodeSelection` 확인
- 이미지 선택 시 핸들 표시
- 핸들을 부모 컨테이너에 오버레이로 배치

**검토 결과**:
- ✅ **안정적**: ProseMirror의 선택 시스템을 직접 활용
- ✅ **충돌 방지**: 이벤트 리스너 충돌 문제 해결
- ✅ **DOM 안정성**: ProseMirror 내부 DOM 조작 최소화
- ✅ **타이밍 문제 해결**: MutationObserver 대신 `update()` 사용

**코드 품질**:
- ✅ 타입 안정성: `NodeSelection`, `ProseMirrorNode` 타입 사용
- ✅ 에러 처리: null 체크 적절
- ✅ 메모리 관리: `destroy()` 훅에서 이벤트 리스너 정리

### 3.3 코드 개선 제안

명세서의 예시 코드는 전반적으로 우수하지만, 몇 가지 개선점이 있습니다:

#### 개선점 1: 이미지 노드 타입 확인

**현재**:
```typescript
function isImageNode(node: ProseMirrorNode | null | undefined) {
  if (!node) return false
  const name = (node.type?.name ?? '').toLowerCase()
  return name.includes('image') || !!node.attrs?.src
}
```

**개선 제안**:
```typescript
function isImageNode(node: ProseMirrorNode | null | undefined) {
  if (!node) return false
  // Novel.sh의 UpdatedImage는 'image' 타입 사용
  return node.type.name === 'image' || !!node.attrs?.src
}
```

#### 개선점 2: 핸들 스타일 클래스명

**현재**: `resizable-image-handle`  
**기존 CSS**: `.resize-handle`

**제안**: 기존 CSS 클래스명과 일치시키기
```typescript
handle.className = 'resize-handle' // globals.css와 일치
```

#### 개선점 3: z-index 값

**현재**: `zIndex: '50'`  
**기존 CSS**: `z-index: 1000`

**제안**: 기존 값과 일치시키기
```typescript
zIndex: '1000' // 기존 CSS와 일치
```

---

## 4. 구현 우선순위

### Phase 1: 빠른 수정 (즉시 적용 가능)

1. **Extension 래퍼 생성** (5분)
   - `components/editor/extensions/ImageResizeExtension.ts` 생성
   - `BlogEditor.tsx`의 extensions 배열에 추가

2. **디버깅 로그 추가** (2분)
   - `view()` 훅에 `console.log` 추가하여 등록 확인

**예상 효과**: 플러그인이 등록되는지 즉시 확인 가능

### Phase 2: 안정적인 구현 (권장)

1. **선택 기반 플러그인으로 교체** (30분)
   - 명세서의 예시 코드 적용
   - MutationObserver 제거
   - 오버레이 방식으로 핸들 배치

2. **CSS 클래스명 통일** (5분)
   - 기존 `globals.css`와 일치시키기

**예상 효과**: 안정적이고 충돌 없는 리사이즈 기능

### Phase 3: 장기 개선 (선택)

1. **NodeView 통합** (2-3시간)
   - `UpdatedImage.extend()`에 `addNodeView()` 구현
   - Novel.sh와 완전 통합

---

## 5. 명세서의 장점

1. ✅ **문제 진단 정확**: 증상과 원인 분석이 명확함
2. ✅ **단계별 접근**: 빠른 수정 → 안정적 구현 → 장기 개선
3. ✅ **실용적 코드**: 바로 사용 가능한 예시 코드 제공
4. ✅ **타이밍 문제 해결**: MutationObserver 대신 `update()` 사용
5. ✅ **DOM 안정성**: 오버레이 방식으로 ProseMirror 내부 조작 최소화

---

## 6. 명세서의 개선 제안

### 6.1 추가할 내용

1. **현재 BlogEditor 구조 확인**
   - extensions 배열이 어디에 정의되어 있는지
   - Novel.sh의 EditorContent가 extensions를 어떻게 처리하는지

2. **이미지 노드 타입 확인 방법**
   - 브라우저 콘솔에서 확인하는 구체적인 명령어
   ```javascript
   // 에디터 인스턴스 접근 방법
   window.editor?.state.selection.node?.type.name
   ```

3. **테스트 체크리스트**
   - [ ] Extension이 extensions 배열에 포함되어 있는지
   - [ ] `view()` 훅이 실행되는지 (콘솔 로그 확인)
   - [ ] 이미지 선택 시 `NodeSelection`이 생성되는지
   - [ ] 핸들이 부모 컨테이너에 올바르게 배치되는지

### 6.2 코드 수정 제안

명세서의 예시 코드를 프로젝트에 맞게 조정:

```typescript
// 1. 클래스명 통일
handle.className = 'resize-handle' // globals.css와 일치

// 2. z-index 통일
zIndex: '1000' // 기존 CSS와 일치

// 3. 이미지 노드 타입 확인 개선
function isImageNode(node: ProseMirrorNode | null | undefined) {
  if (!node) return false
  // Novel.sh의 UpdatedImage는 'image' 타입
  return node.type.name === 'image'
}
```

---

## 7. 결론 및 권장 사항

### 7.1 명세서 평가

**전체 평가**: ⭐⭐⭐⭐⭐ (5/5)

명세서는 문제 진단과 해결 방안이 매우 명확하고 실용적입니다. 특히:
- 문제 원인 분석이 정확함
- 단계별 해결책이 구체적임
- 바로 사용 가능한 코드 제공

### 7.2 즉시 적용 가능한 조치

1. **Extension 래퍼 생성** (명세서 해결책 A)
2. **선택 기반 플러그인으로 교체** (명세서 해결책 B)
3. **CSS 클래스명 통일**

### 7.3 예상 결과

위 조치를 적용하면:
- ✅ 플러그인이 확실히 등록됨
- ✅ 이미지 선택 시 핸들이 안정적으로 표시됨
- ✅ 이벤트 충돌 문제 해결
- ✅ DOM 조작 안정성 향상

---

## 8. 다음 단계

1. ✅ 명세서 검토 완료
2. ⏳ Extension 래퍼 생성 및 등록
3. ⏳ 선택 기반 플러그인으로 교체
4. ⏳ 테스트 및 검증
5. ⏳ 필요시 NodeView 통합

---

**검토 완료일**: 2025-01-15
