# 통계시스템 v2 명세서 검토 보고서

**작성일**: 2025-01-XX  
**검토 대상**: `통계시스템.md` (USLAB Analytics v2 명세서)  
**현재 구현 상태**: Step1 완료  
**검토자**: AI Assistant

---

## 📋 목차

1. [검토 개요](#검토-개요)
2. [현재 구현 상태 (Step1)](#현재-구현-상태-step1)
3. [명세서 v2 제안 사항 분석](#명세서-v2-제안-사항-분석)
4. [구현 가능성 평가](#구현-가능성-평가)
5. [우선순위 제안](#우선순위-제안)
6. [개선 제안](#개선-제안)
7. [마이그레이션 전략](#마이그레이션-전략)

---

## 1. 검토 개요

### 1.1 명세서 목표

- **공통 분석 코어** 구축하여 서비스별 이식 가능하게 함
- Step1 KPI 유지하면서 심화 기능 추가
- Session Replay 제외, Heatmap + Funnel + Web Vitals + AI 요약 포함

### 1.2 검토 범위

- 현재 Step1 구현 상태와의 비교
- v2 제안 사항의 실현 가능성
- 이식성 확보 방안
- 단계별 적용 계획의 타당성

---

## 2. 현재 구현 상태 (Step1)

### 2.1 ✅ 완전 구현된 기능

#### A) 클라이언트 사이드 트래킹
- **파일**: `components/analytics/Tracker.tsx`
- **기능**:
  - ✅ Next.js App Router `usePathname`, `useSearchParams` 사용
  - ✅ localStorage 세션키 (`uslab_sid`) 기반 30분 TTL
  - ✅ `sendBeacon` 우선, fetch keepalive fallback
  - ✅ `/admin`, `/api`, `/_next` 제외
  - ✅ UTM 파라미터 파싱
  - ✅ Referrer 추적

#### B) 서버 사이드 Ingestion API
- **파일**: `app/api/track/route.ts`
- **기능**:
  - ✅ Bot 필터링 (User-Agent 기반)
  - ✅ 세션 Upsert (없으면 생성, 있으면 last_seen_at 업데이트)
  - ✅ 페이지뷰 Insert
  - ✅ 에러 처리 (모든 에러는 204 반환)
  - ✅ Zod 스키마 검증

#### C) 데이터베이스 스키마
- **테이블**:
  - ✅ `uslab_sessions` (완전 구현)
  - ✅ `uslab_page_views` (완전 구현)
- **인덱스**: 모든 필수 인덱스 구현됨
- **RLS**: Row Level Security 활성화

#### D) 통계 쿼리 함수
- **파일**: `lib/queries/analytics.ts`
- **함수**:
  - ✅ `getTodayStats()` - 오늘 통계
  - ✅ `getDailyStats(days)` - 일별 통계
  - ✅ `getTopPages(days, limit)` - Top Pages
  - ✅ `getTopPosts(days, limit)` - Top Posts
  - ✅ `getTopReferrers(days, limit)` - Top Referrers
  - ✅ `getPeriodStats()` - 기간별 통계

#### E) 대시보드 UI
- **파일**: `app/admin/dashboard/page.tsx`
- **기능**:
  - ✅ KPI 카드 (4개)
  - ✅ 트래픽 추이 차트 (7일/30일, Recharts)
  - ✅ SEO 상태 모니터링
  - ✅ Top Posts / Top Referrers
  - ✅ 최근 활동 피드

### 2.2 ⚠️ 부분 구현 / 개선 필요

#### A) Prefix 하드코딩
- **현재**: `uslab_` prefix가 코드에 하드코딩됨
- **명세서 제안**: `ANALYTICS_PREFIX` 환경변수로 설정 가능하게
- **영향**: 이식성 제한

#### B) page_path 정규화
- **현재**: `pathname + search` 전체 저장
- **명세서 제안**: `pathname`만 저장 (canonical)
- **영향**: UTM 파라미터로 인한 path 폭발 가능

#### C) page_view_id
- **현재**: 서버에서 생성
- **명세서 제안**: 클라이언트에서 생성하여 전달
- **영향**: 이벤트와 페이지뷰 연결 어려움

#### D) 이벤트 시스템
- **현재**: 이벤트 수집 없음
- **명세서 제안**: `{{prefix}}_events` 테이블 추가
- **영향**: 히트맵, 퍼널, Web Vitals 불가능

#### E) Rollup 테이블
- **현재**: Raw 데이터에서 직접 집계
- **명세서 제안**: 일별 집계 테이블 도입
- **영향**: 대시보드 성능 저하 가능성

#### F) Retention 정책
- **현재**: 90일 삭제 함수는 있으나 스케줄러 미설정
- **명세서 제안**: 스케줄러 확실히 설정
- **영향**: 데이터 무한 증가 위험

---

## 3. 명세서 v2 제안 사항 분석

### 3.1 ✅ 명세서와 현재 구현의 일치 사항

1. **세션 관리**: 30분 TTL, localStorage 기반 ✅
2. **Bot 필터링**: User-Agent 기반 ✅
3. **sendBeacon 우선**: fire-and-forget 방식 ✅
4. **데이터베이스 구조**: sessions, page_views 기본 구조 ✅
5. **대시보드 기본 기능**: KPI, 차트, Top 콘텐츠 ✅

### 3.2 🔄 명세서 제안 사항 (미구현)

#### A) 이식성 확보 (Phase 0)
- **제안**: `ANALYTICS_PREFIX` 환경변수
- **현재**: 하드코딩 (`uslab_`)
- **우선순위**: 🔴 높음 (이식성 핵심)

#### B) page_path 정규화
- **제안**: pathname만 저장
- **현재**: pathname + search 저장
- **우선순위**: 🟡 중간 (데이터 품질)

#### C) page_view_id 클라이언트 생성
- **제안**: 클라이언트에서 UUID 생성
- **현재**: 서버에서 생성
- **우선순위**: 🟡 중간 (이벤트 연결 필요)

#### D) Events 테이블 (Phase 1)
- **제안**: `{{prefix}}_events` 테이블
- **현재**: 없음
- **우선순위**: 🔴 높음 (v2 핵심)

#### E) 이벤트 수집
- **제안**: click, scroll_depth, conversion, web_vital
- **현재**: 없음
- **우선순위**: 🔴 높음 (히트맵/퍼널 기반)

#### F) Rollup 테이블 (Phase 2)
- **제안**: 일별 집계 테이블
- **현재**: Raw 데이터 직접 집계
- **우선순위**: 🟡 중간 (성능 최적화)

#### G) 히트맵 (Phase 1)
- **제안**: Element heatmap
- **현재**: 없음
- **우선순위**: 🟢 낮음 (고급 기능)

#### H) 퍼널 (Phase 2)
- **제안**: Funnel definitions + daily rollup
- **현재**: 없음
- **우선순위**: 🟢 낮음 (고급 기능)

#### I) Web Vitals (Phase 3)
- **제안**: LCP, CLS, INP 수집
- **현재**: 없음
- **우선순위**: 🟢 낮음 (고급 기능)

#### J) AI 요약 리포트 (Phase 3)
- **제안**: 일일 자동 리포트
- **현재**: 없음
- **우선순위**: 🟢 낮음 (옵션 기능)

---

## 4. 구현 가능성 평가

### 4.1 ✅ 즉시 구현 가능 (Low Risk)

1. **Prefix 환경변수화**
   - 난이도: ⭐ (쉬움)
   - 리스크: 낮음
   - 영향: 이식성 향상

2. **page_path 정규화**
   - 난이도: ⭐ (쉬움)
   - 리스크: 낮음
   - 영향: 데이터 품질 향상

3. **page_view_id 클라이언트 생성**
   - 난이도: ⭐⭐ (보통)
   - 리스크: 낮음
   - 영향: 이벤트 연결 가능

4. **Retention 스케줄러 설정**
   - 난이도: ⭐⭐ (보통)
   - 리스크: 낮음
   - 영향: 데이터 관리

### 4.2 ⚠️ 주의 필요 (Medium Risk)

1. **Events 테이블 추가**
   - 난이도: ⭐⭐⭐ (보통)
   - 리스크: 중간
   - 영향: 이벤트 수집 기반

2. **이벤트 수집 구현**
   - 난이도: ⭐⭐⭐ (보통)
   - 리스크: 중간
   - 영향: 클라이언트 성능, 데이터 볼륨

3. **Rollup 테이블 도입**
   - 난이도: ⭐⭐⭐⭐ (어려움)
   - 리스크: 중간
   - 영향: 대시보드 성능

### 4.3 🔴 복잡함 (High Risk)

1. **히트맵 구현**
   - 난이도: ⭐⭐⭐⭐ (어려움)
   - 리스크: 높음
   - 영향: UI 복잡도, 데이터 처리

2. **퍼널 구현**
   - 난이도: ⭐⭐⭐⭐⭐ (매우 어려움)
   - 리스크: 높음
   - 영향: 복잡한 로직, UI 설계

3. **Web Vitals 수집**
   - 난이도: ⭐⭐⭐ (보통)
   - 리스크: 중간
   - 영향: 클라이언트 성능 모니터링

4. **AI 요약 리포트**
   - 난이도: ⭐⭐⭐⭐⭐ (매우 어려움)
   - 리스크: 높음
   - 영향: AI 모델 통합, 비용

---

## 5. 우선순위 제안

### 5.1 Phase 0: 이식성 확보 (즉시)

**목표**: 다른 서비스로 이식 가능한 구조로 리팩토링

**작업**:
1. ✅ `ANALYTICS_PREFIX` 환경변수 도입
2. ✅ `page_path` 정규화 (pathname만 저장)
3. ✅ `page_view_id` 클라이언트 생성
4. ✅ Retention 스케줄러 설정
5. ✅ Query 함수에 prefix 인자 추가

**예상 기간**: 1-2일  
**리스크**: 낮음  
**ROI**: 높음 (이식성 핵심)

### 5.2 Phase 1: Events + 기본 히트맵 (단기)

**목표**: 이벤트 수집 기반 구축 및 기본 히트맵

**작업**:
1. ✅ `{{prefix}}_events` 테이블 생성
2. ✅ `/api/track`에 events[] payload 추가
3. ✅ 클라이언트 이벤트 수집 (click, scroll_depth, conversion)
4. ✅ 이벤트 배치 전송 로직
5. ✅ Element heatmap 카드 추가 (대시보드)

**예상 기간**: 3-5일  
**리스크**: 중간  
**ROI**: 높음 (핵심 기능)

### 5.3 Phase 2: Rollup + 퍼널 (중기)

**목표**: 성능 최적화 및 퍼널 분석

**작업**:
1. ✅ Rollup 테이블 생성 (daily_stats, daily_page_stats 등)
2. ✅ Rollup 생성 스케줄러 (Vercel Cron)
3. ✅ Query 함수를 rollup 우선으로 변경
4. ✅ Funnel definitions 테이블
5. ✅ Funnel daily rollup
6. ✅ Funnel 카드 추가 (대시보드)

**예상 기간**: 5-7일  
**리스크**: 중간  
**ROI**: 중간 (성능 최적화)

### 5.4 Phase 3: Web Vitals + AI 리포트 (장기)

**목표**: 고급 분석 기능

**작업**:
1. ✅ Web Vitals 수집 (Next.js `useReportWebVitals`)
2. ✅ Web Vitals rollup
3. ✅ Web Vitals 카드 추가 (대시보드)
4. ⚠️ AI 요약 리포트 (옵션, 복잡도 높음)

**예상 기간**: 7-10일  
**리스크**: 높음  
**ROI**: 낮음 (고급 기능)

---

## 6. 개선 제안

### 6.1 명세서 개선 사항

#### A) 명세서의 강점
- ✅ 단계별 적용 계획 명확
- ✅ 이식성 고려 (prefix 전략)
- ✅ 보안/컴플라이언스 가이드 포함
- ✅ 성능 예산 고려

#### B) 명세서 보완 필요 사항

1. **마이그레이션 전략 부족**
   - 현재 Step1 데이터를 v2로 마이그레이션하는 방법 명시 필요
   - `page_path` 정규화 시 기존 데이터 처리 방안

2. **에러 처리 상세화 필요**
   - 이벤트 수집 실패 시 재시도 로직
   - 배치 전송 실패 시 처리 방안

3. **샘플링 정책 구체화**
   - 세션 단위 샘플링 구현 방법
   - 샘플링된 데이터로 집계 시 보정 방법

4. **테스트 전략 부재**
   - 단위 테스트 전략
   - 통합 테스트 전략
   - 성능 테스트 기준

### 6.2 구현 시 고려사항

#### A) 데이터 마이그레이션
- 기존 `uslab_page_views` 데이터 보존
- `page_path` 정규화 시 기존 데이터 업데이트 스크립트 필요
- `page_view_id` 클라이언트 생성으로 변경 시 기존 데이터와의 호환성

#### B) 성능 최적화
- 이벤트 배치 전송 크기 제한
- Rollup 생성 시간 최적화
- 대시보드 쿼리 캐싱 전략

#### C) 보안 강화
- 이벤트 수집 시 개인정보 필터링 강화
- Rate limiting 구체화
- DNT (Do Not Track) 존중 구현

---

## 7. 마이그레이션 전략

### 7.1 Step1 → Step1.5 (Phase 0)

**목표**: 이식성 확보

**단계**:
1. 환경변수 추가: `ANALYTICS_PREFIX=uslab`
2. 코드 리팩토링: 하드코딩된 `uslab_` → 환경변수 사용
3. `page_path` 정규화: 기존 데이터 마이그레이션 스크립트
4. `page_view_id` 클라이언트 생성: API 수정
5. Retention 스케줄러 설정: Vercel Cron

**롤백 계획**: 환경변수만 제거하면 기존 동작

### 7.2 Step1.5 → v2 Phase 1

**목표**: Events 시스템 구축

**단계**:
1. `{{prefix}}_events` 테이블 생성 (마이그레이션)
2. `/api/track` payload 확장 (하위 호환성 유지)
3. 클라이언트 이벤트 수집 추가
4. 대시보드 히트맵 카드 추가

**롤백 계획**: events 수집만 비활성화

### 7.3 v2 Phase 1 → Phase 2

**목표**: Rollup + 퍼널

**단계**:
1. Rollup 테이블 생성
2. Rollup 생성 스케줄러 설정
3. Query 함수를 rollup 우선으로 변경
4. 퍼널 시스템 구축

**롤백 계획**: rollup 비활성화, raw 데이터로 복귀

---

## 8. 결론 및 권장사항

### 8.1 명세서 평가

**전체 평가**: ⭐⭐⭐⭐ (4/5)

**강점**:
- ✅ 단계별 적용 계획이 명확함
- ✅ 이식성 고려가 잘 되어 있음
- ✅ 보안/컴플라이언스 가이드 포함
- ✅ 성능 예산 고려

**보완 필요**:
- ⚠️ 마이그레이션 전략 상세화 필요
- ⚠️ 에러 처리 로직 구체화 필요
- ⚠️ 테스트 전략 추가 필요

### 8.2 권장 적용 순서

1. **즉시 적용 (Phase 0)**: 이식성 확보
   - ROI 높음, 리스크 낮음
   - 다른 서비스 이식 전 필수

2. **단기 적용 (Phase 1)**: Events + 히트맵
   - 핵심 기능 추가
   - 사용자 가치 높음

3. **중기 적용 (Phase 2)**: Rollup + 퍼널
   - 성능 최적화
   - 고급 분석 기능

4. **장기 검토 (Phase 3)**: Web Vitals + AI 리포트
   - 복잡도 높음
   - 필요성에 따라 결정

### 8.3 최종 권장사항

**명세서는 전반적으로 잘 작성되었으며, 단계별 적용 계획이 현실적입니다.**

**우선 적용 권장**:
1. Phase 0 (이식성 확보) - 즉시
2. Phase 1 (Events + 히트맵) - 단기

**검토 후 결정**:
- Phase 2 (Rollup + 퍼널) - 트래픽 증가 시
- Phase 3 (Web Vitals + AI) - 필요성 검토 후

**명세서 보완 권장**:
- 마이그레이션 스크립트 예시 추가
- 에러 처리 로직 상세화
- 테스트 전략 섹션 추가

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-01-XX






